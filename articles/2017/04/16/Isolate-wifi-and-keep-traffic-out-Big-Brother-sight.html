<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Isolate a wifi card and keep your traffic out of the Big Brother sight</title>
  <meta name="description" content="⊕  HTTP Proxies blacklisting evil domains, firewalls blocking weird trafficand IDSs looking for someone that shouldn’t be there are reasonable andunderstanda...">

  
    <link href='//fonts.googleapis.com/css?family=Lato:400,400italic' rel='stylesheet' type='text/css'>
  

  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        extensions: ["tex2jax.js"],
        jax: ["input/TeX","output/HTML-CSS"],
        tex2jax: {inlineMath: [["$$","$$"],["\\(","\\)"]]},
	TeX: {
	  Macros: {
            
	  }
	}
      });
    </script>
    
      <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js' async></script>
    
  

  
    <script
       src="https://code.jquery.com/jquery-3.4.1.min.js"
       integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
       crossorigin="anonymous"></script>
  

  

    
      <script src='https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.9.1/underscore-min.js' ></script>
    

    
      <script src="https://d3js.org/d3.v4.min.js"></script>
    

    <script src='/book-of-gehn/js/venn/venn.min.js'></script>
    <script src='/book-of-gehn/js/venn/helper.js'></script>

    <script src='/book-of-gehn/js/fix_syntax_highlight.js'></script>
  <link rel="stylesheet" type="text/css" href="/book-of-gehn/css/tufte.css">
  <link rel="stylesheet" type="text/css" href="/book-of-gehn/css/latex.css">

  <link rel="canonical" href="/book-of-gehn/articles/2017/04/16/Isolate-wifi-and-keep-traffic-out-Big-Brother-sight.html">

  <link rel="stylesheet" type="text/css" href="/book-of-gehn/css/all.min.css">

  <link type="application/atom+xml" rel="alternate" href="/book-of-gehn/feed.xml" title="The Book of Gehn" />
</head>

  <body>
    <header>
	
		<h1 class="header-title"><a href="/book-of-gehn/">The Book of Gehn</a></h1>
		
		
	

    

    
</header>

    <article class="group">
      <h1>Isolate a wifi card and keep your traffic out of the Big Brother sight</h1>
<p class="subtitle">April 16, 2017</p>

<p><label for="mf-9d56bae39ef3717a0ac0633d00b3095c" class="margin-toggle  in-index-only">⊕</label><input type="checkbox" id="mf-9d56bae39ef3717a0ac0633d00b3095c" class="margin-toggle  in-index-only" /><span class="marginnote  in-index-only"><img style="" class="fullwidth" alt="Big Brother sight" src="/book-of-gehn/assets/isolate_wifi/isolate_wifi_big_brother_sight.png" />  <br /></span></p>

<p>HTTP Proxies blacklisting evil domains, firewalls blocking weird traffic
and IDSs looking for someone that shouldn’t be there are reasonable and
understandable policies for a corporate environment.</p>

<p>But when a friend opened his browser this week and went to <code class="highlighter-rouge">google.com</code>
the things got odd.</p>

<p>The browser refused the connection warning him that the SSL certificate
of the server wasn’t issue by <code class="highlighter-rouge">google.com</code> at all or signed by a
trusted authority.<!--more--></p>

<p>My first thought was, <em>“this is a man in the middle attack”</em> but it turned out
that the IT guys said to him: <em>“it’s OK, just accept the new certificate and
ignore the warning of the browser”</em>.</p>

<p>They were tampering the internet access of all the company!<label for="mf-9d56bae39ef3717a0ac0633d00b3095c" class="margin-toggle ">⊕</label><input type="checkbox" id="mf-9d56bae39ef3717a0ac0633d00b3095c" class="margin-toggle " /><span class="marginnote "><img class="fullwidth" alt="Big Brother sight" src="/book-of-gehn/assets/isolate_wifi/isolate_wifi_big_brother_sight.png" />  <br /></span></p>

<p>All his credentials, emails and documents could be read by someone else.
That was unacceptable.</p>

<p>Fortunately he has a Starbucks near with a decent wifi signal strength.</p>

<p><label for="mn-8a9bc5cc93357406291d1c45363f7f68" class="margin-toggle"> ⊕</label><input type="checkbox" id="mn-8a9bc5cc93357406291d1c45363f7f68" class="margin-toggle" /><span class="marginnote">Spoiler: <a href="/book-of-gehn/assets/isolate_wifi/isolate_wifi.sh">isolate_wifi.sh</a> </span></p>

<p>Now the challenge is how to separate the private traffic so it can go
only through the wifi while ensuring that the corporate traffic stays
where it belongs, under the sight of the <em>Big Brother</em>.</p>

<h3 id="isolate-a-wifi-card-with-network-namespaces">Isolate a wifi card with Network Namespaces</h3>

<p>In a modern linux implementation we can use a <code class="highlighter-rouge">Network Namespace</code> which
can create isolated full network stacks with their own routes and firewall
rules.</p>

<p>Any program running inside that namespace will see only that network stack
which it is perfect for our purpose.</p>

<p>Let’s create it first; pick a nice name and run:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>ip netns add <span class="s2">"starbucks"</span>
</code></pre></div></div>

<p>With that we have our <code class="highlighter-rouge">"starbucks"</code> namespace, empty for now.</p>

<p>Now, we cannot put our wifi card into that namespace directly using
the <code class="highlighter-rouge">ip</code> command.</p>

<p>Typically you should use something like:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>ip <span class="nb">link set </span>DEVICE netns <span class="s2">"starbucks"</span>
</code></pre></div></div>

<p>to move the <code class="highlighter-rouge">DEVICE</code> from the default namespace to the <code class="highlighter-rouge">"starbucks"</code>
namespace, <strong>but no</strong>, we cannot use this.</p>

<p>A wireless card is a little more exotic.</p>

<p>First, we need to know the <em>physical id</em> of our card:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>iw dev <span class="s2">"wlan0"</span> info
Interface
    ifindex 3
    wdev 0x1
    addr &lt;mac-addr&gt;
    <span class="nb">type </span>managed
    wiphy &lt;phy-id&gt;
</code></pre></div></div>

<p>where <code class="highlighter-rouge">"wlan0"</code> is the name of our wifi interface.</p>

<p>If you are lazy like me then you may find useful this shortcut.
The <code class="highlighter-rouge">iw</code> manpage warns that the output of this command shouldn’t be scrapped,
but let’s be disobedient for a while:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ PHYNUM</span><span class="o">=</span><span class="si">$(</span>iw dev <span class="s2">"wlan0"</span> info | <span class="nb">sed</span> <span class="nt">-n</span> <span class="s1">'s/^.*wiphy \([0-9]\+\)$/\1/p'</span><span class="si">)</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"</span><span class="nv">$PHYNUM</span><span class="s2">"</span>
&lt;phy-id&gt;
</code></pre></div></div>

<p>Now, it comes the tricky part.</p>

<p>To move a wifi card to a namespace we need to have a process already
running there in the first place.</p>

<p>Then we use <code class="highlighter-rouge">iw</code> to move the card.</p>

<p>Here are the bits that do the magic:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>ip netns <span class="nb">exec</span> <span class="s2">"starbucks"</span> <span class="nb">sleep </span>3 &amp;
<span class="nv">$ PID</span><span class="o">=</span><span class="nv">$!</span>

<span class="nv">$ </span>iw phy <span class="s2">"phy&lt;phy-id&gt;"</span> <span class="nb">set </span>netns <span class="s2">"</span><span class="nv">$PID</span><span class="s2">"</span>
</code></pre></div></div>

<p>Just run a process in the namespace in background,
grab its process id, and move the <code class="highlighter-rouge">"phy&lt;phy-id&gt;"</code> card to the same
namespace of that process.</p>

<h3 id="connect-to-a-wifi-network">Connect to a wifi network</h3>

<p>With the card in its place, we are left is configure it. Pretty standard.</p>

<p>First, up the interfaces in the <code class="highlighter-rouge">"starbucks"</code> namespace:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>ip netns <span class="nb">exec</span> <span class="s2">"starbucks"</span> rfkill unblock <span class="s2">"&lt;phy-id&gt;"</span>

<span class="nv">$ </span>ip <span class="nt">-n</span> <span class="s2">"starbucks"</span> <span class="nb">link set</span> <span class="s2">"wlan0"</span> up
<span class="nv">$ </span>ip <span class="nt">-n</span> <span class="s2">"starbucks"</span> <span class="nb">link set</span> <span class="s2">"lo"</span> up
</code></pre></div></div>

<p>And connect to the access point.</p>

<p>This of course will depend of the authentication method used by
your local Starbucks.</p>

<p>For an open network it is quite easy:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>ip netns <span class="nb">exec</span> <span class="s2">"starbucks"</span> iw <span class="s2">"wlan0"</span> connect <span class="nt">-w</span> <span class="s2">"</span><span class="nv">$SSID</span><span class="s2">"</span>
wlan0 <span class="o">(</span>phy <span class="c">#&lt;phy-id&gt;): connected to &lt;ap-mac-addr&gt;</span>
</code></pre></div></div>

<p>For a WPA/WPA2 protected network we need to generate a passphrase
(and configuration) and then run <code class="highlighter-rouge">wpa_supplicant</code>, an agent that will
handle the negotiation between your machine and the access point and
it will keep it alive in background.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>wpa_passphrase <span class="s2">"</span><span class="nv">$SSID</span><span class="s2">"</span> <span class="o">&gt;</span> <span class="s2">"/tmp/starbucks_wpa_file"</span>
<span class="nv">$ </span>ip netns <span class="nb">exec</span> <span class="s2">"starbucks"</span> wpa_supplicant <span class="nt">-B</span> <span class="nt">-i</span> <span class="s2">"wlan0"</span> <span class="nt">-c</span> <span class="s2">"/tmp/starbucks_wpa_file"</span>
</code></pre></div></div>

<p>In both cases, the <code class="highlighter-rouge">$SSID</code> is the name of the wifi network
which you want to connect.</p>

<p>To setup the IP address, the gateway and the DNS server we can use
a DHCP client:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>ip netns <span class="nb">exec</span> <span class="s2">"starbucks"</span> dhclient <span class="s2">"wlan0"</span>
</code></pre></div></div>

<p>Or we can setup them manually:</p>

<div class="language-shell_session highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span> ip <span class="nt">-n</span> <span class="s2">"starbucks"</span> addr add <span class="s2">"192.168.0.22/24"</span> dev <span class="s2">"wlan0"</span>
<span class="gp">$</span> ip <span class="nt">-n</span> <span class="s2">"starbucks"</span> route add default via <span class="s2">"192.168.0.1"</span> dev <span class="s2">"wlan0"</span>
<span class="go">
</span><span class="gp">$</span> <span class="nb">mkdir</span> <span class="nt">-p</span> <span class="s2">"/etc/netns/starbucks"</span>
<span class="gp">$</span> <span class="nb">echo</span> <span class="s2">"nameserver 8.8.8.8"</span> <span class="o">&gt;</span> /etc/netns/starbucks/resolv.conf
</code></pre></div></div>

<p>The network namespace will mount on <code class="highlighter-rouge">/etc</code> each custom file
inside <code class="highlighter-rouge">/etc/netns/starbucks</code> so any unaware program executed
by <code class="highlighter-rouge">ip netns exec</code> that wants to read/write a file in <code class="highlighter-rouge">/etc</code> will be
actually accessing to the files in <code class="highlighter-rouge">/etc/netns/starbucks</code>.</p>

<p>In our case, we created a custom <code class="highlighter-rouge">/etc/netns/starbucks/resolv.conf</code> to
configure the DNS lookup.</p>

<blockquote>
  <p>Upss: <code class="highlighter-rouge">dhclient</code> will no be able to write its <code class="highlighter-rouge">resolv.conf</code> and you will
require to setup the DNS manually.</p>

  <p>If you are brave enough you can try another <a href="https://stackoverflow.com/questions/38102481/how-can-dhclient-be-made-namespace-aware">hack</a>.</p>
</blockquote>

<h3 id="surf-out-of-the-big-brother-sight"><em>Surf</em> out of the Big Brother sight</h3>

<p>To navigate free, open your favorite browser (or other network application)
<em>inside</em> the network namespace.</p>

<p>To do that open a shell inside the namespace and log in as a normal user; only
then open your browser:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>ip netns <span class="nb">exec</span> <span class="s2">"starbucks"</span> su <span class="nt">-l</span> <span class="s2">"gehn"</span>
<span class="k">in </span>namespace<span class="o">)</span> firefox
</code></pre></div></div>

<p>This is an important detail: if you run <code class="highlighter-rouge">ip netns exec firefox</code> directly
you will end up running your browser with root privileges.</p>

<h3 id="close-everything">Close everything</h3>

<p>In order to clean up everything, you need to ensure that all the processes
running inside the namespace are killed and only then remove the namespace
itself.</p>

<p>Otherwise if some process keeps alive the namespace will not be deleted.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>ip netns pids <span class="s2">"starbucks"</span> | xargs <span class="nb">kill</span> <span class="nt">-15</span> <span class="c"># be polite</span>
<span class="nv">$ </span><span class="nb">sleep </span>12
<span class="nv">$ </span>ip netns pids <span class="s2">"starbucks"</span> | xargs <span class="nb">kill</span> <span class="nt">-9</span>  <span class="c"># but being bad is more fun</span>
<span class="nv">$ </span>ip netns delete <span class="s2">"starbucks"</span>
<span class="nv">$ </span><span class="nb">rm</span> <span class="nt">-Rf</span> /etc/netns/starbucks/
</code></pre></div></div>

<p>If you are a little paranoiac you can also block the wifi card
before leaving the namespace to ensure that nobody will use it after that
the namespace is gone:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>ip netns <span class="nb">exec</span> <span class="s2">"starbucks"</span> rfkill block <span class="s2">"&lt;phy-id&gt;"</span>
</code></pre></div></div>



    </article>
    <span class="print-footer">Isolate a wifi card and keep your traffic out of the Big Brother sight - April 16, 2017 - Gehn</span>
    <footer>
    <hr class="slender">
    <div class="credits">
        <span>&copy; 2021
            
            Gehn
        </span></br>
            <a style="text-decoration: none;" href="/book-of-gehn/feed.xml"><img height="16px" width="16px" src="/book-of-gehn/assets/blog-assets/rss-32px.png" /></a>
        <br>
        

    
    </div>
</footer>

  </body>
</html>
