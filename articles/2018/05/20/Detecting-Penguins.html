<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Detecting Penguins</title>
  <meta name="description" content="The ECB encrypted image on the rightand its plaintext original version on the left. Image taken fromwikipedia.Can you see the penguin? ⊕– Spoiler Alert! – ">

  
    <link href='//fonts.googleapis.com/css?family=Lato:400,400italic' rel='stylesheet' type='text/css'>
  

  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        extensions: ["tex2jax.js"],
        jax: ["input/TeX","output/HTML-CSS"],
        tex2jax: {inlineMath: [["$$","$$"],["\\(","\\)"]]},
	TeX: {
	  Macros: {
            
	  }
	}
      });
    </script>
    
      <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js' async></script>
    
  

  
    <script
       src="https://code.jquery.com/jquery-3.4.1.min.js"
       integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
       crossorigin="anonymous"></script>
  

  

    
      <script src='https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.9.1/underscore-min.js' ></script>
    

    
      <script src="https://d3js.org/d3.v4.min.js"></script>
    

    <script src='/book-of-gehn/js/venn/venn.min.js'></script>
    <script src='/book-of-gehn/js/venn/helper.js'></script>

    <script src='/book-of-gehn/js/fix_syntax_highlight.js'></script>
  <link rel="stylesheet" type="text/css" href="/book-of-gehn/css/tufte.css">
  <link rel="stylesheet" type="text/css" href="/book-of-gehn/css/latex.css">

  <link rel="canonical" href="/book-of-gehn/articles/2018/05/20/Detecting-Penguins.html">

  <link rel="stylesheet" type="text/css" href="/book-of-gehn/css/all.min.css">

  <link type="application/atom+xml" rel="alternate" href="/book-of-gehn/feed.xml" title="The Book of Gehn" />
</head>

  <body>
    <header>
	
		<h1 class="header-title"><a href="/book-of-gehn/">The Book of Gehn</a></h1>
		
		
	

    

    
</header>

    <article class="group">
      <h1>Detecting Penguins</h1>
<p class="subtitle">May 20, 2018</p>

<figure><figcaption><span>The ECB encrypted image on the right
and its plaintext original version on the left. Image taken from
<a href="https://en.wikipedia.org/wiki/Block_cipher_mode_of_operation">wikipedia</a>.</span></figcaption><img src="/book-of-gehn/assets/matasano/tux.png" /></figure>

<p>Can you see the penguin?<label for="mn-92c40aed2262db60522dbf16855f07d8" class="margin-toggle"> ⊕</label><input type="checkbox" id="mn-92c40aed2262db60522dbf16855f07d8" class="margin-toggle" /><span class="marginnote"><strong>– Spoiler Alert! –</strong> </span></p>

<!--more-->

<h2 id="warming-up">Warming up</h2>

<p>The following ciphertext was encrypted with AES in ECB mode (Electronic Code
Book) with the given key.</p>

<p>In ECB each plaintext block is encrypted using the same key.</p>

<figure><figcaption><span></span></figcaption><img style="max-width:60%;" alt="ECB Enc" src="/book-of-gehn/assets/matasano/ecb-enc.png" /></figure>

<p>Decrypting is a piece of cake; this is just to get practice about
<a href="https://cryptopals.com/sets/1/challenges/7">AES in ECB mode</a></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">cryptonita</span> <span class="kn">import</span> <span class="n">B</span><span class="p">,</span> <span class="n">load_bytes</span>     <span class="c1"># byexample: +timeout=10
</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">ciphertext</span> <span class="o">=</span> <span class="n">B</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s">'./assets/matasano/7.txt'</span><span class="p">),</span> <span class="n">encoding</span><span class="o">=</span><span class="mi">64</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">blocks</span> <span class="o">=</span> <span class="n">ciphertext</span><span class="o">.</span><span class="n">nblocks</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">key</span> <span class="o">=</span> <span class="n">B</span><span class="p">(</span><span class="s">'YELLOW SUBMARINE'</span><span class="p">)</span>

<span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">Crypto.Cipher</span> <span class="kn">import</span> <span class="n">AES</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">plaintext</span> <span class="o">=</span> <span class="n">B</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">AES</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">AES</span><span class="o">.</span><span class="n">MODE_ECB</span><span class="p">)</span><span class="o">.</span><span class="n">decrypt</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">blocks</span><span class="p">)</span>

<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span><span class="p">(</span><span class="n">plaintext</span><span class="p">)</span>
<span class="n">b</span><span class="s">"I'm back and I'm ringin' the bell&lt;...&gt;Play that funky music </span><span class="se">\n\x04\x04\x04\x04</span><span class="s">"</span>
</code></pre></div></div>

<figure><figcaption><span><br />Note how to encryption/decryption of one block don't depend of any other: this allows the encryption/decryption to be at random places and in parallel.</span></figcaption><img style="max-width:60%;" alt="ECB Dec" src="/book-of-gehn/assets/matasano/ecb-dec.png" /></figure>

<h2 id="detecting-penguins">Detecting Penguins</h2>

<p>If two plaintext <em>blocks</em> are the same, ECB
will encrypt them to the <em>same</em> ciphertext block.</p>

<p><a href="https://cryptopals.com/sets/1/challenges/8">Detecting AES in ECB mode</a>
from a pool of random strings is therefore trivial: if the plaintext has two or
more equal blocks, the ciphertext will have the same blocks repeated, something
unlikely for a truly random string.</p>

<p>We can use the same technique done in
<a href="/book-of-gehn/articles/2018/04/01/A-string-of-coincidences-is-not-a-coincidence.html">the previous post</a>
for detecting coincidences.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">ciphertexts</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">load_bytes</span><span class="p">(</span><span class="s">'./assets/matasano/8.txt'</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="mi">16</span><span class="p">))</span>

<span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">cryptonita.scoring</span> <span class="kn">import</span> <span class="n">icoincidences</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">scores</span> <span class="o">=</span> <span class="p">[</span><span class="n">icoincidences</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">ciphertexts</span><span class="p">]</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">scores_and_indexes</span> <span class="o">=</span> <span class="p">[(</span><span class="n">s</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">scores</span><span class="p">)]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">scores_and_indexes</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">scores_and_indexes</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]</span> <span class="c1"># higher values, less random
</span><span class="p">[(</span><span class="mf">0.00526729</span><span class="o">&lt;...&gt;</span><span class="p">,</span> <span class="mi">92</span><span class="p">),</span>
 <span class="p">(</span><span class="mf">0.00526729</span><span class="o">&lt;...&gt;</span><span class="p">,</span> <span class="mi">173</span><span class="p">),</span>
 <span class="p">(</span><span class="mf">0.01305031</span><span class="o">&lt;...&gt;</span><span class="p">,</span> <span class="mi">132</span><span class="p">)]</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">methods</span> <span class="o">=</span> <span class="p">{}</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">methods</span><span class="p">[</span><span class="s">'IC - Byte sequence'</span><span class="p">]</span> <span class="o">=</span> <span class="n">scores</span>
</code></pre></div></div>

<p>Instead of working at the byte level, we can work with blocks:
a coincidence of two or more blocks is much less likely to be random
than a coincidence of two or more bytes:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">scores</span> <span class="o">=</span> <span class="p">[</span><span class="n">icoincidences</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">nblocks</span><span class="p">(</span><span class="mi">16</span><span class="p">))</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">ciphertexts</span><span class="p">]</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">scores_and_indexes</span> <span class="o">=</span> <span class="p">[(</span><span class="n">s</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">scores</span><span class="p">)]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">scores_and_indexes</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">scores_and_indexes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span> <span class="c1"># higher values, less random
</span><span class="p">[(</span><span class="mf">0.133333333</span><span class="o">&lt;...&gt;</span><span class="p">,</span> <span class="mi">132</span><span class="p">)]</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">methods</span><span class="p">[</span><span class="s">'IC - Nblocks sequence'</span><span class="p">]</span> <span class="o">=</span> <span class="n">scores</span>
</code></pre></div></div>

<figure class="fullwidth"><img src="/book-of-gehn/assets/matasano/score_pinguins.png" /><figcaption>Scores by methods. For the Nblocks method, the size of the block is of 16 bytes.</figcaption></figure>

<p><br /></p>

<!--
>>> import sys
>>> sys.path.append("./assets/plotting")

>>> from plotting import plt, show                      # byexample: +timeout=10
>>> import pandas as pd                                 # byexample: +timeout=10

>>> methods = pd.DataFrame(methods)

>>> def min_max_normalizer(c):
...     return (c - c.min()) / (c.max() - c.min())

>>> methods = methods.apply(min_max_normalizer, axis=0)

>>> with show(save='./assets/matasano/score_pinguins.png', latexify_kargs={'columns':2}): # byexample: +timeout=600 +skip
...     axes = methods.plot(style='o', subplots=True, layout=(2, 1))
...
...     _ = [ax.vlines(132, 0, 1, linestyles='dashed') for ax in axes.flat]
-->

<h3 id="broken">Broken?</h3>

<p>Well, distinguishing  a encryption from a random string is enough to considere
a cipher broken, but trying to get the plaintext from it is another
level.</p>

<p>The 132th plaintext  will still be a secret, for now.</p>




    </article>
    <span class="print-footer">Detecting Penguins - May 20, 2018 - Gehn</span>
    <footer>
    <hr class="slender">
    <div class="credits">
        <span>&copy; 2021
            
            Gehn
        </span></br>
            <a style="text-decoration: none;" href="/book-of-gehn/feed.xml"><img height="16px" width="16px" src="/book-of-gehn/assets/blog-assets/rss-32px.png" /></a>
        <br>
        

    
    </div>
</footer>

  </body>
</html>
