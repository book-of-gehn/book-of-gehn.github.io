<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>CBC Bitflipping</title>
  <meta name="description" content="⊕  CBC does not offer any protection against an active attacker.Flipping some bits in a ciphertext block totally scrambles itsplaintext but it has a very spe...">

  
    <link href='//fonts.googleapis.com/css?family=Lato:400,400italic' rel='stylesheet' type='text/css'>
  

  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        extensions: ["tex2jax.js"],
        jax: ["input/TeX","output/HTML-CSS"],
        tex2jax: {inlineMath: [["$$","$$"],["\\(","\\)"]]},
	TeX: {
	  Macros: {
            
	  }
	}
      });
    </script>
    
      <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js' async></script>
    
  

  
    <script
       src="https://code.jquery.com/jquery-3.4.1.min.js"
       integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
       crossorigin="anonymous"></script>
  

  

    
      <script src='https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.9.1/underscore-min.js' ></script>
    

    
      <script src="https://d3js.org/d3.v4.min.js"></script>
    

    <script src='/book-of-gehn/js/venn/venn.min.js'></script>
    <script src='/book-of-gehn/js/venn/helper.js'></script>

    <script src='/book-of-gehn/js/fix_syntax_highlight.js'></script>
  <link rel="stylesheet" type="text/css" href="/book-of-gehn/css/tufte.css">
  <link rel="stylesheet" type="text/css" href="/book-of-gehn/css/latex.css">

  <link rel="canonical" href="/book-of-gehn/articles/2018/07/03/CBC-Bitflipping.html">

  <link rel="stylesheet" type="text/css" href="/book-of-gehn/css/all.min.css">

  <link type="application/atom+xml" rel="alternate" href="/book-of-gehn/feed.xml" title="The Book of Gehn" />
</head>

  <body>
    <header>
	
		<h1 class="header-title"><a href="/book-of-gehn/">The Book of Gehn</a></h1>
		
		
	

    

    
</header>

    <article class="group">
      <h1>CBC Bitflipping</h1>
<p class="subtitle">July 3, 2018</p>

<p><label for="mf-03e66d641fdb1dcfe295e7a3a6f369fb" class="margin-toggle  in-index-only">⊕</label><input type="checkbox" id="mf-03e66d641fdb1dcfe295e7a3a6f369fb" class="margin-toggle  in-index-only" /><span class="marginnote  in-index-only"><img style="max-width:60%;" alt="CBC Dec" src="/book-of-gehn/assets/matasano/cbc-dec.png" />  <br /></span></p>

<p>CBC does not offer any protection against an active attacker.</p>

<p>Flipping some bits in a ciphertext block totally scrambles its
plaintext but it has a very specific effect in the <em>next</em> plaintext
block.</p>

<p>Without any message integrity, a CBC ciphertext can be patched
to modify the plaintext at will.<label for="mn-92c40aed2262db60522dbf16855f07d8" class="margin-toggle"> ⊕</label><input type="checkbox" id="mn-92c40aed2262db60522dbf16855f07d8" class="margin-toggle" /><span class="marginnote"><strong>– Spoiler Alert! –</strong> </span><!--more--></p>

<h3 id="warming-up">Warming up</h3>

<p>But first, let’s define a random configuration with some fixed values like
the block size or the encryption mode:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">cryptonita</span> <span class="kn">import</span> <span class="n">B</span>                <span class="c1"># byexample: +timeout=10
</span>
<span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">sys</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">"./assets/matasano"</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">challenge</span> <span class="kn">import</span> <span class="n">generate_config</span><span class="p">,</span> <span class="n">enc_cbc</span><span class="p">,</span> <span class="n">dec_cbc</span>  <span class="c1"># byexample: +timeout=10
</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">seed</span> <span class="o">=</span> <span class="mi">20180703</span>   <span class="c1"># make the tests 'random' but deterministic
</span><span class="o">&gt;&gt;&gt;</span> <span class="n">block_size</span> <span class="o">=</span> <span class="mi">16</span>     <span class="c1"># leave this fixed, it is what happen in practice
</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">cfg</span> <span class="o">=</span> <span class="n">generate_config</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="n">seed</span><span class="p">,</span> <span class="n">block_size</span><span class="o">=</span><span class="n">block_size</span><span class="p">,</span>
<span class="o">...</span>         <span class="n">enc_mode</span><span class="o">=</span><span class="s">'cbc'</span><span class="p">,</span>
<span class="o">...</span>         <span class="n">prefix</span> <span class="o">=</span> <span class="s">"comment1=cooking</span><span class="si">%20</span><span class="s">MCs;userdata="</span><span class="p">,</span>
<span class="o">...</span>         <span class="n">posfix</span> <span class="o">=</span> <span class="s">";comment2=</span><span class="si">%20</span><span class="s">like</span><span class="si">%20</span><span class="s">a</span><span class="si">%20</span><span class="s">pound</span><span class="si">%20</span><span class="s">of</span><span class="si">%20</span><span class="s">bacon"</span><span class="p">)</span>
</code></pre></div></div>

<p>Take the following toy-function to insert the user’s data (possibly
its profile) between the <code class="highlighter-rouge">cfg.prefix</code> and <code class="highlighter-rouge">cfg.posfix</code> strings
and then encrypt it:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="k">def</span> <span class="nf">add_user_data</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
<span class="o">...</span>     <span class="k">assert</span> <span class="s">';'</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">m</span> <span class="ow">and</span> <span class="s">'='</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">m</span>
<span class="o">...</span>     <span class="n">msg</span> <span class="o">=</span> <span class="n">B</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">prefix</span> <span class="o">+</span> <span class="n">m</span> <span class="o">+</span> <span class="n">cfg</span><span class="o">.</span><span class="n">posfix</span><span class="p">)</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">block_size</span><span class="p">,</span> <span class="s">'pkcs#7'</span><span class="p">)</span>
<span class="o">...</span>     <span class="k">return</span> <span class="n">enc_cbc</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">iv</span><span class="p">)</span>
</code></pre></div></div>

<p>Now imagine this quite-dumb role check function that process the
previous ciphertext: if one of the fields is <code class="highlighter-rouge">admin=true</code>
the user will be considered an Administrator:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="k">def</span> <span class="nf">is_admin</span><span class="p">(</span><span class="n">c</span><span class="p">):</span>
<span class="o">...</span>     <span class="n">msg</span> <span class="o">=</span> <span class="n">dec_cbc</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">iv</span><span class="p">)</span><span class="o">.</span><span class="n">unpad</span><span class="p">(</span><span class="s">'pkcs#7'</span><span class="p">)</span>
<span class="o">...</span>     <span class="k">return</span> <span class="n">b</span><span class="s">'admin=true'</span> <span class="ow">in</span> <span class="n">msg</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">b</span><span class="s">';'</span><span class="p">)</span>
</code></pre></div></div>

<p>We cannot add just <code class="highlighter-rouge">admin=true</code>, it would be too easy:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">add_user_data</span><span class="p">(</span><span class="s">'some;admin=true;bar'</span><span class="p">)</span>
<span class="n">Traceback</span><span class="o">&lt;...&gt;</span>
<span class="nb">AssertionError</span>
</code></pre></div></div>

<p>So the idea is to patch the ciphertext.</p>

<h2 id="bit-flipping-attack">Bit flipping attack</h2>

<p>Recall that in CBC a ciphertext block is xored with the output of the decryption
of the <em>next</em> ciphertext block to get the <em>next</em> plaintext block.</p>

<p>If we modify one ciphertext block its decryption will be totally scrambled
but we will have control of the <em>next</em> plaintext block.</p>

<figure><figcaption><span></span></figcaption><img style="max-width:60%;" alt="CBC Dec" src="/book-of-gehn/assets/matasano/cbc-dec.png" /></figure>

<p><label for="mn-780e229e9af3ba2f8bcf7333e8c79223" class="margin-toggle"> ⊕</label><input type="checkbox" id="mn-780e229e9af3ba2f8bcf7333e8c79223" class="margin-toggle" /><span class="marginnote">We don’t know if our inject plaintext
will be aligned to the block size boundary. To ensure that we inject
padding of twice the block size which warranties that at least one block
will be full with our <code class="highlighter-rouge">A</code>s </span></p>

<p>Let’s create a ciphertext with enough <code class="highlighter-rouge">A</code>s to get at least one plaintext block
full of <code class="highlighter-rouge">A</code>s</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">add_user_data</span><span class="p">(</span><span class="s">'A'</span> <span class="o">*</span> <span class="n">block_size</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">is_admin</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
<span class="bp">False</span>
</code></pre></div></div>

<p>Now we can create the patch: the plaintext that we want
xored with the plaintext that was encrypted:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">patch</span> <span class="o">=</span> <span class="n">B</span><span class="p">(</span><span class="s">';admin=true;'</span><span class="p">)</span> <span class="o">^</span> <span class="n">B</span><span class="p">(</span><span class="s">'A'</span><span class="p">)</span><span class="o">.</span><span class="n">inf</span><span class="p">()</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">patch</span> <span class="o">=</span> <span class="n">patch</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">block_size</span><span class="p">,</span> <span class="s">'zeros'</span><span class="p">)</span>
</code></pre></div></div>

<p>Finally, we apply the patch targeting the ciphertext block of the
full of <code class="highlighter-rouge">A</code>s</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">B</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">mutable</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">cblocks</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">nblocks</span><span class="p">(</span><span class="n">block_size</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">cblocks</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">^=</span> <span class="n">patch</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">is_admin</span><span class="p">(</span><span class="n">B</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
<span class="bp">True</span>
</code></pre></div></div>

<p><a href="https://cryptopals.com/sets/2/challenges/16">CBC bitflipping attacks</a>
challenge unlock!</p>



    </article>
    <span class="print-footer">CBC Bitflipping - July 3, 2018 - Gehn</span>
    <footer>
    <hr class="slender">
    <div class="credits">
        <span>&copy; 2021
            
            Gehn
        </span></br>
            <a style="text-decoration: none;" href="/book-of-gehn/feed.xml"><img height="16px" width="16px" src="/book-of-gehn/assets/blog-assets/rss-32px.png" /></a>
        <br>
        

    
    </div>
</footer>

  </body>
</html>
