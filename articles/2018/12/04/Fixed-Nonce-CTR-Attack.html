<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Fixed Nonce CTR Attack</title>
  <meta name="description" content="The Counter mode, or just CTR mode, turns a block cipher into a stream cipher.More specifically, it builds a pseudo random generator (PRG)from a block cipher...">

  
    <link href='//fonts.googleapis.com/css?family=Lato:400,400italic' rel='stylesheet' type='text/css'>
  

  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        extensions: ["tex2jax.js"],
        jax: ["input/TeX","output/HTML-CSS"],
        tex2jax: {inlineMath: [["$$","$$"],["\\(","\\)"]]},
	TeX: {
	  Macros: {
            
	  }
	}
      });
    </script>
    
      <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js' async></script>
    
  

  
    <script
       src="https://code.jquery.com/jquery-3.4.1.min.js"
       integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
       crossorigin="anonymous"></script>
  

  

    
      <script src='https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.9.1/underscore-min.js' ></script>
    

    
      <script src="https://d3js.org/d3.v4.min.js"></script>
    

    <script src='/book-of-gehn/js/venn/venn.min.js'></script>
    <script src='/book-of-gehn/js/venn/helper.js'></script>

    <script src='/book-of-gehn/js/fix_syntax_highlight.js'></script>
  <link rel="stylesheet" type="text/css" href="/book-of-gehn/css/tufte.css">
  <link rel="stylesheet" type="text/css" href="/book-of-gehn/css/latex.css">

  <link rel="canonical" href="/book-of-gehn/articles/2018/12/04/Fixed-Nonce-CTR-Attack.html">

  <link rel="stylesheet" type="text/css" href="/book-of-gehn/css/all.min.css">

  <link type="application/atom+xml" rel="alternate" href="/book-of-gehn/feed.xml" title="The Book of Gehn" />
</head>

  <body>
    <header>
	
		<h1 class="header-title"><a href="/book-of-gehn/">The Book of Gehn</a></h1>
		
		
	

    

    
</header>

    <article class="group">
      <h1>Fixed Nonce CTR Attack</h1>
<p class="subtitle">December 4, 2018</p>

<p>The Counter mode, or just CTR mode, turns a block cipher into a stream cipher.</p>

<p>More specifically, it builds a pseudo random generator (PRG)
from a block cipher and then generates a random string using
the PRG to encrypt/decrypt the payload performing a simple xor.</p>

<p>The idea is to initialize the PRG with a different <em>seed</em> each time
but if this does not happen, all the plaintexts will be encrypted
with the <em>same</em> pseudo random key stream – totally insecure.</p>

<p>Ready to break it?<label for="mn-92c40aed2262db60522dbf16855f07d8" class="margin-toggle"> ⊕</label><input type="checkbox" id="mn-92c40aed2262db60522dbf16855f07d8" class="margin-toggle" /><span class="marginnote"><strong>– Spoiler Alert! –</strong> </span><!--more--></p>

<h2 id="warming-up">Warming up</h2>

<p><label for="mn-3df421617783be9cdc50680bb6447518" class="margin-toggle"> ⊕</label><input type="checkbox" id="mn-3df421617783be9cdc50680bb6447518" class="margin-toggle" /><span class="marginnote"><a href="https://cryptopals.com/sets/3/challenges/18">Implement CTR, the stream cipher mode</a> </span></p>

<p>Let’s implement a CTR</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">cryptonita</span> <span class="kn">import</span> <span class="n">B</span><span class="p">,</span> <span class="n">load_bytes</span>     <span class="c1"># byexample: +timeout=10
</span>
<span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">sys</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">"./assets/matasano"</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">challenge</span> <span class="kn">import</span> <span class="n">generate_config</span><span class="p">,</span> <span class="n">enc_ctr</span><span class="p">,</span> <span class="n">dec_ctr</span>  <span class="c1"># byexample: +timeout=10
</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">seed</span> <span class="o">=</span> <span class="mi">20181204</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">bsize</span> <span class="o">=</span> <span class="mi">16</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">cfg</span> <span class="o">=</span> <span class="n">generate_config</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="n">seed</span><span class="p">,</span> <span class="n">block_size</span><span class="o">=</span><span class="n">bsize</span><span class="p">,</span>
<span class="o">...</span>                       <span class="n">nonce</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">B</span><span class="p">(</span><span class="s">'YELLOW SUBMARINE'</span><span class="p">))</span>
</code></pre></div></div>

<p>Now let’s check that our AES cipher in Counter mode works</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">ciphertext</span> <span class="o">=</span> <span class="n">B</span><span class="p">(</span><span class="s">'L77na/nrFsKvynd6HzOoG7GHTLXsTVu9qvY/2syLXzhPweyyMTJULu/6/kXX0KSvoOLSFQ=='</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="mi">64</span><span class="p">)</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">dec_ctr</span><span class="p">(</span><span class="n">ciphertext</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">nonce</span><span class="p">)</span>
<span class="s">"Yo, VIP Let's kick it Ice, Ice, baby Ice, Ice, baby "</span>
</code></pre></div></div>

<h2 id="break-fixed-nonce-ctr">Break fixed-nonce CTR</h2>

<p>If the nonce is fixed, then several <em>independent</em> ciphertext
will be encrypted with the same key stream.</p>

<p>Let’s load some plaintexts and let’s encrypt them in that way
and see if we can break the encryption.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">cryptonita.conv</span> <span class="kn">import</span> <span class="n">transpose</span><span class="p">,</span> <span class="n">uniform_length</span>    <span class="c1"># byexample: +timeout=10
</span><span class="o">&gt;&gt;&gt;</span> <span class="n">plaintexts</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">load_bytes</span><span class="p">(</span><span class="s">'./assets/matasano/20.txt'</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="mi">64</span><span class="p">))</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">ciphertexts</span> <span class="o">=</span> <span class="p">[</span><span class="n">enc_ctr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">nonce</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">plaintexts</span><span class="p">]</span>
</code></pre></div></div>

<p>The vulnerability resides in reusing the nonce.</p>

<p>With the same nonce, CTR generates the same random sequence that
uses to xor the payload.</p>

<p>In other words, it performs a xor <em>reusing</em> the key stream and
we already know how to
<a href="/book-of-gehn/articles/2018/03/01/In-XOR-We-Trust.html">break a repeating xor key cipher</a>.</p>

<p>But first, not all the ciphertexts are of the same length so to simplify we need
to uniform their lengths.</p>

<p>For example, we could truncate all the ciphertexts to the length of the smallest.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">tciphertexts</span> <span class="o">=</span> <span class="n">uniform_length</span><span class="p">(</span><span class="n">ciphertexts</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">tplaintexts</span> <span class="o">=</span> <span class="n">uniform_length</span><span class="p">(</span><span class="n">plaintexts</span><span class="p">)</span>
</code></pre></div></div>

<p>Now, because the repeating key is along the column axis (eg, the first byte of
all the plaintexts were xored with the same key byte), it is more
convenient to <em>transpose</em> them.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">tciphertexts_transposed</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">(</span><span class="n">tciphertexts</span><span class="p">)</span>

<span class="o">&gt;&gt;&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">tciphertexts_transposed</span><span class="p">)</span>    <span class="c1"># rows
</span><span class="mi">53</span>

<span class="o">&gt;&gt;&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">tciphertexts_transposed</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="c1"># columns
</span><span class="mi">60</span>
</code></pre></div></div>

<h3 id="plaintext-statistic-model">Plaintext statistic model</h3>

<p>To perform a frequency attack we need the most common letters of
the plaintext.</p>

<p>Given an English text, these are the classical
<a href="https://en.wikipedia.org/wiki/Etaoin_shrdlu">ETAOIN-SHRDLU</a>.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">cryptonita.scoring.freq</span> <span class="kn">import</span> <span class="n">etaoin_shrdlu</span>
</code></pre></div></div>

<p>But consider the first byte of all the plaintexts.</p>

<p>If they are the
begin of a sentence it is very likely that they are in uppercase and
the first letter of a word <strong>may not</strong> (and will not) follow the ETAOIN-SHRDLU
frequency.</p>

<p>Therefor we need <em>another</em> statistical model, one for the upper case:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">cryptonita.scoring.freq</span> <span class="kn">import</span> <span class="n">tsamcin_brped</span>
</code></pre></div></div>

<h3 id="score-a-decryption-using-chi-square-test">Score a decryption using Chi-square test</h3>

<p>The frequency attack (<code class="highlighter-rouge">freq_attack</code>) implemented in
<a href="https://pypi.org/project/cryptonita/">cryptonita</a>
returns a guess: a set of possible key bytes.</p>

<p>To narrow this down we try each one (brute force) and
score each potential plaintext.</p>

<p>For this we take the frequency of the letters in the plaintext
and compare them with the expected frequency using a
<a href="https://en.wikipedia.org/wiki/Chi-squared_test">Chi-square test</a>.</p>

<p>In <a href="https://pypi.org/project/cryptonita/">cryptonita</a>, this
is implemented in the <code class="highlighter-rouge">fit_freq_score</code> function:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">cryptonita.scoring</span> <span class="kn">import</span> <span class="n">fit_freq_score</span>
</code></pre></div></div>

<p>But <code class="highlighter-rouge">fit_freq_score</code> can be a little drastic; if the brute force
yields none key we roll back and score using a more relaxed score function:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">cryptonita.scoring</span> <span class="kn">import</span> <span class="n">all_ascii_printable</span>
</code></pre></div></div>

<h3 id="guess-the-ctr-key-stream">Guess the CTR key stream</h3>

<p>Mixing all this together:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">cryptonita.attacks</span> <span class="kn">import</span> <span class="n">brute_force</span><span class="p">,</span> <span class="n">freq_attack</span>
<span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">guesses</span> <span class="o">=</span> <span class="p">[]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tciphertexts_transposed</span><span class="p">):</span>
<span class="o">...</span>     <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># first letter, use a special statistical model
</span><span class="o">...</span>         <span class="n">most_common</span> <span class="o">=</span> <span class="n">etaoin_shrdlu</span><span class="p">()</span> <span class="o">|</span> <span class="n">tsamcin_brped</span><span class="p">()</span>
<span class="o">...</span>     <span class="k">else</span><span class="p">:</span>
<span class="o">...</span>         <span class="n">most_common</span> <span class="o">=</span> <span class="n">etaoin_shrdlu</span><span class="p">()</span>
<span class="o">...</span>
<span class="o">...</span>     <span class="n">byte_guess</span> <span class="o">=</span> <span class="n">freq_attack</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">most_common</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="o">...</span>     <span class="n">g</span> <span class="o">=</span> <span class="n">brute_force</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">partial</span><span class="p">(</span><span class="n">fit_freq_score</span><span class="p">,</span> <span class="n">expected_prob</span><span class="o">=</span><span class="n">most_common</span><span class="p">),</span> <span class="n">byte_guess</span><span class="p">)</span>
<span class="o">...</span>     <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="p">:</span>   <span class="c1"># fit_freq_score was too hard, rollback to a more soft score func
</span><span class="o">...</span>         <span class="n">g</span> <span class="o">=</span> <span class="n">brute_force</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">all_ascii_printable</span><span class="p">,</span> <span class="n">byte_guess</span><span class="p">)</span>
<span class="o">...</span>
<span class="o">...</span>     <span class="n">byte_guess</span> <span class="o">=</span> <span class="n">g</span>
<span class="o">...</span>     <span class="n">guesses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">byte_guess</span><span class="p">)</span>
</code></pre></div></div>

<p>Let’s peek how large is our key stream (determined by how we cut the
ciphertexts with <code class="highlighter-rouge">uniform_length</code>) and how many different keys we
have (we are still guessing so there is not one single answer yet)</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">klength</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">guesses</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">klength</span>
<span class="mi">53</span>

<span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">cryptonita.fuzzy_set</span> <span class="kn">import</span> <span class="n">len_join_fuzzy_sets</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">len_join_fuzzy_sets</span><span class="p">(</span><span class="n">guesses</span><span class="p">)</span>
<span class="mi">10985</span>
</code></pre></div></div>

<h3 id="correct-the-key-stream">Correct the key stream</h3>

<p>Let’s build the key stream (still a guess):</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">cryptonita.fuzzy_set</span> <span class="kn">import</span> <span class="n">join_fuzzy_sets</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">kstream_guess</span> <span class="o">=</span> <span class="n">join_fuzzy_sets</span><span class="p">(</span><span class="n">guesses</span><span class="p">,</span> <span class="n">cut_off</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">j</span><span class="o">=</span><span class="n">B</span><span class="p">(</span><span class="s">''</span><span class="p">))</span>
</code></pre></div></div>

<p>Now, we take the most likely of our guesses:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">kstream</span> <span class="o">=</span> <span class="n">kstream_guess</span><span class="o">.</span><span class="n">most_likely</span><span class="p">()</span>
</code></pre></div></div>

<p>However this is not enough. This key stream is not the correct one:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">tplaintexts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">tciphertexts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">^</span> <span class="n">kstream</span>
<span class="bp">False</span>
</code></pre></div></div>

<p>But we are <em>very close</em>:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="nb">sum</span><span class="p">(</span><span class="n">p</span> <span class="o">==</span> <span class="n">q</span> <span class="k">for</span> <span class="n">p</span><span class="p">,</span> <span class="n">q</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">tplaintexts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">tciphertexts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">^</span> <span class="n">kstream</span><span class="p">))</span> <span class="o">/</span> <span class="n">klength</span>
<span class="mf">0.9811</span><span class="o">&lt;...&gt;</span>
</code></pre></div></div>

<p>So our current key stream is <em>almost</em> correct, only a few bytes need
to be tweaked.</p>

<p>Some possible next steps:</p>

<ul>
  <li>Use <code class="highlighter-rouge">etaoin_shrdlu</code> to correct them? No really. We used this to build
the initial key stream so it is unlikely that we can fix the key stream
using this or any other model at the <em>character level</em>.</li>
  <li>Then use a bigram model? Much better but a bigram model uses only two
characters and may not be robust enough. Worst, we are working with a very
short plaintexts/ciphertexts (~50 characters) and this is too short for
a bigram model (the model is too sparse and mostly flat so it will be hard
to draw any conclusion.</li>
  <li>So, what about some a more <em>specific</em> model? Bingo!</li>
</ul>

<p>With a more specific model we can get more info from the short sequences
but this requires to know much about the plaintext.</p>

<p>If we assume that most of the plaintext is built from English words
then we could use a <em>spell checker</em> to correct any misspelled word
product of a incorrect key.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">aspell</span>
<span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">cryptonita.suggesters</span> <span class="kn">import</span> <span class="n">good_written_word_suggester</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">gword_suggester</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">good_written_word_suggester</span><span class="p">,</span> <span class="n">speller</span><span class="o">=</span><span class="n">aspell</span><span class="o">.</span><span class="n">Speller</span><span class="p">())</span>
</code></pre></div></div>

<p>With this <em>suggester</em> we can try to <em>correct</em> the key:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">cryptonita.attacks</span> <span class="kn">import</span> <span class="n">correct_key</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">correct_key</span><span class="p">(</span><span class="n">kstream</span><span class="p">,</span> <span class="n">ciphertexts</span><span class="p">,</span> <span class="n">gword_suggester</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">correction</span> <span class="o">=</span> <span class="n">B</span><span class="p">(</span><span class="s">''</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">most_likely</span><span class="p">()</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">tmp</span><span class="p">)</span>
</code></pre></div></div>

<p>The <code class="highlighter-rouge">correct_key</code> method works like <code class="highlighter-rouge">brute_force</code> but from another
point of view.</p>

<p><code class="highlighter-rouge">brute_force</code> tries each possible key, decrypting the same ciphertext
and then scoring each decryption independently.</p>

<p><code class="highlighter-rouge">correct_key</code>, instead, try the same key to decrypt several different
ciphertexts and try to get the most likely corrections that improve
all the decryption (it does not score independently).</p>

<p>Okay, how well was our correction? How many bytes did we correct?
And how the decrypted texts looks like?</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="nb">len</span><span class="p">([</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">correction</span> <span class="k">if</span> <span class="n">c</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">])</span>
<span class="mi">1</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">tciphertexts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">^</span> <span class="n">kstream</span>
<span class="s">':</span><span class="se">\'</span><span class="s">m rated "R"...this is a warning, ya better void / P'</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">tciphertexts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">^</span> <span class="n">kstream</span> <span class="o">^</span> <span class="n">correction</span>
<span class="s">'i</span><span class="se">\'</span><span class="s">m rated "R"...this is a warning, ya better void / P'</span>
</code></pre></div></div>

<p>So we got the correct key stream? Well, we didn’t:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">tplaintexts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="s">'I</span><span class="se">\'</span><span class="s">m rated "R"...this is a warning, ya better void / P'</span>
</code></pre></div></div>

<h3 id="undistinguishable">Undistinguishable</h3>

<p>Unless we have more knowledge about the plaintexts, we cannot distinguish
between <code class="highlighter-rouge">i'm rated</code> and <code class="highlighter-rouge">I'm rated</code>. <code class="highlighter-rouge">:´|</code></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">fix</span> <span class="o">=</span> <span class="n">B</span><span class="p">(</span><span class="n">b</span><span class="s">'i'</span><span class="p">)</span> <span class="o">^</span> <span class="n">B</span><span class="p">(</span><span class="n">b</span><span class="s">'I'</span><span class="p">)</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">kstream</span> <span class="o">=</span> <span class="n">kstream</span> <span class="o">^</span> <span class="n">correction</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">kstream</span> <span class="o">=</span> <span class="p">(</span><span class="n">kstream</span><span class="p">[:</span><span class="mi">1</span><span class="p">]</span> <span class="o">^</span> <span class="n">fix</span><span class="p">)</span> <span class="o">+</span> <span class="n">kstream</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
</code></pre></div></div>

<p><label for="mn-335529b88e6850e165cbd17f88eb1437" class="margin-toggle"> ⊕</label><input type="checkbox" id="mn-335529b88e6850e165cbd17f88eb1437" class="margin-toggle" /><span class="marginnote"><a href="https://cryptopals.com/sets/3/challenges/20">Break fixed-nonce CTR statistically</a> </span></p>

<p>And we are done!</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="nb">all</span><span class="p">(</span><span class="n">p</span> <span class="o">==</span> <span class="n">c</span> <span class="o">^</span> <span class="n">kstream</span> <span class="k">for</span> <span class="n">p</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">tplaintexts</span><span class="p">,</span> <span class="n">tciphertexts</span><span class="p">))</span>
<span class="bp">True</span>

<span class="o">&gt;&gt;&gt;</span> <span class="p">[(</span><span class="n">c</span> <span class="o">^</span> <span class="n">kstream</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">tciphertexts</span><span class="p">]</span>
<span class="p">[</span><span class="s">'I</span><span class="se">\'</span><span class="s">m rated "R"...this is a warning, ya better void / P'</span><span class="p">,</span>
 <span class="s">'Cuz I came back to attack others in spite- / Strike l'</span><span class="p">,</span>
 <span class="s">"But don't be afraid in the dark, in a park / Not a sc"</span><span class="p">,</span>
 <span class="s">'Ya tremble like a alcoholic, muscles tighten up / Wha'</span><span class="p">,</span>
 <span class="s">'Suddenly you feel like your in a horror flick / You g'</span><span class="p">,</span>
 <span class="s">"Music's the clue, when I come your warned / Apocalyps"</span><span class="p">,</span>
 <span class="s">"Haven't you ever heard of a MC-murderer? / This is th"</span><span class="p">,</span>
 <span class="s">'Death wish, so come on, step to this / Hysterical ide'</span><span class="p">,</span>
 <span class="s">'Friday the thirteenth, walking down Elm Street / You '</span><span class="p">,</span>
 <span class="s">'This is off limits, so your visions are blurry / All '</span><span class="p">,</span>
 <span class="s">"Terror in the styles, never error-files / Indeed I'm "</span><span class="p">,</span>
 <span class="s">'For those that oppose to be level or next to this / I'</span><span class="p">,</span>
 <span class="s">"Worse than a nightmare, you don't have to sleep a win"</span><span class="p">,</span>
 <span class="s">'Flashbacks interfere, ya start to hear: / The R-A-K-I'</span><span class="p">,</span>
 <span class="s">'Then the beat is hysterical / That makes Eric go get '</span><span class="p">,</span>
 <span class="s">'Soon the lyrical format is superior / Faces of death '</span><span class="p">,</span>
 <span class="s">"MC's decaying, cuz they never stayed / The scene of a"</span><span class="p">,</span>
 <span class="s">"The fiend of a rhyme on the mic that you know / It's "</span><span class="p">,</span>
 <span class="s">'Melodies-unmakable, pattern-unescapable / A horn if w'</span><span class="p">,</span>
 <span class="s">'I bless the child, the earth, the gods and bomb the r'</span><span class="p">,</span>
 <span class="s">'Hazardous to your health so be friendly / A matter of'</span><span class="p">,</span>
 <span class="s">"Shake 'till your clear, make it disappear, make the n"</span><span class="p">,</span>
 <span class="s">"If not, my soul'll release! / The scene is recreated,"</span><span class="p">,</span>
 <span class="s">'Cuz your about to see a disastrous sight / A performa'</span><span class="p">,</span>
 <span class="s">'Lyrics of fury! A fearified freestyle! / The "R" is i'</span><span class="p">,</span>
 <span class="s">"Make sure the system's loud when I mention / Phrases "</span><span class="p">,</span>
 <span class="s">'You want to hear some sounds that not only pounds but'</span><span class="p">,</span>
 <span class="s">'Then nonchalantly tell you what it mean to me / Stric'</span><span class="p">,</span>
 <span class="s">"And I don't care if the whole crowd's a witness! / I'"</span><span class="p">,</span>
 <span class="s">'Program into the speed of the rhyme, prepare to start'</span><span class="p">,</span>
 <span class="s">"Musical madness MC ever made, see it's / Now an emerg"</span><span class="p">,</span>
 <span class="s">"Open your mind, you will find every word'll be / Furi"</span><span class="p">,</span>
 <span class="s">"Battle's tempting...whatever suits ya! / For words th"</span><span class="p">,</span>
 <span class="s">"You think you're ruffer, then suffer the consequences"</span><span class="p">,</span>
 <span class="s">'I wake ya with hundreds of thousands of volts / Mic-t'</span><span class="p">,</span>
 <span class="s">'Novocain ease the pain it might save him / If not, Er'</span><span class="p">,</span>
 <span class="s">"Yo Rakim, what's up? / Yo, I'm doing the knowledge, E"</span><span class="p">,</span>
 <span class="s">'Well, check this out, since Norby Walters is our agen'</span><span class="p">,</span>
 <span class="s">'Kara Lewis is our agent, word up / Zakia and 4th and '</span><span class="p">,</span>
 <span class="s">"Okay, so who we rollin' with then? We rollin' with Ru"</span><span class="p">,</span>
 <span class="s">'Check this out, since we talking over / This def beat'</span><span class="p">,</span>
 <span class="s">'I wanna hear some of them def rhymes, you know what I'</span><span class="p">,</span>
 <span class="s">"Thinkin' of a master plan / 'Cuz ain't nuthin' but sw"</span><span class="p">,</span>
 <span class="s">'So I dig into my pocket, all my money is spent / So I'</span><span class="p">,</span>
 <span class="s">"So I start my mission, leave my residence / Thinkin' "</span><span class="p">,</span>
 <span class="s">'I need money, I used to be a stick-up kid / So I thin'</span><span class="p">,</span>
 <span class="s">"I used to roll up, this is a hold up, ain't nuthin' f"</span><span class="p">,</span>
 <span class="s">"But now I learned to earn 'cuz I'm righteous / I feel"</span><span class="p">,</span>
 <span class="s">'Search for a nine to five, if I strive / Then maybe I'</span><span class="p">,</span>
 <span class="s">"So I walk up the street whistlin' this / Feelin' out "</span><span class="p">,</span>
 <span class="s">'A pen and a paper, a stereo, a tape of / Me and Eric '</span><span class="p">,</span>
 <span class="s">'Fish, which is my favorite dish / But without no mone'</span><span class="p">,</span>
 <span class="s">"'Cuz I don't like to dream about gettin' paid / So I "</span><span class="p">,</span>
 <span class="s">'So now to test to see if I got pull / Hit the studio,'</span><span class="p">,</span>
 <span class="s">'Rakim, check this out, yo / You go to your girl house'</span><span class="p">,</span>
 <span class="s">"'Cause my girl is definitely mad / 'Cause it took us "</span><span class="p">,</span>
 <span class="s">"Yo, I hear what you're saying / So let's just pump th"</span><span class="p">,</span>
 <span class="s">'And count our money / Yo, well check this out, yo Eli'</span><span class="p">,</span>
 <span class="s">'Turn down the bass down / And let the beat just keep '</span><span class="p">,</span>
 <span class="s">'And we outta here / Yo, what happened to peace? / Pea'</span><span class="p">]</span>
</code></pre></div></div>

<h2 id="break-fixed-nonce-ctr---second-chance">Break fixed-nonce CTR - Second chance</h2>

<p><label for="mn-5247cc03b20e15bdb6c97b1fe5ff8567" class="margin-toggle"> ⊕</label><input type="checkbox" id="mn-5247cc03b20e15bdb6c97b1fe5ff8567" class="margin-toggle" /><span class="marginnote"><a href="https://cryptopals.com/sets/3/challenges/19">Break fixed-nonce CTR mode using substitutions</a> </span></p>

<p>Let’s take another set of plaintexts,
encrypt them with a fixed-nonce CTR and break the encryption.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">plaintexts</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">load_bytes</span><span class="p">(</span><span class="s">'./assets/matasano/19.txt'</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="mi">64</span><span class="p">))</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">ciphertexts</span> <span class="o">=</span> <span class="p">[</span><span class="n">enc_ctr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">nonce</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">plaintexts</span><span class="p">]</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">tplaintexts</span> <span class="o">=</span> <span class="n">uniform_length</span><span class="p">(</span><span class="n">plaintexts</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">tciphertexts</span> <span class="o">=</span> <span class="n">uniform_length</span><span class="p">(</span><span class="n">ciphertexts</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">tciphertexts_transposed</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">(</span><span class="n">tciphertexts</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">guesses</span> <span class="o">=</span> <span class="p">[]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tciphertexts_transposed</span><span class="p">):</span>
<span class="o">...</span>     <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># first letter, use a special statistical model
</span><span class="o">...</span>         <span class="n">most_common</span> <span class="o">=</span> <span class="n">etaoin_shrdlu</span><span class="p">()</span> <span class="o">|</span> <span class="n">tsamcin_brped</span><span class="p">()</span>
<span class="o">...</span>     <span class="k">else</span><span class="p">:</span>
<span class="o">...</span>         <span class="n">most_common</span> <span class="o">=</span> <span class="n">etaoin_shrdlu</span><span class="p">()</span>
<span class="o">...</span>
<span class="o">...</span>     <span class="n">byte_guess</span> <span class="o">=</span> <span class="n">freq_attack</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">most_common</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="o">...</span>     <span class="n">g</span> <span class="o">=</span> <span class="n">brute_force</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">partial</span><span class="p">(</span><span class="n">fit_freq_score</span><span class="p">,</span> <span class="n">expected_prob</span><span class="o">=</span><span class="n">most_common</span><span class="p">),</span> <span class="n">byte_guess</span><span class="p">)</span>
<span class="o">...</span>     <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="p">:</span>   <span class="c1"># fit_freq_score was too hard, rollback to a more soft score func
</span><span class="o">...</span>         <span class="n">g</span> <span class="o">=</span> <span class="n">brute_force</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">all_ascii_printable</span><span class="p">,</span> <span class="n">byte_guess</span><span class="p">)</span>
<span class="o">...</span>
<span class="o">...</span>     <span class="n">byte_guess</span> <span class="o">=</span> <span class="n">g</span>
<span class="o">...</span>     <span class="n">guesses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">byte_guess</span><span class="p">)</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">klength</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">guesses</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">klength</span>
<span class="mi">20</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">len_join_fuzzy_sets</span><span class="p">(</span><span class="n">guesses</span><span class="p">)</span>
<span class="mi">23712</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">kstream_guess</span> <span class="o">=</span> <span class="n">join_fuzzy_sets</span><span class="p">(</span><span class="n">guesses</span><span class="p">,</span> <span class="n">cut_off</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">j</span><span class="o">=</span><span class="n">B</span><span class="p">(</span><span class="s">''</span><span class="p">))</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">kstream</span> <span class="o">=</span> <span class="n">kstream_guess</span><span class="o">.</span><span class="n">most_likely</span><span class="p">()</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">tciphertexts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">^</span> <span class="n">kstream</span>
<span class="s">'7*ming {ith vivid fa'</span>
</code></pre></div></div>

<p>Quite close. By manual inspection the correct plaintext should be
<code class="highlighter-rouge">Coming with vivid fa</code>.</p>

<p>With a <em>known plaintext</em> breaking the rest of the key bytes is trivial:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">correction</span> <span class="o">=</span> <span class="n">tciphertexts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">^</span> <span class="n">kstream</span> <span class="o">^</span> <span class="n">B</span><span class="p">(</span><span class="n">b</span><span class="s">'Coming with vivid fa'</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">kstream</span> <span class="o">=</span> <span class="n">kstream</span> <span class="o">^</span> <span class="n">correction</span>

<span class="o">&gt;&gt;&gt;</span> <span class="nb">all</span><span class="p">(</span><span class="n">p</span> <span class="o">==</span> <span class="n">c</span> <span class="o">^</span> <span class="n">kstream</span> <span class="k">for</span> <span class="n">p</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">tplaintexts</span><span class="p">,</span> <span class="n">tciphertexts</span><span class="p">))</span>
<span class="bp">True</span>

<span class="o">&gt;&gt;&gt;</span> <span class="p">[(</span><span class="n">c</span> <span class="o">^</span> <span class="n">kstream</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">tciphertexts</span><span class="p">]</span>
<span class="p">[</span><span class="s">'I have met them at c'</span><span class="p">,</span>
 <span class="s">'Coming with vivid fa'</span><span class="p">,</span>
 <span class="s">'From counter or desk'</span><span class="p">,</span>
 <span class="s">'Eighteenth-century h'</span><span class="p">,</span>
 <span class="s">'I have passed with a'</span><span class="p">,</span>
 <span class="s">'Or polite meaningles'</span><span class="p">,</span>
 <span class="s">'Or have lingered awh'</span><span class="p">,</span>
 <span class="s">'Polite meaningless w'</span><span class="p">,</span>
 <span class="s">'And thought before I'</span><span class="p">,</span>
 <span class="s">'Of a mocking tale or'</span><span class="p">,</span>
 <span class="s">'To please a companio'</span><span class="p">,</span>
 <span class="s">'Around the fire at t'</span><span class="p">,</span>
 <span class="s">'Being certain that t'</span><span class="p">,</span>
 <span class="s">'But lived where motl'</span><span class="p">,</span>
 <span class="s">'All changed, changed'</span><span class="p">,</span>
 <span class="s">'A terrible beauty is'</span><span class="p">,</span>
 <span class="s">"That woman's days we"</span><span class="p">,</span>
 <span class="s">'In ignorant good wil'</span><span class="p">,</span>
 <span class="s">'Her nights in argume'</span><span class="p">,</span>
 <span class="s">'Until her voice grew'</span><span class="p">,</span>
 <span class="s">'What voice more swee'</span><span class="p">,</span>
 <span class="s">'When young and beaut'</span><span class="p">,</span>
 <span class="s">'She rode to harriers'</span><span class="p">,</span>
 <span class="s">'This man had kept a '</span><span class="p">,</span>
 <span class="s">'And rode our winged '</span><span class="p">,</span>
 <span class="s">'This other his helpe'</span><span class="p">,</span>
 <span class="s">'Was coming into his '</span><span class="p">,</span>
 <span class="s">'He might have won fa'</span><span class="p">,</span>
 <span class="s">'So sensitive his nat'</span><span class="p">,</span>
 <span class="s">'So daring and sweet '</span><span class="p">,</span>
 <span class="s">'This other man I had'</span><span class="p">,</span>
 <span class="s">'A drunken, vain-glor'</span><span class="p">,</span>
 <span class="s">'He had done most bit'</span><span class="p">,</span>
 <span class="s">'To some who are near'</span><span class="p">,</span>
 <span class="s">'Yet I number him in '</span><span class="p">,</span>
 <span class="s">'He, too, has resigne'</span><span class="p">,</span>
 <span class="s">'In the casual comedy'</span><span class="p">,</span>
 <span class="s">'He, too, has been ch'</span><span class="p">,</span>
 <span class="s">'Transformed utterly:'</span><span class="p">,</span>
 <span class="s">'A terrible beauty is'</span><span class="p">]</span>
</code></pre></div></div>

<h2 id="final-thoughts">Final thoughts</h2>

<p><code class="highlighter-rouge">ETAOIN SHRDLU</code> is a statistical model for letter frequency in English
and it was used to break most of the key stream bytes but its strength
depends exclusively in how well the model represents the underlying plaintext.</p>

<p>For the case of the first letter of all the plaintexts it was upper case and
the <code class="highlighter-rouge">ETAOIN SHRDLU</code> model didn’t work and it was extended later.</p>

<p>Once that we have a guess, filter them out requires more knowledge about the
plaintext.</p>

<p>Requiring to be the decrypted text plain ASCII is simple but too open;
requiring to follow the English statistical model using a Chi-square
test (<code class="highlighter-rouge">fit_freq_score</code>) is stricter.</p>

<p>However, like before, the statistical model only applies for long
sequences (samples) and only if the underlying plaintexts are what
one could expect.</p>

<p>A <em>liberal</em> scoring function like <code class="highlighter-rouge">all_ascii_printable</code> serves
as a backup and it is better than nothing.</p>

<p>Even with all of this, the most likely key stream guess may not be
the correct one, inclusive, none of the key stream guesses may be the
correct one!</p>

<p>Correcting a key stream using more information about the plaintext
like using a speller can narrow the search area further but there is no
warranties.</p>

<p>Sometimes you will need to relay in your own brain and do a manual fix.</p>



    </article>
    <span class="print-footer">Fixed Nonce CTR Attack - December 4, 2018 - Gehn</span>
    <footer>
    <hr class="slender">
    <div class="credits">
        <span>&copy; 2021
            
            Gehn
        </span></br>
            <a style="text-decoration: none;" href="/book-of-gehn/feed.xml"><img height="16px" width="16px" src="/book-of-gehn/assets/blog-assets/rss-32px.png" /></a>
        <br>
        

    
    </div>
</footer>

  </body>
</html>
