<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>QEMUlating a Rasbian (ARM)</title>
  <meta name="description" content="Quick how-to download and run a Raspbian Buster (ARM) emulatingthe vm with QEMU.">

  
    <link href='//fonts.googleapis.com/css?family=Lato:400,400italic' rel='stylesheet' type='text/css'>
  

  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        extensions: ["tex2jax.js"],
        jax: ["input/TeX","output/HTML-CSS"],
        tex2jax: {inlineMath: [["$$","$$"],["\\(","\\)"]]},
	TeX: {
	  Macros: {
            
	  }
	}
      });
    </script>
    
      <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js' async></script>
    
  

  
    <script
       src="https://code.jquery.com/jquery-3.4.1.min.js"
       integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
       crossorigin="anonymous"></script>
  

  

    
      <script src='https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.9.1/underscore-min.js' ></script>
    

    
      <script src="https://d3js.org/d3.v4.min.js"></script>
    

    <script src='/book-of-gehn/js/venn/venn.min.js'></script>
    <script src='/book-of-gehn/js/venn/helper.js'></script>

    <script src='/book-of-gehn/js/fix_syntax_highlight.js'></script>
  <link rel="stylesheet" type="text/css" href="/book-of-gehn/css/tufte.css">
  <link rel="stylesheet" type="text/css" href="/book-of-gehn/css/latex.css">

  <link rel="canonical" href="/book-of-gehn/articles/2020/12/15/Qemulating-Rasbian-ARM.html">

  <link rel="stylesheet" type="text/css" href="/book-of-gehn/css/all.min.css">

  <link type="application/atom+xml" rel="alternate" href="/book-of-gehn/feed.xml" title="The Book of Gehn" />
</head>

  <body>
    <header>
	
		<h1 class="header-title"><a href="/book-of-gehn/">The Book of Gehn</a></h1>
		
		
	

    

    
</header>

    <article class="group">
      <h1>QEMUlating a Rasbian (ARM)</h1>
<p class="subtitle">December 15, 2020</p>

<p>Quick how-to download and run a Raspbian Buster (ARM) emulating
the vm with QEMU.<!--more--></p>

<ul>
  <li>Download <a href="https://downloads.raspberrypi.org/raspios_lite_armhf/images/raspios_lite_armhf-2020-12-04/">Raspbian lite image (Buster)</a></li>
  <li>Download <a href="https://github.com/dhruvvyas90/qemu-rpi-kernel">kernel image</a> for
Raspbian (<code class="highlighter-rouge">kernel-qemu-*-buster</code>) and the <em>dtb</em> file for that kernel
(<code class="highlighter-rouge">versatile-pb-buster-*.dtb</code>)</li>
  <li>Install QEMU: <code class="highlighter-rouge">apt-get install qemu-system</code></li>
</ul>

<h2 id="preparing-the-image">Preparing the image</h2>

<p>Unpack and check the disk file.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>unzip 2020-12-02-raspios-buster-armhf-lite.zip
Archive:  2020-12-02-raspios-buster-armhf-lite.zip
  inflating: 2020-12-02-raspios-buster-armhf-lite.img

<span class="nv">$ </span><span class="nb">sudo </span>fdisk <span class="nt">-l</span> 2020-12-02-raspios-buster-armhf-lite.img
Disk 2020-12-02-raspios-buster-armhf-lite.img: 1.7 GiB, 1858076672 bytes, 3629056 sectors
Units: sectors of 1 <span class="k">*</span> 512 <span class="o">=</span> 512 bytes
Sector size <span class="o">(</span>logical/physical<span class="o">)</span>: 512 bytes / 512 bytes
I/O size <span class="o">(</span>minimum/optimal<span class="o">)</span>: 512 bytes / 512 bytes
Disklabel <span class="nb">type</span>: dos
Disk identifier: 0x067e19d7

Device                                    Boot  Start     End Sectors Size Id Type
2020-12-02-raspios-buster-armhf-lite.img1        8192  532479  524288 256M  c W95 FAT32 <span class="o">(</span>LBA<span class="o">)</span>
2020-12-02-raspios-buster-armhf-lite.img2      532480 3629055 3096576 1.5G 83 Linux
</code></pre></div></div>

<p>Mount the second partition. Because the file has 2 partitions, we need
to set the offset where the second starts: the start sector number
multiplied by the size of each sector in bytes.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>mount <span class="nt">-v</span> <span class="nt">-o</span> <span class="nv">offset</span><span class="o">=</span><span class="k">$((</span><span class="m">532480</span> <span class="o">*</span> <span class="m">512</span><span class="k">))</span> <span class="nt">-t</span> ext4 2020-12-02-raspios-buster-armhf-lite.img ~/mnt
</code></pre></div></div>

<p><label for="mn-041d94432f6bed87af4cb4909d1213cf" class="margin-toggle"> ⊕</label><input type="checkbox" id="mn-041d94432f6bed87af4cb4909d1213cf" class="margin-toggle" /><span class="marginnote">Why we need to do this? No idea. May be is related with
<a href="https://stackoverflow.com/questions/45253755/why-is-the-stack-segment-executable-on-raspberry-pi">this</a>
 </span></p>

<p>Comment out any entry of <code class="highlighter-rouge">ld.so.preload</code> adding a <code class="highlighter-rouge">#</code> at the begin of
each line.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">cat</span> ~/mnt/etc/ld.so.preload
/usr/lib/arm-linux-gnueabihf/libarmmem-<span class="k">${</span><span class="nv">PLATFORM</span><span class="k">}</span>.so

<span class="nv">$ </span><span class="nb">sudo sed</span> <span class="nt">-i</span> <span class="s1">'s/^.*$/#\0/'</span> ~/mnt/etc/ld.so.preload
</code></pre></div></div>

<p>Check the <code class="highlighter-rouge">fstab</code>. Replace <code class="highlighter-rouge">/dev/mmcblk0p1</code> and
<code class="highlighter-rouge">/dev/mmcblk0p2</code> with <code class="highlighter-rouge">/dev/sda1</code> and <code class="highlighter-rouge">/dev/sda2</code>.</p>

<p>In my case there are not explicit names like <code class="highlighter-rouge">/dev/mmcblk0p1</code>. Instead,
there are UUIDs so I didn’t touch them.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ cat ~/mnt/etc/fstab
proc                  /proc    proc    defaults             0   0
PARTUUID=067e19d7-01  /boot    vfat    defaults             0   2
PARTUUID=067e19d7-02  /        ext4    defaults,noatime     0   1
</code></pre></div></div>

<p>We are done.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>umount ~/mnt
</code></pre></div></div>

<p>Now it is show time!</p>

<h2 id="running-the-os">Running the OS</h2>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>qemu-system-arm                       <span class="se">\</span>
  <span class="nt">-M</span> versatilepb                        <span class="se">\</span>
  <span class="nt">-cpu</span> arm1176                          <span class="se">\</span>
  <span class="nt">-m</span> 256                                <span class="se">\</span>
  <span class="nt">-drive</span> <span class="s2">"file=2020-12-02-raspios-buster-armhf-lite.img,if=none,index=0,media=disk,format=raw,id=disk0"</span>  <span class="se">\</span>
  <span class="nt">-device</span> <span class="s2">"virtio-blk-pci,drive=disk0,disable-modern=on,disable-legacy=off"</span>                              <span class="se">\</span>
  <span class="nt">-net</span> <span class="s2">"user,hostfwd=tcp::3022-:22"</span>     <span class="se">\</span>
  <span class="nt">-dtb</span> versatile-pb-buster-5.4.51.dtb   <span class="se">\</span>
  <span class="nt">-kernel</span> kernel-qemu-5.4.51-buster     <span class="se">\</span>
  <span class="nt">-append</span> <span class="s1">'root=/dev/vda2 panic=1'</span>      <span class="se">\</span>
  <span class="nt">-no-reboot</span>                            <span class="se">\</span>
  <span class="nt">-net</span> nic                              <span class="se">\</span>
  <span class="nt">-nographic</span>
</code></pre></div></div>

<p>The <code class="highlighter-rouge">hostfwd=tcp::3022-:22</code> tells QEMU to forward TCP connections to the
3022 port from the host to the 22 port on the guest side. More forward
rules can be added.</p>

<p>Enable ssh (now and on boot); login with <code class="highlighter-rouge">pi</code>/<code class="highlighter-rouge">raspberry</code>. This will
allows us to upload/retrieve files to the vm and have additional
consoles.</p>

<pre><code class="language-ssh">$ sudo service ssh start
$ sudo update-rc.d ssh enable
</code></pre>

<p>Now, from your host connect to the vm through the port 3022.</p>

<p>Install <code class="highlighter-rouge">gdbserver</code> for remote debugging:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>apt-get <span class="nb">install </span>gdbserver
Reading package lists... Done
Building dependency tree
Reading state information... Done
The following NEW packages will be installed:
  gdbserver
0 upgraded, 1 newly installed, 0 to remove and 0 not upgraded.
&lt;...&gt;
Preparing to unpack .../gdbserver_8.2.1-2_armhf.deb ...
Unpacking gdbserver <span class="o">(</span>8.2.1-2<span class="o">)</span> ...
Setting up gdbserver <span class="o">(</span>8.2.1-2<span class="o">)</span> ...
</code></pre></div></div>

<h2 id="enlarge-the-disk">Enlarge the disk</h2>

<p>Optionally, you can expand the disk image to have more room for your
programs.</p>

<p>First, with QEMU turned off, expand the disk image</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>qemu-img resize 2020-12-02-raspios-buster-armhf-lite.img +1G
</code></pre></div></div>

<p>Now, turn on the vm and redefine the partition. In my case is the
partition number 2 (<code class="highlighter-rouge">/dev/vda2</code>):</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pi@raspberrypi:~<span class="nv">$ </span><span class="nb">sudo </span>fdisk /dev/vda

Command <span class="o">(</span>m <span class="k">for </span><span class="nb">help</span><span class="o">)</span>: p
Disk /dev/vda: 2.7 GiB, 2931818496 bytes, 5726208 sectors
Units: sectors of 1 <span class="k">*</span> 512 <span class="o">=</span> 512 bytes
Sector size <span class="o">(</span>logical/physical<span class="o">)</span>: 512 bytes / 512 bytes
I/O size <span class="o">(</span>minimum/optimal<span class="o">)</span>: 512 bytes / 512 bytes
Disklabel <span class="nb">type</span>: dos
Disk identifier: 0x067e19d7

Device     Boot  Start     End Sectors  Size Id Type
/dev/vda1         8192  532479  524288  256M  c W95 FAT32 <span class="o">(</span>LBA<span class="o">)</span>
/dev/vda2       532480 3629055 3096576  1.5G 83 Linux

Command <span class="o">(</span>m <span class="k">for </span><span class="nb">help</span><span class="o">)</span>: d
Partition number <span class="o">(</span>1,2, default 2<span class="o">)</span>: 2

Partition 2 has been deleted.

Command <span class="o">(</span>m <span class="k">for </span><span class="nb">help</span><span class="o">)</span>: n
Partition <span class="nb">type
   </span>p   primary <span class="o">(</span>1 primary, 0 extended, 3 free<span class="o">)</span>
   e   extended <span class="o">(</span>container <span class="k">for </span>logical partitions<span class="o">)</span>
Select <span class="o">(</span>default p<span class="o">)</span>: p
Partition number <span class="o">(</span>2-4, default 2<span class="o">)</span>: 2
First sector <span class="o">(</span>2048-5726207, default 2048<span class="o">)</span>: 532480
Last sector, +/-sectors or +/-size<span class="o">{</span>K,M,G,T,P<span class="o">}</span> <span class="o">(</span>532480-5726207, default 5726207<span class="o">)</span>:

Created a new partition 2 of <span class="nb">type</span> <span class="s1">'Linux'</span> and of size 2.5 GiB.
Partition <span class="c">#2 contains a ext4 signature.</span>

Do you want to remove the signature? <span class="o">[</span>Y]es/[N]o: n

Command <span class="o">(</span>m <span class="k">for </span><span class="nb">help</span><span class="o">)</span>: w

The partition table has been altered.
Syncing disks.
</code></pre></div></div>

<p>Note that <code class="highlighter-rouge">fdisk</code> offered by default the first sector to be 2048. This
is the space <em>before</em> <code class="highlighter-rouge">/dev/vda1</code> and it is too small, only 8kb.</p>

<p>Instead we want to start <em>after</em> <code class="highlighter-rouge">/dev/vda1</code>, in the same sector that
the original <code class="highlighter-rouge">/dev/vda2</code>: the 532480.</p>

<p>From there, to the end of the disk: 5726207.</p>

<p>With the partition expanded, reboot and then update the filesystem:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pi@raspberrypi:~<span class="nv">$ </span><span class="nb">sudo </span>resize2fs /dev/vda2
resize2fs 1.44.5 <span class="o">(</span>15-Dec-2018<span class="o">)</span>
Filesystem at /dev/vda2 is mounted on /<span class="p">;</span> on-line resizing required
old_desc_blocks <span class="o">=</span> 1, new_desc_blocks <span class="o">=</span> 1
The filesystem on /dev/vda2 is now 649216 <span class="o">(</span>4k<span class="o">)</span> blocks long.
</code></pre></div></div>

<h2 id="references">References</h2>

<p>This tutorial setups a <a href="https://azeria-labs.com/emulate-raspberry-pi-with-qemu/">Raspbian Jessie in Qemu</a>.</p>

<p>I adapted the steps to use a modern Raspbian Buster image.</p>

<p>The tutorial is super complete and includes how to enlarge the disk and
setup the network.</p>

<p>But for the enlarge the disk part, this
<a href="https://gist.github.com/larsks/3933980">gist</a> explains the thing a
little better.</p>

<p><a href="https://github.com/bradfitz/embiggen-disk">embiggen-disk</a> seems to be a
tool to facilite the task.</p>



    </article>
    <span class="print-footer">QEMUlating a Rasbian (ARM) - December 15, 2020 - Gehn</span>
    <footer>
    <hr class="slender">
    <div class="credits">
        <span>&copy; 2021
            
            Gehn
        </span></br>
            <a style="text-decoration: none;" href="/book-of-gehn/feed.xml"><img height="16px" width="16px" src="/book-of-gehn/assets/blog-assets/rss-32px.png" /></a>
        <br>
        

    
    </div>
</footer>

  </body>
</html>
