<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <meta name="description" content="Review Arm Assembly There is no other way to learn something that playing with it. Take assembly code, read it and predice what will do. Then test it. Those mistakes, those mismatches between what you think and what it really is, those surprises are what move us forward into learning. Deeper. In this post I will dig into Arm, assisted with an interactive assembler.">

  
  <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      
          "@type": "BlogPosting",
          "headline": "Review Arm Assembly",
          
          
          "datePublished": "2021-01-04T00:00:00+00:00",
          "dateModified": "2021-01-04T00:00:00+00:00",
          

          "author": [{
              "@type": "Person",
              "name": "Martin Di Paola",
              "url": "https://book-of-gehn.github.io"
            }]
      
    }
  </script>


  

  <title>Review Arm Assembly</title>

  <link rel="icon" type="image/x-icon" href="/img/favicon.ico">

  
  <link rel="alternate" type="application/rss+xml" href="https://book-of-gehn.github.io/rss.xml">

  <link rel="canonical" href="https://book-of-gehn.github.io/articles/2021/01/04/Review-Arm-Assembly.html">

  <link href='/css/load-lato-fonts.min.css' rel='stylesheet' type='text/css'>

  <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      //root: "/js/MathJax-2.7.7",
      extensions: ["tex2jax.js"],
      jax: ["input/TeX","output/HTML-CSS"],
      tex2jax: {inlineMath: [["\\(","\\)"]]},
      TeX: {
        Macros: {
          
        }
      }
    });
  </script>
  <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js' async></script>

  <script src="/js/jquery-3.6.0.min.js"></script>

  <script src='/js/underscore-1.9.1.min.js' ></script>

  <script src='/js/d3-7.4.2.min.js'></script>

  <script src='/js/venn/venn-0.2.14.min.js'></script>
  <script src='/js/venn/helper.min.js'></script>

  <script src='/js/fix_syntax_highlight.min.js'></script>
  <link rel="stylesheet" type="text/css" href="/css/tufte.min.css">
  <link rel="stylesheet" type="text/css" href="/css/latex.min.css">

  <link rel="stylesheet" type="text/css" href="/css/font-awesome-5.min.css">

  <script src='/js/lunr-2.3.9.min.js'></script>
  <script src='/js/search_index.js'></script>
  <script src='/js/search.min.js'></script>
</head>
<body>
<header>
                <hgroup class="header-group">
        <h1 class="header-title"><a href="/">The Book of Gehn</a></h1>
                </hgroup>
                <ul class="header-list">
                    <li><a href="https://byexamples.github.io">byexample</a></li>
                    <li><a href="https://bisturi.github.io">bisturi</a></li>
                    <li>
                        <a class="raw_link" href="/atom.xml"><img height="16px" width="16px" src="/img/rss-32px.png" /></a>
                        <a class="raw_link" href="https://github.com/eldipa"><img height="16px" width="16px" src="/img/github.png" /></a>
                    </li>
                </ul>
        
        

    

</header>
<article class="group">
<h1>
Review Arm Assembly
</h1>
<p class="subtitle">
January 4, 2021
</p>
<p>There is no other way to learn something that playing with it.</p>
<p>Take assembly code, read it and predice what will do. Then test it.</p>
<p>Those mistakes, those mismatches between what you think and what it really is, those <em>surprises</em> are what move us forward into learning. Deeper.</p>
<p>In this post I will dig into Arm, assisted with an <a href="https://github.com/bad-address/iasm">interactive assembler</a>.<!--more--></p>
<h2 id="gcc-generated-arm-assembly">GCC generated Arm assembly</h2>
<p>We will see the assembly of the following C code compiled as:</p>
<div class="highlight-candombe"><pre><span></span><code>pi@raspberrypi:~$<span class="w"> </span>gcc<span class="w"> </span>-S<span class="w"> </span>-O0<span class="w"> </span>-o<span class="w"> </span>asm1.asm<span class="w"> </span>asm1.c
</code></pre></div>

<p><code class="none">raspberrypi</code> is a QEMU virtual machine for Arm running a Raspbian Stretch. The setup is explained in my previous post <a href="/articles/2020/12/15/Qemulating-Rasbian-ARM.html">QEMUlating a Rasbian (ARM)</a>.</p>
<p>The code is quite simple:</p>
<div class="highlight-candombe"><pre><span></span><code><span class="kt">int</span><span class="w"> </span><span class="nf">rand</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mh">0x42</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">a</span><span class="o">+</span><span class="n">b</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rand</span><span class="p">();</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">  </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mh">0x4041</span><span class="p">)</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">sum</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="mh">0x4041</span><span class="p">);</span>
<span class="w">  </span><span class="k">else</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p>Let’s dig into the assembly. I will use an <a href="https://github.com/bad-address/iasm">interactive assembler</a>.</p>
<h2 id="the-rand-function">The <code class="none">rand</code> function</h2>
<div class="highlight-candombe"><pre><span></span><code><span class="w">        </span><span class="nf">.align</span><span class="w">  </span><span class="mi">2</span>
<span class="w">        </span><span class="nf">.global</span><span class="w"> </span><span class="nv">rand</span>
<span class="w">        </span><span class="nf">.arch</span><span class="w"> </span><span class="nv">armv6</span>
<span class="w">        </span><span class="nf">.syntax</span><span class="w"> </span><span class="nv">unified</span>
<span class="w">        </span><span class="nf">.arm</span>
<span class="w">        </span><span class="nf">.fpu</span><span class="w"> </span><span class="nv">vfp</span>
<span class="w">        </span><span class="nf">.type</span><span class="w">   </span><span class="nv">rand</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="nv">function</span>
<span class="nl">rand:</span>
<span class="w">        </span><span class="c1">; link register save eliminated.</span>
<span class="w">        </span><span class="nf">str</span><span class="w">     </span><span class="nv">fp</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nb">sp</span><span class="p">,</span><span class="w"> </span><span class="c1">#-4]!</span>
<span class="w">        </span><span class="nf">add</span><span class="w">     </span><span class="nv">fp</span><span class="p">,</span><span class="w"> </span><span class="nb">sp</span><span class="p">,</span><span class="w"> </span><span class="c1">#0</span>
<span class="w">        </span><span class="nf">mov</span><span class="w">     </span><span class="nb">r3</span><span class="p">,</span><span class="w"> </span><span class="c1">#66</span>
<span class="w">        </span><span class="nf">mov</span><span class="w">     </span><span class="nb">r0</span><span class="p">,</span><span class="w"> </span><span class="nb">r3</span>
<span class="w">        </span><span class="nf">add</span><span class="w">     </span><span class="nb">sp</span><span class="p">,</span><span class="w"> </span><span class="nv">fp</span><span class="p">,</span><span class="w"> </span><span class="c1">#0</span>
<span class="w">        </span><span class="nf">ldr</span><span class="w">     </span><span class="nv">fp</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nb">sp</span><span class="p">],</span><span class="w"> </span><span class="c1">#4</span>
<span class="w">        </span><span class="nf">bx</span><span class="w">      </span><span class="nv">lr</span>
<span class="w">        </span><span class="nf">.size</span><span class="w">   </span><span class="nv">rand</span><span class="p">,</span><span class="w"> </span><span class="nv">.</span><span class="o">-</span><span class="nv">rand</span>
</code></pre></div>

<p>First, the code is aligned and the symbol is marked as “global”. <code><span class="highlight-candombe-inline"><span class="nf">.arm</span></span></code> says that the code is Arm (aka <code><span class="highlight-candombe-inline"><span class="nf">.code</span><span class="w"> </span><span class="mi">32</span></span></code>).</p>
<h3 id="prologue">Prologue</h3>
<p>The function begins saving the <em>frame pointer</em> <code><span class="highlight-candombe-inline"><span class="nf">fp</span></span></code> in the stack.</p>
<p>The <code><span class="highlight-candombe-inline"><span class="nf">str</span><span class="w"> </span><span class="nv">fp</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nb">sp</span><span class="p">,</span><span class="w"> </span><span class="c1">#-4]!</span></span></code> is a <em>pre-index</em> addressing store: the <code><span class="highlight-candombe-inline"><span class="nf">fp</span></span></code> is saved 4 bytes “up” in the stack (the stack grows towards lower addresses).</p>
<p>And the store is in <em>pre write-back</em> store (<code><span class="highlight-candombe-inline"><span class="err">!</span></span></code>): the <code><span class="highlight-candombe-inline"><span class="nf">sp</span></span></code> is updated (decremented by 4) <em>before</em> performing the store.</p>
<p>The <code><span class="highlight-candombe-inline"><span class="nf">sp</span></span></code> points always to the latest <em>valid</em> value in the stack. That’s why <code><span class="highlight-candombe-inline"><span class="nf">sp</span></span></code> is decremented before performing the store.</p>
<p>The <code><span class="highlight-candombe-inline"><span class="nf">add</span><span class="w"> </span><span class="nv">fp</span><span class="p">,</span><span class="w"> </span><span class="nb">sp</span><span class="p">,</span><span class="w"> </span><span class="c1">#0</span></span></code> is an alternative to <code><span class="highlight-candombe-inline"><span class="nf">mov</span><span class="w"> </span><span class="nv">fp</span><span class="p">,</span><span class="w"> </span><span class="nb">sp</span></span></code>.</p>
<p>At the begin of the call:</p>
<div class="highlight-candombe"><pre><span></span><code><span class="err">------</span><span class="w">  </span><span class="err">-</span><span class="w">  </span><span class="err">------</span><span class="w">  </span><span class="err">----</span><span class="w">  </span><span class="err">------</span><span class="w">  </span><span class="err">---------</span><span class="w">  </span><span class="err">------</span><span class="w">  </span><span class="err">---------</span>
<span class="w">    </span><span class="nf">r0</span><span class="w">  </span><span class="mi">0</span><span class="w">  </span><span class="nb">r1</span><span class="w">      </span><span class="mi">0</span><span class="w">     </span><span class="nb">r2</span><span class="w">      </span><span class="mi">0</span><span class="w">          </span><span class="nb">r3</span><span class="w">      </span><span class="mi">0</span>
<span class="w">    </span><span class="nf">r4</span><span class="w">  </span><span class="mi">0</span><span class="w">  </span><span class="nb">r5</span><span class="w">      </span><span class="mi">0</span><span class="w">     </span><span class="nb">r6</span><span class="w">      </span><span class="mi">0</span><span class="w">          </span><span class="nb">r7</span><span class="w">      </span><span class="mi">0</span>
<span class="w">    </span><span class="nf">r8</span><span class="w">  </span><span class="mi">0</span><span class="w">  </span><span class="nb">r9</span><span class="o">/</span><span class="nv">sb</span><span class="w">   </span><span class="mi">0</span><span class="w">     </span><span class="nb">r10</span><span class="w">     </span><span class="mi">0</span><span class="w">          </span><span class="nb">r11</span><span class="o">/</span><span class="nv">fp</span><span class="w">  </span><span class="nv">bbbb</span><span class="p">:</span><span class="nv">bbbb</span>
<span class="nf">r12</span><span class="o">/</span><span class="nv">ip</span><span class="w">  </span><span class="mi">0</span><span class="w">  </span><span class="nb">r13</span><span class="o">/</span><span class="nb">sp</span><span class="w">  </span><span class="mi">2000</span><span class="w">  </span><span class="nb">r14</span><span class="o">/</span><span class="nv">lr</span><span class="w">  </span><span class="nv">aaaa</span><span class="p">:</span><span class="nv">aaaa</span><span class="w">  </span><span class="nb">r15</span><span class="o">/</span><span class="nv">pc</span><span class="w">  </span><span class="mi">100</span><span class="p">:</span><span class="mi">0</span>
<span class="err">------</span><span class="w">  </span><span class="err">-</span><span class="w">  </span><span class="err">------</span><span class="w">  </span><span class="err">----</span><span class="w">  </span><span class="err">------</span><span class="w">  </span><span class="err">---------</span><span class="w">  </span><span class="err">------</span><span class="w">  </span><span class="err">---------</span>
</code></pre></div>

<p>After the <code><span class="highlight-candombe-inline"><span class="nf">fp</span></span></code> and <code><span class="highlight-candombe-inline"><span class="nf">sp</span></span></code> update:</p>
<div class="highlight-candombe"><pre><span></span><code><span class="err">------</span><span class="w">  </span><span class="err">-</span><span class="w">  </span><span class="err">------</span><span class="w">  </span><span class="err">----</span><span class="w">  </span><span class="err">------</span><span class="w">  </span><span class="err">---------</span><span class="w">  </span><span class="err">------</span><span class="w">  </span><span class="err">-----</span>
<span class="w">    </span><span class="nf">r0</span><span class="w">  </span><span class="mi">0</span><span class="w">  </span><span class="nb">r1</span><span class="w">      </span><span class="mi">0</span><span class="w">     </span><span class="nb">r2</span><span class="w">      </span><span class="mi">0</span><span class="w">          </span><span class="nb">r3</span><span class="w">      </span><span class="mi">0</span>
<span class="w">    </span><span class="nf">r4</span><span class="w">  </span><span class="mi">0</span><span class="w">  </span><span class="nb">r5</span><span class="w">      </span><span class="mi">0</span><span class="w">     </span><span class="nb">r6</span><span class="w">      </span><span class="mi">0</span><span class="w">          </span><span class="nb">r7</span><span class="w">      </span><span class="mi">0</span>
<span class="w">    </span><span class="nf">r8</span><span class="w">  </span><span class="mi">0</span><span class="w">  </span><span class="nb">r9</span><span class="o">/</span><span class="nv">sb</span><span class="w">   </span><span class="mi">0</span><span class="w">     </span><span class="nb">r10</span><span class="w">     </span><span class="mi">0</span><span class="w">          </span><span class="nb">r11</span><span class="o">/</span><span class="nv">fp</span><span class="w">  </span><span class="mi">1</span><span class="nv">ffc</span>
<span class="nf">r12</span><span class="o">/</span><span class="nv">ip</span><span class="w">  </span><span class="mi">0</span><span class="w">  </span><span class="nb">r13</span><span class="o">/</span><span class="nb">sp</span><span class="w">  </span><span class="mi">1</span><span class="nv">ffc</span><span class="w">  </span><span class="nb">r14</span><span class="o">/</span><span class="nv">lr</span><span class="w">  </span><span class="nv">aaaa</span><span class="p">:</span><span class="nv">aaaa</span><span class="w">  </span><span class="nb">r15</span><span class="o">/</span><span class="nv">pc</span><span class="w">  </span><span class="mi">100</span><span class="p">:</span><span class="mi">4</span>
<span class="err">------</span><span class="w">  </span><span class="err">-</span><span class="w">  </span><span class="err">------</span><span class="w">  </span><span class="err">----</span><span class="w">  </span><span class="err">------</span><span class="w">  </span><span class="err">---------</span><span class="w">  </span><span class="err">------</span><span class="w">  </span><span class="err">-----</span>
</code></pre></div>

<p><label for='CltpYXNtXShodHRwczovL2dpdGh1Yi5jb20vYmFkLWFkZHJlc3MvaWFzbSksIHRoZSBpbnRlcmFjdGl2ZSBhc3NlbWJsZXIsCmFsbG93cyB0byBleHBsb3JlIHRoZSBtZW1vcnkgd2l0aCB0aGUgYE1gIG9iamVjdC4gYE1bc3A6XWAgbWVhbnMgc2hvdwp0aGUgbWVtb3J5IGZyb20gdGhlIGFkZHJlc3Mgc3RvcmVkIGluIGBzcGAgdG8gdGhlIGxhc3QgYWRkcmVzcyBtYXBwZWQKcGFnZS4KCkluIG90aGVyIHdvcmRzOiBzaG93IHRoZSBzdGFjay4KIG1hcmdpbm5vdGVz' class='margin-toggle'> &#8853;</label>
<input type='checkbox' id='CltpYXNtXShodHRwczovL2dpdGh1Yi5jb20vYmFkLWFkZHJlc3MvaWFzbSksIHRoZSBpbnRlcmFjdGl2ZSBhc3NlbWJsZXIsCmFsbG93cyB0byBleHBsb3JlIHRoZSBtZW1vcnkgd2l0aCB0aGUgYE1gIG9iamVjdC4gYE1bc3A6XWAgbWVhbnMgc2hvdwp0aGUgbWVtb3J5IGZyb20gdGhlIGFkZHJlc3Mgc3RvcmVkIGluIGBzcGAgdG8gdGhlIGxhc3QgYWRkcmVzcyBtYXBwZWQKcGFnZS4KCkluIG90aGVyIHdvcmRzOiBzaG93IHRoZSBzdGFjay4KIG1hcmdpbm5vdGVz' class='margin-toggle'/>
<span class='marginnote'>
<a href="https://github.com/bad-address/iasm">iasm</a>, the interactive assembler, allows to explore the memory with the <code><span class="highlight-candombe-inline"><span class="nf">M</span></span></code> object. <code><span class="highlight-candombe-inline"><span class="nf">M</span><span class="p">[</span><span class="nb">sp</span><span class="p">:]</span></span></code> means show the memory from the address stored in <code><span class="highlight-candombe-inline"><span class="nf">sp</span></span></code> to the last address mapped page.
<br /><br />
In other words: show the stack.
</span></p>
<p>And the state of the stack is:</p>
<div class="highlight-candombe"><pre><span></span><code><span class="mi">100</span><span class="p">:</span><span class="mi">4</span><span class="o">&gt;</span> <span class="p">;</span><span class="err">!</span> <span class="n">M</span><span class="p">[</span><span class="n">sp</span><span class="p">:]</span>
<span class="p">[</span>\<span class="n">xbb</span>\<span class="n">xbb</span>\<span class="n">xbb</span>\<span class="n">xbb</span><span class="p">]</span>
       <span class="p">(</span><span class="n">fp</span><span class="p">)</span>

<span class="mi">100</span><span class="p">:</span><span class="mi">4</span><span class="o">&gt;</span> <span class="p">;</span><span class="err">!</span> <span class="n">M</span><span class="p">[</span><span class="n">fp</span><span class="p">:]</span>
<span class="p">[</span>\<span class="n">xbb</span>\<span class="n">xbb</span>\<span class="n">xbb</span>\<span class="n">xbb</span><span class="p">]</span>
       <span class="p">(</span><span class="n">fp</span><span class="p">)</span>
</code></pre></div>

<p><code><span class="highlight-candombe-inline"><span class="nf">sp</span></span></code> points always to the latest value of the stack; <code><span class="highlight-candombe-inline"><span class="nf">fp</span></span></code> points to the previous <code><span class="highlight-candombe-inline"><span class="nf">fp</span></span></code> value (<code><span class="highlight-candombe-inline"><span class="err">0</span><span class="nf">xbbbbbbbb</span></span></code> in this case).</p>
<h3 id="body">Body</h3>
<p>The assembler didn’t optimize the code: it stored in <code><span class="highlight-candombe-inline"><span class="nf">r3</span></span></code> the immediate value of <code><span class="highlight-candombe-inline"><span class="c1">#66</span></span></code> (0x42) to then copy it to <code><span class="highlight-candombe-inline"><span class="nf">r0</span></span></code> (the register used for returning values). <code><span class="highlight-candombe-inline"><span class="nf">mov</span><span class="w"> </span><span class="nb">r0</span><span class="p">,</span><span class="w"> </span><span class="c1">#66</span></span></code> would be shorter.</p>
<h3 id="epilogue">Epilogue</h3>
<p>Then the <code><span class="highlight-candombe-inline"><span class="nf">sp</span></span></code> is restored to the current <code><span class="highlight-candombe-inline"><span class="nf">fp</span></span></code> and the <code><span class="highlight-candombe-inline"><span class="nf">fp</span></span></code> is restored to the previous <code><span class="highlight-candombe-inline"><span class="nf">fp</span></span></code> value with <code><span class="highlight-candombe-inline"><span class="nf">ldr</span><span class="w"> </span><span class="nv">fp</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nb">sp</span><span class="p">],</span><span class="w"> </span><span class="c1">#4</span></span></code></p>
<p>This load is a <em>pre-index</em> addressing with <em>post write-back</em>. That’s it, the <code><span class="highlight-candombe-inline"><span class="nf">fp</span></span></code> is loaded with the valued pointed by <code><span class="highlight-candombe-inline"><span class="nf">sp</span></span></code> and then <code><span class="highlight-candombe-inline"><span class="nf">sp</span></span></code> is added 4 bytes (aka pop).</p>
<p>The compiler however should optimize this because the stack is not used at all so saving and restoring <code><span class="highlight-candombe-inline"><span class="nf">fp</span></span></code> has no value.</p>
<p>What the compiled did, it didn’t save the <em>link</em> register <code><span class="highlight-candombe-inline"><span class="nf">lr</span></span></code>.</p>
<p>The register holds the address to where return from a call. Because <code class="none">rand</code> doesn’t call anything, <code><span class="highlight-candombe-inline"><span class="nf">lr</span></span></code> from the caller is preserved so it is not needed to save it in the stack.</p>
<p><code><span class="highlight-candombe-inline"><span class="nf">bx</span><span class="w"> </span><span class="nv">lr</span></span></code> returns to the caller.</p>
<h2 id="the-sum-function">The <code class="none">sum</code> function</h2>
<div class="highlight-candombe"><pre><span></span><code><span class="nl">sum:</span>
<span class="w">        </span><span class="nf">str</span><span class="w">     </span><span class="nv">fp</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nb">sp</span><span class="p">,</span><span class="w"> </span><span class="c1">#-4]!</span>
<span class="w">        </span><span class="nf">add</span><span class="w">     </span><span class="nv">fp</span><span class="p">,</span><span class="w"> </span><span class="nb">sp</span><span class="p">,</span><span class="w"> </span><span class="c1">#0</span>
<span class="w">        </span><span class="nf">sub</span><span class="w">     </span><span class="nb">sp</span><span class="p">,</span><span class="w"> </span><span class="nb">sp</span><span class="p">,</span><span class="w"> </span><span class="c1">#12</span>
<span class="w">        </span><span class="nf">str</span><span class="w">     </span><span class="nb">r0</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nv">fp</span><span class="p">,</span><span class="w"> </span><span class="c1">#-8]</span>
<span class="w">        </span><span class="nf">str</span><span class="w">     </span><span class="nb">r1</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nv">fp</span><span class="p">,</span><span class="w"> </span><span class="c1">#-12]</span>
<span class="w">        </span><span class="nf">ldr</span><span class="w">     </span><span class="nb">r2</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nv">fp</span><span class="p">,</span><span class="w"> </span><span class="c1">#-8]</span>
<span class="w">        </span><span class="nf">ldr</span><span class="w">     </span><span class="nb">r3</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nv">fp</span><span class="p">,</span><span class="w"> </span><span class="c1">#-12]</span>
<span class="w">        </span><span class="nf">add</span><span class="w">     </span><span class="nb">r3</span><span class="p">,</span><span class="w"> </span><span class="nb">r2</span><span class="p">,</span><span class="w"> </span><span class="nb">r3</span>
<span class="w">        </span><span class="nf">mov</span><span class="w">     </span><span class="nb">r0</span><span class="p">,</span><span class="w"> </span><span class="nb">r3</span>
<span class="w">        </span><span class="nf">add</span><span class="w">     </span><span class="nb">sp</span><span class="p">,</span><span class="w"> </span><span class="nv">fp</span><span class="p">,</span><span class="w"> </span><span class="c1">#0</span>
<span class="w">        </span><span class="nf">ldr</span><span class="w">     </span><span class="nv">fp</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nb">sp</span><span class="p">],</span><span class="w"> </span><span class="c1">#4</span>
<span class="w">        </span><span class="nf">bx</span><span class="w">      </span><span class="nv">lr</span>
<span class="w">        </span><span class="nf">.size</span><span class="w">   </span><span class="nv">sum</span><span class="p">,</span><span class="w"> </span><span class="nv">.</span><span class="o">-</span><span class="nv">sum</span>
</code></pre></div>

<h3 id="prologue-1">Prologue</h3>
<p>In this case the function allocates 12 bytes to hold local variables (<code><span class="highlight-candombe-inline"><span class="nf">sub</span><span class="w"> </span><span class="nb">sp</span><span class="p">,</span><span class="w"> </span><span class="nb">sp</span><span class="p">,</span><span class="w"> </span><span class="c1">#12</span></span></code>).</p>
<p>The second argument <code><span class="highlight-candombe-inline"><span class="nf">r1</span></span></code> is stored in the top of the stack; the first argument <code><span class="highlight-candombe-inline"><span class="nf">r0</span></span></code> is stored below. Arguments are pushed from left (<code><span class="highlight-candombe-inline"><span class="nf">r0</span></span></code>) to right (<code><span class="highlight-candombe-inline"><span class="nf">r1</span></span></code>).</p>
<p>The call convention says that the arguments are passed via registers (up to 4 args). They are set by the caller and, if needed, the callee needs to preserve them in the stack.</p>
<p>No really needed here because <code class="none">sum</code> does not call other function but still the compiler follows the cookbook.</p>
<p>The function allocated 12 byte to hold 3 variables of 32 bits. We stored 2, the arguments, but the third element is never set.</p>
<p>The registers at the begin of the call were:</p>
<div class="highlight-candombe"><pre><span></span><code><span class="err">------</span><span class="w">  </span><span class="err">---------</span><span class="w">  </span><span class="err">------</span><span class="w">  </span><span class="err">---------</span><span class="w">  </span><span class="err">------</span><span class="w">  </span><span class="err">---------</span><span class="w">  </span><span class="err">------</span><span class="w">  </span><span class="err">---------</span>
<span class="w">    </span><span class="nf">r0</span><span class="w">  </span><span class="nv">cccc</span><span class="p">:</span><span class="nv">cccc</span><span class="w">  </span><span class="nb">r1</span><span class="w">      </span><span class="nv">dddd</span><span class="p">:</span><span class="nv">dddd</span><span class="w">  </span><span class="nb">r2</span><span class="w">      </span><span class="mi">0</span><span class="w">          </span><span class="nb">r3</span><span class="w">      </span><span class="mi">0</span>
<span class="w">    </span><span class="nf">r4</span><span class="w">  </span><span class="mi">0</span><span class="w">          </span><span class="nb">r5</span><span class="w">      </span><span class="mi">0</span><span class="w">          </span><span class="nb">r6</span><span class="w">      </span><span class="mi">0</span><span class="w">          </span><span class="nb">r7</span><span class="w">      </span><span class="mi">0</span>
<span class="w">    </span><span class="nf">r8</span><span class="w">  </span><span class="mi">0</span><span class="w">          </span><span class="nb">r9</span><span class="o">/</span><span class="nv">sb</span><span class="w">   </span><span class="mi">0</span><span class="w">          </span><span class="nb">r10</span><span class="w">     </span><span class="mi">0</span><span class="w">          </span><span class="nb">r11</span><span class="o">/</span><span class="nv">fp</span><span class="w">  </span><span class="nv">bbbb</span><span class="p">:</span><span class="nv">bbbb</span>
<span class="nf">r12</span><span class="o">/</span><span class="nv">ip</span><span class="w">  </span><span class="mi">0</span><span class="w">          </span><span class="nb">r13</span><span class="o">/</span><span class="nb">sp</span><span class="w">  </span><span class="mi">2000</span><span class="w">       </span><span class="nb">r14</span><span class="o">/</span><span class="nv">lr</span><span class="w">  </span><span class="nv">aaaa</span><span class="p">:</span><span class="nv">aaaa</span><span class="w">  </span><span class="nb">r15</span><span class="o">/</span><span class="nv">pc</span><span class="w">  </span><span class="mi">100</span><span class="p">:</span><span class="mi">0</span>
<span class="err">------</span><span class="w">  </span><span class="err">---------</span><span class="w">  </span><span class="err">------</span><span class="w">  </span><span class="err">---------</span><span class="w">  </span><span class="err">------</span><span class="w">  </span><span class="err">---------</span><span class="w">  </span><span class="err">------</span><span class="w">  </span><span class="err">---------</span>
</code></pre></div>

<p>And after the stores, the stack has:</p>
<div class="highlight-candombe"><pre><span></span><code><span class="mi">100</span><span class="p">:</span><span class="mi">10</span><span class="o">&gt;</span> <span class="p">;</span><span class="err">!</span> <span class="n">M</span><span class="p">[</span><span class="n">sp</span><span class="p">:]</span>
<span class="p">[</span>\<span class="n">xdd</span>\<span class="n">xdd</span>\<span class="n">xdd</span>\<span class="n">xdd</span>\<span class="n">xcc</span>\<span class="n">xcc</span>\<span class="n">xcc</span>\<span class="n">xcc</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">xbb</span>\<span class="n">xbb</span>\<span class="n">xbb</span>\<span class="n">xbb</span><span class="p">]</span>
       <span class="p">(</span><span class="n">r1</span><span class="p">)</span>            <span class="p">(</span><span class="n">r0</span><span class="p">)</span>            <span class="p">(</span><span class="err">??</span><span class="p">)</span>            <span class="p">(</span><span class="n">fp</span><span class="p">)</span>

<span class="mi">100</span><span class="p">:</span><span class="mi">10</span><span class="o">&gt;</span> <span class="p">;</span><span class="err">!</span> <span class="n">M</span><span class="p">[</span><span class="n">fp</span><span class="p">:]</span>
<span class="p">[</span>\<span class="n">xbb</span>\<span class="n">xbb</span>\<span class="n">xbb</span>\<span class="n">xbb</span><span class="p">]</span>
       <span class="p">(</span><span class="n">fp</span><span class="p">)</span>
</code></pre></div>

<p>I presume that the unused space (??) is for the <code><span class="highlight-candombe-inline"><span class="nf">lr</span></span></code> register.</p>
<h2 id="the-main-function">The <code class="none">main</code> function</h2>
<div class="highlight-candombe"><pre><span></span><code><span class="nl">main:</span>
<span class="w">        </span><span class="nf">push</span><span class="w">    </span><span class="p">{</span><span class="nv">fp</span><span class="p">,</span><span class="w"> </span><span class="nv">lr</span><span class="p">}</span>
<span class="w">        </span><span class="nf">add</span><span class="w">     </span><span class="nv">fp</span><span class="p">,</span><span class="w"> </span><span class="nb">sp</span><span class="p">,</span><span class="w"> </span><span class="c1">#4</span>
<span class="w">        </span><span class="nf">sub</span><span class="w">     </span><span class="nb">sp</span><span class="p">,</span><span class="w"> </span><span class="nb">sp</span><span class="p">,</span><span class="w"> </span><span class="c1">#8</span>
<span class="w">        </span><span class="nf">bl</span><span class="w">      </span><span class="nv">rand</span>
<span class="w">        </span><span class="nf">str</span><span class="w">     </span><span class="nb">r0</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nv">fp</span><span class="p">,</span><span class="w"> </span><span class="c1">#-8]</span>
<span class="w">        </span><span class="nf">ldr</span><span class="w">     </span><span class="nb">r3</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nv">fp</span><span class="p">,</span><span class="w"> </span><span class="c1">#-8]</span>
<span class="w">        </span><span class="nf">cmp</span><span class="w">     </span><span class="nb">r3</span><span class="p">,</span><span class="w"> </span><span class="c1">#0</span>
<span class="w">        </span><span class="nf">bne</span><span class="w">     </span><span class="nv">.L6</span>
<span class="w">        </span><span class="nf">mov</span><span class="w">     </span><span class="nb">r3</span><span class="p">,</span><span class="w"> </span><span class="c1">#0</span>
<span class="w">        </span><span class="nf">b</span><span class="w">       </span><span class="nv">.L7</span>
<span class="nl">.L6:</span>
<span class="w">        </span><span class="nf">ldr</span><span class="w">     </span><span class="nb">r3</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nv">fp</span><span class="p">,</span><span class="w"> </span><span class="c1">#-8]</span>
<span class="w">        </span><span class="nf">ldr</span><span class="w">     </span><span class="nb">r2</span><span class="p">,</span><span class="w"> </span><span class="nv">.L9</span>
<span class="w">        </span><span class="nf">cmp</span><span class="w">     </span><span class="nb">r3</span><span class="p">,</span><span class="w"> </span><span class="nb">r2</span>
<span class="w">        </span><span class="nf">ble</span><span class="w">     </span><span class="nv">.L8</span>
<span class="w">        </span><span class="nf">ldr</span><span class="w">     </span><span class="nb">r1</span><span class="p">,</span><span class="w"> </span><span class="nv">.L9</span>
<span class="w">        </span><span class="nf">ldr</span><span class="w">     </span><span class="nb">r0</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nv">fp</span><span class="p">,</span><span class="w"> </span><span class="c1">#-8]</span>
<span class="w">        </span><span class="nf">bl</span><span class="w">      </span><span class="nv">sum</span>
<span class="w">        </span><span class="nf">mov</span><span class="w">     </span><span class="nb">r3</span><span class="p">,</span><span class="w"> </span><span class="nb">r0</span>
<span class="w">        </span><span class="nf">b</span><span class="w">       </span><span class="nv">.L7</span>
<span class="nl">.L8:</span>
<span class="w">        </span><span class="nf">mvn</span><span class="w">     </span><span class="nb">r3</span><span class="p">,</span><span class="w"> </span><span class="c1">#0</span>
<span class="nl">.L7:</span>
<span class="w">        </span><span class="nf">mov</span><span class="w">     </span><span class="nb">r0</span><span class="p">,</span><span class="w"> </span><span class="nb">r3</span>
<span class="w">        </span><span class="nf">sub</span><span class="w">     </span><span class="nb">sp</span><span class="p">,</span><span class="w"> </span><span class="nv">fp</span><span class="p">,</span><span class="w"> </span><span class="c1">#4</span>
<span class="w">        </span><span class="nf">pop</span><span class="w">     </span><span class="p">{</span><span class="nv">fp</span><span class="p">,</span><span class="w"> </span><span class="nv">pc</span><span class="p">}</span>
<span class="nl">.L10:</span>
<span class="w">        </span><span class="nf">.align</span><span class="w">  </span><span class="mi">2</span>
</code></pre></div>

<h3 id="prologue-2">Prologue</h3>
<p>The function saves <code><span class="highlight-candombe-inline"><span class="nf">fp</span></span></code> and <code><span class="highlight-candombe-inline"><span class="nf">lr</span></span></code> with a single <code><span class="highlight-candombe-inline"><span class="nf">push</span><span class="w"> </span><span class="p">{</span><span class="nv">fp</span><span class="p">,</span><span class="nv">lr</span><span class="p">}</span></span></code>.</p>
<p>The <code><span class="highlight-candombe-inline"><span class="err">{</span><span class="nf">r</span><span class="p">,</span><span class="nv">r</span><span class="p">}</span></span></code> notation is a <em>set</em>, not a <em>list</em>: registers are pushed in the <em>inverse</em> order of the registers (<code><span class="highlight-candombe-inline"><span class="nf">r0</span></span></code> to <code><span class="highlight-candombe-inline"><span class="nf">r15</span></span></code>) regardless of how the <code><span class="highlight-candombe-inline"><span class="nf">push</span></span></code> is written.</p>
<p>In our case <code><span class="highlight-candombe-inline"><span class="nf">fp</span></span></code> is <code><span class="highlight-candombe-inline"><span class="nf">r11</span></span></code> and <code><span class="highlight-candombe-inline"><span class="nf">lr</span></span></code> is <code><span class="highlight-candombe-inline"><span class="nf">r14</span></span></code> so that is the natural order, then the inverse order applies: <code><span class="highlight-candombe-inline"><span class="nf">r14</span></span></code> is pushed first, <code><span class="highlight-candombe-inline"><span class="nf">r11</span></span></code> later.</p>
<p>In short: <code><span class="highlight-candombe-inline"><span class="nf">r14</span></span></code> will be at the bottom of the stack (higher addresses) while <code><span class="highlight-candombe-inline"><span class="nf">r11</span></span></code> will be at the top (lower addresses).</p>
<p>The <code><span class="highlight-candombe-inline"><span class="nf">fp</span></span></code> is then updated to the base of the stack for the current function call. The stack frame begins <em>after</em> storing the previous <code><span class="highlight-candombe-inline"><span class="nf">fp</span></span></code> so the current <code><span class="highlight-candombe-inline"><span class="nf">fp</span></span></code> points to the saved <code><span class="highlight-candombe-inline"><span class="nf">lr</span></span></code>.</p>
<p>The <code><span class="highlight-candombe-inline"><span class="nf">fp</span></span></code> update is done with <code><span class="highlight-candombe-inline"><span class="nf">add</span><span class="w"> </span><span class="nv">fp</span><span class="p">,</span><span class="w"> </span><span class="nb">sp</span><span class="p">,</span><span class="w"> </span><span class="c1">#4</span></span></code> (by this moment the <code><span class="highlight-candombe-inline"><span class="nf">sp</span></span></code> is off by 4 due the push of <code><span class="highlight-candombe-inline"><span class="nf">lr</span></span></code>).</p>
<p>The registers at the begin of the call were:</p>
<div class="highlight-candombe"><pre><span></span><code><span class="err">------</span><span class="w">  </span><span class="err">---------</span><span class="w">  </span><span class="err">------</span><span class="w">  </span><span class="err">---------</span><span class="w">  </span><span class="err">------</span><span class="w">  </span><span class="err">---------</span><span class="w">  </span><span class="err">------</span><span class="w">  </span><span class="err">---------</span>
<span class="w">    </span><span class="nf">r0</span><span class="w">  </span><span class="nv">cccc</span><span class="p">:</span><span class="nv">cccc</span><span class="w">  </span><span class="nb">r1</span><span class="w">      </span><span class="nv">dddd</span><span class="p">:</span><span class="nv">dddd</span><span class="w">  </span><span class="nb">r2</span><span class="w">      </span><span class="mi">0</span><span class="w">          </span><span class="nb">r3</span><span class="w">      </span><span class="mi">0</span>
<span class="w">    </span><span class="nf">r4</span><span class="w">  </span><span class="mi">0</span><span class="w">          </span><span class="nb">r5</span><span class="w">      </span><span class="mi">0</span><span class="w">          </span><span class="nb">r6</span><span class="w">      </span><span class="mi">0</span><span class="w">          </span><span class="nb">r7</span><span class="w">      </span><span class="mi">0</span>
<span class="w">    </span><span class="nf">r8</span><span class="w">  </span><span class="mi">0</span><span class="w">          </span><span class="nb">r9</span><span class="o">/</span><span class="nv">sb</span><span class="w">   </span><span class="mi">0</span><span class="w">          </span><span class="nb">r10</span><span class="w">     </span><span class="mi">0</span><span class="w">          </span><span class="nb">r11</span><span class="o">/</span><span class="nv">fp</span><span class="w">  </span><span class="nv">bbbb</span><span class="p">:</span><span class="nv">bbbb</span>
<span class="nf">r12</span><span class="o">/</span><span class="nv">ip</span><span class="w">  </span><span class="mi">0</span><span class="w">          </span><span class="nb">r13</span><span class="o">/</span><span class="nb">sp</span><span class="w">  </span><span class="mi">2000</span><span class="w">       </span><span class="nb">r14</span><span class="o">/</span><span class="nv">lr</span><span class="w">  </span><span class="nv">aaaa</span><span class="p">:</span><span class="nv">aaaa</span><span class="w">  </span><span class="nb">r15</span><span class="o">/</span><span class="nv">pc</span><span class="w">  </span><span class="mi">100</span><span class="p">:</span><span class="mi">0</span>
<span class="err">------</span><span class="w">  </span><span class="err">---------</span><span class="w">  </span><span class="err">------</span><span class="w">  </span><span class="err">---------</span><span class="w">  </span><span class="err">------</span><span class="w">  </span><span class="err">---------</span><span class="w">  </span><span class="err">------</span><span class="w">  </span><span class="err">---------</span>
</code></pre></div>

<p>And after the <code><span class="highlight-candombe-inline"><span class="nf">push</span></span></code> and <code><span class="highlight-candombe-inline"><span class="nf">add</span></span></code>, the registers were:</p>
<div class="highlight-candombe"><pre><span></span><code><span class="err">------</span><span class="w">  </span><span class="err">---------</span><span class="w">  </span><span class="err">------</span><span class="w">  </span><span class="err">---------</span><span class="w">  </span><span class="err">------</span><span class="w">  </span><span class="err">---------</span><span class="w">  </span><span class="err">------</span><span class="w">  </span><span class="err">-----</span>
<span class="w">    </span><span class="nf">r0</span><span class="w">  </span><span class="nv">cccc</span><span class="p">:</span><span class="nv">cccc</span><span class="w">  </span><span class="nb">r1</span><span class="w">      </span><span class="nv">dddd</span><span class="p">:</span><span class="nv">dddd</span><span class="w">  </span><span class="nb">r2</span><span class="w">      </span><span class="mi">0</span><span class="w">          </span><span class="nb">r3</span><span class="w">      </span><span class="mi">0</span>
<span class="w">    </span><span class="nf">r4</span><span class="w">  </span><span class="mi">0</span><span class="w">          </span><span class="nb">r5</span><span class="w">      </span><span class="mi">0</span><span class="w">          </span><span class="nb">r6</span><span class="w">      </span><span class="mi">0</span><span class="w">          </span><span class="nb">r7</span><span class="w">      </span><span class="mi">0</span>
<span class="w">    </span><span class="nf">r8</span><span class="w">  </span><span class="mi">0</span><span class="w">          </span><span class="nb">r9</span><span class="o">/</span><span class="nv">sb</span><span class="w">   </span><span class="mi">0</span><span class="w">          </span><span class="nb">r10</span><span class="w">     </span><span class="mi">0</span><span class="w">          </span><span class="nb">r11</span><span class="o">/</span><span class="nv">fp</span><span class="w">  </span><span class="mi">1</span><span class="nv">ffc</span>
<span class="nf">r12</span><span class="o">/</span><span class="nv">ip</span><span class="w">  </span><span class="mi">0</span><span class="w">          </span><span class="nb">r13</span><span class="o">/</span><span class="nb">sp</span><span class="w">  </span><span class="mi">1</span><span class="nv">ff8</span><span class="w">       </span><span class="nb">r14</span><span class="o">/</span><span class="nv">lr</span><span class="w">  </span><span class="nv">aaaa</span><span class="p">:</span><span class="nv">aaaa</span><span class="w">  </span><span class="nb">r15</span><span class="o">/</span><span class="nv">pc</span><span class="w">  </span><span class="mi">100</span><span class="p">:</span><span class="mi">4</span>
<span class="err">------</span><span class="w">  </span><span class="err">---------</span><span class="w">  </span><span class="err">------</span><span class="w">  </span><span class="err">---------</span><span class="w">  </span><span class="err">------</span><span class="w">  </span><span class="err">---------</span><span class="w">  </span><span class="err">------</span><span class="w">  </span><span class="err">-----</span>
</code></pre></div>

<p>And the stack:</p>
<div class="highlight-candombe"><pre><span></span><code><span class="mi">100</span><span class="p">:</span><span class="mi">4</span><span class="o">&gt;</span> <span class="p">;</span><span class="err">!</span> <span class="n">M</span><span class="p">[</span><span class="n">sp</span><span class="p">:]</span>
<span class="p">[</span>\<span class="n">xbb</span>\<span class="n">xbb</span>\<span class="n">xbb</span>\<span class="n">xbb</span>\<span class="n">xaa</span>\<span class="n">xaa</span>\<span class="n">xaa</span>\<span class="n">xaa</span><span class="p">]</span>
       <span class="p">(</span><span class="n">fp</span><span class="p">)</span>            <span class="p">(</span><span class="n">lr</span><span class="p">)</span>

<span class="mi">100</span><span class="p">:</span><span class="mi">4</span><span class="o">&gt;</span> <span class="p">;</span><span class="err">!</span> <span class="n">M</span><span class="p">[</span><span class="n">fp</span><span class="p">:]</span>
<span class="p">[</span>\<span class="n">xaa</span>\<span class="n">xaa</span>\<span class="n">xaa</span>\<span class="n">xaa</span><span class="p">]</span>
       <span class="p">(</span><span class="n">lr</span><span class="p">)</span>
</code></pre></div>

<p>This is <strong>not</strong> compatible with what we saw in <code class="none">rand</code> and <code class="none">sum</code>: the <code><span class="highlight-candombe-inline"><span class="nf">fp</span></span></code> points to the saved <code><span class="highlight-candombe-inline"><span class="nf">fp</span></span></code> in these functions but points to <code><span class="highlight-candombe-inline"><span class="nf">lr</span></span></code> in <code class="none">main</code>.</p>
<p>Also, in <code class="none">sum</code> we believed that 4 unused bytes were reserved to store <code><span class="highlight-candombe-inline"><span class="nf">lr</span></span></code> but here we see that the space is reserved later with <code><span class="highlight-candombe-inline"><span class="nf">sub</span><span class="w"> </span><span class="nb">sp</span><span class="p">,</span><span class="w"> </span><span class="nb">sp</span><span class="p">,</span><span class="w"> </span><span class="c1">#8</span></span></code> and does not include space for <code><span class="highlight-candombe-inline"><span class="nf">lr</span></span></code>.</p>
<h3 id="comparisons">Comparisons</h3>
<p>The call to <code class="none">rand</code> (parameterless) is done with <code><span class="highlight-candombe-inline"><span class="nf">bl</span></span></code>, branch and link.</p>
<p>The return value is in <code><span class="highlight-candombe-inline"><span class="nf">r0</span></span></code> and for some reason it is pushed and popped back from the stack into <code><span class="highlight-candombe-inline"><span class="nf">r3</span></span></code>.</p>
<p><code><span class="highlight-candombe-inline"><span class="nf">M</span><span class="p">[</span><span class="nv">fp</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">8</span><span class="p">]</span></span></code> is used as the placeholder for this and for subsequent references to the returned value of <code class="none">rand</code>.</p>
<p>Two comparisons are made for the <code class="none">if-else if</code> statement:</p>
<div class="highlight-candombe"><pre><span></span><code><span class="w">        </span><span class="nf">ldr</span><span class="w">     </span><span class="nb">r3</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nv">fp</span><span class="p">,</span><span class="w"> </span><span class="c1">#-8]</span>
<span class="w">        </span><span class="nf">cmp</span><span class="w">     </span><span class="nb">r3</span><span class="p">,</span><span class="w"> </span><span class="c1">#0</span>
<span class="w">    </span><span class="nf">...</span>
<span class="w">        </span><span class="nf">ldr</span><span class="w">     </span><span class="nb">r3</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nv">fp</span><span class="p">,</span><span class="w"> </span><span class="c1">#-8]</span>
<span class="w">        </span><span class="nf">ldr</span><span class="w">     </span><span class="nb">r2</span><span class="p">,</span><span class="w"> </span><span class="nv">.L9</span>
<span class="w">        </span><span class="nf">cmp</span><span class="w">     </span><span class="nb">r3</span><span class="p">,</span><span class="w"> </span><span class="nb">r2</span>
</code></pre></div>

<p>The first compares <code><span class="highlight-candombe-inline"><span class="nf">r3</span></span></code> (<code class="none">rand</code> returned value) with a immediate value of <code><span class="highlight-candombe-inline"><span class="err">0</span></span></code> (<code><span class="highlight-candombe-inline"><span class="nf">cmp</span><span class="w"> </span><span class="nb">r3</span><span class="p">,</span><span class="w"> </span><span class="c1">#0</span></span></code>).</p>
<p>The second compares two registers, <code><span class="highlight-candombe-inline"><span class="nf">r3</span></span></code> and <code><span class="highlight-candombe-inline"><span class="nf">r2</span></span></code>, where <code><span class="highlight-candombe-inline"><span class="nf">r2</span></span></code> is also a fixed value but it is to large to fit in the <code><span class="highlight-candombe-inline"><span class="nf">cmp</span></span></code> instruction as an immediate value.</p>
<p>In this case the value is loaded in the <code><span class="highlight-candombe-inline"><span class="nf">r2</span></span></code> register from the code segment (label <code><span class="highlight-candombe-inline"><span class="nf">.L9</span></span></code>).</p>
<div class="highlight-candombe"><pre><span></span><code><span class="nl">.L9:</span>
<span class="w">        </span><span class="nf">.word</span><span class="w">   </span><span class="mi">16449</span>
</code></pre></div>

<h3 id="function-call">Function call</h3>
<p>A function call is done with <em>branch with link</em> <code><span class="highlight-candombe-inline"><span class="nf">bl</span></span></code>.</p>
<p>Arguments are passed via <code><span class="highlight-candombe-inline"><span class="nf">r0</span></span></code> to <code><span class="highlight-candombe-inline"><span class="nf">r3</span></span></code> registers from left to right. More than 4 arguments require the stack.</p>
<div class="highlight-candombe"><pre><span></span><code><span class="w">        </span><span class="c1">; call to sum(r, 0x4041)</span>
<span class="w">        </span><span class="nf">ldr</span><span class="w">     </span><span class="nb">r1</span><span class="p">,</span><span class="w"> </span><span class="nv">.L9</span><span class="w">         </span><span class="c1">; second arg</span>
<span class="w">        </span><span class="nf">ldr</span><span class="w">     </span><span class="nb">r0</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nv">fp</span><span class="p">,</span><span class="w"> </span><span class="c1">#-8]   ; first arg</span>
<span class="w">        </span><span class="nf">bl</span><span class="w">      </span><span class="nv">sum</span>
</code></pre></div>

<p>The <code><span class="highlight-candombe-inline"><span class="nf">bl</span></span></code> saves the next instruction (the <em>return address</em>) in the <em>link</em> <code><span class="highlight-candombe-inline"><span class="nf">lr</span></span></code> register (<code><span class="highlight-candombe-inline"><span class="nf">r14</span></span></code>) and set the destination address in the <em>program counter</em> <code><span class="highlight-candombe-inline"><span class="nf">pc</span></span></code> register (<code><span class="highlight-candombe-inline"><span class="nf">r15</span></span></code>).</p>
<p><code><span class="highlight-candombe-inline"><span class="nf">bx</span><span class="w"> </span><span class="nv">lr</span></span></code> (<em>branch and exchange</em>) is used to return to the caller.</p>
<h2 id="arm-directives">Arm directives</h2>
<p>Two more fragments remains that are not part of any function.</p>
<p>These are <a href="https://sourceware.org/binutils/docs-2.27/as/ARM-Directives.html">directives for the GNU Assembler</a>, see also <a href="https://ftp.gnu.org/old-gnu/Manuals/gas-2.9.1/html_chapter/as_7.html">this</a>:</p>
<div class="highlight-candombe"><pre><span></span><code><span class="w">        </span><span class="nf">.arch</span><span class="w"> </span><span class="nv">armv6</span>
<span class="w">        </span><span class="nf">.eabi_attribute</span><span class="w"> </span><span class="mi">28</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span>
<span class="w">        </span><span class="nf">.eabi_attribute</span><span class="w"> </span><span class="mi">20</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span>
<span class="w">        </span><span class="nf">.eabi_attribute</span><span class="w"> </span><span class="mi">21</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span>
<span class="w">        </span><span class="nf">.eabi_attribute</span><span class="w"> </span><span class="mi">23</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span>
<span class="w">        </span><span class="nf">.eabi_attribute</span><span class="w"> </span><span class="mi">24</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span>
<span class="w">        </span><span class="nf">.eabi_attribute</span><span class="w"> </span><span class="mi">25</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span>
<span class="w">        </span><span class="nf">.eabi_attribute</span><span class="w"> </span><span class="mi">26</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span>
<span class="w">        </span><span class="nf">.eabi_attribute</span><span class="w"> </span><span class="mi">30</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span>
<span class="w">        </span><span class="nf">.eabi_attribute</span><span class="w"> </span><span class="mi">34</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span>
<span class="w">        </span><span class="nf">.eabi_attribute</span><span class="w"> </span><span class="mi">18</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span>
<span class="w">        </span><span class="nf">.file</span><span class="w">   </span><span class="s">&quot;asm1.c&quot;</span>
<span class="w">        </span><span class="nf">.text</span>
</code></pre></div>

<div class="highlight-candombe"><pre><span></span><code><span class="w">        </span><span class="nf">.ident</span><span class="w">  </span><span class="s">&quot;GCC: (Raspbian 8.3.0-6+rpi1) 8.3.0&quot;</span>
<span class="w">        </span><span class="nf">.section</span><span class="w">        </span><span class="nv">.note.GNU</span><span class="o">-</span><span class="nv">stack</span><span class="p">,</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="o">%</span><span class="nv">progbits</span>
</code></pre></div>

<h2 id="final-thoughts">Final thoughts</h2>
<p>I have being reading <a href="https://developer.arm.com/documentation/ihi0042/latest/">documentation</a> and <a href="https://www.coranac.com/tonc/text/asm.htm">write ups</a> about Arm during the last weeks.</p>
<p>When I <a href="/articles/2020/12/27/TLDR-Quick-Overview-of-Arm.html">started</a> my idea was to use a <a href="/articles/2020/12/15/Qemulating-Rasbian-ARM.html">QEMU virtual machine for testing</a>: code a little of assembly, compile it, debugging it with GDB and seeing the effects.</p>
<p>It turns out to be tedious very quickly.</p>
<p>I relayed then more in the documentation and the <a href="https://documentation-service.arm.com/static/5ed66080ca06a95ce53f932d?token=">instruction set reference</a> but when I review real code (like the one in this post) some things made no sense.</p>
<p>Obviously there were errors in my interpretation of the code.</p>
<p>That’s why I coded an <a href="https://github.com/bad-address/iasm">interactive assembler</a> to have a quick feedback of what each instruction does without requiring a compile-upload-debug cycle.</p>
<p>It really help me to “smooth out certain rough edges” and understand better the code specially when the indexing flavors and how the things are pushed and popped from the stack.</p>
<p class="small-subtitle-with-top-margin">
Related tags: <a href='https://book-of-gehn.github.io/?tag="ARM"'>ARM</a>, <a href='https://book-of-gehn.github.io/?tag="reversing"'>reversing</a>, <a href='https://book-of-gehn.github.io/?tag="iasm"'>iasm</a>
</p>
<script src="https://utteranc.es/client.js"
        repo="book-of-gehn/book-of-gehn.github.io"
        issue-term="pathname"
        label="comments-utteranc"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
</article>
<span class="print-footer">Review Arm Assembly - January 4, 2021 - Martin Di Paola</span>
<footer>
    <hr class="slender">
    <div class="credits">
        <span>&copy;
            Martin Di Paola
        </span></br>
            <a class="raw_link" href="/atom.xml"><img height="16px" width="16px" src="/img/rss-32px.png" /></a>
            <a class="raw_link" href="https://github.com/eldipa"><img height="16px" width="16px" src="/img/github.png" /></a>
        <br>
        
        <a href="mailto:martinp.dipaola@gmail.com">martinp.dipaola@gmail.com</a></span></br> <br>
        
    </div>

    <img src='http://192.34.63.156:6127/img/http%3A//127.0.0.1%3A4000/articles/2021/01/04/Review-Arm-Assembly.html.png' onerror="this.style.display='none'" async></img>
</footer>
</body>
</html>
