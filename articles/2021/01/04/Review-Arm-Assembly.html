<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Review Arm Assembly</title>
  <meta name="description" content="There is no other way to learn something that playing with it.Take assembly code, read it and predice what will do. Then test it.Those mistakes, those mismat...">

  
    <link href='//fonts.googleapis.com/css?family=Lato:400,400italic' rel='stylesheet' type='text/css'>
  

  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        extensions: ["tex2jax.js"],
        jax: ["input/TeX","output/HTML-CSS"],
        tex2jax: {inlineMath: [["$$","$$"],["\\(","\\)"]]},
	TeX: {
	  Macros: {
            
	  }
	}
      });
    </script>
    
      <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js' async></script>
    
  

  
    <script
       src="https://code.jquery.com/jquery-3.4.1.min.js"
       integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
       crossorigin="anonymous"></script>
  

  

    
      <script src='https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.9.1/underscore-min.js' ></script>
    

    
      <script src="https://d3js.org/d3.v4.min.js"></script>
    

    <script src='/book-of-gehn/js/venn/venn.min.js'></script>
    <script src='/book-of-gehn/js/venn/helper.js'></script>

    <script src='/book-of-gehn/js/fix_syntax_highlight.js'></script>
  <link rel="stylesheet" type="text/css" href="/book-of-gehn/css/tufte.css">
  <link rel="stylesheet" type="text/css" href="/book-of-gehn/css/latex.css">

  <link rel="canonical" href="/book-of-gehn/articles/2021/01/04/Review-Arm-Assembly.html">

  <link rel="stylesheet" type="text/css" href="/book-of-gehn/css/all.min.css">

  <link type="application/atom+xml" rel="alternate" href="/book-of-gehn/feed.xml" title="The Book of Gehn" />
</head>

  <body>
    <header>
	
		<h1 class="header-title"><a href="/book-of-gehn/">The Book of Gehn</a></h1>
		
		
	

    

    
</header>

    <article class="group">
      <h1>Review Arm Assembly</h1>
<p class="subtitle">January 4, 2021</p>

<p>There is no other way to learn something that playing with it.</p>

<p>Take assembly code, read it and predice what will do. Then test it.</p>

<p>Those mistakes, those mismatches between what you think and what it
really is, those <em>surprises</em> are what move us forward into learning. Deeper.</p>

<p>In this post I will dig into Arm, assisted with an
<a href="https://github.com/bad-address/iasm">interactive assembler</a>.<!--more--></p>

<h2 id="gcc-generated-arm-assembly">GCC generated Arm assembly</h2>

<p>We will see the assembly of the following C code compiled as:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pi@raspberrypi:~<span class="nv">$ </span>gcc <span class="nt">-S</span> <span class="nt">-O0</span> <span class="nt">-o</span> asm1.asm asm1.c
</code></pre></div></div>

<p><code class="highlighter-rouge">raspberrypi</code> is a QEMU virtual machine for Arm running a Raspbian
Stretch. The setup is explained in my previous post
<a href="/book-of-gehn/articles/2020/12/15/Qemulating-Rasbian-ARM.html">QEMUlating a Rasbian (ARM)</a>.</p>

<p>The code is quite simple:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="nf">rand</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="mh">0x42</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">sum</span><span class="p">(</span><span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">a</span><span class="o">+</span><span class="n">b</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="n">rand</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&gt;</span> <span class="mh">0x4041</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">sum</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mh">0x4041</span><span class="p">);</span>
  <span class="k">else</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Let’s dig into the assembly. I will use an
<a href="https://github.com/bad-address/iasm">interactive assembler</a>.</p>

<h2 id="the-rand-function">The <code class="highlighter-rouge">rand</code> function</h2>

<div class="language-nasm highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="p">.</span><span class="n">align</span>  <span class="mi">2</span>
        <span class="p">.</span><span class="kr">global</span> <span class="n">rand</span>
        <span class="p">.</span><span class="n">arch</span> <span class="n">armv6</span>
        <span class="p">.</span><span class="n">syntax</span> <span class="n">unified</span>
        <span class="p">.</span><span class="n">arm</span>
        <span class="p">.</span><span class="n">fpu</span> <span class="n">vfp</span>
        <span class="p">.</span><span class="n">type</span>   <span class="n">rand</span><span class="p">,</span> <span class="err">%</span><span class="n">function</span>
<span class="n">rand</span><span class="o">:</span>
        <span class="c">; link register save eliminated.</span>
        <span class="k">str</span>     <span class="n">fp</span><span class="p">,</span> <span class="err">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="o">-</span><span class="mi">4</span><span class="err">]!</span>
        <span class="k">add</span>     <span class="n">fp</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">0</span>
        <span class="k">mov</span>     <span class="n">r3</span><span class="p">,</span> <span class="err">#</span><span class="mi">66</span>
        <span class="k">mov</span>     <span class="n">r0</span><span class="p">,</span> <span class="n">r3</span>
        <span class="k">add</span>     <span class="n">sp</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="err">#</span><span class="mi">0</span>
        <span class="n">ldr</span>     <span class="n">fp</span><span class="p">,</span> <span class="p">[sp],</span> <span class="err">#</span><span class="mi">4</span>
        <span class="n">bx</span>      <span class="n">lr</span>
        <span class="p">.</span><span class="n">size</span>   <span class="n">rand</span><span class="p">,</span> <span class="p">.</span><span class="o">-</span><span class="n">rand</span>
</code></pre></div></div>

<p>First, the code is aligned and the symbol is marked as “global”.
<code class="highlighter-rouge">.arm</code> says that the code is Arm (aka <code class="highlighter-rouge">.code 32</code>).</p>

<h3 id="prologue">Prologue</h3>

<p>The function begins saving the <em>frame pointer</em> <code class="highlighter-rouge">fp</code> in the stack.</p>

<p>The <code class="highlighter-rouge">str fp, [sp, #-4]!</code> is a <em>pre-index</em> addressing store: the <code class="highlighter-rouge">fp</code>
is saved 4 bytes “up” in the stack (the stack grows towards lower
addresses).</p>

<p>And the store is in <em>pre write-back</em> store (<code class="highlighter-rouge">!</code>): the <code class="highlighter-rouge">sp</code> is
updated (decremented by 4) <em>before</em> performing the store.</p>

<p>The <code class="highlighter-rouge">sp</code> points always to the latest <em>valid</em> value in the stack. That’s
why <code class="highlighter-rouge">sp</code> is decremented before performing the store.</p>

<p>The <code class="highlighter-rouge">add fp, sp, #0</code> is an alternative to <code class="highlighter-rouge">mov fp, sp</code>.</p>

<p>At the begin of the call:</p>

<div class="language-nasm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">------</span>  <span class="o">-</span>  <span class="o">------</span>  <span class="o">----</span>  <span class="o">------</span>  <span class="o">---------</span>  <span class="o">------</span>  <span class="o">---------</span>
    <span class="n">r0</span>  <span class="mi">0</span>  <span class="n">r1</span>      <span class="mi">0</span>     <span class="n">r2</span>      <span class="mi">0</span>          <span class="n">r3</span>      <span class="mi">0</span>
    <span class="n">r4</span>  <span class="mi">0</span>  <span class="n">r5</span>      <span class="mi">0</span>     <span class="n">r6</span>      <span class="mi">0</span>          <span class="n">r7</span>      <span class="mi">0</span>
    <span class="n">r8</span>  <span class="mi">0</span>  <span class="n">r9</span><span class="o">/</span><span class="n">sb</span>   <span class="mi">0</span>     <span class="n">r10</span>     <span class="mi">0</span>          <span class="n">r11</span><span class="o">/</span><span class="n">fp</span>  <span class="n">bbbb</span><span class="o">:</span><span class="n">bbbb</span>
<span class="n">r12</span><span class="o">/</span><span class="n">ip</span>  <span class="mi">0</span>  <span class="n">r13</span><span class="o">/</span><span class="n">sp</span>  <span class="mi">2000</span>  <span class="n">r14</span><span class="o">/</span><span class="n">lr</span>  <span class="n">aaaa</span><span class="o">:</span><span class="n">aaaa</span>  <span class="n">r15</span><span class="o">/</span><span class="n">pc</span>  <span class="mi">100</span><span class="o">:</span><span class="mi">0</span>
<span class="o">------</span>  <span class="o">-</span>  <span class="o">------</span>  <span class="o">----</span>  <span class="o">------</span>  <span class="o">---------</span>  <span class="o">------</span>  <span class="o">---------</span>
</code></pre></div></div>

<p>After the <code class="highlighter-rouge">fp</code> and <code class="highlighter-rouge">sp</code> update:</p>

<div class="language-nasm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">------</span>  <span class="o">-</span>  <span class="o">------</span>  <span class="o">----</span>  <span class="o">------</span>  <span class="o">---------</span>  <span class="o">------</span>  <span class="o">-----</span>
    <span class="n">r0</span>  <span class="mi">0</span>  <span class="n">r1</span>      <span class="mi">0</span>     <span class="n">r2</span>      <span class="mi">0</span>          <span class="n">r3</span>      <span class="mi">0</span>
    <span class="n">r4</span>  <span class="mi">0</span>  <span class="n">r5</span>      <span class="mi">0</span>     <span class="n">r6</span>      <span class="mi">0</span>          <span class="n">r7</span>      <span class="mi">0</span>
    <span class="n">r8</span>  <span class="mi">0</span>  <span class="n">r9</span><span class="o">/</span><span class="n">sb</span>   <span class="mi">0</span>     <span class="n">r10</span>     <span class="mi">0</span>          <span class="n">r11</span><span class="o">/</span><span class="n">fp</span>  <span class="mi">1</span><span class="n">ffc</span>
<span class="n">r12</span><span class="o">/</span><span class="n">ip</span>  <span class="mi">0</span>  <span class="n">r13</span><span class="o">/</span><span class="n">sp</span>  <span class="mi">1</span><span class="n">ffc</span>  <span class="n">r14</span><span class="o">/</span><span class="n">lr</span>  <span class="n">aaaa</span><span class="o">:</span><span class="n">aaaa</span>  <span class="n">r15</span><span class="o">/</span><span class="n">pc</span>  <span class="mi">100</span><span class="o">:</span><span class="mi">4</span>
<span class="o">------</span>  <span class="o">-</span>  <span class="o">------</span>  <span class="o">----</span>  <span class="o">------</span>  <span class="o">---------</span>  <span class="o">------</span>  <span class="o">-----</span>
</code></pre></div></div>

<p><label for="mn-275f0f8b94cfa074405e20db30591048" class="margin-toggle"> ⊕</label><input type="checkbox" id="mn-275f0f8b94cfa074405e20db30591048" class="margin-toggle" /><span class="marginnote"><a href="https://github.com/bad-address/iasm">iasm</a>, the interactive assembler,
allows to explore the memory with the <code class="highlighter-rouge">M</code> object. <code class="highlighter-rouge">M[sp:]</code> means show
the memory from the address stored in <code class="highlighter-rouge">sp</code> to the last address mapped
page.
<br />
In other words: show the stack.
 </span></p>

<p>And the state of the stack is:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mi">100</span><span class="p">:</span><span class="mi">4</span><span class="o">&gt;</span> <span class="p">;</span><span class="err">!</span> <span class="n">M</span><span class="p">[</span><span class="n">sp</span><span class="p">:]</span>
<span class="p">[</span>\<span class="n">xbb</span>\<span class="n">xbb</span>\<span class="n">xbb</span>\<span class="n">xbb</span><span class="p">]</span>
       <span class="p">(</span><span class="n">fp</span><span class="p">)</span>

<span class="mi">100</span><span class="p">:</span><span class="mi">4</span><span class="o">&gt;</span> <span class="p">;</span><span class="err">!</span> <span class="n">M</span><span class="p">[</span><span class="n">fp</span><span class="p">:]</span>
<span class="p">[</span>\<span class="n">xbb</span>\<span class="n">xbb</span>\<span class="n">xbb</span>\<span class="n">xbb</span><span class="p">]</span>
       <span class="p">(</span><span class="n">fp</span><span class="p">)</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">sp</code> points always to the latest value of the stack; <code class="highlighter-rouge">fp</code> points to the
previous <code class="highlighter-rouge">fp</code> value (<code class="highlighter-rouge">0xbbbbbbbb</code> in this case).</p>

<h3 id="body">Body</h3>

<p>The assembler didn’t optimize the code: it stored in <code class="highlighter-rouge">r3</code> the immediate
value of <code class="highlighter-rouge">#66</code> (0x42) to then copy it to <code class="highlighter-rouge">r0</code> (the register used for
returning values). <code class="highlighter-rouge">mov r0, #66</code> would be shorter.</p>

<h3 id="epilogue">Epilogue</h3>

<p>Then the <code class="highlighter-rouge">sp</code> is restored to the current <code class="highlighter-rouge">fp</code> and the <code class="highlighter-rouge">fp</code> is restored
to the previous <code class="highlighter-rouge">fp</code> value with <code class="highlighter-rouge">ldr fp, [sp], #4</code></p>

<p>This load is a <em>pre-index</em> addressing with <em>post write-back</em>. That’s it,
the <code class="highlighter-rouge">fp</code> is loaded with the valued pointed by <code class="highlighter-rouge">sp</code> and then <code class="highlighter-rouge">sp</code> is
added 4 bytes (aka pop).</p>

<p>The compiler however should optimize this because the stack is not used
at all so saving and restoring <code class="highlighter-rouge">fp</code> has no value.</p>

<p>What the compiled did, it didn’t save the <em>link</em> register <code class="highlighter-rouge">lr</code>.</p>

<p>The register holds the address to where return from a call. Because
<code class="highlighter-rouge">rand</code> doesn’t call anything, <code class="highlighter-rouge">lr</code> from the caller is preserved so it is
not needed to save it in the stack.</p>

<p><code class="highlighter-rouge">bx lr</code> returns to the caller.</p>

<h2 id="the-sum-function">The <code class="highlighter-rouge">sum</code> function</h2>

<div class="language-nasm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">sum</span><span class="o">:</span>
        <span class="k">str</span>     <span class="n">fp</span><span class="p">,</span> <span class="err">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="o">-</span><span class="mi">4</span><span class="err">]!</span>
        <span class="k">add</span>     <span class="n">fp</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">0</span>
        <span class="k">sub</span>     <span class="n">sp</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">12</span>
        <span class="k">str</span>     <span class="n">r0</span><span class="p">,</span> <span class="err">[</span><span class="n">fp</span><span class="p">,</span> <span class="err">#</span><span class="o">-</span><span class="mi">8</span><span class="err">]</span>
        <span class="k">str</span>     <span class="n">r1</span><span class="p">,</span> <span class="err">[</span><span class="n">fp</span><span class="p">,</span> <span class="err">#</span><span class="o">-</span><span class="mi">12</span><span class="err">]</span>
        <span class="n">ldr</span>     <span class="n">r2</span><span class="p">,</span> <span class="err">[</span><span class="n">fp</span><span class="p">,</span> <span class="err">#</span><span class="o">-</span><span class="mi">8</span><span class="err">]</span>
        <span class="n">ldr</span>     <span class="n">r3</span><span class="p">,</span> <span class="err">[</span><span class="n">fp</span><span class="p">,</span> <span class="err">#</span><span class="o">-</span><span class="mi">12</span><span class="err">]</span>
        <span class="k">add</span>     <span class="n">r3</span><span class="p">,</span> <span class="n">r2</span><span class="p">,</span> <span class="n">r3</span>
        <span class="k">mov</span>     <span class="n">r0</span><span class="p">,</span> <span class="n">r3</span>
        <span class="k">add</span>     <span class="n">sp</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="err">#</span><span class="mi">0</span>
        <span class="n">ldr</span>     <span class="n">fp</span><span class="p">,</span> <span class="p">[sp],</span> <span class="err">#</span><span class="mi">4</span>
        <span class="n">bx</span>      <span class="n">lr</span>
        <span class="p">.</span><span class="n">size</span>   <span class="n">sum</span><span class="p">,</span> <span class="p">.</span><span class="o">-</span><span class="n">sum</span>
</code></pre></div></div>

<h3 id="prologue-1">Prologue</h3>

<p>In this case the function allocates 12 bytes to hold local variables
(<code class="highlighter-rouge">sub sp, sp, #12</code>).</p>

<p>The second argument <code class="highlighter-rouge">r1</code> is stored in the top of the stack; the first
argument <code class="highlighter-rouge">r0</code> is stored below. Arguments are pushed from left (<code class="highlighter-rouge">r0</code>) to
right (<code class="highlighter-rouge">r1</code>).</p>

<p>The call convention says that the arguments are passed via registers (up
to 4 args). They are set by the caller and, if needed, the callee needs
to preserve them in the stack.</p>

<p>No really needed here because <code class="highlighter-rouge">sum</code> does not call other function but
still the compiler follows the cookbook.</p>

<p>The function allocated 12 byte to hold 3 variables of 32 bits. We stored
2, the arguments, but the third element is never set.</p>

<p>The registers at the begin of the call were:</p>

<div class="language-nasm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">------</span>  <span class="o">---------</span>  <span class="o">------</span>  <span class="o">---------</span>  <span class="o">------</span>  <span class="o">---------</span>  <span class="o">------</span>  <span class="o">---------</span>
    <span class="n">r0</span>  <span class="n">cccc</span><span class="o">:</span><span class="n">cccc</span>  <span class="n">r1</span>      <span class="n">dddd</span><span class="o">:</span><span class="n">dddd</span>  <span class="n">r2</span>      <span class="mi">0</span>          <span class="n">r3</span>      <span class="mi">0</span>
    <span class="n">r4</span>  <span class="mi">0</span>          <span class="n">r5</span>      <span class="mi">0</span>          <span class="n">r6</span>      <span class="mi">0</span>          <span class="n">r7</span>      <span class="mi">0</span>
    <span class="n">r8</span>  <span class="mi">0</span>          <span class="n">r9</span><span class="o">/</span><span class="n">sb</span>   <span class="mi">0</span>          <span class="n">r10</span>     <span class="mi">0</span>          <span class="n">r11</span><span class="o">/</span><span class="n">fp</span>  <span class="n">bbbb</span><span class="o">:</span><span class="n">bbbb</span>
<span class="n">r12</span><span class="o">/</span><span class="n">ip</span>  <span class="mi">0</span>          <span class="n">r13</span><span class="o">/</span><span class="n">sp</span>  <span class="mi">2000</span>       <span class="n">r14</span><span class="o">/</span><span class="n">lr</span>  <span class="n">aaaa</span><span class="o">:</span><span class="n">aaaa</span>  <span class="n">r15</span><span class="o">/</span><span class="n">pc</span>  <span class="mi">100</span><span class="o">:</span><span class="mi">0</span>
<span class="o">------</span>  <span class="o">---------</span>  <span class="o">------</span>  <span class="o">---------</span>  <span class="o">------</span>  <span class="o">---------</span>  <span class="o">------</span>  <span class="o">---------</span>
</code></pre></div></div>

<p>And after the stores, the stack has:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mi">100</span><span class="p">:</span><span class="mi">10</span><span class="o">&gt;</span> <span class="p">;</span><span class="err">!</span> <span class="n">M</span><span class="p">[</span><span class="n">sp</span><span class="p">:]</span>
<span class="p">[</span>\<span class="n">xdd</span>\<span class="n">xdd</span>\<span class="n">xdd</span>\<span class="n">xdd</span>\<span class="n">xcc</span>\<span class="n">xcc</span>\<span class="n">xcc</span>\<span class="n">xcc</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">xbb</span>\<span class="n">xbb</span>\<span class="n">xbb</span>\<span class="n">xbb</span><span class="p">]</span>
       <span class="p">(</span><span class="n">r1</span><span class="p">)</span>            <span class="p">(</span><span class="n">r0</span><span class="p">)</span>            <span class="p">(</span><span class="err">??</span><span class="p">)</span>            <span class="p">(</span><span class="n">fp</span><span class="p">)</span>

<span class="mi">100</span><span class="p">:</span><span class="mi">10</span><span class="o">&gt;</span> <span class="p">;</span><span class="err">!</span> <span class="n">M</span><span class="p">[</span><span class="n">fp</span><span class="p">:]</span>
<span class="p">[</span>\<span class="n">xbb</span>\<span class="n">xbb</span>\<span class="n">xbb</span>\<span class="n">xbb</span><span class="p">]</span>
       <span class="p">(</span><span class="n">fp</span><span class="p">)</span>
</code></pre></div></div>

<p>I presume that the unused space (??) is for the <code class="highlighter-rouge">lr</code> register.</p>

<h2 id="the-main-function">The <code class="highlighter-rouge">main</code> function</h2>

<div class="language-nasm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">main</span><span class="o">:</span>
        <span class="k">push</span>    <span class="err">{</span><span class="n">fp</span><span class="p">,</span> <span class="n">lr</span><span class="err">}</span>
        <span class="k">add</span>     <span class="n">fp</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">4</span>
        <span class="k">sub</span>     <span class="n">sp</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">8</span>
        <span class="n">bl</span>      <span class="n">rand</span>
        <span class="k">str</span>     <span class="n">r0</span><span class="p">,</span> <span class="err">[</span><span class="n">fp</span><span class="p">,</span> <span class="err">#</span><span class="o">-</span><span class="mi">8</span><span class="err">]</span>
        <span class="n">ldr</span>     <span class="n">r3</span><span class="p">,</span> <span class="err">[</span><span class="n">fp</span><span class="p">,</span> <span class="err">#</span><span class="o">-</span><span class="mi">8</span><span class="err">]</span>
        <span class="k">cmp</span>     <span class="n">r3</span><span class="p">,</span> <span class="err">#</span><span class="mi">0</span>
        <span class="n">bne</span>     <span class="p">.</span><span class="n">L6</span>
        <span class="k">mov</span>     <span class="n">r3</span><span class="p">,</span> <span class="err">#</span><span class="mi">0</span>
        <span class="n">b</span>       <span class="p">.</span><span class="n">L7</span>
<span class="p">.</span><span class="n">L6</span><span class="o">:</span>
        <span class="n">ldr</span>     <span class="n">r3</span><span class="p">,</span> <span class="err">[</span><span class="n">fp</span><span class="p">,</span> <span class="err">#</span><span class="o">-</span><span class="mi">8</span><span class="err">]</span>
        <span class="n">ldr</span>     <span class="n">r2</span><span class="p">,</span> <span class="p">.</span><span class="n">L9</span>
        <span class="k">cmp</span>     <span class="n">r3</span><span class="p">,</span> <span class="n">r2</span>
        <span class="n">ble</span>     <span class="p">.</span><span class="n">L8</span>
        <span class="n">ldr</span>     <span class="n">r1</span><span class="p">,</span> <span class="p">.</span><span class="n">L9</span>
        <span class="n">ldr</span>     <span class="n">r0</span><span class="p">,</span> <span class="err">[</span><span class="n">fp</span><span class="p">,</span> <span class="err">#</span><span class="o">-</span><span class="mi">8</span><span class="err">]</span>
        <span class="n">bl</span>      <span class="n">sum</span>
        <span class="k">mov</span>     <span class="n">r3</span><span class="p">,</span> <span class="n">r0</span>
        <span class="n">b</span>       <span class="p">.</span><span class="n">L7</span>
<span class="p">.</span><span class="n">L8</span><span class="o">:</span>
        <span class="n">mvn</span>     <span class="n">r3</span><span class="p">,</span> <span class="err">#</span><span class="mi">0</span>
<span class="p">.</span><span class="n">L7</span><span class="o">:</span>
        <span class="k">mov</span>     <span class="n">r0</span><span class="p">,</span> <span class="n">r3</span>
        <span class="k">sub</span>     <span class="n">sp</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="err">#</span><span class="mi">4</span>
        <span class="k">pop</span>     <span class="err">{</span><span class="n">fp</span><span class="p">,</span> <span class="n">pc</span><span class="err">}</span>
<span class="p">.</span><span class="n">L10</span><span class="o">:</span>
        <span class="p">.</span><span class="n">align</span>  <span class="mi">2</span>
</code></pre></div></div>

<h3 id="prologue-2">Prologue</h3>

<p>The function saves <code class="highlighter-rouge">fp</code> and <code class="highlighter-rouge">lr</code> with a single <code class="highlighter-rouge">push {fp,lr}</code>.</p>

<p>The <code class="highlighter-rouge">{r,r}</code> notation is a <em>set</em>, not a <em>list</em>: registers are pushed in
the <em>inverse</em> order of the registers (<code class="highlighter-rouge">r0</code> to <code class="highlighter-rouge">r15</code>)
regardless of how the <code class="highlighter-rouge">push</code> is written.</p>

<p>In our case <code class="highlighter-rouge">fp</code> is <code class="highlighter-rouge">r11</code> and <code class="highlighter-rouge">lr</code> is <code class="highlighter-rouge">r14</code> so that is the natural order,
then the inverse order applies: <code class="highlighter-rouge">r14</code> is pushed first, <code class="highlighter-rouge">r11</code> later.</p>

<p>In short: <code class="highlighter-rouge">r14</code> will be at the bottom of the stack (higher addresses)
while <code class="highlighter-rouge">r11</code> will be at the top (lower addresses).</p>

<p>The <code class="highlighter-rouge">fp</code> is then updated to the base of the stack for the current
function call. The stack frame begins <em>after</em> storing the previous <code class="highlighter-rouge">fp</code>
so the current <code class="highlighter-rouge">fp</code> points to the saved <code class="highlighter-rouge">lr</code>.</p>

<p>The <code class="highlighter-rouge">fp</code> update is done with <code class="highlighter-rouge">add fp, sp, #4</code> (by this moment the <code class="highlighter-rouge">sp</code>
is off by 4 due the push of <code class="highlighter-rouge">lr</code>).</p>

<p>The registers at the begin of the call were:</p>

<div class="language-nasm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">------</span>  <span class="o">---------</span>  <span class="o">------</span>  <span class="o">---------</span>  <span class="o">------</span>  <span class="o">---------</span>  <span class="o">------</span>  <span class="o">---------</span>
    <span class="n">r0</span>  <span class="n">cccc</span><span class="o">:</span><span class="n">cccc</span>  <span class="n">r1</span>      <span class="n">dddd</span><span class="o">:</span><span class="n">dddd</span>  <span class="n">r2</span>      <span class="mi">0</span>          <span class="n">r3</span>      <span class="mi">0</span>
    <span class="n">r4</span>  <span class="mi">0</span>          <span class="n">r5</span>      <span class="mi">0</span>          <span class="n">r6</span>      <span class="mi">0</span>          <span class="n">r7</span>      <span class="mi">0</span>
    <span class="n">r8</span>  <span class="mi">0</span>          <span class="n">r9</span><span class="o">/</span><span class="n">sb</span>   <span class="mi">0</span>          <span class="n">r10</span>     <span class="mi">0</span>          <span class="n">r11</span><span class="o">/</span><span class="n">fp</span>  <span class="n">bbbb</span><span class="o">:</span><span class="n">bbbb</span>
<span class="n">r12</span><span class="o">/</span><span class="n">ip</span>  <span class="mi">0</span>          <span class="n">r13</span><span class="o">/</span><span class="n">sp</span>  <span class="mi">2000</span>       <span class="n">r14</span><span class="o">/</span><span class="n">lr</span>  <span class="n">aaaa</span><span class="o">:</span><span class="n">aaaa</span>  <span class="n">r15</span><span class="o">/</span><span class="n">pc</span>  <span class="mi">100</span><span class="o">:</span><span class="mi">0</span>
<span class="o">------</span>  <span class="o">---------</span>  <span class="o">------</span>  <span class="o">---------</span>  <span class="o">------</span>  <span class="o">---------</span>  <span class="o">------</span>  <span class="o">---------</span>
</code></pre></div></div>

<p>And after the <code class="highlighter-rouge">push</code> and <code class="highlighter-rouge">add</code>, the registers were:</p>

<div class="language-nasm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">------</span>  <span class="o">---------</span>  <span class="o">------</span>  <span class="o">---------</span>  <span class="o">------</span>  <span class="o">---------</span>  <span class="o">------</span>  <span class="o">-----</span>
    <span class="n">r0</span>  <span class="n">cccc</span><span class="o">:</span><span class="n">cccc</span>  <span class="n">r1</span>      <span class="n">dddd</span><span class="o">:</span><span class="n">dddd</span>  <span class="n">r2</span>      <span class="mi">0</span>          <span class="n">r3</span>      <span class="mi">0</span>
    <span class="n">r4</span>  <span class="mi">0</span>          <span class="n">r5</span>      <span class="mi">0</span>          <span class="n">r6</span>      <span class="mi">0</span>          <span class="n">r7</span>      <span class="mi">0</span>
    <span class="n">r8</span>  <span class="mi">0</span>          <span class="n">r9</span><span class="o">/</span><span class="n">sb</span>   <span class="mi">0</span>          <span class="n">r10</span>     <span class="mi">0</span>          <span class="n">r11</span><span class="o">/</span><span class="n">fp</span>  <span class="mi">1</span><span class="n">ffc</span>
<span class="n">r12</span><span class="o">/</span><span class="n">ip</span>  <span class="mi">0</span>          <span class="n">r13</span><span class="o">/</span><span class="n">sp</span>  <span class="mi">1</span><span class="n">ff8</span>       <span class="n">r14</span><span class="o">/</span><span class="n">lr</span>  <span class="n">aaaa</span><span class="o">:</span><span class="n">aaaa</span>  <span class="n">r15</span><span class="o">/</span><span class="n">pc</span>  <span class="mi">100</span><span class="o">:</span><span class="mi">4</span>
<span class="o">------</span>  <span class="o">---------</span>  <span class="o">------</span>  <span class="o">---------</span>  <span class="o">------</span>  <span class="o">---------</span>  <span class="o">------</span>  <span class="o">-----</span>
</code></pre></div></div>

<p>And the stack:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mi">100</span><span class="p">:</span><span class="mi">4</span><span class="o">&gt;</span> <span class="p">;</span><span class="err">!</span> <span class="n">M</span><span class="p">[</span><span class="n">sp</span><span class="p">:]</span>
<span class="p">[</span>\<span class="n">xbb</span>\<span class="n">xbb</span>\<span class="n">xbb</span>\<span class="n">xbb</span>\<span class="n">xaa</span>\<span class="n">xaa</span>\<span class="n">xaa</span>\<span class="n">xaa</span><span class="p">]</span>
       <span class="p">(</span><span class="n">fp</span><span class="p">)</span>            <span class="p">(</span><span class="n">lr</span><span class="p">)</span>

<span class="mi">100</span><span class="p">:</span><span class="mi">4</span><span class="o">&gt;</span> <span class="p">;</span><span class="err">!</span> <span class="n">M</span><span class="p">[</span><span class="n">fp</span><span class="p">:]</span>
<span class="p">[</span>\<span class="n">xaa</span>\<span class="n">xaa</span>\<span class="n">xaa</span>\<span class="n">xaa</span><span class="p">]</span>
       <span class="p">(</span><span class="n">lr</span><span class="p">)</span>
</code></pre></div></div>

<p>This is <strong>not</strong> compatible with what we saw in <code class="highlighter-rouge">rand</code> and <code class="highlighter-rouge">sum</code>: the
<code class="highlighter-rouge">fp</code> points to the saved <code class="highlighter-rouge">fp</code> in these functions but points to <code class="highlighter-rouge">lr</code> in
<code class="highlighter-rouge">main</code>.</p>

<p>Also, in <code class="highlighter-rouge">sum</code> we believed that 4 unused bytes were reserved to store
<code class="highlighter-rouge">lr</code> but here we see that the space is reserved later with
<code class="highlighter-rouge">sub sp, sp, #8</code> and does not include space for <code class="highlighter-rouge">lr</code>.</p>

<h3 id="comparisons">Comparisons</h3>

<p>The call to <code class="highlighter-rouge">rand</code> (parameterless) is done with <code class="highlighter-rouge">bl</code>, branch and link.</p>

<p>The return value is in <code class="highlighter-rouge">r0</code> and for some reason it is pushed and popped
back from the stack into <code class="highlighter-rouge">r3</code>.</p>

<p><code class="highlighter-rouge">M[fp - 8]</code> is used as the placeholder for this and for subsequent
references to the returned value of <code class="highlighter-rouge">rand</code>.</p>

<p>Two comparisons are made for the <code class="highlighter-rouge">if-else if</code> statement:</p>

<div class="language-nasm highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="n">ldr</span>     <span class="n">r3</span><span class="p">,</span> <span class="err">[</span><span class="n">fp</span><span class="p">,</span> <span class="err">#</span><span class="o">-</span><span class="mi">8</span><span class="err">]</span>
        <span class="k">cmp</span>     <span class="n">r3</span><span class="p">,</span> <span class="err">#</span><span class="mi">0</span>
    <span class="p">...</span>
        <span class="n">ldr</span>     <span class="n">r3</span><span class="p">,</span> <span class="err">[</span><span class="n">fp</span><span class="p">,</span> <span class="err">#</span><span class="o">-</span><span class="mi">8</span><span class="err">]</span>
        <span class="n">ldr</span>     <span class="n">r2</span><span class="p">,</span> <span class="p">.</span><span class="n">L9</span>
        <span class="k">cmp</span>     <span class="n">r3</span><span class="p">,</span> <span class="n">r2</span>
</code></pre></div></div>

<p>The first compares <code class="highlighter-rouge">r3</code> (<code class="highlighter-rouge">rand</code> returned value) with a immediate value
of <code class="highlighter-rouge">0</code> (<code class="highlighter-rouge">cmp r3, #0</code>).</p>

<p>The second compares two registers, <code class="highlighter-rouge">r3</code> and <code class="highlighter-rouge">r2</code>, where <code class="highlighter-rouge">r2</code> is also a
fixed value but it is to large to fit in the <code class="highlighter-rouge">cmp</code> instruction as an
immediate value.</p>

<p>In this case the value is loaded in the <code class="highlighter-rouge">r2</code> register from the code
segment (label <code class="highlighter-rouge">.L9</code>).</p>

<div class="language-nasm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">.</span><span class="n">L9</span><span class="o">:</span>
        <span class="p">.</span><span class="n">word</span>   <span class="mi">16449</span>
</code></pre></div></div>

<h3 id="function-call">Function call</h3>

<p>A function call is done with <em>branch with link</em> <code class="highlighter-rouge">bl</code>.</p>

<p>Arguments are passed via <code class="highlighter-rouge">r0</code> to <code class="highlighter-rouge">r3</code> registers from left to right.
More than 4 arguments require the stack.</p>

<div class="language-nasm highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="c">; call to sum(r, 0x4041)</span>
        <span class="n">ldr</span>     <span class="n">r1</span><span class="p">,</span> <span class="p">.</span><span class="n">L9</span>         <span class="c">; second arg</span>
        <span class="n">ldr</span>     <span class="n">r0</span><span class="p">,</span> <span class="err">[</span><span class="n">fp</span><span class="p">,</span> <span class="err">#</span><span class="o">-</span><span class="mi">8</span><span class="err">]</span>   <span class="c">; first arg</span>
        <span class="n">bl</span>      <span class="n">sum</span>
</code></pre></div></div>

<p>The <code class="highlighter-rouge">bl</code> saves the next instruction (the <em>return address</em>) in the <em>link</em>
<code class="highlighter-rouge">lr</code> register (<code class="highlighter-rouge">r14</code>) and set the destination address in the <em>program
counter</em> <code class="highlighter-rouge">pc</code> register (<code class="highlighter-rouge">r15</code>).</p>

<p><code class="highlighter-rouge">bx lr</code> (<em>branch and exchange</em>) is used to return to the caller.</p>

<h2 id="arm-directives">Arm directives</h2>

<p>Two more fragments remains that are not part of any function.</p>

<p>These are <a href="https://sourceware.org/binutils/docs-2.27/as/ARM-Directives.html">directives for the
GNU Assembler</a>,
see also
<a href="https://ftp.gnu.org/old-gnu/Manuals/gas-2.9.1/html_chapter/as_7.html">this</a>:</p>

<div class="language-nasm highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="p">.</span><span class="n">arch</span> <span class="n">armv6</span>
        <span class="p">.</span><span class="n">eabi_attribute</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">1</span>
        <span class="p">.</span><span class="n">eabi_attribute</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">1</span>
        <span class="p">.</span><span class="n">eabi_attribute</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">1</span>
        <span class="p">.</span><span class="n">eabi_attribute</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">3</span>
        <span class="p">.</span><span class="n">eabi_attribute</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">1</span>
        <span class="p">.</span><span class="n">eabi_attribute</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">1</span>
        <span class="p">.</span><span class="n">eabi_attribute</span> <span class="mi">26</span><span class="p">,</span> <span class="mi">2</span>
        <span class="p">.</span><span class="n">eabi_attribute</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">6</span>
        <span class="p">.</span><span class="n">eabi_attribute</span> <span class="mi">34</span><span class="p">,</span> <span class="mi">1</span>
        <span class="p">.</span><span class="n">eabi_attribute</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">4</span>
        <span class="p">.</span><span class="n">file</span>   <span class="s">"asm1.c"</span>
        <span class="p">.</span><span class="n">text</span>
</code></pre></div></div>

<div class="language-nasm highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="p">.</span><span class="n">ident</span>  <span class="s">"GCC: (Raspbian 8.3.0-6+rpi1) 8.3.0"</span>
        <span class="p">.</span><span class="kr">section</span>        <span class="p">.</span><span class="n">note</span><span class="p">.</span><span class="n">GNU</span><span class="o">-</span><span class="n">stack</span><span class="p">,</span><span class="s">""</span><span class="p">,</span><span class="err">%</span><span class="n">progbits</span>
</code></pre></div></div>

<h2 id="final-thoughts">Final thoughts</h2>

<p>I have being reading <a href="https://developer.arm.com/documentation/ihi0042/latest/">documentation</a>
and <a href="https://www.coranac.com/tonc/text/asm.htm">write ups</a> about Arm
during the last weeks.</p>

<p>When I
<a href="/book-of-gehn/articles/2020/12/27/TLDR-Quick-Overview-of-Arm.html">started</a>
 my idea was to use a <a href="/book-of-gehn/articles/2020/12/15/Qemulating-Rasbian-ARM.html">QEMU virtual machine for
testing</a>:
code a little of assembly, compile it, debugging it with GDB and seeing
the effects.</p>

<p>It turns out to be tedious very quickly.</p>

<p>I relayed then more in the documentation and the <a href="https://documentation-service.arm.com/static/5ed66080ca06a95ce53f932d?token=">instruction set
reference</a>
but when I review real code (like the one in this post) some things made
no sense.</p>

<p>Obviously there were errors in my interpretation of the code.</p>

<p>That’s why I coded an <a href="https://github.com/bad-address/iasm">interactive assembler</a>
to have a quick feedback of what each instruction does without requiring
a compile-upload-debug cycle.</p>

<p>It really help me to “smooth out certain rough edges” and understand
better the code specially when the indexing flavors and how the things
are pushed and popped from the stack.</p>



    </article>
    <span class="print-footer">Review Arm Assembly - January 4, 2021 - Gehn</span>
    <footer>
    <hr class="slender">
    <div class="credits">
        <span>&copy; 2021
            
            Gehn
        </span></br>
            <a style="text-decoration: none;" href="/book-of-gehn/feed.xml"><img height="16px" width="16px" src="/book-of-gehn/assets/blog-assets/rss-32px.png" /></a>
        <br>
        

    
    </div>
</footer>

  </body>
</html>
