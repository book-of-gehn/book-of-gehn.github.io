<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Blending Whisky with Z3</title>
  <meta name="description" content="A whisky producer uses three kind of licor to make their whisky: , and .Three kind of whisky can be made using the licorin the following proportions:        ...">

  
    <link href='//fonts.googleapis.com/css?family=Lato:400,400italic' rel='stylesheet' type='text/css'>
  

  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        extensions: ["tex2jax.js"],
        jax: ["input/TeX","output/HTML-CSS"],
        tex2jax: {inlineMath: [["$$","$$"],["\\(","\\)"]]},
	TeX: {
	  Macros: {
            
	  }
	}
      });
    </script>
    
      <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js' async></script>
    
  

  
    <script
       src="https://code.jquery.com/jquery-3.4.1.min.js"
       integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
       crossorigin="anonymous"></script>
  

  

    
      <script src='https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.9.1/underscore-min.js' ></script>
    

    
      <script src="https://d3js.org/d3.v4.min.js"></script>
    

    <script src='/book-of-gehn/js/venn/venn.min.js'></script>
    <script src='/book-of-gehn/js/venn/helper.js'></script>

    <script src='/book-of-gehn/js/fix_syntax_highlight.js'></script>
  <link rel="stylesheet" type="text/css" href="/book-of-gehn/css/tufte.css">
  <link rel="stylesheet" type="text/css" href="/book-of-gehn/css/latex.css">

  <link rel="canonical" href="/book-of-gehn/articles/2021/04/29/Blending-Whisky.html">

  <link rel="stylesheet" type="text/css" href="/book-of-gehn/css/all.min.css">

  <link type="application/atom+xml" rel="alternate" href="/book-of-gehn/feed.xml" title="The Book of Gehn" />
</head>

  <body>
    <header>
	
		<h1 class="header-title"><a href="/book-of-gehn/">The Book of Gehn</a></h1>
		
		
	

    

    
</header>

    <article class="group">
      <h1>Blending Whisky with Z3</h1>
<p class="subtitle">April 29, 2021</p>

<p>A whisky producer uses three kind of licor to make their whisky: <script type="math/tex">A</script>,
<script type="math/tex">B</script> and <script type="math/tex">C</script>.</p>

<p>Three kind of whisky can be made using the licor
in the following proportions:</p>

<table>
  <thead>
    <tr>
      <th>Whisky</th>
      <th>Sales Price</th>
      <th>Recipe</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><script type="math/tex">E</script></td>
      <td><script type="math/tex">680</script></td>
      <td>No less than 60% of <script type="math/tex">A</script>, no more than 20% of <script type="math/tex">C</script></td>
    </tr>
    <tr>
      <td><script type="math/tex">F</script></td>
      <td><script type="math/tex">570</script></td>
      <td>No less than 15% of <script type="math/tex">A</script>, no more than 80% of <script type="math/tex">C</script></td>
    </tr>
    <tr>
      <td><script type="math/tex">G</script></td>
      <td><script type="math/tex">450</script></td>
      <td>No more than 50% of <script type="math/tex">C</script></td>
    </tr>
  </tbody>
</table>

<p>The producer has the following stock and price list from its licor supplier:</p>

<table>
  <thead>
    <tr>
      <th>Licor</th>
      <th>Stock</th>
      <th>Price</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><script type="math/tex">A</script></td>
      <td><script type="math/tex">2000</script></td>
      <td><script type="math/tex">700</script></td>
    </tr>
    <tr>
      <td><script type="math/tex">B</script></td>
      <td><script type="math/tex">2500</script></td>
      <td><script type="math/tex">500</script></td>
    </tr>
    <tr>
      <td><script type="math/tex">C</script></td>
      <td><script type="math/tex">1200</script></td>
      <td><script type="math/tex">400</script></td>
    </tr>
  </tbody>
</table>

<p>Note: the prices are in $ per liter and the stock are in liters.</p>

<p>The goal is to maximize the profit.<!--more--></p>

<h2 id="bad-plan-non-linear-system">Bad plan: non-linear system</h2>

<p>Let’s begin with the bounds of each licor:</p>

<script type="math/tex; mode=display">% <![CDATA[
A_E  E + A_F  F + A_G  G = A <= 2000 \\
B_E  E + B_F  F + B_G  G = B <= 2500 \\
C_E  E + C_F  F + C_G  G = C <= 1200 \\ %]]></script>

<p>We introduced a new variable per combination of licor and whisky: <script type="math/tex">A_E</script>
stands for the ratio of licor <script type="math/tex">A</script> used in the whisky <code class="highlighter-rouge">B</code>,
<script type="math/tex">B_F</script> stands for the ratio of licor <script type="math/tex">B</script> used in the whisky <script type="math/tex">F</script> and so on.</p>

<p>These variables are in liters of licor per liter of whisky (or they are
unit-less if you prefer).</p>

<p>And we are fuck.</p>

<p>These three equations are not longer linear because we have the product
of two variable (<script type="math/tex">A_E  E</script> for example).</p>

<p>We need to rethink our strategy.</p>

<h2 id="the-blending">The blending</h2>

<p>Think in <script type="math/tex">A_E</script> <em>not as the ratio but as the amount of
liters itself</em> of licor <script type="math/tex">A</script> used in <script type="math/tex">E</script>.</p>

<p>This is a <em>blending</em> problem where some variables represent a part,
fraction or subcomponent of another.</p>

<script type="math/tex; mode=display">% <![CDATA[
A_E + A_F + A_G = A <= 2000 \\
B_E + B_F + B_G = B <= 2500 \\
C_E + C_F + C_G = C <= 1200 \\ %]]></script>

<p>Now the system is linear again.</p>

<p>What about the restrictions of each recipe?</p>

<p>It would be wonderful to put something like this
which it is a literal translation of the problem into inequalities:</p>

<script type="math/tex; mode=display">% <![CDATA[
0.6 <= A_E/E <= 1 \\
0 <= C_E/E <= 0.2 \\
--- \\
0.15 <= A_F/F <= 1 \\
0 <= C_F/F <= 0.8 \\
--- \\
0 <= C_G/G <= 0.5 \\ %]]></script>

<p>But again, that makes the system non-linear.</p>

<p>Instead we do the following:</p>

<script type="math/tex; mode=display">% <![CDATA[
0.6  E <= A_E <= 1  E \\
0  E <= C_E <= 0.2  E \\
--- \\
0.15  F <= A_F <= 1  F \\
0  F <= C_F <= 0.8  F \\
--- \\
0  G <= C_G <= 0.5  G \\ %]]></script>

<p>We complete the recipe of each whisky with the remaining licor:</p>

<script type="math/tex; mode=display">A_E + B_E + C_E = E \\
A_F + B_F + C_F = F \\
A_G + B_G + C_G = G \\</script>

<p>So what did we do? We split each licor (input <script type="math/tex">I</script>) into <script type="math/tex">N</script> <em>blending</em>
variables (<script type="math/tex">I_o</script>), one for each whisky type (output <script type="math/tex">O</script>).</p>

<ul>
  <li>We ensured that the sum of the <em>blending</em> variables for the <strong>same</strong> licor
(input) summed up the total amount of <strong>that</strong> licor (<script type="math/tex">A_E + A_F + A_G = A</script>) –
we did a <em>partition</em>.</li>
  <li>We restricted each blending variable based on a proportion of each
amount of whisky (<script type="math/tex">% <![CDATA[
0.6  E <= A_E <= 1  E %]]></script>) – these are the <em>blending
rules</em>.</li>
  <li>We ensured that the sum of the <em>blending</em> variable <strong>across</strong> all the
licor (input) for the <strong>same</strong> whisky (output) summed up the total amount of
<strong>that</strong> whisky.</li>
</ul>

<table>
  <tbody>
    <tr>
      <td><script type="math/tex">A_E</script></td>
      <td><script type="math/tex">A_F</script></td>
      <td><script type="math/tex">A_G</script></td>
      <td>→  <script type="math/tex">A</script></td>
    </tr>
    <tr>
      <td><script type="math/tex">B_E</script></td>
      <td><script type="math/tex">B_F</script></td>
      <td><script type="math/tex">B_G</script></td>
      <td>→  <script type="math/tex">B</script></td>
    </tr>
    <tr>
      <td><script type="math/tex">C_E</script></td>
      <td><script type="math/tex">C_F</script></td>
      <td><script type="math/tex">C_G</script></td>
      <td>→  <script type="math/tex">C</script></td>
    </tr>
    <tr>
      <td>↓</td>
      <td>↓</td>
      <td>↓</td>
      <td> </td>
    </tr>
    <tr>
      <td><script type="math/tex">E</script></td>
      <td><script type="math/tex">F</script></td>
      <td><script type="math/tex">G</script></td>
      <td> </td>
    </tr>
  </tbody>
</table>

<h2 id="the-goal">The goal</h2>

<p>And finally, this is the goal to maximize:</p>

<script type="math/tex; mode=display">Z = max\{680 E + 570 F + 450 G - 700 A - 500 B - 400 C \}</script>

<h2 id="find-the-optimum-with-z3">Find the optimum with Z3</h2>

<p>Setup the engine, create the variables and ensure that them are
non-negative.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">z3</span> <span class="kn">import</span> <span class="n">Reals</span><span class="p">,</span> <span class="n">Optimize</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">s</span> <span class="o">=</span> <span class="n">Optimize</span><span class="p">()</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">E</span><span class="p">,</span> <span class="n">F</span><span class="p">,</span> <span class="n">G</span> <span class="o">=</span> <span class="n">Reals</span><span class="p">(</span><span class="s">'A B C E F G'</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">A_E</span><span class="p">,</span> <span class="n">A_F</span><span class="p">,</span> <span class="n">A_G</span> <span class="o">=</span> <span class="n">Reals</span><span class="p">(</span><span class="s">'A_E A_F A_G'</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">B_E</span><span class="p">,</span> <span class="n">B_F</span><span class="p">,</span> <span class="n">B_G</span> <span class="o">=</span> <span class="n">Reals</span><span class="p">(</span><span class="s">'B_E B_F B_G'</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">C_E</span><span class="p">,</span> <span class="n">C_F</span><span class="p">,</span> <span class="n">C_G</span> <span class="o">=</span> <span class="n">Reals</span><span class="p">(</span><span class="s">'C_E C_F C_G'</span><span class="p">)</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">s</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">x</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">E</span><span class="p">,</span> <span class="n">F</span><span class="p">,</span> <span class="n">G</span><span class="p">]])</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">s</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">x</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="n">A_E</span><span class="p">,</span> <span class="n">A_F</span><span class="p">,</span> <span class="n">A_G</span><span class="p">]])</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">s</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">x</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="n">B_E</span><span class="p">,</span> <span class="n">B_F</span><span class="p">,</span> <span class="n">B_G</span><span class="p">]])</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">s</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">x</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="n">C_E</span><span class="p">,</span> <span class="n">C_F</span><span class="p">,</span> <span class="n">C_G</span><span class="p">]])</span>
</code></pre></div></div>

<p>Limit the amount of supplies</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">s</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
<span class="o">...</span>     <span class="n">A</span> <span class="o">&lt;=</span> <span class="mi">2000</span><span class="p">,</span>
<span class="o">...</span>     <span class="n">B</span> <span class="o">&lt;=</span> <span class="mi">2500</span><span class="p">,</span>
<span class="o">...</span>     <span class="n">C</span> <span class="o">&lt;=</span> <span class="mi">1200</span>
<span class="o">...</span> <span class="p">)</span>
</code></pre></div></div>

<p>Split the licor for each whisky</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">s</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
<span class="o">...</span>     <span class="n">A_E</span> <span class="o">+</span> <span class="n">A_F</span> <span class="o">+</span> <span class="n">A_G</span> <span class="o">==</span> <span class="n">A</span><span class="p">,</span>
<span class="o">...</span>     <span class="n">B_E</span> <span class="o">+</span> <span class="n">B_F</span> <span class="o">+</span> <span class="n">B_G</span> <span class="o">==</span> <span class="n">B</span><span class="p">,</span>
<span class="o">...</span>     <span class="n">C_E</span> <span class="o">+</span> <span class="n">C_F</span> <span class="o">+</span> <span class="n">C_G</span> <span class="o">==</span> <span class="n">C</span>
<span class="o">...</span> <span class="p">)</span>
</code></pre></div></div>

<p>Blending rules:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">s</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
<span class="o">...</span>     <span class="c1"># minimum amount of licor for whisky E
</span><span class="o">...</span>     <span class="mf">0.6</span> <span class="o">*</span> <span class="n">E</span> <span class="o">&lt;=</span> <span class="n">A_E</span><span class="p">,</span>
<span class="o">...</span>     <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">C_E</span><span class="p">,</span>
<span class="o">...</span>     <span class="c1"># maximum amount of licor for whisky E
</span><span class="o">...</span>     <span class="n">A_E</span> <span class="o">&lt;=</span> <span class="n">E</span><span class="p">,</span>
<span class="o">...</span>     <span class="n">C_E</span> <span class="o">&lt;=</span> <span class="mf">0.2</span> <span class="o">*</span> <span class="n">E</span><span class="p">,</span>
<span class="o">...</span>
<span class="o">...</span>     <span class="c1"># minimum amount of licor for whisky F
</span><span class="o">...</span>     <span class="mf">0.15</span> <span class="o">*</span> <span class="n">F</span> <span class="o">&lt;=</span> <span class="n">A_F</span><span class="p">,</span>
<span class="o">...</span>     <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">C_F</span><span class="p">,</span>
<span class="o">...</span>     <span class="c1"># maximum amount of licor for whisky F
</span><span class="o">...</span>     <span class="n">A_F</span> <span class="o">&lt;=</span> <span class="n">F</span><span class="p">,</span>
<span class="o">...</span>     <span class="n">C_F</span> <span class="o">&lt;=</span> <span class="mf">0.8</span> <span class="o">*</span> <span class="n">F</span><span class="p">,</span>
<span class="o">...</span>
<span class="o">...</span>     <span class="c1"># the same for whisky G
</span><span class="o">...</span>     <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">C_G</span><span class="p">,</span>
<span class="o">...</span>     <span class="n">C_G</span> <span class="o">&lt;=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">G</span>
<span class="o">...</span> <span class="p">)</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">s</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
<span class="o">...</span>     <span class="n">A_E</span> <span class="o">+</span> <span class="n">B_E</span> <span class="o">+</span> <span class="n">C_E</span> <span class="o">==</span> <span class="n">E</span><span class="p">,</span>
<span class="o">...</span>     <span class="n">A_F</span> <span class="o">+</span> <span class="n">B_F</span> <span class="o">+</span> <span class="n">C_F</span> <span class="o">==</span> <span class="n">F</span><span class="p">,</span>
<span class="o">...</span>     <span class="n">A_G</span> <span class="o">+</span> <span class="n">B_G</span> <span class="o">+</span> <span class="n">C_G</span> <span class="o">==</span> <span class="n">G</span>
<span class="o">...</span> <span class="p">)</span>
</code></pre></div></div>

<p>Profit!</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">costs</span> <span class="o">=</span> <span class="n">A</span> <span class="o">*</span> <span class="mi">700</span> <span class="o">+</span> <span class="n">B</span> <span class="o">*</span> <span class="mi">500</span> <span class="o">+</span> <span class="n">C</span> <span class="o">*</span> <span class="mi">400</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">income</span> <span class="o">=</span> <span class="n">E</span> <span class="o">*</span> <span class="mi">680</span> <span class="o">+</span> <span class="n">F</span> <span class="o">*</span> <span class="mi">570</span> <span class="o">+</span> <span class="n">G</span> <span class="o">*</span> <span class="mi">450</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">profit</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">maximize</span><span class="p">(</span><span class="n">income</span> <span class="o">-</span> <span class="n">costs</span><span class="p">)</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">s</span><span class="o">.</span><span class="n">check</span><span class="p">()</span>
<span class="n">sat</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">profit</span><span class="o">.</span><span class="n">value</span><span class="p">()</span>
<span class="mi">3590000</span><span class="o">/</span><span class="mi">9</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">m</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">model</span><span class="p">()</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span><span class="p">(</span><span class="s">"Licor:"</span><span class="p">,</span> <span class="s">"A ="</span><span class="p">,</span> <span class="n">m</span><span class="p">[</span><span class="n">A</span><span class="p">],</span> <span class="s">"B ="</span><span class="p">,</span> <span class="n">m</span><span class="p">[</span><span class="n">B</span><span class="p">],</span> <span class="s">"C ="</span><span class="p">,</span> <span class="n">m</span><span class="p">[</span><span class="n">C</span><span class="p">])</span>
<span class="n">Licor</span><span class="p">:</span> <span class="n">A</span> <span class="o">=</span> <span class="mi">2000</span> <span class="n">B</span> <span class="o">=</span> <span class="mi">2500</span> <span class="n">C</span> <span class="o">=</span> <span class="mi">1200</span>

<span class="o">&gt;&gt;&gt;</span> <span class="c1"># We use m[.] to retrieve simple variables
</span><span class="o">&gt;&gt;&gt;</span> <span class="k">print</span><span class="p">(</span><span class="s">"Whisky:"</span><span class="p">,</span> <span class="s">"E ="</span><span class="p">,</span> <span class="n">m</span><span class="p">[</span><span class="n">E</span><span class="p">],</span> <span class="s">"F ="</span><span class="p">,</span> <span class="n">m</span><span class="p">[</span><span class="n">F</span><span class="p">],</span> <span class="s">"G ="</span><span class="p">,</span> <span class="n">m</span><span class="p">[</span><span class="n">G</span><span class="p">])</span>
<span class="n">Whisky</span><span class="p">:</span> <span class="n">E</span> <span class="o">=</span> <span class="mi">22900</span><span class="o">/</span><span class="mi">9</span> <span class="n">F</span> <span class="o">=</span> <span class="mi">28400</span><span class="o">/</span><span class="mi">9</span> <span class="n">G</span> <span class="o">=</span> <span class="mi">0</span>

<span class="o">&gt;&gt;&gt;</span> <span class="c1"># We use m.eval() to evaluate complex expressions in the model context
</span><span class="o">&gt;&gt;&gt;</span> <span class="k">print</span><span class="p">(</span><span class="s">"Costs ="</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="nb">eval</span><span class="p">(</span><span class="n">costs</span><span class="p">),</span> <span class="s">"Income ="</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="nb">eval</span><span class="p">(</span><span class="n">income</span><span class="p">),</span> <span class="s">"Profit ="</span><span class="p">,</span> <span class="n">profit</span><span class="o">.</span><span class="n">value</span><span class="p">())</span>
<span class="n">Costs</span> <span class="o">=</span> <span class="mi">3130000</span> <span class="n">Income</span> <span class="o">=</span> <span class="mi">31760000</span><span class="o">/</span><span class="mi">9</span> <span class="n">Profit</span> <span class="o">=</span> <span class="mi">3590000</span><span class="o">/</span><span class="mi">9</span>
</code></pre></div></div>



    </article>
    <span class="print-footer">Blending Whisky with Z3 - April 29, 2021 - Gehn</span>
    <footer>
    <hr class="slender">
    <div class="credits">
        <span>&copy; 2021
            
            Gehn
        </span></br>
            <a style="text-decoration: none;" href="/book-of-gehn/feed.xml"><img height="16px" width="16px" src="/book-of-gehn/assets/blog-assets/rss-32px.png" /></a>
        <br>
        

    
    </div>
</footer>

  </body>
</html>
