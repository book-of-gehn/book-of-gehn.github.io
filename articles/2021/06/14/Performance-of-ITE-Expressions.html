<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <meta name="description" content="Performance of ITE Expressions (incomplete) A branch is an expensive operation even in modern CPUs because the computer will know which of the paths is taken only in the latest stages of the CPU pipeline. In the meantime, the CPU stalls. Modern CPUs use branch prediction, speculative execution and instruction reordering to minimize the impact of a branch. They do a good job but still a branch is potentially expensive so they are replaced by branchless variants. Minimum time (y axis) per branch/branchless function (x axis). or ITE for short, are symbolic expression that denotes a value chosen from two possible values based on a condition. These are the symbolic branch. Naturally we could rewrite a symbolic ITE with a symbolic branchless expression. The question is: which is better for a solver like Z3? Which makes the SMT/SAT solver faster? After two weeks working on this post I still don’t have an answer but at least I know some unknowns.">

  
  <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      
          "@type": "BlogPosting",
          "headline": "Performance of ITE Expressions (incomplete)",
          
          
          "datePublished": "2021-06-14T00:00:00+00:00",
          "dateModified": "2021-06-14T00:00:00+00:00",
          

          "author": [{
              "@type": "Person",
              "name": "Martin Di Paola",
              "url": "https://book-of-gehn.github.io"
            }]
      
    }
  </script>


  

  <title>Performance of ITE Expressions (incomplete)</title>

  <link rel="icon" type="image/x-icon" href="/img/favicon.ico">

  
  <link rel="alternate" type="application/rss+xml" href="https://book-of-gehn.github.io/rss.xml">

  <link rel="canonical" href="https://book-of-gehn.github.io/articles/2021/06/14/Performance-of-ITE-Expressions.html">

  <link href='/css/load-lato-fonts.min.css' rel='stylesheet' type='text/css'>

  <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      //root: "/js/MathJax-2.7.7",
      extensions: ["tex2jax.js"],
      jax: ["input/TeX","output/HTML-CSS"],
      tex2jax: {inlineMath: [["\\(","\\)"]]},
      TeX: {
        Macros: {
          
        }
      }
    });
  </script>
  <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js' async></script>

  <script src="/js/jquery-3.6.0.min.js"></script>

  <script src='/js/underscore-1.9.1.min.js' ></script>

  <script src='/js/d3-7.4.2.min.js'></script>

  <script src='/js/venn/venn-0.2.14.min.js'></script>
  <script src='/js/venn/helper.min.js'></script>

  <script src='/js/fix_syntax_highlight.min.js'></script>
  <link rel="stylesheet" type="text/css" href="/css/tufte.min.css">
  <link rel="stylesheet" type="text/css" href="/css/latex.min.css">

  <link rel="stylesheet" type="text/css" href="/css/font-awesome-5.min.css">

  <script src='/js/lunr-2.3.9.min.js'></script>
  <script src='/js/search_index.js'></script>
  <script src='/js/search.min.js'></script>
</head>
<body>
<header>
                <hgroup class="header-group">
        <h1 class="header-title"><a href="/">The Book of Gehn</a></h1>
                </hgroup>
                <ul class="header-list">
                    <li><a href="https://byexamples.github.io">byexample</a></li>
                    <li><a href="https://bisturi.github.io">bisturi</a></li>
                    <li>
                        <a class="raw_link" href="/atom.xml"><img height="16px" width="16px" src="/img/rss-32px.png" /></a>
                        <a class="raw_link" href="https://github.com/eldipa"><img height="16px" width="16px" src="/img/github.png" /></a>
                    </li>
                </ul>
        
        

    

</header>
<article class="group">
<h1>
Performance of ITE Expressions (incomplete)
</h1>
<p class="subtitle">
June 14, 2021
</p>
<p>A <em>branch</em> is an expensive operation even in modern CPUs because the computer will know which of the paths is taken only in the latest stages of the CPU pipeline.</p>
<p>In the meantime, the CPU <em>stalls</em>.</p>
<p>Modern CPUs use branch prediction, speculative execution and instruction reordering to minimize the impact of a branch.</p>
<p>They do a good job but still a <em>branch</em> is potentially expensive so they are replaced by <em>branchless</em> variants.</p>
<p><code><span class="highlight-candombe-inline"><span class="n">If</span><span class="o">-</span><span class="n">Then</span><span class="o">-</span><span class="n">Else</span></span></code> or ITE for short, are symbolic expression that denotes a value chosen from two possible values based on a condition. These are the <em>symbolic branch</em>.</p>
<p>Naturally we could rewrite a symbolic ITE with a symbolic <em>branchless</em> expression.</p>
<p>The question is: which is better for a solver like Z3? Which makes the SMT/SAT solver faster?</p>
<p>After two weeks working on this post <strong>I still don’t have an answer but at least I know some unknowns.</strong><!--more--></p>
<h2 id="z3-if-then-else">Z3 <code><span class="highlight-candombe-inline"><span class="n">If</span><span class="o">-</span><span class="n">Then</span><span class="o">-</span><span class="n">Else</span></span></code></h2>
<p>In Z3 we use <code><span class="highlight-candombe-inline"><span class="n">z3</span><span class="o">.</span><span class="n">If</span></span></code> to build such symbolic expressions.</p>
<p>Take for example the following Python function <code><span class="highlight-candombe-inline"><span class="n">xtime</span></span></code>:</p>
<div class="highlight-candombe"><pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="k">def</span> <span class="nf">xtime</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
<span class="o">...</span>     <span class="n">thenval</span> <span class="o">=</span> <span class="p">(((</span><span class="n">a</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">^</span> <span class="mh">0x1B</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">)</span>
<span class="o">...</span>     <span class="n">elseval</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span>
<span class="o">...</span>     <span class="n">condval</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span>
<span class="o">...</span>     <span class="k">return</span> <span class="n">thenval</span> <span class="k">if</span> <span class="n">condval</span> <span class="k">else</span> <span class="n">elseval</span>
</code></pre></div>

<p>Symbolically, we could rewrite it as follows:</p>
<div class="highlight-candombe"><pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">z3</span> <span class="kn">import</span> <span class="n">If</span><span class="p">,</span> <span class="n">BitVec</span><span class="p">,</span> <span class="n">simplify</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">def</span> <span class="nf">xtime_branch</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
<span class="o">...</span>     <span class="n">thenval</span> <span class="o">=</span> <span class="p">(((</span><span class="n">a</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">^</span> <span class="mh">0x1B</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">)</span>
<span class="o">...</span>     <span class="n">elseval</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span>
<span class="o">...</span>     <span class="n">condval</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span>
<span class="o">...</span>     <span class="k">return</span> <span class="n">If</span><span class="p">(</span><span class="n">condval</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">thenval</span><span class="p">,</span> <span class="n">elseval</span><span class="p">)</span>
</code></pre></div>

<p>Remember that in Python, the <code><span class="highlight-candombe-inline"><span class="p">(</span><span class="n">thenval</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">condval</span><span class="p">)</span> <span class="k">else</span> <span class="p">(</span><span class="n">elseval</span><span class="p">)</span></span></code> is <strong>evaluated</strong> at runtime but in Z3 we cannot evaluate anything.</p>
<p>So we need to model the fact that the output of <code><span class="highlight-candombe-inline"><span class="n">xtime</span></span></code> it may be <code><span class="highlight-candombe-inline"><span class="n">thenval</span></span></code> or <code><span class="highlight-candombe-inline"><span class="n">elseval</span></span></code>, depending of the condition.</p>
<p>Let’s see what is the result of <code><span class="highlight-candombe-inline"><span class="n">xtime_branch</span></span></code></p>
<div class="highlight-candombe"><pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="n">T</span> <span class="o">=</span> <span class="n">BitVec</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">xtime_branch</span><span class="p">(</span><span class="n">T</span><span class="p">)</span>
<span class="n">If</span><span class="p">(</span><span class="n">T</span> <span class="o">&amp;</span> <span class="mi">128</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">T</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span> <span class="o">^</span> <span class="mi">27</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">255</span><span class="p">,</span> <span class="n">T</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">simplify</span><span class="p">(</span><span class="n">xtime_branch</span><span class="p">(</span><span class="n">T</span><span class="p">))</span>
<span class="n">If</span><span class="p">(</span><span class="n">Extract</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="n">T</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span>
   <span class="n">Concat</span><span class="p">(</span><span class="n">Extract</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">T</span><span class="p">),</span> <span class="mi">0</span><span class="p">),</span>
   <span class="n">Concat</span><span class="p">(</span><span class="n">Extract</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">T</span><span class="p">),</span>
          <span class="o">~</span><span class="n">Extract</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">T</span><span class="p">),</span>
          <span class="n">Extract</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">T</span><span class="p">),</span>
          <span class="o">~</span><span class="n">Extract</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">T</span><span class="p">),</span>
          <span class="mi">1</span><span class="p">))</span>
</code></pre></div>

<p>Before continuing, I would like to simplify <code><span class="highlight-candombe-inline"><span class="n">xtime_branch</span></span></code> a little:</p>
<ul>
<li>the input are always an 8 bits, so the <code><span class="highlight-candombe-inline"><span class="n">x</span> <span class="o">&amp;</span> <span class="mh">0xFF</span></span></code> mask is not needed</li>
<li>the <code><span class="highlight-candombe-inline"><span class="n">thenval</span></span></code> can reuse the <code><span class="highlight-candombe-inline"><span class="n">elseval</span></span></code></li>
</ul>
<div class="highlight-candombe"><pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="k">def</span> <span class="nf">xtime_branch</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
<span class="o">...</span>     <span class="n">elseval</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span>
<span class="o">...</span>     <span class="n">thenval</span> <span class="o">=</span> <span class="p">(</span><span class="n">elseval</span> <span class="o">^</span> <span class="mh">0x1B</span><span class="p">)</span>
<span class="o">...</span>     <span class="n">condval</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span>
<span class="o">...</span>     <span class="k">return</span> <span class="n">If</span><span class="p">(</span><span class="n">condval</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">thenval</span><span class="p">,</span> <span class="n">elseval</span><span class="p">)</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">xtime_branch</span><span class="p">(</span><span class="n">T</span><span class="p">)</span>
<span class="n">If</span><span class="p">(</span><span class="n">T</span> <span class="o">&amp;</span> <span class="mi">128</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">T</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span> <span class="o">^</span> <span class="mi">27</span><span class="p">,</span> <span class="n">T</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">simplify</span><span class="p">(</span><span class="n">xtime_branch</span><span class="p">(</span><span class="n">T</span><span class="p">))</span>
<span class="n">If</span><span class="p">(</span><span class="n">Extract</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="n">T</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span>
   <span class="n">Concat</span><span class="p">(</span><span class="n">Extract</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">T</span><span class="p">),</span> <span class="mi">0</span><span class="p">),</span>
   <span class="n">Concat</span><span class="p">(</span><span class="n">Extract</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">T</span><span class="p">),</span>
          <span class="o">~</span><span class="n">Extract</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">T</span><span class="p">),</span>
          <span class="n">Extract</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">T</span><span class="p">),</span>
          <span class="o">~</span><span class="n">Extract</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">T</span><span class="p">),</span>
          <span class="mi">1</span><span class="p">))</span>
</code></pre></div>

<p>As you see, this <code><span class="highlight-candombe-inline"><span class="n">xtime_branch</span></span></code> and the previous one yield the <strong>same result</strong> after applying <code><span class="highlight-candombe-inline"><span class="n">z3</span><span class="o">.</span><span class="n">simplify</span></span></code>.</p>
<p>However I’m going to keep those simplifications explicit in <code><span class="highlight-candombe-inline"><span class="n">xtime_branch</span></span></code> for further optimizations later.</p>
<h2 id="branchless-ite">Branchless ITE</h2>
<p>The <code><span class="highlight-candombe-inline"><span class="p">(</span><span class="n">a</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span></span></code> condition is equivalent to <code><span class="highlight-candombe-inline"><span class="p">(</span><span class="n">a</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span></span></code>.</p>
<p>The key point to notice is that when <code><span class="highlight-candombe-inline"><span class="p">(</span><span class="n">a</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span></span></code> then <code><span class="highlight-candombe-inline"><span class="n">a</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span> <span class="o">==</span> <span class="mi">1</span></span></code>; when <code><span class="highlight-candombe-inline"><span class="p">(</span><span class="n">a</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span></span></code> then <code><span class="highlight-candombe-inline"><span class="n">a</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span> <span class="o">==</span> <span class="mi">0</span></span></code>.</p>
<p>With this <em>single bit boolean</em> we can get rid of the <code><span class="highlight-candombe-inline"><span class="n">If</span></span></code> doing a <strong>branchless</strong> <a href="https://graphics.stanford.edu/~seander/bithacks.html#IntegerMinOrMax">bithack</a></p>
<div class="highlight-candombe"><pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="k">def</span> <span class="nf">xtime_branchless</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
<span class="o">...</span>     <span class="n">elseval</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span>
<span class="o">...</span>     <span class="n">thenval</span> <span class="o">=</span> <span class="p">(</span><span class="n">elseval</span> <span class="o">^</span> <span class="mh">0x1B</span><span class="p">)</span>
<span class="o">...</span>     <span class="n">condval</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="c1"># it can be 0 or 1</span>
<span class="o">...</span>     <span class="k">return</span> <span class="n">elseval</span> <span class="o">^</span> <span class="p">((</span><span class="n">thenval</span> <span class="o">^</span> <span class="n">elseval</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">-</span><span class="p">(</span><span class="n">condval</span><span class="p">))</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">xtime_branchless</span><span class="p">(</span><span class="n">T</span><span class="p">)</span>
<span class="n">T</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span> <span class="o">^</span> <span class="p">(</span><span class="n">T</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span> <span class="o">^</span> <span class="mi">27</span> <span class="o">^</span> <span class="n">T</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">-</span><span class="p">(</span><span class="n">T</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">simplify</span><span class="p">(</span><span class="n">xtime_branchless</span><span class="p">(</span><span class="n">T</span><span class="p">))</span>
<span class="n">Concat</span><span class="p">(</span><span class="n">Extract</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">T</span><span class="p">),</span>
       <span class="n">Extract</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">T</span><span class="p">)</span> <span class="o">^</span> <span class="n">Extract</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">255</span><span class="o">*</span><span class="p">(</span><span class="n">T</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)),</span>
       <span class="n">Extract</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">T</span><span class="p">),</span>
       <span class="n">Extract</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">T</span><span class="p">)</span> <span class="o">^</span>
       <span class="n">Extract</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="o">*</span><span class="n">Extract</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">T</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)),</span>
       <span class="n">Extract</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">T</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">))</span>
</code></pre></div>

<p>We don’t longer have an ITE expression!</p>
<p>But there is a catch…</p>
<h2 id="bit-broadcasting">Bit broadcasting</h2>
<p>The catch is that we have some multiplications:</p>
<ul>
<li><code><span class="highlight-candombe-inline"><span class="mi">255</span><span class="o">*</span><span class="p">(</span><span class="n">T</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span></span></code></li>
<li><code><span class="highlight-candombe-inline"><span class="mi">3</span><span class="o">*</span><span class="n">Extract</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">T</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span></span></code></li>
</ul>
<p>These come from <code><span class="highlight-candombe-inline"><span class="o">-</span><span class="p">(</span><span class="n">condval</span><span class="p">)</span></span></code>.</p>
<p>When <code><span class="highlight-candombe-inline"><span class="n">condval</span></span></code> is 0, then <code><span class="highlight-candombe-inline"><span class="o">-</span><span class="p">(</span><span class="n">condval</span><span class="p">)</span></span></code> is 0, represented as eight <code><span class="highlight-candombe-inline"><span class="mi">0</span></span></code> bits, the <code><span class="highlight-candombe-inline"><span class="p">((</span><span class="n">thenval</span> <span class="o">^</span> <span class="n">elseval</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">-</span><span class="p">(</span><span class="n">condval</span><span class="p">))</span></span></code> goes to 0 and the expression reduces to the left part of the main xor: <code><span class="highlight-candombe-inline"><span class="n">elseval</span></span></code>.</p>
<p>When <code><span class="highlight-candombe-inline"><span class="n">condval</span></span></code> is 1, then <code><span class="highlight-candombe-inline"><span class="o">-</span><span class="p">(</span><span class="n">condval</span><span class="p">)</span></span></code> is 1, represented as eight <code><span class="highlight-candombe-inline"><span class="mi">1</span></span></code> bits because in Z3 (and it a lot of other languages), the negative numbers are in 2-complement representation.</p>
<p>This <code><span class="highlight-candombe-inline"><span class="mi">1</span></span></code> bits mask <em>allows</em> the right side to be xor’d with the left side <code><span class="highlight-candombe-inline"><span class="n">elseval</span> <span class="o">^</span> <span class="n">thenval</span> <span class="o">^</span> <span class="n">elseval</span></span></code> which reduces to <code><span class="highlight-candombe-inline"><span class="n">thenval</span></span></code>.</p>
<p>This why the <strong>branchless</strong> bithack works and more over, from <em>where</em> those multiplications come: from the 2-complement.</p>
<p><code><span class="highlight-candombe-inline"><span class="n">z3</span><span class="o">.</span><span class="n">simplify</span></span></code> was <strong>not</strong> smart enough to <em>broadcasting</em> the least significant bit of <code><span class="highlight-candombe-inline"><span class="n">a</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span></span></code>.</p>
<p>We could do it better <em>broadcasting</em> the most significant bit of <code><span class="highlight-candombe-inline"><span class="n">a</span></span></code> and build the <em>condition mask</em> directly:</p>
<div class="highlight-candombe"><pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">z3</span> <span class="kn">import</span> <span class="n">Extract</span><span class="p">,</span> <span class="n">Concat</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">def</span> <span class="nf">xtime_broadcasted</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
<span class="o">...</span>     <span class="n">elseval</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span>
<span class="o">...</span>     <span class="n">thenval</span> <span class="o">=</span> <span class="p">(</span><span class="n">elseval</span> <span class="o">^</span> <span class="mh">0x1B</span><span class="p">)</span>
<span class="o">...</span>     <span class="n">msb</span> <span class="o">=</span> <span class="n">Extract</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>
<span class="o">...</span>     <span class="n">condmask</span> <span class="o">=</span> <span class="n">Concat</span><span class="p">(</span><span class="o">*</span><span class="p">([</span><span class="n">msb</span><span class="p">]</span> <span class="o">*</span> <span class="mi">8</span><span class="p">))</span> <span class="c1"># broadcast a single bit to 8 bits</span>
<span class="o">...</span>     <span class="k">return</span> <span class="n">elseval</span> <span class="o">^</span> <span class="p">((</span><span class="n">thenval</span> <span class="o">^</span> <span class="n">elseval</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">condmask</span><span class="p">)</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">xtime_broadcasted</span><span class="p">(</span><span class="n">T</span><span class="p">)</span>
<span class="n">T</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span> <span class="o">^</span>
<span class="p">(</span><span class="n">T</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span> <span class="o">^</span> <span class="mi">27</span> <span class="o">^</span> <span class="n">T</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span>
<span class="n">Concat</span><span class="p">(</span><span class="n">Concat</span><span class="p">(</span><span class="n">Concat</span><span class="p">(</span><span class="n">Concat</span><span class="p">(</span><span class="n">Concat</span><span class="p">(</span><span class="n">Concat</span><span class="p">(</span><span class="n">Concat</span><span class="p">(</span><span class="n">Extract</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span>
                                        <span class="mi">7</span><span class="p">,</span>
                                        <span class="n">T</span><span class="p">),</span>
                                        <span class="n">Extract</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="n">T</span><span class="p">)),</span>
                                        <span class="n">Extract</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="n">T</span><span class="p">)),</span>
                                   <span class="n">Extract</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="n">T</span><span class="p">)),</span>
                            <span class="n">Extract</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="n">T</span><span class="p">)),</span>
                     <span class="n">Extract</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="n">T</span><span class="p">)),</span>
              <span class="n">Extract</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="n">T</span><span class="p">)),</span>
       <span class="n">Extract</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="n">T</span><span class="p">))</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">simplify</span><span class="p">(</span><span class="n">xtime_broadcasted</span><span class="p">(</span><span class="n">T</span><span class="p">))</span>
<span class="n">Concat</span><span class="p">(</span><span class="n">Extract</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">T</span><span class="p">),</span>
       <span class="n">Extract</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">T</span><span class="p">)</span> <span class="o">^</span> <span class="n">Extract</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="n">T</span><span class="p">),</span>
       <span class="n">Extract</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">T</span><span class="p">)</span> <span class="o">^</span> <span class="n">Extract</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="n">T</span><span class="p">),</span>
       <span class="n">Extract</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">T</span><span class="p">),</span>
       <span class="n">Extract</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">T</span><span class="p">)</span> <span class="o">^</span> <span class="n">Extract</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="n">T</span><span class="p">),</span>
       <span class="n">Extract</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="n">T</span><span class="p">))</span>
</code></pre></div>

<p>Ugly but once simplified with <code><span class="highlight-candombe-inline"><span class="n">z3</span><span class="o">.</span><span class="n">simplify</span></span></code>, <code><span class="highlight-candombe-inline"><span class="n">xtime_broadcasted</span></span></code> seems to be quite simple: only bit picking and xor.</p>
<h2 id="one-last-hack">One last hack</h2>
<p><code><span class="highlight-candombe-inline"><span class="n">xtime_broadcasted</span></span></code> can be simplified further <em>canceling</em> the <code><span class="highlight-candombe-inline"><span class="n">elseval</span></span></code> from <code><span class="highlight-candombe-inline"><span class="n">thenval</span> <span class="o">^</span> <span class="n">elseval</span></span></code> because <code><span class="highlight-candombe-inline"><span class="n">thenval</span> <span class="o">==</span> <span class="n">elseval</span> <span class="o">&amp;</span> <span class="mh">0x1B</span></span></code></p>
<p>So <code><span class="highlight-candombe-inline"><span class="n">elseval</span> <span class="o">^</span> <span class="p">((</span><span class="n">thenval</span> <span class="o">^</span> <span class="n">elseval</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">condmask</span><span class="p">)</span></span></code> reduces to <code><span class="highlight-candombe-inline"><span class="n">elseval</span> <span class="o">^</span> <span class="p">(</span><span class="mh">0x1B</span> <span class="o">&amp;</span> <span class="n">condmask</span><span class="p">)</span></span></code>:</p>
<div class="highlight-candombe"><pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="k">def</span> <span class="nf">xtime_cancelled</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
<span class="o">...</span>     <span class="n">elseval</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span>
<span class="o">...</span>     <span class="n">msb</span> <span class="o">=</span> <span class="n">Extract</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>
<span class="o">...</span>     <span class="n">condmask</span> <span class="o">=</span> <span class="n">Concat</span><span class="p">(</span><span class="o">*</span><span class="p">([</span><span class="n">msb</span><span class="p">]</span> <span class="o">*</span> <span class="mi">8</span><span class="p">))</span> <span class="c1"># broadcast a single bit to 8 bits</span>
<span class="o">...</span>     <span class="k">return</span> <span class="n">elseval</span> <span class="o">^</span> <span class="p">(</span><span class="mh">0x1B</span> <span class="o">&amp;</span> <span class="n">condmask</span><span class="p">)</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">xtime_cancelled</span><span class="p">(</span><span class="n">T</span><span class="p">)</span>
<span class="n">T</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span> <span class="o">^</span>
<span class="mi">27</span> <span class="o">&amp;</span>
<span class="n">Concat</span><span class="p">(</span><span class="n">Concat</span><span class="p">(</span><span class="n">Concat</span><span class="p">(</span><span class="n">Concat</span><span class="p">(</span><span class="n">Concat</span><span class="p">(</span><span class="n">Concat</span><span class="p">(</span><span class="n">Concat</span><span class="p">(</span><span class="n">Extract</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span>
                                        <span class="mi">7</span><span class="p">,</span>
                                        <span class="n">T</span><span class="p">),</span>
                                        <span class="n">Extract</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="n">T</span><span class="p">)),</span>
                                        <span class="n">Extract</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="n">T</span><span class="p">)),</span>
                                   <span class="n">Extract</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="n">T</span><span class="p">)),</span>
                            <span class="n">Extract</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="n">T</span><span class="p">)),</span>
                     <span class="n">Extract</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="n">T</span><span class="p">)),</span>
              <span class="n">Extract</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="n">T</span><span class="p">)),</span>
       <span class="n">Extract</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="n">T</span><span class="p">))</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">simplify</span><span class="p">(</span><span class="n">xtime_cancelled</span><span class="p">(</span><span class="n">T</span><span class="p">))</span>
<span class="n">Concat</span><span class="p">(</span><span class="n">Extract</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">T</span><span class="p">),</span>
       <span class="n">Extract</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">T</span><span class="p">)</span> <span class="o">^</span> <span class="n">Extract</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="n">T</span><span class="p">),</span>
       <span class="n">Extract</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">T</span><span class="p">)</span> <span class="o">^</span> <span class="n">Extract</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="n">T</span><span class="p">),</span>
       <span class="n">Extract</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">T</span><span class="p">),</span>
       <span class="n">Extract</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">T</span><span class="p">)</span> <span class="o">^</span> <span class="n">Extract</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="n">T</span><span class="p">),</span>
       <span class="n">Extract</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="n">T</span><span class="p">))</span>
</code></pre></div>

<p>Note how <code><span class="highlight-candombe-inline"><span class="n">z3</span><span class="o">.</span><span class="n">simplify</span></span></code> was <strong>smart</strong> enough to do the <em>cancellation</em> automatically by itself: once simplified by Z3, <code><span class="highlight-candombe-inline"><span class="n">xtime_broadcasted</span></span></code> and <code><span class="highlight-candombe-inline"><span class="n">xtime_cancelled</span></span></code> are the same.</p>
<h2 id="correctness-of-xtime">Correctness of <code><span class="highlight-candombe-inline"><span class="n">xtime</span><span class="o">*</span></span></code></h2>
<p>Let’s verify that we didn’t screw up.</p>
<p>The search space is only \(2^8\) so we can prove if the <code><span class="highlight-candombe-inline"><span class="n">xtime_X</span></span></code> works comparing it with the original <code><span class="highlight-candombe-inline"><span class="n">xtime</span></span></code> <strong>for all the possible inputs</strong>.</p>
<div class="highlight-candombe"><pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">z3</span> <span class="kn">import</span> <span class="n">Solver</span><span class="p">,</span> <span class="n">And</span><span class="p">,</span> <span class="n">Or</span><span class="p">,</span> <span class="n">BitVec</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">a</span> <span class="o">=</span> <span class="n">BitVec</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">solver</span> <span class="o">=</span> <span class="n">Solver</span><span class="p">()</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">full_search</span> <span class="o">=</span> <span class="p">[</span><span class="n">And</span><span class="p">(</span><span class="n">a</span> <span class="o">==</span> <span class="n">i</span><span class="p">,</span> <span class="n">xtime_branch</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">==</span> <span class="n">xtime</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">256</span><span class="p">)]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">solver</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="n">Or</span><span class="p">(</span><span class="o">*</span><span class="n">full_search</span><span class="p">))</span>
<span class="n">sat</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">full_search</span> <span class="o">=</span> <span class="p">[</span><span class="n">And</span><span class="p">(</span><span class="n">a</span> <span class="o">==</span> <span class="n">i</span><span class="p">,</span> <span class="n">xtime_branchless</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">==</span> <span class="n">xtime</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">256</span><span class="p">)]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">solver</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="n">Or</span><span class="p">(</span><span class="o">*</span><span class="n">full_search</span><span class="p">))</span>
<span class="n">sat</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">full_search</span> <span class="o">=</span> <span class="p">[</span><span class="n">And</span><span class="p">(</span><span class="n">a</span> <span class="o">==</span> <span class="n">i</span><span class="p">,</span> <span class="n">xtime_cancelled</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">==</span> <span class="n">xtime</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">256</span><span class="p">)]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">solver</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="n">Or</span><span class="p">(</span><span class="o">*</span><span class="n">full_search</span><span class="p">))</span>
<span class="n">sat</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">full_search</span> <span class="o">=</span> <span class="p">[</span><span class="n">And</span><span class="p">(</span><span class="n">a</span> <span class="o">==</span> <span class="n">i</span><span class="p">,</span> <span class="n">xtime_broadcasted</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">==</span> <span class="n">xtime</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">256</span><span class="p">)]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">solver</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="n">Or</span><span class="p">(</span><span class="o">*</span><span class="n">full_search</span><span class="p">))</span>
<span class="n">sat</span>
</code></pre></div>

<p>Everything is in order.</p>
<h2 id="experiments-setup">Experiments setup</h2>
<p>The 4 functions were tested in <a href="/assets/z3/perf/performance-ite-expr.py">4 different experiments</a> or scenarios:</p>
<ul>
<li><code><span class="highlight-candombe-inline"><span class="n">null_experiment</span></span></code>: an 8-bit vector and a simple bitmask operation on it <strong>without</strong> using <code><span class="highlight-candombe-inline"><span class="n">xtime</span><span class="o">*</span></span></code>. Intended to see the performance of Z3 in a trivial case.</li>
<li><code><span class="highlight-candombe-inline"><span class="n">single_bitvec_experiment</span></span></code>: a call to <code><span class="highlight-candombe-inline"><span class="n">xtime</span><span class="o">*</span></span></code> on an 8-bit vector and the verification of the results testing 256 possible values.</li>
<li><code><span class="highlight-candombe-inline"><span class="n">mix_two_bitvec_experiment</span></span></code>: call <code><span class="highlight-candombe-inline"><span class="n">xtime</span><span class="o">*</span></span></code> twice on two 8-bit vectors, perform a few bitmask operations on them and verify the correctness doing a full search of the 65536 possible values.</li>
<li><code><span class="highlight-candombe-inline"><span class="n">encrypt_rounds_experiment</span></span></code>: call <code><span class="highlight-candombe-inline"><span class="n">xtime</span><span class="o">*</span></span></code> several times doing several bitmask and shift operations on 32 8-bit vectors. This represents a simplified version of a single round of the AES cipher.</li>
</ul>
<p>For each experiment, each <code><span class="highlight-candombe-inline"><span class="n">xtime</span><span class="o">*</span></span></code> function was tested using the simplified and not-simplified variants.</p>
<p>Each experiment consisted in create and setup a new <code><span class="highlight-candombe-inline"><span class="n">z3</span><span class="o">.</span><span class="n">Solver</span></span></code> with its <em>own</em> <code><span class="highlight-candombe-inline"><span class="n">z3</span><span class="o">.</span><span class="n">Context</span></span></code> and <a href="/assets/z3/perf/perf-results.pq">measure the time</a> that it took checking the model: the <code><span class="highlight-candombe-inline"><span class="n">check</span><span class="o">-</span><span class="n">elapsed</span></span></code> time.</p>
<p>Because Z3 is <strong>not</strong> deterministic, we ran each experiment at least 20 times with a maximum of 100 times and collected not only the <code><span class="highlight-candombe-inline"><span class="n">check</span><span class="o">-</span><span class="n">elapsed</span></span></code> time but also the <a href="/assets/z3/perf/z3-stats-results.pq">statistics of the solver</a> provided by Z3 with <code><span class="highlight-candombe-inline"><span class="n">solver</span><span class="o">.</span><span class="n">statistics</span><span class="p">()</span></span></code>.</p>
<p>The <code><span class="highlight-candombe-inline"><span class="n">null_experiment</span></span></code> actually does <strong>not</strong> use the <code><span class="highlight-candombe-inline"><span class="n">xtime</span><span class="o">*</span></span></code> function and it is used to have an idea of how small the <code><span class="highlight-candombe-inline"><span class="n">check</span><span class="o">-</span><span class="n">elapsed</span></span></code> time can be.</p>
<h2 id="experiments-results">Experiments results</h2>
<p>The first thing that we can see is how each <code><span class="highlight-candombe-inline"><span class="n">xtime</span><span class="o">*</span></span></code> performed in each experiment.</p>
<p><figure class='fullwidth'><img style="width: 100%;" class='fullwidth' alt='' src='/img/z3/perf/mean-check-elapsed-per-func-experiment.svg' />
<figcaption>
Mean <code><span class="highlight-candombe-inline"><span class="n">check</span><span class="o">-</span><span class="n">elapsed</span></span></code> time (y axis) per <code><span class="highlight-candombe-inline"><span class="n">xtime</span><span class="o">*</span></span></code> function (x axis). Each subplot corresponds to a different experiment.
</figcaption></figure></p>
<p>A few remarks:</p>
<ul>
<li>The <code><span class="highlight-candombe-inline"><span class="n">null_experiment</span></span></code> shows a quite stable plot regardless of the <code><span class="highlight-candombe-inline"><span class="n">xtime</span><span class="o">*</span></span></code> used as expected.</li>
<li>For <code><span class="highlight-candombe-inline"><span class="n">single_bitvec_experiment</span></span></code> and <code><span class="highlight-candombe-inline"><span class="n">mix_two_bitvec_experiment</span></span></code> there is little difference if <code><span class="highlight-candombe-inline"><span class="n">xtime</span><span class="o">*</span></span></code> was simplified or not but it <strong>really made a difference</strong> for the <code><span class="highlight-candombe-inline"><span class="n">encrypt_rounds_experiment</span></span></code>.</li>
<li>The ITE expression of <code><span class="highlight-candombe-inline"><span class="n">xtime_branch</span></span></code> performed better than the others in <code><span class="highlight-candombe-inline"><span class="n">single_bitvec_experiment</span></span></code> but it was as twice as slow in <code><span class="highlight-candombe-inline"><span class="n">mix_two_bitvec_experiment</span></span></code>. <em>Why?</em></li>
<li>The <code><span class="highlight-candombe-inline"><span class="n">encrypt_rounds_experiment</span></span></code> shows some weird results: a simplified <code><span class="highlight-candombe-inline"><span class="n">xtime_branchless</span></span></code> is incredibly slow while the non-simplified version is incredibly fast, even faster than the rest.</li>
<li>Moreover, in <code><span class="highlight-candombe-inline"><span class="n">encrypt_rounds_experiment</span></span></code> the simplified <code><span class="highlight-candombe-inline"><span class="n">xtime_broadcasted</span></span></code> and <code><span class="highlight-candombe-inline"><span class="n">xtime_cancelled</span></span></code> have different performance but as we shown before, they are the same!</li>
</ul>
<p>This last item makes me thing, are we seeing an outlier affecting the mean?</p>
<p>We can rule that out measuring the <em>minimum</em> instead of the <em>mean</em>.</p>
<p><figure><figcaption><span markdown='1'>
Minimum <code><span class="highlight-candombe-inline"><span class="n">check</span><span class="o">-</span><span class="n">elapsed</span></span></code> time (y axis) per <code><span class="highlight-candombe-inline"><span class="n">xtime</span><span class="o">*</span></span></code> function (x axis). Each subplot corresponds to a different experiment. Note how the plot has the same shape than before.
</span></figcaption>
<img style="width: 100%;" class='' alt='' src='/img/z3/perf/min-check-elapsed-per-func-in-encrypt-experiment.svg' /></figure></p>
<p>Nope, same thing.</p>
<p>Could be this discrepancy be just by luck? We need a measure independent from the time and Z3 tracks several statistics for that.</p>
<p>It’s unclear what they mean however.</p>
<p>Exploring a little it seems that there is a relationship between <code><span class="highlight-candombe-inline"><span class="s1">&#39;added eqs&#39;</span></span></code> and the elapsed time.</p>
<p><figure><figcaption><span markdown='1'>
Relation and linear regression between the time that <code><span class="highlight-candombe-inline"><span class="n">check</span><span class="p">()</span></span></code> took and the amount of <code><span class="highlight-candombe-inline"><span class="n">added</span> <span class="n">eqs</span></span></code>. They follow almost a perfect linear relationship.
</span></figcaption>
<img style="width: 100%;" class='' alt='' src='/img/z3/perf/rel-check-elapsed-and-added-eqs.svg' /></figure></p>
<p>Let’s see how many <code><span class="highlight-candombe-inline"><span class="n">eqs</span></span></code> were <code><span class="highlight-candombe-inline"><span class="n">added</span></span></code> in the <code><span class="highlight-candombe-inline"><span class="n">encrypt_rounds_experiment</span></span></code>:</p>
<p><figure><figcaption><span markdown='1'>
Mean <code><span class="highlight-candombe-inline"><span class="n">added</span> <span class="n">eqs</span></span></code> (y axis) per <code><span class="highlight-candombe-inline"><span class="n">xtime</span><span class="o">*</span></span></code> function (x axis). Each subplot corresponds to a different experiment. Note how the plot has the same shape than before showing a strong relationship between <code><span class="highlight-candombe-inline"><span class="n">added</span> <span class="n">eqs</span></span></code> and the <code><span class="highlight-candombe-inline"><span class="n">check</span><span class="o">-</span><span class="n">elapsed</span></span></code> time.
</span></figcaption>
<img style="width: 100%;" class='' alt='' src='/img/z3/perf/mean-added-eqs-per-func-in-encrypt-experiment.svg' /></figure></p>
<p>Same shape that before: for some reason Z3 added more eqs in <code><span class="highlight-candombe-inline"><span class="n">xtime_broadcasted</span></span></code> than in <code><span class="highlight-candombe-inline"><span class="n">xtime_cancelled</span></span></code> (both simplified) even if both are the same Z3 expressions.</p>
<p>So the discrepancy is not due the noise: Z3 indeed saw these two as different things.</p>
<h3 id="code-and-results">Code and results</h3>
<ul>
<li><a href="/assets/z3/perf/performance-ite-expr.py">Experiments (Python code)</a></li>
<li><a href="/assets/z3/perf/plot.py">Plotting (Python code)</a></li>
<li><a href="/assets/z3/perf/perf-results.pq">Runtime results (Pandas DataFrame in Parquet format)</a></li>
<li><a href="/assets/z3/perf/z3-stats-results.pq">Z3 stats (Pandas DataFrame in Parquet format)</a></li>
</ul>
<h2 id="conclusions">Conclusions</h2>
<p>None.</p>
<p>I’m still missing a lot of pieces of this puzzle.</p>
<p class="small-subtitle-with-top-margin">
Related tags: <a href='https://book-of-gehn.github.io/?tag="z3"'>z3</a>, <a href='https://book-of-gehn.github.io/?tag="smt"'>smt</a>, <a href='https://book-of-gehn.github.io/?tag="sat"'>sat</a>, <a href='https://book-of-gehn.github.io/?tag="solver"'>solver</a>, <a href='https://book-of-gehn.github.io/?tag="if ITE"'>if ITE</a>, <a href='https://book-of-gehn.github.io/?tag="bithack"'>bithack</a>, <a href='https://book-of-gehn.github.io/?tag="performance"'>performance</a>
</p>
<script src="https://utteranc.es/client.js"
        repo="book-of-gehn/book-of-gehn.github.io"
        issue-term="pathname"
        label="comments-utteranc"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
</article>
<span class="print-footer">Performance of ITE Expressions (incomplete) - June 14, 2021 - Martin Di Paola</span>
<footer>
    <hr class="slender">
    <div class="credits">
        <span>&copy;
            Martin Di Paola
        </span></br>
            <a class="raw_link" href="/atom.xml"><img height="16px" width="16px" src="/img/rss-32px.png" /></a>
            <a class="raw_link" href="https://github.com/eldipa"><img height="16px" width="16px" src="/img/github.png" /></a>
        <br>
        
        <a href="mailto:martinp.dipaola@gmail.com">martinp.dipaola@gmail.com</a></span></br> <br>
        
    </div>

    <img src='http://192.34.63.156:6127/img/http%3A//127.0.0.1%3A4000/articles/2021/06/14/Performance-of-ITE-Expressions.html.png' onerror="this.style.display='none'" async></img>
</footer>
</body>
</html>
