<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>IPv4 Scan 2021 - Dataset Preprocessing</title>
  <meta name="description" content="The datasetis a survey or port scan of the whole IPv4 range madewith masscan.The dataset however is much smaller than the expected mostly becausemost of the ...">

  
    <link href='//fonts.googleapis.com/css?family=Lato:400,400italic' rel='stylesheet' type='text/css'>
  

  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        extensions: ["tex2jax.js"],
        jax: ["input/TeX","output/HTML-CSS"],
        tex2jax: {inlineMath: [["$$","$$"],["\\(","\\)"]]},
	TeX: {
	  Macros: {
            
	  }
	}
      });
    </script>
    
      <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js' async></script>
    
  

  
    <script
       src="https://code.jquery.com/jquery-3.4.1.min.js"
       integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
       crossorigin="anonymous"></script>
  

  

    
      <script src='https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.9.1/underscore-min.js' ></script>
    

    
      <script src="https://d3js.org/d3.v4.min.js"></script>
    

    <script src='/js/venn/venn.min.js'></script>
    <script src='/js/venn/helper.js'></script>

    <script src='/js/fix_syntax_highlight.js'></script>
  <link rel="stylesheet" type="text/css" href="/css/tufte.css">
  <link rel="stylesheet" type="text/css" href="/css/latex.css">

  <link rel="canonical" href="/articles/2021/09/10/IPv4-Scan-Dataset-Preprocessing.html">

  <link rel="stylesheet" type="text/css" href="/css/all.min.css">

    <script src='/js/lunr-2.3.9.js'></script>
    <script src='/js/search_index.js'></script>
    <script src='/js/search.js'></script>
  <link type="application/atom+xml" rel="alternate" href="/feed.xml" title="The Book of Gehn" />
</head>

  <body>
    <header>
	
                <hgroup class="header-group">
		<h1 class="header-title"><a href="/">The Book of Gehn</a></h1>
                </hgroup>
                <ul class="header-list">
                    <li><a href="https://byexamples.github.io">byexample</a></li>
                    <li><a href="https://bisturi.github.io">bisturi</a></li>
                    <li>
                        <a class="raw_link" href="/feed.xml"><img height="16px" width="16px" src="/assets/blog-assets/rss-32px.png" /></a>
                        <a class="raw_link" href="https://github.com/eldipa"><img height="16px" width="16px" src="/assets/blog-assets/github.png" /></a>
                    </li>
                </ul>
		
		
	

    

    <nav class="group">
    
            <form id="blog-search-form">
                <input type="search" placeholder="+must -not *fuzzy*"></input>
                <span class="query-error"></span>
                <span class="controls">
                    <button type="submit">Filter</button>
                    <button style="display: none;" id="reset_search" type="reset">Clear</button>
                </span>
            </form>
	</nav>

    <div style="display: none;" id="search_error"></div>
    <article style="display: none;" class="group" id="search_results">
    </article>
</header>

    <article class="group">
      <h1>IPv4 Scan 2021 - Dataset Preprocessing</h1>
<p class="subtitle">September 10, 2021</p>

<p>The <a href="https://www.kaggle.com/signalspikes/internet-port-scan-1">dataset</a>
is a survey or port scan of the whole IPv4 range made
with <a href="https://github.com/robertdavidgraham/masscan">masscan</a>.</p>

<p>The dataset however is much smaller than the expected mostly because
most of the hosts didn’t response and/or they had all the scanned ports
closed.</p>

<p>Only open ports were registered.</p>

<p>More over, of the 65536 available ports only a few were scanned and only
for the TCP protocol.</p>

<p>Even with such reduced scope the dataset occupies around 9 GB.</p>

<p>This post is a walk-through for loading and preprocessing it.<!--more--></p>

<h2 id="loading-json">Loading JSON</h2>

<p>The original dataset is in JSON which it is not the most
space-efficient format.</p>

<p>It consists in an array of hosts and per host we have an array of ports.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="p">{</span>
    <span class="dl">'</span><span class="s1">ip</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">165.221.32.138</span><span class="dl">'</span><span class="p">,</span>
    <span class="dl">'</span><span class="s1">timestamp</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">1619562631</span><span class="dl">'</span><span class="p">,</span>
    <span class="dl">'</span><span class="s1">ports</span><span class="dl">'</span><span class="p">:</span> <span class="p">[</span>
       <span class="p">{</span>
         <span class="dl">'</span><span class="s1">port</span><span class="dl">'</span><span class="p">:</span> <span class="mi">21</span><span class="p">,</span>
         <span class="dl">'</span><span class="s1">proto</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">tcp</span><span class="dl">'</span><span class="p">,</span>
         <span class="dl">'</span><span class="s1">status</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">open</span><span class="dl">'</span><span class="p">,</span>
         <span class="dl">'</span><span class="s1">reason</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">syn-ack</span><span class="dl">'</span><span class="p">,</span>
         <span class="dl">'</span><span class="s1">ttl</span><span class="dl">'</span><span class="p">:</span> <span class="mi">245</span>
       <span class="p">}</span>
    <span class="p">]</span>
  <span class="p">}</span>
</code></pre></div></div>

<p>So there is plenty room for improvements.</p>

<p>Python’s <code class="highlighter-rouge">json</code> library loads everything to memory. This is a no-go.
We use instead <a href="https://github.com/ICRAR/ijson">ijson</a> that iterates
over the elements of the file loading only what it is needed.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">ijson</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="c1"># read from standard input and yield each host from it
</span><span class="n">hosts</span> <span class="o">=</span> <span class="n">ijson</span><span class="o">.</span><span class="n">items</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="p">,</span> <span class="s">'item'</span><span class="p">)</span>

<span class="k">for</span> <span class="n">host</span> <span class="ow">in</span> <span class="n">hosts</span><span class="p">:</span>
    <span class="n">ip</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">,</span> <span class="n">ports</span> <span class="o">=</span> <span class="n">host</span><span class="p">[</span><span class="s">'ip'</span><span class="p">],</span> <span class="nb">int</span><span class="p">(</span><span class="n">host</span><span class="p">[</span><span class="s">'timestamp'</span><span class="p">]),</span> <span class="n">host</span><span class="p">[</span><span class="s">'ports'</span><span class="p">]</span>
    <span class="o">...</span>
</code></pre></div></div>

<h2 id="ipv4-packing">IPv4 packing</h2>

<p>The IP address can be stored in 4 bytes and Python’s <code class="highlighter-rouge">ipaddress</code> can pack
it for us:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">ipaddress</span>

<span class="k">for</span> <span class="n">host</span> <span class="ow">in</span> <span class="n">hosts</span><span class="p">:</span>
    <span class="n">ip</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">,</span> <span class="n">ports</span> <span class="o">=</span> <span class="n">host</span><span class="p">[</span><span class="s">'ip'</span><span class="p">],</span> <span class="nb">int</span><span class="p">(</span><span class="n">host</span><span class="p">[</span><span class="s">'timestamp'</span><span class="p">]),</span> <span class="n">host</span><span class="p">[</span><span class="s">'ports'</span><span class="p">]</span>

    <span class="n">ip</span> <span class="o">=</span> <span class="n">ipaddress</span><span class="o">.</span><span class="n">ip_address</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">ip</span><span class="o">.</span><span class="n">version</span> <span class="o">==</span> <span class="mi">4</span>

    <span class="n">ip</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span>
    <span class="o">...</span>
</code></pre></div></div>

<h2 id="categorical-data">Categorical data</h2>

<p>Each port has a <code class="highlighter-rouge">status</code> and protocol (<code class="highlighter-rouge">proto</code>). Because those two
are fixed to <code class="highlighter-rouge">open</code> and <code class="highlighter-rouge">tcp</code> respectively, it is pointless to store
them.</p>

<p>The rest of the port’s attributes are more interesting:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for</span> <span class="n">host</span> <span class="ow">in</span> <span class="n">hosts</span><span class="p">:</span>
    <span class="o">...</span>
    <span class="k">for</span> <span class="n">port</span> <span class="ow">in</span> <span class="n">ports</span><span class="p">:</span>
        <span class="n">num</span><span class="p">,</span> <span class="n">ttl</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">port</span><span class="p">[</span><span class="s">'port'</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">port</span><span class="p">[</span><span class="s">'ttl'</span><span class="p">])</span>
        <span class="n">reason</span> <span class="o">=</span> <span class="n">port</span><span class="p">[</span><span class="s">'reason'</span><span class="p">]</span>
        <span class="o">...</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">reason</code> is a string that represent why the port is open. But strings
are expensive.</p>

<p>We can use instead a <em>categorical type</em>, a mapping between these strings
and integers that represent them more efficiently:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">pandas.api.types</span> <span class="kn">import</span> <span class="n">CategoricalDtype</span>

<span class="c1"># all the reasons that are in the dataset
</span><span class="n">reason_cat</span> <span class="o">=</span> <span class="n">CategoricalDtype</span><span class="p">([</span>
    <span class="s">'syn-ack'</span><span class="p">,</span>
    <span class="s">'syn-ack-ece-cwr'</span><span class="p">,</span>
    <span class="s">'syn-ack-ece'</span><span class="p">,</span>
    <span class="s">'syn-psh-ack'</span><span class="p">,</span>
    <span class="s">'syn-ack-cwr'</span><span class="p">,</span>
    <span class="s">'fin-syn-ack'</span>
    <span class="p">])</span>
</code></pre></div></div>

<p>Pandas already generates the categories for us but this requires to feed
Pandas with all the dataset at once.</p>

<p>Instead we create the categories beforehand, split the dataset
into manageable subsets, <em>buckets</em> or <em>partitions</em> and create one Pandas’
<code class="highlighter-rouge">DataFrame</code> per bucket/partition.</p>

<p>We use the <em>same</em> <code class="highlighter-rouge">reason_cat</code> object for all the dataframes created.</p>

<p>This is critical because merging/concatenating two dataframes
with different (but semantically-equivalent) category sets will
<strong>not</strong> raise any error but it will convert the column(s) into
object type.</p>

<p>Quiet unhappy.</p>

<p><label for="mn-8bf42f2fd69ca2a31f933f79f7aefb0a" class="margin-toggle"> ⊕</label><input type="checkbox" id="mn-8bf42f2fd69ca2a31f933f79f7aefb0a" class="margin-toggle" /><span class="marginnote">Yes, I know, 22 is less than 80
but it is meaningless: “ssh” is less than “http”, what could you draw
from it?
 </span></p>

<p>The port numbers are also categories as they are not quantities
nor have a meaningful order.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># all the port numbers that are in the dataset
</span><span class="n">port_cat</span> <span class="o">=</span> <span class="n">CategoricalDtype</span><span class="p">([</span>
    <span class="s">'21'</span><span class="p">,</span>
    <span class="s">'22'</span><span class="p">,</span>
    <span class="s">'23'</span><span class="p">,</span>
    <span class="s">'80'</span><span class="p">,</span>
    <span class="s">'443'</span><span class="p">,</span>
    <span class="s">'3389'</span><span class="p">,</span>
    <span class="s">'4444'</span><span class="p">,</span>
    <span class="s">'5601'</span><span class="p">,</span>
    <span class="s">'8000'</span><span class="p">,</span>
    <span class="s">'8443'</span><span class="p">,</span>
    <span class="s">'9200'</span><span class="p">,</span>
    <span class="p">])</span>
</code></pre></div></div>

<h2 id="serialization-in-apaches-parquet-format">Serialization in Apache’s Parquet format</h2>

<p>To keep the dataset as small as possible we can use smaller types
for each column:</p>

<ul>
  <li><code class="highlighter-rouge">ip</code> and <code class="highlighter-rouge">timestamp</code> can be represented by <code class="highlighter-rouge">uint32</code></li>
  <li><code class="highlighter-rouge">ttl</code> fits perfectly in <code class="highlighter-rouge">uint8</code></li>
</ul>

<p>Finally, we store each dataframe in disk using
Apache’s <a href="https://parquet.apache.org/">Parquet format</a>. We use version 2
that supports a much richer set of data types including <code class="highlighter-rouge">uint32</code>.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">save_df</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">fileno</span><span class="p">):</span>
    <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s">'ip'</span><span class="p">,</span> <span class="s">'timestamp'</span><span class="p">,</span> <span class="s">'port'</span><span class="p">,</span> <span class="s">'ttl'</span><span class="p">,</span> <span class="s">'reason'</span><span class="p">]</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">columns</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">astype</span><span class="p">({</span>
        <span class="s">'ip'</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">,</span>   <span class="s">'timestamp'</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">,</span>
        <span class="s">'port'</span><span class="p">:</span> <span class="n">port_cat</span><span class="p">,</span>  <span class="s">'reason'</span><span class="p">:</span> <span class="n">reason_cat</span><span class="p">,</span>
        <span class="s">'ttl'</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">,</span>
        <span class="p">})</span>

    <span class="c1"># clean up
</span>    <span class="n">rows</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

    <span class="c1"># Save. 'brotli' yielded better compression ratio
</span>    <span class="c1"># when compared with snappy y gzip.
</span>    <span class="n">df</span><span class="o">.</span><span class="n">to_parquet</span><span class="p">(</span><span class="n">f</span><span class="s">'scan{fileno:04}.pq'</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="s">'brotli'</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="s">'2.0'</span><span class="p">)</span>


<span class="n">i</span><span class="p">,</span> <span class="n">fileno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
<span class="n">rows</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">host</span> <span class="ow">in</span> <span class="n">hosts</span><span class="p">:</span>
    <span class="o">...</span>
    <span class="k">for</span> <span class="n">port</span> <span class="ow">in</span> <span class="n">ports</span><span class="p">:</span>
        <span class="o">...</span>
        <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">ttl</span><span class="p">,</span> <span class="n">reason</span><span class="p">)</span>

    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="n">bucket_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">save_df</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">fileno</span><span class="p">)</span>
        <span class="n">fileno</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="o">...</span>
</code></pre></div></div>

<p>The dataframes are in <em>tidy format</em>: each row represents a single
observation, or in this case, a single port scan.</p>

<p>We repeat over and over data that it is shared between port scans
like the IP address or the timestamp (it is the opposite format
of the <em>normalized format</em>).</p>

<p>It occupies more space, yes, but the manipulation of the dataset is <em>much
simpler</em> and Pandas and Seaborn <em>are</em> tidy-centric.</p>

<h2 id="host-aggregation">Host aggregation</h2>

<p>We know that all the ports for the same host are in the same <code class="highlighter-rouge">df</code>
object so we can do some analysis here instead on the whole dataset.</p>

<p>We could count how many ports each host has, how many <em>different</em>
reasons were found on each host and the minimum and maximum
TTL seen.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s">'ip'</span><span class="p">,</span> <span class="s">'port'</span><span class="p">,</span> <span class="s">'ttl'</span><span class="p">,</span> <span class="s">'reason'</span><span class="p">]]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s">'ip'</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">({</span>
    <span class="s">'port'</span><span class="p">:</span> <span class="s">'count'</span><span class="p">,</span>
    <span class="s">'ttl'</span><span class="p">:</span> <span class="p">[</span><span class="s">'min'</span><span class="p">,</span> <span class="s">'max'</span><span class="p">],</span>
    <span class="s">'reason'</span><span class="p">:</span> <span class="s">'nunique'</span><span class="p">,</span>
<span class="p">})</span>
</code></pre></div></div>

<p>After a group by/aggregation, the columns will be <em>multi-index</em> (to
access the minimum of the TTL we will write <code class="highlighter-rouge">df['ttl']['min']</code>).</p>

<p>We don’t want that so we can remap the columns and reset the index.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="nb">map</span><span class="p">(</span><span class="s">'_'</span><span class="o">.</span><span class="n">join</span><span class="p">)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">astype</span><span class="p">({</span>
    <span class="s">'port_count'</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">,</span>
    <span class="s">'reason_count'</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span>
<span class="p">})</span>
</code></pre></div></div>

<p>Then we can extend <code class="highlighter-rouge">save_df()</code>:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">save_df</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">fileno</span><span class="p">):</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">columns</span><span class="p">)</span>
    <span class="o">...</span>
    <span class="n">df</span><span class="o">.</span><span class="n">to_parquet</span><span class="p">(</span><span class="n">f</span><span class="s">'scan/scan{fileno:04}.pq'</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="s">'2.0'</span><span class="p">)</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s">'ip'</span><span class="p">,</span> <span class="s">'port'</span><span class="p">,</span> <span class="s">'ttl'</span><span class="p">,</span> <span class="s">'reason'</span><span class="p">]]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s">'ip'</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">({</span>
        <span class="s">'port'</span><span class="p">:</span> <span class="s">'count'</span><span class="p">,</span>
        <span class="s">'ttl'</span><span class="p">:</span> <span class="p">[</span><span class="s">'min'</span><span class="p">,</span> <span class="s">'max'</span><span class="p">],</span>
        <span class="s">'reason'</span><span class="p">:</span> <span class="s">'nunique'</span><span class="p">,</span>
    <span class="p">})</span>
    <span class="o">...</span>
    <span class="n">df</span><span class="o">.</span><span class="n">to_parquet</span><span class="p">(</span><span class="n">f</span><span class="s">'agg/agg{fileno:04}.pq'</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="s">'2.0'</span><span class="p">)</span>
</code></pre></div></div>

<h2 id="final-bits">Final bits</h2>

<p>Putting all this together in <a href="/assets/internet_scan/repack.py">repack.py</a>
and presto!</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>unzip <span class="nt">-p</span> archive.zip | python repack.py
</code></pre></div></div>



    </article>
    <span class="print-footer">IPv4 Scan 2021 - Dataset Preprocessing - September 10, 2021 - Gehn</span>
    <footer>
    <hr class="slender">
    <div class="credits">
        <span>&copy; 2021
            
            Gehn
        </span></br>
            <a style="text-decoration: none;" href="/feed.xml"><img height="16px" width="16px" src="/assets/blog-assets/rss-32px.png" /></a>
        <br>
        

    
    </div>
</footer>

  </body>
</html>
