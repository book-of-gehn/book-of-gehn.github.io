<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>IPv4 Scan 2021 - Multiprobes Analysis</title>
  <meta name="description" content="IPv4 Scan 2021 - Multiprobes Analysis">

  <link href='/css/load-lato-fonts.min.css' rel='stylesheet' type='text/css'>

  <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      //root: "/js/MathJax-2.7.7",
      extensions: ["tex2jax.js"],
      jax: ["input/TeX","output/HTML-CSS"],
      tex2jax: {inlineMath: [["\\(","\\)"]]},
      TeX: {
        Macros: {
          
        }
      }
    });
  </script>
  <!-- <script src='/js/MathJax-2.7.7/MathJax.js' async></script> -->
  <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js' async></script>

  <script src="/js/jquery-3.6.0.min.js"></script>

  <script src='/js/underscore-1.9.1.min.js' ></script>

  <script src='/js/d3-7.4.2.min.js'></script>

  <script src='/js/venn/venn-0.2.14.min.js'></script>
  <script src='/js/venn/helper.min.js'></script>

  <script src='/js/fix_syntax_highlight.min.js'></script>
  <link rel="stylesheet" type="text/css" href="/css/tufte.min.css">
  <link rel="stylesheet" type="text/css" href="/css/latex.min.css">

  <link rel="canonical" href="https://book-of-gehn.github.io/articles/2021/09/19/IPv4-Scan-Part-II-Multiprobes-Analysis.html">

  <link rel="stylesheet" type="text/css" href="/css/font-awesome-5.min.css">

  <script src='/js/lunr-2.3.9.min.js'></script>
  <script src='/js/search_index.js'></script>
  <script src='/js/search.min.js'></script>
</head>
<body>
<header>
                <hgroup class="header-group">
        <h1 class="header-title"><a href="/">The Book of Gehn</a></h1>
                </hgroup>
                <ul class="header-list">
                    <li><a href="https://byexamples.github.io">byexample</a></li>
                    <li><a href="https://bisturi.github.io">bisturi</a></li>
                    <li>
                        <a class="raw_link" href="/feed.xml"><img height="16px" width="16px" src="/img/rss-32px.png" /></a>
                        <a class="raw_link" href="https://github.com/eldipa"><img height="16px" width="16px" src="/img/github.png" /></a>
                    </li>
                </ul>
        
        

    

    <nav class="group">
            <form id="blog-search-form">
                <input type="search" placeholder="+must -not *fuzzy*"></input>
                <span class="query-error"></span>
                <span class="controls">
                    <button type="submit">Filter</button>
                    <button style="display: none;" id="reset_search" type="reset">Clear</button>
                </span>
            </form>
    </nav>

    <div style="display: none;" id="search_error"></div>
    <article style="display: none;" class="group" id="search_results">
    </article>
</header>
<article class="group">
<h1>
IPv4 Scan 2021 - Multiprobes Analysis
</h1>
<p class="subtitle">
September 19, 2021
</p>
<p>To my surprise the <a href="https://www.kaggle.com/signalspikes/internet-port-scan-1">dataset</a> preprocessed in my <a href="/articles/2021/09/10/IPv4-Scan-Dataset-Preprocessing.html">previous post</a> <strong>has</strong> duplicated entries. These are scans to the same host and port but with a different timestamp.</p>
<p>Questions like “which open port is more likely” will biased because the same host-port may be counted more than once.</p>
<p>On the other hand, this opens <em>new questions</em>:</p>
<ul>
<li>which is the reason to scan the same port more than once? If it is <em>fixed</em> by the scanner we can deduce that ports scanned once <em>were scanned more times</em> but the other probes failed and get an estimation of such.</li>
<li>is the same port opened due different reasons?</li>
<li>could we characterize the scanner based on the timestamps like scanning patterns?</li>
</ul>
<p>The second surprise was that even working with small samples (around 100MB), <a href="https://pandas.pydata.org/">Pandas</a>/<a href="https://dask.org/">Dask</a> has <strong>serious performance problems</strong>:</p>
<ul>
<li>consumes much more memory (gigas)</li>
<li>CPU at 100% all the time</li>
<li>simple operations like <code><span class="highlight-candombe-inline"><span class="n">groupby</span></span></code> take forever.</li>
</ul>
<p>Goodbye Pandas, hello <a href="https://julialang.org/">Julia</a>?<!--more--></p>
<h2 id="julias-dataframes">Julia’s DataFrames</h2>
<p>First we need to install a few packages:</p>
<div class="highlight-candombe"><pre><span></span><code><span class="n">julia</span><span class="o">&gt;</span> <span class="k">import</span> <span class="n">Pkg</span>

<span class="n">julia</span><span class="o">&gt;</span> <span class="n">Pkg</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&quot;DataFrames&quot;</span><span class="p">)</span>
<span class="n">julia</span><span class="o">&gt;</span> <span class="n">Pkg</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&quot;Parquet&quot;</span><span class="p">)</span>
<span class="n">julia</span><span class="o">&gt;</span> <span class="n">Pkg</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&quot;CategoricalArrays&quot;</span><span class="p">)</span>
<span class="n">julia</span><span class="o">&gt;</span> <span class="n">Pkg</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&quot;StatsBase&quot;</span><span class="p">)</span>
<span class="n">julia</span><span class="o">&gt;</span> <span class="n">Pkg</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&quot;Statistics&quot;</span><span class="p">)</span>
<span class="n">julia</span><span class="o">&gt;</span> <span class="n">Pkg</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&quot;StatsPlots&quot;</span><span class="p">)</span>
</code></pre></div>

<p>Then we load the dataframe:</p>
<div class="highlight-candombe"><pre><span></span><code><span class="n">julia</span><span class="o">&gt;</span> <span class="k">using</span> <span class="n">Parquet</span><span class="p">,</span> <span class="n">DataFrames</span><span class="p">,</span> <span class="n">CategoricalArrays</span><span class="p">,</span> <span class="n">StatsBase</span><span class="p">,</span> <span class="n">Statistics</span><span class="p">,</span> <span class="n">StatsPlots</span>
<span class="n">julia</span><span class="o">&gt;</span> <span class="n">df</span> <span class="o">=</span> <span class="n">DataFrame</span><span class="p">(</span><span class="n">read_parquet</span><span class="p">(</span><span class="s">&quot;scans&quot;</span><span class="p">))</span>
</code></pre></div>

<h3 id="categorical-data">Categorical data</h3>
<p><label for='ClRoZSBgY29tcHJlc3M9dHJ1ZWAgaXMgbmVlZGVkIHNvIHRoZSBjb2x1bW4gd2lsbCBiZSBvZiB0aGUgc21hbGxlc3QgdHlwZQp0aGF0IGNhbiByZXByZXNlbnQgdGhlIGNhdGVnb3JpZXMsIGluIG91ciBjYXNlLCBgVUludDhgOyBvdGhlcndpc2UKYENhdGVnb3JpY2FsQXJyYXlzLmpsYCB1c2VzIGBVSW50MzJgIGJ5IGRlZmF1bHQuCiBtYXJnaW5ub3Rlcw==' class='margin-toggle'> &#8853;</label>
<input type='checkbox' id='ClRoZSBgY29tcHJlc3M9dHJ1ZWAgaXMgbmVlZGVkIHNvIHRoZSBjb2x1bW4gd2lsbCBiZSBvZiB0aGUgc21hbGxlc3QgdHlwZQp0aGF0IGNhbiByZXByZXNlbnQgdGhlIGNhdGVnb3JpZXMsIGluIG91ciBjYXNlLCBgVUludDhgOyBvdGhlcndpc2UKYENhdGVnb3JpY2FsQXJyYXlzLmpsYCB1c2VzIGBVSW50MzJgIGJ5IGRlZmF1bHQuCiBtYXJnaW5ub3Rlcw==' class='margin-toggle'/>
<span class='marginnote'>
The <code><span class="highlight-candombe-inline"><span class="n">compress</span><span class="o">=</span><span class="nb">true</span></span></code> is needed so the column will be of the smallest type that can represent the categories, in our case, <code><span class="highlight-candombe-inline"><span class="kt">UInt8</span></span></code>; otherwise <code><span class="highlight-candombe-inline"><span class="n">CategoricalArrays</span><span class="o">.</span><span class="n">jl</span></span></code> uses <code><span class="highlight-candombe-inline"><span class="kt">UInt32</span></span></code> by default.
</span></p>
<p><code><span class="highlight-candombe-inline"><span class="n">Parquet</span><span class="o">.</span><span class="n">jl</span></span></code> does not load the categories (or Pandas’s <code><span class="highlight-candombe-inline"><span class="n">to_parquet</span></span></code> is not writing them). This consumes more RAM because the <code><span class="highlight-candombe-inline"><span class="n">reason</span></span></code> and <code><span class="highlight-candombe-inline"><span class="n">port</span></span></code> columns are strings.</p>
<p>We can make them <em>categorical</em> back again with:</p>
<div class="highlight-candombe"><pre><span></span><code><span class="n">julia</span><span class="o">&gt;</span> <span class="n">df</span><span class="p">[</span><span class="o">!</span><span class="p">,</span> <span class="ss">:reason</span><span class="p">]</span> <span class="o">=</span> <span class="n">categorical</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="o">:</span><span class="p">,</span> <span class="ss">:reason</span><span class="p">],</span> <span class="n">compress</span><span class="o">=</span><span class="nb">true</span><span class="p">)</span>
</code></pre></div>

<h3 id="ordinal-data">Ordinal data</h3>
<p>We do the same for <code><span class="highlight-candombe-inline"><span class="n">port</span></span></code> column but we additionally mark the categorical as <em>ordered</em>.</p>
<div class="highlight-candombe"><pre><span></span><code><span class="n">julia</span><span class="o">&gt;</span> <span class="n">df</span><span class="p">[</span><span class="o">!</span><span class="p">,</span> <span class="ss">:port</span><span class="p">]</span> <span class="o">=</span> <span class="n">categorical</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="o">:</span><span class="p">,</span> <span class="ss">:port</span><span class="p">],</span> <span class="n">compress</span><span class="o">=</span><span class="nb">true</span><span class="p">,</span> <span class="n">ordered</span><span class="o">=</span><span class="nb">true</span><span class="p">)</span>
</code></pre></div>

<p>As <a href="/articles/2021/09/10/IPv4-Scan-Dataset-Preprocessing.html">explained earlier</a>, the ports <strong>don’t</strong> have a natural order however I this as an opportunity to explore and document <em>how to work with ordinals</em>.</p>
<p><code><span class="highlight-candombe-inline"><span class="n">CategoricalArrays</span><span class="o">.</span><span class="n">jl</span></span></code> orders lexicographically by default. To change the order we need to do it later with <code><span class="highlight-candombe-inline"><span class="n">levels!</span></span></code>.</p>
<p>First we get ports labels (strings):</p>
<div class="highlight-candombe"><pre><span></span><code><span class="n">julia</span><span class="o">&gt;</span> <span class="n">s</span> <span class="o">=</span> <span class="n">levels</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">port</span><span class="p">)</span>
</code></pre></div>

<p>Then we parse them as integers and sort them numerically:</p>
<div class="highlight-candombe"><pre><span></span><code><span class="n">julia</span><span class="o">&gt;</span> <span class="n">s</span> <span class="o">=</span> <span class="n">sort</span><span class="p">(</span><span class="n">parse</span><span class="o">.</span><span class="p">(</span><span class="kt">UInt16</span><span class="p">,</span> <span class="n">s</span><span class="p">))</span>
</code></pre></div>

<p>We get back the ports labels as strings:</p>
<div class="highlight-candombe"><pre><span></span><code><span class="n">julia</span><span class="o">&gt;</span> <span class="n">s</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</code></pre></div>

<p>Finally we rewrite the levels of the ordinal column:</p>
<div class="highlight-candombe"><pre><span></span><code><span class="n">julia</span><span class="o">&gt;</span> <span class="n">levels!</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">port</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
</code></pre></div>

<p>Now the <code><span class="highlight-candombe-inline"><span class="n">port</span></span></code> column is an ordinal column and the order is implied by the numerical interpretation of its labels.</p>
<!--
using Parquet, DataFrames, CategoricalArrays, StatsBase, Statistics, StatsPlots
df = DataFrame(read_parquet("indexed"))
df[!, :reason] = categorical(df[:, :reason], compress=true)
df[!, :port] = categorical(df[:, :port], compress=true, ordered=true)
s = levels(df.port)
s = sort(parse.(UInt16, s))
s = string.(s)
levels!(df.port, s)


sudo apt-get install libreadline-gplv2-dev libncursesw5-dev libgdbm-compat-dev
sudo apt-get install libsqlite3-dev tk-dev libgdbm-dev libc6-dev libbz2-dev
sudo apt-get install libssl-dev liblzma-dev zlib1g-dev lzma lzma-dev libgdbm-dev

make clean
./configure --enable-shared --enable-optimizations
make
make test

ENV["PYTHON"] = "/home/user/env/bin/python"
ENV["PYTHONHOME"] = ""
Pkg.add("PyCall")
Pkg.build("PyCall")
<..restart..>

import Pkg; Pkg.add("PyPlot")

-->
<h2 id="is-the-same-port-opened-due-different-reasons">Is the same port opened due different reasons?</h2>
<p><label for='ClRoZSBgOmZvb2AgYXJlIHN5bWJvbHMgd2hpY2ggaW4gb3VyIGNhc2UgYXJlIHRoZSBuYW1lcyBvZiB0aGUgY29sdW1ucy4gVGhlCmDiiJhgIChgXGNpcmNgIGluIExhdGV4KSBpcyB0aGUgKmNvbXBvc2l0ZSBvcGVyYXRvcio6IGBsZW5ndGgg4oiYIHVuaXF1ZWAgaXMKZXF1aXZhbGVudCB0byBgbGVuZ3RoKHVuaXF1ZSh4KSlgLgpUaGUgd2hvbGUgYDpyZWFzb24gPT4gbGVuZ3RoIOKImCB1bmlxdWUgPT4gOm51bmlxdWVgIHJlYWRzIGFzOiB0YWtlIHRoZQpgcmVhc29uYCBjb2x1bW4sIGNvdW50IGhvdyBtYW55IHVuaXF1ZSB2YWx1ZXMgYXJlIGluIGVhY2ggZ3JvdXAgYW5kCnN0b3JlIHRoZSByZXN1bHQgKG9uZSBwZXIgZ3JvdXApIGluIHRoZSBjb2x1bW4gYG51bmlxdWVgLgogbWFyZ2lubm90ZXM=' class='margin-toggle'> &#8853;</label>
<input type='checkbox' id='ClRoZSBgOmZvb2AgYXJlIHN5bWJvbHMgd2hpY2ggaW4gb3VyIGNhc2UgYXJlIHRoZSBuYW1lcyBvZiB0aGUgY29sdW1ucy4gVGhlCmDiiJhgIChgXGNpcmNgIGluIExhdGV4KSBpcyB0aGUgKmNvbXBvc2l0ZSBvcGVyYXRvcio6IGBsZW5ndGgg4oiYIHVuaXF1ZWAgaXMKZXF1aXZhbGVudCB0byBgbGVuZ3RoKHVuaXF1ZSh4KSlgLgpUaGUgd2hvbGUgYDpyZWFzb24gPT4gbGVuZ3RoIOKImCB1bmlxdWUgPT4gOm51bmlxdWVgIHJlYWRzIGFzOiB0YWtlIHRoZQpgcmVhc29uYCBjb2x1bW4sIGNvdW50IGhvdyBtYW55IHVuaXF1ZSB2YWx1ZXMgYXJlIGluIGVhY2ggZ3JvdXAgYW5kCnN0b3JlIHRoZSByZXN1bHQgKG9uZSBwZXIgZ3JvdXApIGluIHRoZSBjb2x1bW4gYG51bmlxdWVgLgogbWFyZ2lubm90ZXM=' class='margin-toggle'/>
<span class='marginnote'>
The <code><span class="highlight-candombe-inline"><span class="ss">:foo</span></span></code> are symbols which in our case are the names of the columns. The <code><span class="highlight-candombe-inline"><span class="o">∘</span></span></code> (<code><span class="highlight-candombe-inline"><span class="o">\</span><span class="n">circ</span></span></code> in Latex) is the <em>composite operator</em>: <code><span class="highlight-candombe-inline"><span class="n">length</span> <span class="o">∘</span> <span class="n">unique</span></span></code> is equivalent to <code><span class="highlight-candombe-inline"><span class="n">length</span><span class="p">(</span><span class="n">unique</span><span class="p">(</span><span class="n">x</span><span class="p">))</span></span></code>. The whole <code><span class="highlight-candombe-inline"><span class="ss">:reason</span> <span class="o">=&gt;</span> <span class="n">length</span> <span class="o">∘</span> <span class="n">unique</span> <span class="o">=&gt;</span> <span class="ss">:nunique</span></span></code> reads as: take the <code><span class="highlight-candombe-inline"><span class="n">reason</span></span></code> column, count how many unique values are in each group and store the result (one per group) in the column <code><span class="highlight-candombe-inline"><span class="n">nunique</span></span></code>.
</span></p>
<div class="highlight-candombe"><pre><span></span><code><span class="n">julia</span><span class="o">&gt;</span> <span class="n">g</span> <span class="o">=</span> <span class="n">groupby</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="p">[</span><span class="ss">:ip</span><span class="p">,</span> <span class="ss">:port</span><span class="p">])</span>
<span class="n">julia</span><span class="o">&gt;</span> <span class="n">df2</span> <span class="o">=</span> <span class="n">combine</span><span class="p">(</span><span class="n">g</span><span class="p">,</span>
                <span class="ss">:reason</span> <span class="o">=&gt;</span> <span class="n">length</span> <span class="o">∘</span> <span class="n">unique</span> <span class="o">=&gt;</span> <span class="ss">:nunique</span><span class="p">)</span>

<span class="n">julia</span><span class="o">&gt;</span> <span class="n">countmap</span><span class="p">(</span><span class="n">df2</span><span class="o">.</span><span class="n">nunique</span><span class="p">)</span>
<span class="kt">Dict</span><span class="p">{</span><span class="kt">Int64</span><span class="p">,</span> <span class="kt">Int64</span><span class="p">}</span> <span class="n">with</span> <span class="mi">1</span> <span class="n">entry</span><span class="o">:</span>
  <span class="mi">1</span> <span class="o">=&gt;</span> <span class="mi">64787998</span>
</code></pre></div>

<p>Nope, for each open port there is only one reason why it is open.</p>
<h2 id="which-is-the-reason-to-scan-the-same-port-more-than-once">Which is the reason to scan the same port more than once?</h2>
<p><code><span class="highlight-candombe-inline"><span class="n">masscan</span></span></code> supports a <code><span class="highlight-candombe-inline"><span class="o">--</span><span class="n">retries</span></span></code> flag. From the <a href="https://github.com/robertdavidgraham/masscan/blob/952755771ab8065c052cdf4b6d18041435b2d661/doc/masscan.8.markdown">documentation</a>:</p>
<blockquote>
<p><em><code><span class="highlight-candombe-inline"><span class="o">--</span><span class="n">retries</span></span></code>: the number of retries to send, at 1 second intervals. Note that since this scanner is stateless, retries are sent regardless if replies have already been received.</em></p>
</blockquote>
<p>This means that <code><span class="highlight-candombe-inline"><span class="n">masscan</span></span></code> will send \(N\) probes to each port, always, within a second apart.</p>
<p>Let’s check that.</p>
<h2 id="what-is-the-distributions-of-probes-per-open-port">What is the distributions of probes per open port?</h2>
<p><label for='CmBucm93YCBpcyBhIHNwZWNpYWwgdmFsdWUgdGhhdCBgRGF0YUZyYW1lYCdzIGBjb21iaW5lYCB3aWxsCmludGVycHJldCBhcyAqY291bnQgdGhlIHJvd3Mgb2YgZWFjaCBncm91cCouIFRoZSByZXN0IGZvbGxvd3MgdGhlIHVzdWFsCm1lYW5pbmc6IGBucm93ID0+IDpjb3VudGAgbWVhbnMgc3RvcmUgdGhlIGNvdW50IGluIGEgY29sdW1uIG5hbWVkIGBjb3VudGAuCiBtYXJnaW5ub3Rlcw==' class='margin-toggle'> &#8853;</label>
<input type='checkbox' id='CmBucm93YCBpcyBhIHNwZWNpYWwgdmFsdWUgdGhhdCBgRGF0YUZyYW1lYCdzIGBjb21iaW5lYCB3aWxsCmludGVycHJldCBhcyAqY291bnQgdGhlIHJvd3Mgb2YgZWFjaCBncm91cCouIFRoZSByZXN0IGZvbGxvd3MgdGhlIHVzdWFsCm1lYW5pbmc6IGBucm93ID0+IDpjb3VudGAgbWVhbnMgc3RvcmUgdGhlIGNvdW50IGluIGEgY29sdW1uIG5hbWVkIGBjb3VudGAuCiBtYXJnaW5ub3Rlcw==' class='margin-toggle'/>
<span class='marginnote'>
<code><span class="highlight-candombe-inline"><span class="n">nrow</span></span></code> is a special value that <code><span class="highlight-candombe-inline"><span class="n">DataFrame</span></span></code>’s <code><span class="highlight-candombe-inline"><span class="n">combine</span></span></code> will interpret as <em>count the rows of each group</em>. The rest follows the usual meaning: <code><span class="highlight-candombe-inline"><span class="n">nrow</span> <span class="o">=&gt;</span> <span class="ss">:count</span></span></code> means store the count in a column named <code><span class="highlight-candombe-inline"><span class="n">count</span></span></code>.
</span></p>
<div class="highlight-candombe"><pre><span></span><code><span class="n">julia</span><span class="o">&gt;</span> <span class="n">g</span> <span class="o">=</span> <span class="n">groupby</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="p">[</span><span class="ss">:ip</span><span class="p">,</span> <span class="ss">:port</span><span class="p">])</span>
<span class="n">julia</span><span class="o">&gt;</span> <span class="n">df2</span> <span class="o">=</span> <span class="n">combine</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">nrow</span> <span class="o">=&gt;</span> <span class="ss">:count</span><span class="p">)</span>

<span class="n">julia</span><span class="o">&gt;</span> <span class="n">countmap</span><span class="p">(</span><span class="n">df2</span><span class="o">.</span><span class="n">count</span><span class="p">)</span>
<span class="kt">Dict</span><span class="p">{</span><span class="kt">Int64</span><span class="p">,</span> <span class="kt">Int64</span><span class="p">}</span> <span class="n">with</span> <span class="mi">5</span> <span class="n">entries</span><span class="o">:</span>
  <span class="mi">5</span> <span class="o">=&gt;</span> <span class="mi">1</span>
  <span class="mi">4</span> <span class="o">=&gt;</span> <span class="mi">27</span>
  <span class="mi">2</span> <span class="o">=&gt;</span> <span class="mi">13038</span>
  <span class="mi">3</span> <span class="o">=&gt;</span> <span class="mi">750</span>
  <span class="mi">1</span> <span class="o">=&gt;</span> <span class="mi">64774182</span>
</code></pre></div>

<p>Notice how most of ip-port tuples were scanned once.</p>
<p>So <code><span class="highlight-candombe-inline"><span class="n">masscan</span></span></code> didn’t send \(N\) probes to each port <strong>or</strong> it did it but the some probes never were answered <em>(why?, who knows)</em>.</p>
<p>This could explain why some ports were scanned twice while others only one.</p>
<h2 id="what-is-the-distribution-of-intervals-between-probes-for-each-port">What is the distribution of intervals between probes for each port?</h2>
<p><label for='ClNhbml0eSBjaGVjazogZnJvbSB0aGUgZGlzdHJpYnV0aW9uIG9mIHByb2JlcyBwZXIgcG9ydCB3ZSBrbm93IHRoYXQgd2UKaGF2ZSAxMzAzOCBwb3J0cyB3aXRoIDIgcHJvYmVzIHdoaWNoIHdpbGwgY29udHJpYnV0ZSB3aXRoIDEzMDM4IHJvd3MgdG8KdGhlIGRpZmZlcmVuY2UgZGF0YWZyYW1lOwoKNzUwIHBvcnRzIHdpdGggMyBwcm9iZXMgd2hpY2ggd2lsbCBjb250cmlidXRlCndpdGggNzUwICogMiByb3dzIHRvIHRoZSByZXN1bHQ7IDI3IHBvcnRzIHdpdGggNCBwcm9iZXMgY29udHJpYnV0aW5nCndpdGggMjcgKiAzIHJvd3MgYW5kIGZpbmFsbHkgMSBwb3J0IHdpdGggNSBwcm9iZXMgY29udHJpYnV0aW5nIHdpdGggNSAqCjQgcm93cy4KClRoZSBleHBlY3RlZCB0b3RhbCBpcyAxNDYyMyB3aGljaCBpdCBpcyBleGFjdGx5IHRoZSByb3cgY291bnQKb2YgYGRmMmAuCiBtYXJnaW5ub3Rlcw==' class='margin-toggle'> &#8853;</label>
<input type='checkbox' id='ClNhbml0eSBjaGVjazogZnJvbSB0aGUgZGlzdHJpYnV0aW9uIG9mIHByb2JlcyBwZXIgcG9ydCB3ZSBrbm93IHRoYXQgd2UKaGF2ZSAxMzAzOCBwb3J0cyB3aXRoIDIgcHJvYmVzIHdoaWNoIHdpbGwgY29udHJpYnV0ZSB3aXRoIDEzMDM4IHJvd3MgdG8KdGhlIGRpZmZlcmVuY2UgZGF0YWZyYW1lOwoKNzUwIHBvcnRzIHdpdGggMyBwcm9iZXMgd2hpY2ggd2lsbCBjb250cmlidXRlCndpdGggNzUwICogMiByb3dzIHRvIHRoZSByZXN1bHQ7IDI3IHBvcnRzIHdpdGggNCBwcm9iZXMgY29udHJpYnV0aW5nCndpdGggMjcgKiAzIHJvd3MgYW5kIGZpbmFsbHkgMSBwb3J0IHdpdGggNSBwcm9iZXMgY29udHJpYnV0aW5nIHdpdGggNSAqCjQgcm93cy4KClRoZSBleHBlY3RlZCB0b3RhbCBpcyAxNDYyMyB3aGljaCBpdCBpcyBleGFjdGx5IHRoZSByb3cgY291bnQKb2YgYGRmMmAuCiBtYXJnaW5ub3Rlcw==' class='margin-toggle'/>
<span class='marginnote'>
Sanity check: from the distribution of probes per port we know that we have 13038 ports with 2 probes which will contribute with 13038 rows to the difference dataframe;
<br /><br />
750 ports with 3 probes which will contribute with 750 * 2 rows to the result; 27 ports with 4 probes contributing with 27 * 3 rows and finally 1 port with 5 probes contributing with 5 * 4 rows.
<br /><br />
The expected total is 14623 which it is exactly the row count of <code><span class="highlight-candombe-inline"><span class="n">df2</span></span></code>.
</span></p>
<div class="highlight-candombe"><pre><span></span><code><span class="n">julia</span><span class="o">&gt;</span> <span class="n">g</span> <span class="o">=</span> <span class="n">groupby</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="p">[</span><span class="ss">:ip</span><span class="p">,</span> <span class="ss">:port</span><span class="p">])</span>
<span class="n">julia</span><span class="o">&gt;</span> <span class="n">df2</span> <span class="o">=</span> <span class="n">combine</span><span class="p">(</span><span class="n">g</span><span class="p">,</span>
                <span class="ss">:timestamp</span> <span class="o">=&gt;</span> <span class="n">diff</span> <span class="o">∘</span> <span class="n">sort</span> <span class="o">=&gt;</span> <span class="ss">:interval</span><span class="p">)</span>

<span class="n">julia</span><span class="o">&gt;</span> <span class="n">countmap</span><span class="p">(</span><span class="n">df2</span><span class="o">.</span><span class="n">interval</span><span class="p">)</span>
<span class="kt">Dict</span><span class="p">{</span><span class="kt">Union</span><span class="p">{</span><span class="kt">Missing</span><span class="p">,</span> <span class="kt">Int32</span><span class="p">},</span> <span class="kt">Int64</span><span class="p">}</span> <span class="n">with</span> <span class="mi">30</span> <span class="n">entries</span><span class="o">:</span>
  <span class="mi">0</span>  <span class="o">=&gt;</span> <span class="mi">320</span>
  <span class="mi">1</span>  <span class="o">=&gt;</span> <span class="mi">2793</span>
  <span class="mi">2</span>  <span class="o">=&gt;</span> <span class="mi">585</span>
  <span class="mi">3</span>  <span class="o">=&gt;</span> <span class="mi">2625</span>
  <span class="mi">4</span>  <span class="o">=&gt;</span> <span class="mi">843</span>
  <span class="mi">5</span>  <span class="o">=&gt;</span> <span class="mi">159</span>
  <span class="mi">6</span>  <span class="o">=&gt;</span> <span class="mi">316</span>
  <span class="mi">7</span>  <span class="o">=&gt;</span> <span class="mi">1364</span>
  <span class="mi">8</span>  <span class="o">=&gt;</span> <span class="mi">512</span>
  <span class="mi">9</span>  <span class="o">=&gt;</span> <span class="mi">1435</span>
  <span class="mi">10</span> <span class="o">=&gt;</span> <span class="mi">495</span>
  <span class="mi">11</span> <span class="o">=&gt;</span> <span class="mi">149</span>
  <span class="mi">12</span> <span class="o">=&gt;</span> <span class="mi">103</span>
  <span class="mi">13</span> <span class="o">=&gt;</span> <span class="mi">52</span>
  <span class="mi">14</span> <span class="o">=&gt;</span> <span class="mi">139</span>
  <span class="mi">15</span> <span class="o">=&gt;</span> <span class="mi">1715</span>
  <span class="mi">16</span> <span class="o">=&gt;</span> <span class="mi">828</span>
  <span class="mi">17</span> <span class="o">=&gt;</span> <span class="mi">15</span>
  <span class="mi">18</span> <span class="o">=&gt;</span> <span class="mi">6</span>
  <span class="mi">19</span> <span class="o">=&gt;</span> <span class="mi">1</span>
  <span class="mi">23</span> <span class="o">=&gt;</span> <span class="mi">2</span>
  <span class="mi">24</span> <span class="o">=&gt;</span> <span class="mi">5</span>
  <span class="mi">25</span> <span class="o">=&gt;</span> <span class="mi">3</span>
  <span class="mi">28</span> <span class="o">=&gt;</span> <span class="mi">2</span>
  <span class="mi">29</span> <span class="o">=&gt;</span> <span class="mi">1</span>
  <span class="mi">31</span> <span class="o">=&gt;</span> <span class="mi">55</span>
  <span class="mi">32</span> <span class="o">=&gt;</span> <span class="mi">92</span>
  <span class="mi">33</span> <span class="o">=&gt;</span> <span class="mi">4</span>
  <span class="mi">34</span> <span class="o">=&gt;</span> <span class="mi">3</span>
  <span class="mi">40</span> <span class="o">=&gt;</span> <span class="mi">1</span>
</code></pre></div>

<p>Certainly a histogram is better for this case:</p>
<p><figure><figcaption><span markdown='1'>
Histogram of intervals between probes to the same host-port in seconds.
<br /><br />
The median (5.0) and the mean (6.89) are labeled. The vertical axis is in logarithmic scale.
</span></figcaption>
<img  class='' alt='' src='/img/network/internet_scan/time_interval_hist.svg' /></figure></p>
<p>This was more spread than I expected. Most of the intervals are in the low range but there is non-negligible count for the 15 secs interval.</p>
<p>A quick statistics for the intervals:</p>
<div class="highlight-candombe"><pre><span></span><code><span class="n">julia</span><span class="o">&gt;</span> <span class="n">describe</span><span class="p">(</span><span class="n">df2</span><span class="p">,</span> <span class="ss">:mean</span><span class="p">,</span> <span class="ss">:std</span><span class="p">,</span> <span class="ss">:min</span><span class="p">,</span> <span class="ss">:q25</span><span class="p">,</span> <span class="ss">:median</span><span class="p">,</span> <span class="ss">:q75</span><span class="p">,</span> <span class="ss">:max</span><span class="p">,</span> <span class="n">cols</span><span class="o">=</span><span class="ss">:interval</span><span class="p">)</span>
<span class="mi">1</span><span class="o">×</span><span class="mi">8</span> <span class="n">DataFrame</span>
 <span class="n">Row</span> <span class="n">│</span> <span class="n">variable</span>  <span class="n">mean</span>     <span class="n">std</span>      <span class="n">min</span>    <span class="n">q25</span>      <span class="n">median</span>   <span class="n">q75</span>      <span class="n">max</span>
     <span class="n">│</span> <span class="kt">Symbol</span>    <span class="kt">Float64</span>  <span class="kt">Float64</span>  <span class="kt">Int32</span>  <span class="kt">Float64</span>  <span class="kt">Float64</span>  <span class="kt">Float64</span>  <span class="kt">Int32</span>
<span class="n">─────┼─────────────────────────────────────────────────────────────────────</span>
   <span class="mi">1</span> <span class="n">│</span> <span class="n">interval</span>   <span class="mf">6.8051</span>  <span class="mf">5.75237</span>      <span class="mi">0</span>      <span class="mf">2.0</span>      <span class="mf">5.0</span>     <span class="mf">10.0</span>  <span class="mi">40</span>
</code></pre></div>

<p>Or, statistic by statistic:</p>
<div class="highlight-candombe"><pre><span></span><code><span class="n">julia</span><span class="o">&gt;</span> <span class="n">mean</span><span class="p">(</span><span class="n">df2</span><span class="o">.</span><span class="n">interval</span><span class="p">)</span>
<span class="mf">6.805101552349039</span>

<span class="n">julia</span><span class="o">&gt;</span> <span class="n">median</span><span class="p">(</span><span class="n">df2</span><span class="o">.</span><span class="n">interval</span><span class="p">)</span>
<span class="mf">5.0</span>

<span class="n">julia</span><span class="o">&gt;</span> <span class="n">mode</span><span class="p">(</span><span class="n">df2</span><span class="o">.</span><span class="n">interval</span><span class="p">)</span>
<span class="mi">1</span>

<span class="n">julia</span><span class="o">&gt;</span> <span class="n">std</span><span class="p">(</span><span class="n">df2</span><span class="o">.</span><span class="n">interval</span><span class="p">)</span>
<span class="mf">5.752370354791699</span>

<span class="n">julia</span><span class="o">&gt;</span> <span class="n">quantile</span><span class="p">(</span><span class="n">df2</span><span class="o">.</span><span class="n">interval</span><span class="p">,</span> <span class="p">[</span><span class="mf">.25</span><span class="p">,</span> <span class="mf">.5</span><span class="p">,</span> <span class="mf">.75</span><span class="p">])</span>
<span class="mi">3</span><span class="o">-</span><span class="n">element</span> <span class="kt">Vector</span><span class="p">{</span><span class="kt">Float64</span><span class="p">}</span><span class="o">:</span>
  <span class="mf">2.0</span>
  <span class="mf">5.0</span>
 <span class="mf">10.0</span>

<span class="n">julia</span><span class="o">&gt;</span> <span class="n">iqr</span><span class="p">(</span><span class="n">df2</span><span class="o">.</span><span class="n">interval</span><span class="p">)</span>
<span class="mf">8.0</span>
</code></pre></div>

<p>The median confirms our first analysis: the distribution is right skewed <em>(the mean is on the right of the median)</em>.</p>
<h3 id="what-about-the-zero-interval">What about the zero interval?</h3>
<p>We can filter which rows has such in two ways being the second one the preferred and fastest:</p>
<div class="highlight-candombe"><pre><span></span><code><span class="n">julia</span><span class="o">&gt;</span> <span class="n">filter</span><span class="p">(</span><span class="n">dfrows</span> <span class="o">-&gt;</span> <span class="n">dfrows</span><span class="o">.</span><span class="n">interval</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">df2</span><span class="p">,</span> <span class="n">view</span><span class="o">=</span><span class="nb">true</span><span class="p">)</span>
<span class="n">julia</span><span class="o">&gt;</span> <span class="n">filter</span><span class="p">(</span><span class="ss">:interval</span> <span class="o">=&gt;</span> <span class="o">==</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">df2</span><span class="p">,</span> <span class="n">view</span><span class="o">=</span><span class="nb">true</span><span class="p">)</span>
</code></pre></div>

<p>Choosing one of the got IPs we can get the probes:</p>
<div class="highlight-candombe"><pre><span></span><code><span class="n">julia</span><span class="o">&gt;</span> <span class="n">filter</span><span class="p">(</span><span class="ss">:ip</span> <span class="o">=&gt;</span> <span class="o">==</span><span class="p">(</span><span class="mi">22207380</span><span class="p">),</span> <span class="n">df</span><span class="p">,</span> <span class="n">view</span><span class="o">=</span><span class="nb">true</span><span class="p">)</span>
<span class="mi">2</span><span class="o">×</span><span class="mi">5</span> <span class="n">SubDataFrame</span>
 <span class="n">Row</span> <span class="n">│</span> <span class="n">timestamp</span>   <span class="n">port</span>   <span class="n">ttl</span>     <span class="n">reason</span>   <span class="n">ip</span>
     <span class="n">│</span> <span class="kt">Int32</span><span class="o">?</span>      <span class="n">Cat…</span><span class="o">?</span>  <span class="kt">Int32</span><span class="o">?</span>  <span class="n">Cat…</span><span class="o">?</span>    <span class="kt">Int64</span><span class="o">?</span>
<span class="n">─────┼──────────────────────────────────────────────</span>
   <span class="mi">1</span> <span class="n">│</span> <span class="mi">1619740697</span>  <span class="mi">80</span>         <span class="mi">42</span>  <span class="n">syn</span><span class="o">-</span><span class="n">ack</span>  <span class="mi">22207380</span>
   <span class="mi">2</span> <span class="n">│</span> <span class="mi">1619740697</span>  <span class="mi">80</span>         <span class="mi">42</span>  <span class="n">syn</span><span class="o">-</span><span class="n">ack</span>  <span class="mi">22207380</span>
</code></pre></div>

<p><code><span class="highlight-candombe-inline"><span class="n">timestamp</span></span></code> as you see has 1-second resolution (<a href="https://github.com/robertdavidgraham/masscan/blob/2895fa0acfe45983a3e9b2bbfadf25934c8d2c65/src/out-binary.c#L131">4 bytes</a>).</p>
<p>We could assume then that these two probes were done with 1-second interval apart but due the low resolution of the clock we got the same timestamp.</p>
<h2 id="some-thoughts">Some thoughts</h2>
<p>My initial idea was to use this walk-through to learn and practice <a href="https://pandas.pydata.org/">Pandas</a>. Having a dataset of a non-trivial size, I knew that this was going to be a challenge.</p>
<p>But what a better opportunity to work with <a href="https://dask.org/">Dask</a> too!</p>
<p>I really tried to make it work but even processing a 10% of the dataset made no difference: Pandas and Dask consumed so much memory that I couldn’t finish a single group-by + aggregation.</p>
<p>It is obvious that there are too many copies.</p>
<p>Doing a home-made custom aggregation function to sort this, I successfully <em>bypassed</em> the memory problem but I ended up in another one: <em>CPU 100% never-finishing</em> execution problem.</p>
<p>The custom aggregation function was written in Python, of course, but calling Python code for each row is incredible slow.</p>
<p>And all of this for a reduced dataset!</p>
<p>I’m talking of processing a 10% dataset and it didn’t finish after running for a whole night.</p>
<p>After a week of trying and failing, it was clear that Pandas+Dask need more love.</p>
<p>That’s when I considered <a href="https://julialang.org/">Julia</a>.</p>
<p>Julia code is compiled into machine code and because it deduces the types (most of the times), it can pack the data in arrays with high-locality and generates fast code ala C.</p>
<p>It is not magic and the libraries are designed to work in this way and avoid any sort of temporal copies.</p>
<p>On the other hand Julia libraries are much more modest in capabilities compared with Python’s ones.</p>
<p>It is a non-trivial trade-of.</p>
</article>
<span class="print-footer">IPv4 Scan 2021 - Multiprobes Analysis - September 19, 2021 - Martin Di Paola</span>
<footer>
    <hr class="slender">
    <div class="credits">
        <span>&copy;
            Martin Di Paola
        </span></br>
            <a class="raw_link" href="/feed.xml"><img height="16px" width="16px" src="/img/rss-32px.png" /></a>
            <a class="raw_link" href="https://github.com/eldipa"><img height="16px" width="16px" src="/img/github.png" /></a>
        <br>
        
        <a href="mailto:martinp.dipaola@gmail.com">martinp.dipaola@gmail.com</a></span></br> <br>
        
    </div>
</footer>
</body>
</html>
