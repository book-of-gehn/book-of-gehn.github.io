<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <meta name="description" content="Diff Between Data Frames for Testing Let’s say that we want to compare two Pandas’ dataframes for unit testing. One is the expected dataframe, crafted by us and it will be the source of truth for the test. The other is the obtained dataframe which is the result of the experiment that we want to check. Doing a naive comparison will not work: first we may want to tolerate some minor differences due computation imprecision; and second, and most important, we don’t want to know just if the dataframes are different or not We want to know where are the differences. Knowing exactly what is different makes the debugging much easier – trying to figure out which column in which row there is a different by hand is not fun.">

  
  <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      
          "@type": "BlogPosting",
          "headline": "Diff Between Data Frames for Testing",
          
          
          "datePublished": "2022-10-01T00:00:00+00:00",
          "dateModified": "2022-10-01T00:00:00+00:00",
          

          "author": [{
              "@type": "Person",
              "name": "Martin Di Paola",
              "url": "https://book-of-gehn.github.io"
            }]
      
    }
  </script>


  

  <title>Diff Between Data Frames for Testing</title>

  <link rel="icon" type="image/x-icon" href="/img/favicon.ico">

  
  <link rel="alternate" type="application/rss+xml" href="https://book-of-gehn.github.io/rss.xml">

  <link rel="canonical" href="https://book-of-gehn.github.io/articles/2022/10/01/Diff-Between-Dataframes-for-Testing.html">

  <link href='/css/load-lato-fonts.min.css' rel='stylesheet' type='text/css'>

  <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      //root: "/js/MathJax-2.7.7",
      extensions: ["tex2jax.js"],
      jax: ["input/TeX","output/HTML-CSS"],
      tex2jax: {inlineMath: [["\\(","\\)"]]},
      TeX: {
        Macros: {
          
        }
      }
    });
  </script>
  <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js' async></script>

  <script src="/js/jquery-3.6.0.min.js"></script>

  <script src='/js/underscore-1.9.1.min.js' ></script>

  <script src='/js/d3-7.4.2.min.js'></script>

  <script src='/js/venn/venn-0.2.14.min.js'></script>
  <script src='/js/venn/helper.min.js'></script>

  <script src='/js/fix_syntax_highlight.min.js'></script>
  <link rel="stylesheet" type="text/css" href="/css/tufte.min.css">
  <link rel="stylesheet" type="text/css" href="/css/latex.min.css">

  <link rel="stylesheet" type="text/css" href="/css/font-awesome-5.min.css">

  <script src='/js/lunr-2.3.9.min.js'></script>
  <script src='/js/search_index.js'></script>
  <script src='/js/search.min.js'></script>
</head>
<body>
<header>
                <hgroup class="header-group">
        <h1 class="header-title"><a href="/">The Book of Gehn</a></h1>
                </hgroup>
                <ul class="header-list">
                    <li><a href="https://byexamples.github.io">byexample</a></li>
                    <li><a href="https://bisturi.github.io">bisturi</a></li>
                    <li>
                        <a class="raw_link" href="/atom.xml"><img height="16px" width="16px" src="/img/rss-32px.png" /></a>
                        <a class="raw_link" href="https://github.com/eldipa"><img height="16px" width="16px" src="/img/github.png" /></a>
                    </li>
                </ul>
        
        

    

</header>
<article class="group">
<h1>
Diff Between Data Frames for Testing
</h1>
<p class="subtitle">
October 1, 2022
</p>
<p>Let’s say that we want to compare two Pandas’ dataframes for unit testing.</p>
<p>One is the <em>expected</em> dataframe, crafted by us and it will be the <em>source of truth</em> for the test.</p>
<p>The other is the <em>obtained</em> dataframe which is the result of the experiment that we want to check.</p>
<p>Doing a naive comparison will not work: first we may want to <em>tolerate</em> some minor differences due computation imprecision; and second, and most important, we don’t want to know <em>just</em> if the dataframes are different or not</p>
<p>We want to know <strong>where are the differences</strong>.</p>
<p>Knowing exactly what is different makes the debugging much easier – trying to figure out which column in which row there is a different by hand is <strong>not fun</strong>.<!--more--></p>
<h2 id="comparison-row-by-row-the-naive-approach">Comparison row-by-row (the naive approach)</h2>
<p>Pandas has a beautiful <code><span class="highlight-candombe-inline"><span class="n">assert_frame_equal</span></span></code> <a href="https://pandas.pydata.org/docs/reference/api/pandas.testing.assert_frame_equal.html">function for unit testing</a>: it compares the dataframes row by row and shows which column has some differences and how many there are.</p>
<p>Considere the following dataframes:</p>
<div class="highlight-candombe"><pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">expected_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
<span class="o">...</span>     <span class="s1">&#39;name&#39;</span><span class="p">:</span>    <span class="p">[</span><span class="s1">&#39;alice&#39;</span><span class="p">,</span>  <span class="s1">&#39;bob&#39;</span><span class="p">,</span>   <span class="s1">&#39;alice&#39;</span><span class="p">,</span> <span class="s1">&#39;charlie&#39;</span><span class="p">],</span>
<span class="o">...</span>     <span class="s1">&#39;subject&#39;</span><span class="p">:</span> <span class="p">[</span> <span class="s1">&#39;math&#39;</span><span class="p">,</span> <span class="s1">&#39;math&#39;</span><span class="p">,</span> <span class="s1">&#39;physics&#39;</span><span class="p">,</span>    <span class="s1">&#39;math&#39;</span><span class="p">],</span>
<span class="o">...</span>     <span class="s1">&#39;grade&#39;</span><span class="p">:</span>   <span class="p">[</span>      <span class="mi">5</span><span class="p">,</span>      <span class="mi">4</span><span class="p">,</span>         <span class="mi">4</span><span class="p">,</span>         <span class="mi">5</span><span class="p">],</span>
<span class="o">...</span> <span class="p">})</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">obtained_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
<span class="o">...</span>     <span class="s1">&#39;name&#39;</span><span class="p">:</span>    <span class="p">[</span>  <span class="s1">&#39;alice&#39;</span><span class="p">,</span>   <span class="s1">&#39;bob&#39;</span><span class="p">,</span>  <span class="s1">&#39;alice&#39;</span><span class="p">,</span> <span class="s1">&#39;charlie&#39;</span><span class="p">],</span>
<span class="o">...</span>     <span class="s1">&#39;subject&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;physics&#39;</span><span class="p">,</span>  <span class="s1">&#39;math&#39;</span><span class="p">,</span>   <span class="s1">&#39;math&#39;</span><span class="p">,</span>    <span class="s1">&#39;math&#39;</span><span class="p">],</span>
<span class="o">...</span>     <span class="s1">&#39;grade&#39;</span><span class="p">:</span>   <span class="p">[</span>        <span class="mi">4</span><span class="p">,</span>       <span class="mi">4</span><span class="p">,</span>        <span class="mi">3</span><span class="p">,</span>         <span class="mi">2</span><span class="p">],</span>
<span class="o">...</span> <span class="p">})</span>
</code></pre></div>

<p>Now let’s use <code><span class="highlight-candombe-inline"><span class="n">assert_frame_equal</span></span></code>:</p>
<div class="highlight-candombe"><pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">pandas.testing</span> <span class="kn">import</span> <span class="n">assert_frame_equal</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">assert_frame_equal</span><span class="p">(</span>
<span class="o">...</span>     <span class="n">obtained_df</span><span class="p">,</span>
<span class="o">...</span>     <span class="n">expected_df</span><span class="p">,</span>
<span class="o">...</span>     <span class="n">check_exact</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="o">...</span>     <span class="n">check_like</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="o">...</span>     <span class="n">check_dtype</span><span class="o">=</span><span class="kc">False</span>
<span class="o">...</span> <span class="p">)</span>
<span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>
<span class="o">&lt;...&gt;</span>
<span class="ne">AssertionError</span><span class="p">:</span> <span class="n">DataFrame</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="p">(</span><span class="n">column</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;subject&quot;</span><span class="p">)</span> <span class="n">are</span> <span class="n">different</span>
<span class="o">&lt;...&gt;</span>
<span class="n">DataFrame</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="p">(</span><span class="n">column</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;subject&quot;</span><span class="p">)</span> <span class="n">values</span> <span class="n">are</span> <span class="n">different</span> <span class="p">(</span><span class="mf">50.0</span> <span class="o">%</span><span class="p">)</span>
<span class="p">[</span><span class="n">index</span><span class="p">]:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
<span class="p">[</span><span class="n">left</span><span class="p">]:</span>  <span class="p">[</span><span class="n">physics</span><span class="p">,</span> <span class="n">math</span><span class="p">,</span> <span class="n">math</span><span class="p">,</span> <span class="n">math</span><span class="p">]</span>
<span class="p">[</span><span class="n">right</span><span class="p">]:</span> <span class="p">[</span><span class="n">math</span><span class="p">,</span> <span class="n">math</span><span class="p">,</span> <span class="n">physics</span><span class="p">,</span> <span class="n">math</span><span class="p">]</span>
</code></pre></div>

<p>So <code><span class="highlight-candombe-inline"><span class="n">assert_frame_equal</span></span></code> detected that half of the rows are different on the <code><span class="highlight-candombe-inline"><span class="s2">&quot;subject&quot;</span></span></code> column.</p>
<p>With a closer inspection on the <code><span class="highlight-candombe-inline"><span class="n">left</span></span></code> and <code><span class="highlight-candombe-inline"><span class="n">right</span></span></code> series we see that the first and third values are different (<code><span class="highlight-candombe-inline"><span class="n">physics</span><span class="o">/</span><span class="n">math</span></span></code> and <code><span class="highlight-candombe-inline"><span class="n">math</span><span class="o">/</span><span class="n">physics</span></span></code>).</p>
<p>Now if you see dataframes <code><span class="highlight-candombe-inline"><span class="n">obtained_df</span></span></code> and <code><span class="highlight-candombe-inline"><span class="n">expected_df</span></span></code> you will see that it is more likely to interpret this <strong>difference as an reorder of the rows</strong> and not as a real discrepancy (unless you are really wanting to have a specific order).</p>
<h2 id="make-the-comparison-order-insensitive">Make the comparison order-insensitive</h2>
<p><code><span class="highlight-candombe-inline"><span class="n">assert_frame_equal</span></span></code> alone is not enough as it is sensible to reorders.</p>
<p><label for='ClRoZSBgcmVzZXRfaW5kZXhgIGlzIHJlcXVpcmVkIGJlY2F1c2UgYHNvcnRfdmFsdWVzYCBwcmVzZXJ2ZXMgdGhlCmluZGV4OiBlYWNoIHJvdyByZW1lbWJlciBpdHMgb3JpZ2luYWwgcG9zaXRpb24uIGBhc3NlcnRfZnJhbWVfZXF1YWxgCmNoZWNrcyBieSBpbmRleCBzbyBpdCB3aWxsIHJldmVydCB0aGUgc29ydC4KbWFyZ2lubm90ZXM=' class='margin-toggle'> &#8853;</label>
<input type='checkbox' id='ClRoZSBgcmVzZXRfaW5kZXhgIGlzIHJlcXVpcmVkIGJlY2F1c2UgYHNvcnRfdmFsdWVzYCBwcmVzZXJ2ZXMgdGhlCmluZGV4OiBlYWNoIHJvdyByZW1lbWJlciBpdHMgb3JpZ2luYWwgcG9zaXRpb24uIGBhc3NlcnRfZnJhbWVfZXF1YWxgCmNoZWNrcyBieSBpbmRleCBzbyBpdCB3aWxsIHJldmVydCB0aGUgc29ydC4KbWFyZ2lubm90ZXM=' class='margin-toggle'/>
<span class='marginnote'>
The <code><span class="highlight-candombe-inline"><span class="n">reset_index</span></span></code> is required because <code><span class="highlight-candombe-inline"><span class="n">sort_values</span></span></code> preserves the index: each row remember its original position. <code><span class="highlight-candombe-inline"><span class="n">assert_frame_equal</span></span></code> checks by index so it will revert the sort.
</span></p>
<p>Let’s try to sort the rows before the check then:</p>
<div class="highlight-candombe"><pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="n">sort_by</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;subject&quot;</span><span class="p">]</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">ob</span> <span class="o">=</span> <span class="n">obtained_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">sort_by</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">ex</span> <span class="o">=</span> <span class="n">expected_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">sort_by</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">assert_frame_equal</span><span class="p">(</span>
<span class="o">...</span>     <span class="n">ob</span><span class="p">,</span>
<span class="o">...</span>     <span class="n">ex</span><span class="p">,</span>
<span class="o">...</span>     <span class="n">check_exact</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="o">...</span>     <span class="n">check_like</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="o">...</span>     <span class="n">check_dtype</span><span class="o">=</span><span class="kc">False</span>
<span class="o">...</span> <span class="p">)</span>
<span class="n">Traceback</span><span class="o">&lt;...&gt;</span>
<span class="ne">AssertionError</span><span class="p">:</span> <span class="n">DataFrame</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="p">(</span><span class="n">column</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;name&quot;</span><span class="p">)</span> <span class="n">are</span> <span class="n">different</span>
<span class="o">&lt;...&gt;</span>
<span class="n">DataFrame</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="p">(</span><span class="n">column</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;name&quot;</span><span class="p">)</span> <span class="n">values</span> <span class="n">are</span> <span class="n">different</span> <span class="p">(</span><span class="mf">50.0</span> <span class="o">%</span><span class="p">)</span>
<span class="p">[</span><span class="n">index</span><span class="p">]:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
<span class="p">[</span><span class="n">left</span><span class="p">]:</span>  <span class="p">[</span><span class="n">bob</span><span class="p">,</span> <span class="n">alice</span><span class="p">,</span> <span class="n">charlie</span><span class="p">,</span> <span class="n">alice</span><span class="p">]</span>
<span class="p">[</span><span class="n">right</span><span class="p">]:</span> <span class="p">[</span><span class="n">alice</span><span class="p">,</span> <span class="n">bob</span><span class="p">,</span> <span class="n">charlie</span><span class="p">,</span> <span class="n">alice</span><span class="p">]</span>
</code></pre></div>

<p>Mmm… more noise… perhaps sorting by <code><span class="highlight-candombe-inline"><span class="s2">&quot;name&quot;</span></span></code> <strong>and</strong> <code><span class="highlight-candombe-inline"><span class="s2">&quot;subject&quot;</span></span></code>?</p>
<div class="highlight-candombe"><pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="n">sort_by</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;subject&quot;</span><span class="p">]</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">ob</span> <span class="o">=</span> <span class="n">obtained_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">sort_by</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">ex</span> <span class="o">=</span> <span class="n">expected_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">sort_by</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">assert_frame_equal</span><span class="p">(</span>
<span class="o">...</span>     <span class="n">ob</span><span class="p">,</span>
<span class="o">...</span>     <span class="n">ex</span><span class="p">,</span>
<span class="o">...</span>     <span class="n">check_exact</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="o">...</span>     <span class="n">check_like</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="o">...</span>     <span class="n">check_dtype</span><span class="o">=</span><span class="kc">False</span>
<span class="o">...</span> <span class="p">)</span>
<span class="n">Traceback</span><span class="o">&lt;...&gt;</span>
<span class="ne">AssertionError</span><span class="p">:</span> <span class="n">DataFrame</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="p">(</span><span class="n">column</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;grade&quot;</span><span class="p">)</span> <span class="n">are</span> <span class="n">different</span>
<span class="o">&lt;...&gt;</span>
<span class="n">DataFrame</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="p">(</span><span class="n">column</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;grade&quot;</span><span class="p">)</span> <span class="n">values</span> <span class="n">are</span> <span class="n">different</span> <span class="p">(</span><span class="mf">50.0</span> <span class="o">%</span><span class="p">)</span>
<span class="p">[</span><span class="n">index</span><span class="p">]:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
<span class="p">[</span><span class="n">left</span><span class="p">]:</span>  <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
<span class="p">[</span><span class="n">right</span><span class="p">]:</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span>
</code></pre></div>

<p>Better, I guess.</p>
<p>Sorting solves the reorder problem but it is still <strong>hard to interpret</strong> the results.</p>
<p>Even with this example of just 4 rows, there are too many rows!</p>
<p>More over, <code><span class="highlight-candombe-inline"><span class="n">assert_frame_equal</span></span></code> is not helpful when the dataframes has a different size, it just says that and that it <code><span class="highlight-candombe-inline"><span class="p">:</span><span class="o">|</span></span></code></p>
<div class="highlight-candombe"><pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="n">ob</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">ob</span><span class="o">.</span><span class="n">index</span><span class="p">)]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;alice&quot;</span><span class="p">,</span> <span class="s2">&quot;algebra&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">assert_frame_equal</span><span class="p">(</span>
<span class="o">...</span>     <span class="n">ob</span><span class="p">,</span>
<span class="o">...</span>     <span class="n">ex</span><span class="p">,</span>
<span class="o">...</span>     <span class="n">check_exact</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="o">...</span>     <span class="n">check_like</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="o">...</span>     <span class="n">check_dtype</span><span class="o">=</span><span class="kc">False</span>
<span class="o">...</span> <span class="p">)</span>
<span class="o">&lt;...&gt;</span>
<span class="ne">AssertionError</span><span class="p">:</span> <span class="n">DataFrame</span> <span class="n">are</span> <span class="n">different</span>
<span class="o">&lt;...&gt;</span>
<span class="n">DataFrame</span> <span class="n">shape</span> <span class="n">mismatch</span>
<span class="p">[</span><span class="n">left</span><span class="p">]:</span>  <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="p">[</span><span class="n">right</span><span class="p">]:</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</code></pre></div>

<h2 id="comparing-group-by-group">Comparing group-by-group</h2>
<p>Instead of comparing row by row we could group the rows under some key and compare then each row <strong>within each group</strong>.</p>
<div class="highlight-candombe"><pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="n">group_by</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;subject&quot;</span><span class="p">]</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">obtained_g</span> <span class="o">=</span> <span class="n">obtained_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">group_by</span><span class="p">,</span> <span class="n">dropna</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">expected_g</span> <span class="o">=</span> <span class="n">expected_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">group_by</span><span class="p">,</span> <span class="n">dropna</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</code></pre></div>

<p>The intuition is that we will get fewer differences between groups and possibly more meaningful.</p>
<p>Here we get which groups do we have in common:</p>
<div class="highlight-candombe"><pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="n">obtained_group_names</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">obtained_g</span><span class="p">}</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">expected_group_names</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">expected_g</span><span class="p">}</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">common_group_names</span> <span class="o">=</span> <span class="n">obtained_group_names</span> <span class="o">&amp;</span> <span class="n">expected_group_names</span>
<span class="o">&gt;&gt;&gt;</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">common_group_names</span><span class="p">)</span>
<span class="p">[(</span><span class="s1">&#39;alice&#39;</span><span class="p">,</span> <span class="s1">&#39;math&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;alice&#39;</span><span class="p">,</span> <span class="s1">&#39;physics&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;bob&#39;</span><span class="p">,</span> <span class="s1">&#39;math&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;charlie&#39;</span><span class="p">,</span> <span class="s1">&#39;math&#39;</span><span class="p">)]</span>
</code></pre></div>

<p>Now for each group we compare them using <code><span class="highlight-candombe-inline"><span class="n">assert_frame_equal</span></span></code>:</p>
<div class="highlight-candombe"><pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="n">name</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;alice&#39;</span><span class="p">,</span> <span class="s1">&#39;math&#39;</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">ob</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">obtained_g</span><span class="o">.</span><span class="n">get_group</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">ex</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">expected_g</span><span class="o">.</span><span class="n">get_group</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">assert_frame_equal</span><span class="p">(</span>
<span class="o">...</span>     <span class="n">ob</span><span class="p">,</span>
<span class="o">...</span>     <span class="n">ex</span><span class="p">,</span>
<span class="o">...</span>     <span class="n">check_exact</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="o">...</span>     <span class="n">check_like</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="o">...</span>     <span class="n">check_dtype</span><span class="o">=</span><span class="kc">False</span>
<span class="o">...</span> <span class="p">)</span>
<span class="n">Traceback</span><span class="o">&lt;...&gt;</span>
<span class="ne">AssertionError</span><span class="p">:</span> <span class="n">DataFrame</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="p">(</span><span class="n">column</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;grade&quot;</span><span class="p">)</span> <span class="n">are</span> <span class="n">different</span>
<span class="o">&lt;...&gt;</span>
<span class="n">DataFrame</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="p">(</span><span class="n">column</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;grade&quot;</span><span class="p">)</span> <span class="n">values</span> <span class="n">are</span> <span class="n">different</span> <span class="p">(</span><span class="mf">100.0</span> <span class="o">%</span><span class="p">)</span>
<span class="p">[</span><span class="n">index</span><span class="p">]:</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="p">[</span><span class="n">left</span><span class="p">]:</span>  <span class="p">[</span><span class="mi">3</span><span class="p">]</span>
<span class="p">[</span><span class="n">right</span><span class="p">]:</span> <span class="p">[</span><span class="mi">5</span><span class="p">]</span>
</code></pre></div>

<p>Now it is clear that Alice got a grade of 3 in her Math class but it was expected to get a 5.</p>
<p><label for='CmBwZC5jb25jYXRgIHdpbGwgcHV0IHRoZSByb3dzIG9mIG9uZSBkYXRhZnJhbWUgYWZ0ZXIgdGhlIHJvd3Mgb2YgdGhlCm90aGVyICpwcmVzZXJ2aW5nKiB0aGVpciBvcmlnaW5hbCBpbmRleGVzLgoKU29ydGluZyBieSBpbmRleCB0aGVuIHdpbGwKbWFrZSB0aGUgZmlyc3Qgcm93IG9mIHRoZSBleHBlY3RlZCBhcHBlYXIgYWZ0ZXIgdGhlIGZpcnN0IHJvdyBvZiB0aGUKb2J0YWluZWQsIHRoZSBzZWNvbmQgcm93IG9mIHRoZSBleHBlY3RlZCBhcHBlYXIgYWZ0ZXIgdGhlIHNlY29uZCByb3cgb2YKdGhlIG9idGFpbmVkIGFuZCBzbyBvbi4KbWFyZ2lubm90ZXM=' class='margin-toggle'> &#8853;</label>
<input type='checkbox' id='CmBwZC5jb25jYXRgIHdpbGwgcHV0IHRoZSByb3dzIG9mIG9uZSBkYXRhZnJhbWUgYWZ0ZXIgdGhlIHJvd3Mgb2YgdGhlCm90aGVyICpwcmVzZXJ2aW5nKiB0aGVpciBvcmlnaW5hbCBpbmRleGVzLgoKU29ydGluZyBieSBpbmRleCB0aGVuIHdpbGwKbWFrZSB0aGUgZmlyc3Qgcm93IG9mIHRoZSBleHBlY3RlZCBhcHBlYXIgYWZ0ZXIgdGhlIGZpcnN0IHJvdyBvZiB0aGUKb2J0YWluZWQsIHRoZSBzZWNvbmQgcm93IG9mIHRoZSBleHBlY3RlZCBhcHBlYXIgYWZ0ZXIgdGhlIHNlY29uZCByb3cgb2YKdGhlIG9idGFpbmVkIGFuZCBzbyBvbi4KbWFyZ2lubm90ZXM=' class='margin-toggle'/>
<span class='marginnote'>
<code><span class="highlight-candombe-inline"><span class="n">pd</span><span class="o">.</span><span class="n">concat</span></span></code> will put the rows of one dataframe after the rows of the other <em>preserving</em> their original indexes.
<br /><br />
Sorting by index then will make the first row of the expected appear after the first row of the obtained, the second row of the expected appear after the second row of the obtained and so on.
</span></p>
<p>We could pretty print the group <em>interleaving the rows</em> of the obtained and expected dataframes so we can compare them line by line:</p>
<div class="highlight-candombe"><pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="n">ob</span><span class="p">[</span><span class="s2">&quot;DF&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;obtained&quot;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">ex</span><span class="p">[</span><span class="s2">&quot;DF&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;expected&quot;</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">merged</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">ob</span><span class="p">,</span> <span class="n">ex</span><span class="p">])</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">merged</span>
    <span class="n">name</span> <span class="n">subject</span>  <span class="n">grade</span>        <span class="n">DF</span>
<span class="mi">0</span>  <span class="n">alice</span>    <span class="n">math</span>      <span class="mi">3</span>  <span class="n">obtained</span>
<span class="mi">0</span>  <span class="n">alice</span>    <span class="n">math</span>      <span class="mi">5</span>  <span class="n">expected</span>
</code></pre></div>

<p>Much better!</p>
<h2 id="putting-all-this-together">Putting all this together</h2>
<p>The plan is:</p>
<ul>
<li>group by some columns to compare smaller groups</li>
<li>sort the rows of each group to make the comparison order-insensitive.</li>
<li>call <code><span class="highlight-candombe-inline"><span class="n">assert_frame_equal</span></span></code> on each <em>common</em> group and add the differences found to the list of differences.</li>
<li>add to the list any <em>unexpected</em> and <em>missing</em> group</li>
<li>if the list is not empty, raise <code><span class="highlight-candombe-inline"><span class="ne">AssertionError</span></span></code></li>
</ul>
<p><label for='ClVwZGF0ZWQgdmVyc2lvbjogPGEgaHJlZj0iL2Fzc2V0cy9weXRob24vZGF0YWZyYW1lcy90ZXN0aW5nL2Fzc2VydF9kZl9lcXVhbC5weSI+PHNwYW4gc3R5bGU9IndoaXRlLXNwYWNlOiBub3dyYXA7Ij48aSBjbGFzcz0iZmFiIGZhLWdpdGh1YiI+PC9pPiZuYnNwO2NvZGU8L3NwYW4+PC9hPgptYXJnaW5ub3Rlcw==' class='margin-toggle'> &#8853;</label>
<input type='checkbox' id='ClVwZGF0ZWQgdmVyc2lvbjogPGEgaHJlZj0iL2Fzc2V0cy9weXRob24vZGF0YWZyYW1lcy90ZXN0aW5nL2Fzc2VydF9kZl9lcXVhbC5weSI+PHNwYW4gc3R5bGU9IndoaXRlLXNwYWNlOiBub3dyYXA7Ij48aSBjbGFzcz0iZmFiIGZhLWdpdGh1YiI+PC9pPiZuYnNwO2NvZGU8L3NwYW4+PC9hPgptYXJnaW5ub3Rlcw==' class='margin-toggle'/>
<span class='marginnote'>
Updated version: <a href="/assets/python/dataframes/testing/assert_df_equal.py"><span style="white-space: nowrap;"><i class="fab fa-github"></i> code</span></a>
</span></p>
<p>This is the code:</p>
<div class="highlight-candombe"><pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="k">def</span> <span class="nf">assert_df_equal</span><span class="p">(</span><span class="n">obtained_df</span><span class="p">,</span> <span class="n">expected_df</span><span class="p">,</span> <span class="n">group_by</span><span class="o">=</span><span class="p">[],</span> <span class="n">sort_by</span><span class="o">=</span><span class="p">[],</span> <span class="n">check_exact</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">1e-5</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1e-8</span><span class="p">,</span> <span class="n">to_string_kwargs</span><span class="o">=</span><span class="p">{}):</span>
<span class="o">...</span>     <span class="n">diffs</span> <span class="o">=</span> <span class="p">[]</span>
<span class="o">...</span>
<span class="o">...</span>     <span class="c1"># See the whole dataframe as the single group in case of</span>
<span class="o">...</span>     <span class="c1"># the user don&#39;t wanting to group the rows</span>
<span class="o">...</span>     <span class="n">singleton_group</span> <span class="o">=</span> <span class="kc">False</span>
<span class="o">...</span>     <span class="k">if</span> <span class="ow">not</span> <span class="n">group_by</span><span class="p">:</span>
<span class="o">...</span>         <span class="n">group_by</span> <span class="o">=</span> <span class="k">lambda</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">singleton_group</span>
<span class="o">...</span>         <span class="n">singleton_group</span> <span class="o">=</span> <span class="kc">True</span>
<span class="o">...</span>
<span class="o">...</span>     <span class="n">obtained_g</span> <span class="o">=</span> <span class="n">obtained_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">group_by</span><span class="p">,</span> <span class="n">dropna</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="o">...</span>     <span class="n">expected_g</span> <span class="o">=</span> <span class="n">expected_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">group_by</span><span class="p">,</span> <span class="n">dropna</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="o">...</span>
<span class="o">...</span>     <span class="n">obtained_group_names</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">obtained_g</span><span class="p">}</span>
<span class="o">...</span>     <span class="n">expected_group_names</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">expected_g</span><span class="p">}</span>
<span class="o">...</span>
<span class="o">...</span>     <span class="n">common_group_names</span> <span class="o">=</span> <span class="n">obtained_group_names</span> <span class="o">&amp;</span> <span class="n">expected_group_names</span>
<span class="o">...</span>     <span class="n">unexpected_group_names</span> <span class="o">=</span> <span class="n">obtained_group_names</span> <span class="o">-</span> <span class="n">expected_group_names</span>
<span class="o">...</span>     <span class="n">missing_group_names</span> <span class="o">=</span> <span class="n">expected_group_names</span> <span class="o">-</span> <span class="n">obtained_group_names</span>
<span class="o">...</span>
<span class="o">...</span>     <span class="c1"># Check if we have unexpected groups or missing groups.</span>
<span class="o">...</span>     <span class="c1"># These are groups that cannot be compared with any other row</span>
<span class="o">...</span>     <span class="c1"># in the opposite dataframes and therefore they are straight</span>
<span class="o">...</span>     <span class="c1"># differences by definition</span>
<span class="o">...</span>     <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">unexpected_group_names</span><span class="p">):</span>
<span class="o">...</span>         <span class="n">ob</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">obtained_g</span><span class="o">.</span><span class="n">get_group</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
<span class="o">...</span>         <span class="k">if</span> <span class="n">sort_by</span><span class="p">:</span>
<span class="o">...</span>             <span class="n">ob</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">sort_by</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="o">...</span>
<span class="o">...</span>         <span class="n">ob</span><span class="p">[</span><span class="s2">&quot;DF&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;obtained&quot;</span>
<span class="o">...</span>
<span class="o">...</span>         <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Unexpected (not expected) group </span><span class="si">{</span><span class="n">name</span><span class="si">!r}</span><span class="se">\n\n</span><span class="si">{</span><span class="n">ob</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="o">**</span><span class="n">to_string_kwargs</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="o">...</span>         <span class="n">diffs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
<span class="o">...</span>
<span class="o">...</span>     <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">missing_group_names</span><span class="p">):</span>
<span class="o">...</span>         <span class="n">ex</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">expected_g</span><span class="o">.</span><span class="n">get_group</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
<span class="o">...</span>         <span class="k">if</span> <span class="n">sort_by</span><span class="p">:</span>
<span class="o">...</span>             <span class="n">ex</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">sort_by</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="o">...</span>
<span class="o">...</span>         <span class="n">ex</span><span class="p">[</span><span class="s2">&quot;DF&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;expected&quot;</span>
<span class="o">...</span>
<span class="o">...</span>         <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Missing (not obtained) group </span><span class="si">{</span><span class="n">name</span><span class="si">!r}</span><span class="se">\n\n</span><span class="si">{</span><span class="n">ex</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="o">**</span><span class="n">to_string_kwargs</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="o">...</span>         <span class="n">diffs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
<span class="o">...</span>
<span class="o">...</span>     <span class="c1"># Compare group by group, sorting them if sort_by is given.</span>
<span class="o">...</span>     <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">common_group_names</span><span class="p">):</span>
<span class="o">...</span>         <span class="n">ob</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">obtained_g</span><span class="o">.</span><span class="n">get_group</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
<span class="o">...</span>         <span class="n">ex</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">expected_g</span><span class="o">.</span><span class="n">get_group</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
<span class="o">...</span>
<span class="o">...</span>         <span class="k">if</span> <span class="n">sort_by</span><span class="p">:</span>
<span class="o">...</span>             <span class="n">ob</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">sort_by</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="o">...</span>             <span class="n">ex</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">sort_by</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="o">...</span>
<span class="o">...</span>         <span class="n">ob</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="o">...</span>         <span class="n">ex</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="o">...</span>
<span class="o">...</span>         <span class="k">try</span><span class="p">:</span>
<span class="o">...</span>             <span class="n">assert_frame_equal</span><span class="p">(</span><span class="n">ob</span><span class="p">,</span> <span class="n">ex</span><span class="p">,</span> <span class="n">check_exact</span><span class="o">=</span><span class="n">check_exact</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="n">rtol</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="n">atol</span><span class="p">,</span> <span class="n">check_like</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">check_dtype</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="o">...</span>         <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
<span class="o">...</span>             <span class="n">ob</span><span class="p">[</span><span class="s2">&quot;DF&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;obtained&quot;</span>
<span class="o">...</span>             <span class="n">ex</span><span class="p">[</span><span class="s2">&quot;DF&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;expected&quot;</span>
<span class="o">...</span>
<span class="o">...</span>             <span class="n">merged</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">ob</span><span class="p">,</span> <span class="n">ex</span><span class="p">])</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
<span class="o">...</span>
<span class="o">...</span>             <span class="k">if</span> <span class="n">singleton_group</span><span class="p">:</span>
<span class="o">...</span>                 <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">err</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="o">...</span>             <span class="k">else</span><span class="p">:</span>
<span class="o">...</span>                 <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;For group </span><span class="si">{</span><span class="n">name</span><span class="si">!r}</span><span class="s2">: </span><span class="si">{</span><span class="n">err</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="o">...</span>
<span class="o">...</span>             <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="se">\n\n</span><span class="si">{</span><span class="n">merged</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="o">**</span><span class="n">to_string_kwargs</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="o">...</span>             <span class="n">diffs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
<span class="o">...</span>
<span class="o">...</span>     <span class="k">if</span> <span class="n">diffs</span><span class="p">:</span>
<span class="o">...</span>         <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">diffs</span><span class="p">)</span><span class="si">}</span><span class="s2"> difference</span><span class="si">{</span><span class="s1">&#39;s&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="n">diffs</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}</span><span class="s2">.</span><span class="se">\n</span><span class="s2">Details follows:</span><span class="se">\n\n</span><span class="s2">&quot;</span>
<span class="o">...</span>         <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="n">msg</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">diffs</span><span class="p">))</span>
</code></pre></div>

<h2 id="examples">Examples</h2>
<p>Let’s begin with the same dataframes as before:</p>
<div class="highlight-candombe"><pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="n">expected_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
<span class="o">...</span>     <span class="s1">&#39;name&#39;</span><span class="p">:</span>    <span class="p">[</span><span class="s1">&#39;alice&#39;</span><span class="p">,</span>  <span class="s1">&#39;bob&#39;</span><span class="p">,</span>   <span class="s1">&#39;alice&#39;</span><span class="p">,</span> <span class="s1">&#39;charlie&#39;</span><span class="p">],</span>
<span class="o">...</span>     <span class="s1">&#39;subject&#39;</span><span class="p">:</span> <span class="p">[</span> <span class="s1">&#39;math&#39;</span><span class="p">,</span> <span class="s1">&#39;math&#39;</span><span class="p">,</span> <span class="s1">&#39;physics&#39;</span><span class="p">,</span>    <span class="s1">&#39;math&#39;</span><span class="p">],</span>
<span class="o">...</span>     <span class="s1">&#39;grade&#39;</span><span class="p">:</span>   <span class="p">[</span>      <span class="mi">5</span><span class="p">,</span>      <span class="mi">4</span><span class="p">,</span>         <span class="mi">4</span><span class="p">,</span>         <span class="mi">5</span><span class="p">],</span>
<span class="o">...</span> <span class="p">})</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">obtained_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
<span class="o">...</span>     <span class="s1">&#39;name&#39;</span><span class="p">:</span>    <span class="p">[</span>  <span class="s1">&#39;alice&#39;</span><span class="p">,</span>   <span class="s1">&#39;bob&#39;</span><span class="p">,</span>  <span class="s1">&#39;alice&#39;</span><span class="p">,</span> <span class="s1">&#39;charlie&#39;</span><span class="p">],</span>
<span class="o">...</span>     <span class="s1">&#39;subject&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;physics&#39;</span><span class="p">,</span>  <span class="s1">&#39;math&#39;</span><span class="p">,</span>   <span class="s1">&#39;math&#39;</span><span class="p">,</span>    <span class="s1">&#39;math&#39;</span><span class="p">],</span>
<span class="o">...</span>     <span class="s1">&#39;grade&#39;</span><span class="p">:</span>   <span class="p">[</span>        <span class="mi">4</span><span class="p">,</span>       <span class="mi">4</span><span class="p">,</span>        <span class="mi">3</span><span class="p">,</span>         <span class="mi">2</span><span class="p">],</span>
<span class="o">...</span> <span class="p">})</span>
</code></pre></div>

<p>Calling <code><span class="highlight-candombe-inline"><span class="n">assert_df_equal</span></span></code> without any group by or sort by does not gives you much. As before a straight call to <code><span class="highlight-candombe-inline"><span class="n">assert_frame_equal</span></span></code> says that there is a difference on <code><span class="highlight-candombe-inline"><span class="s2">&quot;subject&quot;</span></span></code> when we already know that it is not.</p>
<div class="highlight-candombe"><pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="n">assert_df_equal</span><span class="p">(</span><span class="n">obtained_df</span><span class="p">,</span> <span class="n">expected_df</span><span class="p">)</span>
<span class="o">&lt;...&gt;</span>
<span class="ne">AssertionError</span><span class="p">:</span> <span class="n">Found</span> <span class="mi">1</span> <span class="n">difference</span><span class="o">.</span>
<span class="n">Details</span> <span class="n">follows</span><span class="p">:</span>
<span class="o">&lt;...&gt;</span>
<span class="n">DataFrame</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="p">(</span><span class="n">column</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;subject&quot;</span><span class="p">)</span> <span class="n">are</span> <span class="n">different</span>
<span class="o">&lt;...&gt;</span>
<span class="n">DataFrame</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="p">(</span><span class="n">column</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;subject&quot;</span><span class="p">)</span> <span class="n">values</span> <span class="n">are</span> <span class="n">different</span> <span class="p">(</span><span class="mf">50.0</span> <span class="o">%</span><span class="p">)</span>
<span class="p">[</span><span class="n">index</span><span class="p">]:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
<span class="p">[</span><span class="n">left</span><span class="p">]:</span>  <span class="p">[</span><span class="n">physics</span><span class="p">,</span> <span class="n">math</span><span class="p">,</span> <span class="n">math</span><span class="p">,</span> <span class="n">math</span><span class="p">]</span>
<span class="p">[</span><span class="n">right</span><span class="p">]:</span> <span class="p">[</span><span class="n">math</span><span class="p">,</span> <span class="n">math</span><span class="p">,</span> <span class="n">physics</span><span class="p">,</span> <span class="n">math</span><span class="p">]</span>
<span class="o">&lt;...&gt;</span>
      <span class="n">name</span>  <span class="n">subject</span>  <span class="n">grade</span>        <span class="n">DF</span>
<span class="mi">0</span>    <span class="n">alice</span>  <span class="n">physics</span>      <span class="mi">4</span>  <span class="n">obtained</span>
<span class="mi">0</span>    <span class="n">alice</span>     <span class="n">math</span>      <span class="mi">5</span>  <span class="n">expected</span>
<span class="mi">1</span>      <span class="n">bob</span>     <span class="n">math</span>      <span class="mi">4</span>  <span class="n">obtained</span>
<span class="mi">1</span>      <span class="n">bob</span>     <span class="n">math</span>      <span class="mi">4</span>  <span class="n">expected</span>
<span class="mi">2</span>    <span class="n">alice</span>     <span class="n">math</span>      <span class="mi">3</span>  <span class="n">obtained</span>
<span class="mi">2</span>    <span class="n">alice</span>  <span class="n">physics</span>      <span class="mi">4</span>  <span class="n">expected</span>
<span class="mi">3</span>  <span class="n">charlie</span>     <span class="n">math</span>      <span class="mi">2</span>  <span class="n">obtained</span>
<span class="mi">3</span>  <span class="n">charlie</span>     <span class="n">math</span>      <span class="mi">5</span>  <span class="n">expected</span>
</code></pre></div>

<p>Sorting quickly makes the real difference visible:</p>
<div class="highlight-candombe"><pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="n">assert_df_equal</span><span class="p">(</span><span class="n">obtained_df</span><span class="p">,</span> <span class="n">expected_df</span><span class="p">,</span> <span class="n">sort_by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;subject&#39;</span><span class="p">])</span>
<span class="o">&lt;...&gt;</span>
<span class="ne">AssertionError</span><span class="p">:</span> <span class="n">Found</span> <span class="mi">1</span> <span class="n">difference</span><span class="o">.</span>
<span class="n">Details</span> <span class="n">follows</span><span class="p">:</span>
<span class="o">&lt;...&gt;</span>
<span class="n">DataFrame</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="p">(</span><span class="n">column</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;grade&quot;</span><span class="p">)</span> <span class="n">are</span> <span class="n">different</span>
<span class="o">&lt;...&gt;</span>
<span class="n">DataFrame</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="p">(</span><span class="n">column</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;grade&quot;</span><span class="p">)</span> <span class="n">values</span> <span class="n">are</span> <span class="n">different</span> <span class="p">(</span><span class="mf">50.0</span> <span class="o">%</span><span class="p">)</span>
<span class="p">[</span><span class="n">index</span><span class="p">]:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
<span class="p">[</span><span class="n">left</span><span class="p">]:</span>  <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
<span class="p">[</span><span class="n">right</span><span class="p">]:</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span>
<span class="o">&lt;...&gt;</span>
      <span class="n">name</span>  <span class="n">subject</span>  <span class="n">grade</span>        <span class="n">DF</span>
<span class="mi">0</span>    <span class="n">alice</span>     <span class="n">math</span>      <span class="mi">3</span>  <span class="n">obtained</span>
<span class="mi">0</span>    <span class="n">alice</span>     <span class="n">math</span>      <span class="mi">5</span>  <span class="n">expected</span>
<span class="mi">1</span>    <span class="n">alice</span>  <span class="n">physics</span>      <span class="mi">4</span>  <span class="n">obtained</span>
<span class="mi">1</span>    <span class="n">alice</span>  <span class="n">physics</span>      <span class="mi">4</span>  <span class="n">expected</span>
<span class="mi">2</span>      <span class="n">bob</span>     <span class="n">math</span>      <span class="mi">4</span>  <span class="n">obtained</span>
<span class="mi">2</span>      <span class="n">bob</span>     <span class="n">math</span>      <span class="mi">4</span>  <span class="n">expected</span>
<span class="mi">3</span>  <span class="n">charlie</span>     <span class="n">math</span>      <span class="mi">2</span>  <span class="n">obtained</span>
<span class="mi">3</span>  <span class="n">charlie</span>     <span class="n">math</span>      <span class="mi">5</span>  <span class="n">expected</span>
</code></pre></div>

<p>But the dataframes are too large and it is not easy to see exactly where is the problem.</p>
<p>Moreover adding an extra row breaks the comparison.</p>
<div class="highlight-candombe"><pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="n">obtained_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">obtained_df</span><span class="o">.</span><span class="n">index</span><span class="p">)]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;alice&quot;</span><span class="p">,</span> <span class="s2">&quot;algebra&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">assert_df_equal</span><span class="p">(</span><span class="n">obtained_df</span><span class="p">,</span> <span class="n">expected_df</span><span class="p">,</span> <span class="n">sort_by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;subject&#39;</span><span class="p">])</span>
<span class="o">&lt;...&gt;</span>
<span class="ne">AssertionError</span><span class="p">:</span> <span class="n">Found</span> <span class="mi">1</span> <span class="n">difference</span><span class="o">.</span>
<span class="n">Details</span> <span class="n">follows</span><span class="p">:</span>
<span class="o">&lt;...&gt;</span>
<span class="n">DataFrame</span> <span class="n">are</span> <span class="n">different</span>
<span class="o">&lt;...&gt;</span>
<span class="n">DataFrame</span> <span class="n">shape</span> <span class="n">mismatch</span>
<span class="p">[</span><span class="n">left</span><span class="p">]:</span>  <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="p">[</span><span class="n">right</span><span class="p">]:</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="o">&lt;...&gt;</span>
</code></pre></div>

<p><code><span class="highlight-candombe-inline"><span class="n">group_by</span></span></code> to rescue!</p>
<p>Partitioning the dataframes in smaller groups makes much easier the debugging and much more robust against shape mismatches</p>
<div class="highlight-candombe"><pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="n">assert_df_equal</span><span class="p">(</span><span class="n">obtained_df</span><span class="p">,</span> <span class="n">expected_df</span><span class="p">,</span> <span class="n">group_by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;subject&#39;</span><span class="p">])</span>
<span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>
<span class="o">&lt;...&gt;</span>
<span class="ne">AssertionError</span><span class="p">:</span> <span class="n">Found</span> <span class="mi">3</span> <span class="n">differences</span><span class="o">.</span>
<span class="n">Details</span> <span class="n">follows</span><span class="p">:</span>
<span class="o">&lt;...&gt;</span>
<span class="n">Unexpected</span> <span class="p">(</span><span class="ow">not</span> <span class="n">expected</span><span class="p">)</span> <span class="n">group</span> <span class="p">(</span><span class="s1">&#39;alice&#39;</span><span class="p">,</span> <span class="s1">&#39;algebra&#39;</span><span class="p">)</span>
<span class="o">&lt;...&gt;</span>
    <span class="n">name</span>  <span class="n">subject</span>  <span class="n">grade</span>        <span class="n">DF</span>
<span class="mi">4</span>  <span class="n">alice</span>  <span class="n">algebra</span>      <span class="mi">3</span>  <span class="n">obtained</span>
<span class="o">&lt;...&gt;</span>
<span class="n">For</span> <span class="n">group</span> <span class="p">(</span><span class="s1">&#39;alice&#39;</span><span class="p">,</span> <span class="s1">&#39;math&#39;</span><span class="p">):</span> <span class="n">DataFrame</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="p">(</span><span class="n">column</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;grade&quot;</span><span class="p">)</span> <span class="n">are</span> <span class="n">different</span>
<span class="o">&lt;...&gt;</span>
<span class="n">DataFrame</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="p">(</span><span class="n">column</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;grade&quot;</span><span class="p">)</span> <span class="n">values</span> <span class="n">are</span> <span class="n">different</span> <span class="p">(</span><span class="mf">100.0</span> <span class="o">%</span><span class="p">)</span>
<span class="p">[</span><span class="n">index</span><span class="p">]:</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="p">[</span><span class="n">left</span><span class="p">]:</span>  <span class="p">[</span><span class="mi">3</span><span class="p">]</span>
<span class="p">[</span><span class="n">right</span><span class="p">]:</span> <span class="p">[</span><span class="mi">5</span><span class="p">]</span>
<span class="o">&lt;...&gt;</span>
    <span class="n">name</span> <span class="n">subject</span>  <span class="n">grade</span>        <span class="n">DF</span>
<span class="mi">0</span>  <span class="n">alice</span>    <span class="n">math</span>      <span class="mi">3</span>  <span class="n">obtained</span>
<span class="mi">0</span>  <span class="n">alice</span>    <span class="n">math</span>      <span class="mi">5</span>  <span class="n">expected</span>
<span class="o">&lt;...&gt;</span>
<span class="n">For</span> <span class="n">group</span> <span class="p">(</span><span class="s1">&#39;charlie&#39;</span><span class="p">,</span> <span class="s1">&#39;math&#39;</span><span class="p">):</span> <span class="n">DataFrame</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="p">(</span><span class="n">column</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;grade&quot;</span><span class="p">)</span> <span class="n">are</span> <span class="n">different</span>
<span class="o">&lt;...&gt;</span>
<span class="n">DataFrame</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="p">(</span><span class="n">column</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;grade&quot;</span><span class="p">)</span> <span class="n">values</span> <span class="n">are</span> <span class="n">different</span> <span class="p">(</span><span class="mf">100.0</span> <span class="o">%</span><span class="p">)</span>
<span class="p">[</span><span class="n">index</span><span class="p">]:</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="p">[</span><span class="n">left</span><span class="p">]:</span>  <span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="p">[</span><span class="n">right</span><span class="p">]:</span> <span class="p">[</span><span class="mi">5</span><span class="p">]</span>
<span class="o">&lt;...&gt;</span>
      <span class="n">name</span> <span class="n">subject</span>  <span class="n">grade</span>        <span class="n">DF</span>
<span class="mi">0</span>  <span class="n">charlie</span>    <span class="n">math</span>      <span class="mi">2</span>  <span class="n">obtained</span>
<span class="mi">0</span>  <span class="n">charlie</span>    <span class="n">math</span>      <span class="mi">5</span>  <span class="n">expected</span>
</code></pre></div>

<p>It looks complicated but now we know <strong>exactly</strong> where are the differences:</p>
<ul>
<li><p>We have a <em>unexpected</em> row: <code><span class="highlight-candombe-inline"><span class="n">alice</span>  <span class="n">algebra</span>  <span class="mi">3</span></span></code></p></li>
<li><p>For <code><span class="highlight-candombe-inline"><span class="p">(</span><span class="s1">&#39;alice&#39;</span><span class="p">,</span> <span class="s1">&#39;math&#39;</span><span class="p">)</span></span></code> the obtained grade was 3 but expected 5</p></li>
<li><p>For <code><span class="highlight-candombe-inline"><span class="p">(</span><span class="s1">&#39;charlie&#39;</span><span class="p">,</span> <span class="s1">&#39;math&#39;</span><span class="p">)</span></span></code> the obtained grade was 2 but expected 5</p>
<p class="small-subtitle-with-top-margin">
<p>Related tags: <a href='https://book-of-gehn.github.io/?tag="python"'>python</a>, <a href='https://book-of-gehn.github.io/?tag="dataframe"'>dataframe</a>, <a href='https://book-of-gehn.github.io/?tag="pandas"'>pandas</a></p>
</p></li>
</ul>
<script src="https://utteranc.es/client.js"
        repo="book-of-gehn/book-of-gehn.github.io"
        issue-term="pathname"
        label="comments-utteranc"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
</article>
<span class="print-footer">Diff Between Data Frames for Testing - October 1, 2022 - Martin Di Paola</span>
<footer>
    <hr class="slender">
    <div class="credits">
        <span>&copy;
            Martin Di Paola
        </span></br>
            <a class="raw_link" href="/atom.xml"><img height="16px" width="16px" src="/img/rss-32px.png" /></a>
            <a class="raw_link" href="https://github.com/eldipa"><img height="16px" width="16px" src="/img/github.png" /></a>
        <br>
        
        <a href="mailto:martinp.dipaola@gmail.com">martinp.dipaola@gmail.com</a></span></br> <br>
        
    </div>

    <img src='http://192.34.63.156:6127/img/http%3A//127.0.0.1%3A4000/articles/2022/10/01/Diff-Between-Dataframes-for-Testing.html.png' onerror="this.style.display='none'" async></img>
</footer>
</body>
</html>
