import speakerViewHTML from"./speaker-view.html";import{marked}from"marked";const Plugin=()=>{let r,s=null,i;function t(){if(s&&!s.closed)s.focus();else if((s=window.open("about:blank","reveal.js - Notes","width=1100,height=700")).marked=marked,s.document.write(speakerViewHTML),s){const e=i.getConfig().url,t="string"==typeof e?e:window.location.protocol+"//"+window.location.host+window.location.pathname+window.location.search;r=setInterval(function(){s.postMessage(JSON.stringify({namespace:"reveal-notes",type:"connect",state:i.getState(),url:t}),"*")},500),window.addEventListener("message",n)}else alert("Speaker view popup failed to open. Please make sure popups are allowed and reopen the speaker view.")}function e(e){let t=i.getCurrentSlide(),n=t.querySelectorAll("aside.notes"),a=t.querySelector(".current-fragment");var o,r={namespace:"reveal-notes",type:"state",notes:"",markdown:!1,whitespace:"normal",state:i.getState()};t.hasAttribute("data-notes")&&(r.notes=t.getAttribute("data-notes"),r.whitespace="pre-wrap"),a&&((o=a.querySelector("aside.notes"))?(r.notes=o.innerHTML,r.markdown="string"==typeof o.getAttribute("data-markdown"),n=null):a.hasAttribute("data-notes")&&(r.notes=a.getAttribute("data-notes"),r.whitespace="pre-wrap",n=null)),n&&n.length&&(n=Array.from(n).filter(e=>null===e.closest(".fragment")),r.notes=n.map(e=>e.innerHTML).join("\n"),r.markdown=n[0]&&"string"==typeof n[0].getAttribute("data-markdown")),s.postMessage(JSON.stringify(r),"*")}function n(e){if(function(e){try{return window.location.origin===e.source.location.origin}catch(e){}}(e))try{var t=JSON.parse(e.data);t&&"reveal-notes"===t.namespace&&"connected"===t.type?(clearInterval(r),l()):t&&"reveal-notes"===t.namespace&&"call"===t.type&&(n=t.methodName,a=t.arguments,o=t.callId,n=i[n].apply(i,a),s.postMessage(JSON.stringify({namespace:"reveal-notes",type:"return",result:n,callId:o}),"*"))}catch(e){}var n,a,o}function l(){i.on("slidechanged",e),i.on("fragmentshown",e),i.on("fragmenthidden",e),i.on("overviewhidden",e),i.on("overviewshown",e),i.on("paused",e),i.on("resumed",e),e()}return{id:"notes",init:function(e){i=e,/receiver/i.test(window.location.search)||(null!==window.location.search.match(/(\?|\&)notes/gi)?t():window.addEventListener("message",t=>{if(!s&&"string"==typeof t.data){let e;try{e=JSON.parse(t.data)}catch(e){}e&&"reveal-notes"===e.namespace&&"heartbeat"===e.type&&(t=t.source,s&&!s.closed?s.focus():(s=t,window.addEventListener("message",n),l()))}}),i.addKeyBinding({keyCode:83,key:"S",description:"Speaker notes view"},function(){t()}))},open:t}};export default Plugin;